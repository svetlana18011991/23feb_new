<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî editor+game</title>
  <style>
    :root{
      --bg0:#0b0f14;
      --card:rgba(20,28,38,.72);
      --card2:rgba(15,22,30,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.70);
      --gold: #caa24d;
      --gold2:#f1d089;
      --danger:#ff5b6b;
      --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%),
                  radial-gradient(900px 520px at 70% 18%, rgba(255,190,90,.08), transparent 60%),
                  linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Layout (editor) ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 480px 1fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100%;}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0; /* –≤–∞–∂–Ω–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω—É—Ç—Ä–∏ flex */
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 100% 0%, rgba(255,215,120,.07), transparent 65%),
                  repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 2px, transparent 2px 12px);
      opacity:.35;
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:1}

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:800;
      font-size:22px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .btn{
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.13);
      background: rgba(25,35,46,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(30,43,58,.68); border-color: rgba(255,255,255,.18)}
    .btn:active{ transform: translateY(1px) }
    .btnGold{
      background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13));
      border-color: rgba(202,162,77,.45);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,91,107,.24), rgba(255,91,107,.12));
      border-color: rgba(255,91,107,.38);
    }

    .scroll{
      flex: 1;
      min-height: 0;
      overflow:auto;
      padding: 14px 18px 18px 18px;
    }
    .section{
      background: rgba(10,14,20,.22);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .section h3{
      margin:0 0 10px 0;
      font-size:14px;
      color: rgba(255,255,255,.92);
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      outline:none;
      background: rgba(10,14,18,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{min-height: 84px; resize: vertical;}
    input[type="number"]{appearance:textfield}
    .help{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,238,247,.62);
      line-height:1.25;
    }
    .split{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }
    .qList{display:flex; flex-direction:column; gap:10px;}
    .qItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.48);
      align-items:center;
    }
    .qTitle{
      font-weight:700;
      font-size:13px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }
    .qMeta{
      font-size:12px;
      color: rgba(232,238,247,.62);
    }
    .iconBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(25,35,46,.45);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ background: rgba(25,35,46,.65) }
    .iconBtn.danger{ border-color: rgba(255,91,107,.45); background: rgba(255,91,107,.12)}
    .iconBtn.danger:hover{ background: rgba(255,91,107,.18)}
    .soundRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .range{
      width:100%;
      accent-color: #2aa6ff;
    }

    /* ====== Preview ====== */
    .previewWrap{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .previewHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .previewHeader .title2{
      font-weight:800;
      font-size:18px;
    }
    .previewHeader .muted{
      font-size:12px; color:var(--muted);
    }
    .previewFrame{
      flex:1;
      min-height: 420px;
      border:0;
      width:100%;
      background: transparent;
    }

    /* ====== Version badge ====== */
    .versionBadge{
      position:fixed;
      right:14px; bottom:14px;
      z-index:50;
      font-size:12px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      pointer-events:none;
    }

    /* ====== GAME MODE ====== */
    .gameRoot{
      position:fixed;
      inset:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#000;
    }
    .arena{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      margin: 16px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background: #0b0f14;
    }

    /* Background image (non-transparent) */
    .arenaBg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      transform: scale(1.06);
      filter: saturate(1.05) contrast(1.03) brightness(1.02);
    }
    .arenaBg::after{
      /* cinematic + depth */
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,230,160,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 25%, rgba(100,180,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .arenaBg3d{
      /* subtle parallax */
      will-change: transform;
      transition: transform .08s linear;
    }

    .hud{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudLeft{
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      min-width: 260px;
      max-width: 460px;
    }
    .gameTitle{
      font-weight:900;
      font-size:22px;
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .gameHint{
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .hudRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pillBtn{
      pointer-events:auto;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-weight:650;
      font-size:13px;
      cursor:pointer;
    }
    .pillBtn:hover{ background: rgba(0,0,0,.40) }
    .hudStat{
      pointer-events:none;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      font-weight:650;
      font-size:13px;
    }

    /* Team bars */
    .teams{
      position:absolute;
      top:78px; left:14px; right:14px;
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      pointer-events:none;
    }
    .teamCard{
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      padding:10px 10px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
    }
    .teamNameInput{
      pointer-events:auto;
      width: 100%;
      max-width: 220px;
      font-weight:800;
      font-size:14px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      outline:none;
    }
    .teamNameInput:focus{ border-color: rgba(202,162,77,.50); box-shadow: 0 0 0 3px rgba(202,162,77,.12); }
    .teamScore{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.95);
      min-width: 40px;
      text-align:right;
    }
    .teamNow{
      display:flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.78);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.24);
      border: 1px solid rgba(255,255,255,.25);
    }
    .dot.on{ background: rgba(202,162,77,.95); border-color: rgba(202,162,77,.95); box-shadow: 0 0 0 4px rgba(202,162,77,.16); }

    /* Targets */
    .targets{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .target{
      position:absolute;
      width: 92px;
      height: 92px;
      border-radius: 999px;
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      transform: translate(-50%, -50%);
      /* fallback if image missing */
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(240,200,120,.18), transparent 65%),
        rgba(0,0,0,.20);
      box-shadow:
        0 12px 30px rgba(0,0,0,.50),
        0 0 0 2px rgba(240,200,120,.16) inset,
        0 0 22px rgba(240,200,120,.18);
      backdrop-filter: blur(2px);
    }
    .target .tImg{
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background-image: var(--target-img);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
      animation: targetFloat 2.8s ease-in-out infinite;
      animation-delay: var(--float-delay, 0s);
      transform-origin: 50% 60%;
    }
    .target .tNum{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:22px;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      letter-spacing:.5px;
    }
    .target .tPts{
      position:absolute;
      left:50%;
      bottom:-18px;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight:700;
      color: rgba(240,200,120,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap;
      pointer-events:none;
    }
    .target.hit{ opacity:.25; filter: grayscale(1); }
    @keyframes targetFloat{
      0%{ transform: translateY(0px) scale(1); }
      50%{ transform: translateY(-7px) scale(1.02); }
      100%{ transform: translateY(0px) scale(1); }
    }
    .target:hover{ transform: translate(-50%,-50%) scale(1.05); }
    .target.hit{
      opacity:.38;
      filter: grayscale(1) brightness(.9);
      pointer-events:none;
    }
    .tNum{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 25px rgba(0,0,0,.65);
    }
    .tPts{
      position:absolute;
      bottom:-10px;
      left:50%;
      transform: translateX(-50%);
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.40);
      background: rgba(0,0,0,.35);
      color: rgba(255,232,190,.95);
      font-weight:800;
      font-size:11px;
      white-space:nowrap;
    }

    /* Modal (game question) */
    .modalBackdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 40;
    }
    .modalBackdrop.on{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,8,10,.88);  /* NOT transparent */
      box-shadow: 0 24px 95px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 36px);
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader .h{
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }
    .modalClose{
      border-radius: 14px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .modalBody{
      padding: 16px;
      display:grid;
      gap:12px;
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .qText{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
    }
    .mediaRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: rgba(255,255,255,.8);
      font-size:12px;
    }
    .mediaTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .answers{grid-template-columns:1fr}
    }
    .ansBtn{
      text-align:left;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      position:relative;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .ansBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16);}
    .ansKey{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.50);
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,232,190,.95);
      flex:0 0 auto;
    }
    .ansText{ font-weight:700; line-height:1.25; }
    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputRow input{
      flex:1;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:700;
      outline:none;
    }
    .primary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(202,162,77,.55);
      background: rgba(202,162,77,.18);
      color: rgba(255,245,225,.95);
      font-weight:900;
      cursor:pointer;
    }
    .secondary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:800;
      cursor:pointer;
    }

    /* Timer badge top-center */
    .timerBadge{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,166,60,.55);
      background: rgba(255,166,60,.12);
      color: rgba(255,230,190,.95);
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      display:none;
      align-items:center;
      gap:10px;
    }
    .timerBadge.on{
      display:flex;
      animation: pulseOrange 1.6s ease-in-out infinite;
    }
    @keyframes pulseOrange{
      0%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      35%{ box-shadow: 0 0 0 10px rgba(255,166,60,.14) }
      70%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      100%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
    }

    /* Small toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 60;
      font-weight:700;
      font-size:13px;
    }
    .toast.on{ display:block; }
  
/* --- Cursor: crosshair inside game/preview --- */
#previewFrame { cursor: crosshair; }
body[data-mode="game"] .gameRoot,
body[data-mode="game"] .gameRoot * { cursor: crosshair; }
body[data-mode="game"] .gameRoot input,
body[data-mode="game"] .gameRoot textarea { cursor: text; }
body[data-mode="game"] .gameRoot a { cursor: pointer; }


/* ==== Custom crosshair (works inside Genially overlays) ==== */
body.game-cursor { cursor: none !important; }
#aimCursor{
  position: fixed;
  left: -100px;
  top: -100px;
  width: 54px;
  height: 54px;
  transform: translate(-50%,-50%);
  pointer-events: none;
  z-index: 2147483647;
  opacity: 0;
  transition: opacity .12s ease;
}
#aimCursor .ring{
  position:absolute; inset:0;
  border: 2px solid rgba(255,190,90,.9);
  border-radius: 999px;
  box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 16px rgba(255,170,60,.18);
  background: radial-gradient(circle at 50% 50%, rgba(255,190,90,.08), transparent 60%);
}
#aimCursor .h, #aimCursor .v{
  position:absolute;
  left:50%; top:50%;
  background: rgba(255,190,90,.95);
  box-shadow: 0 0 10px rgba(255,170,60,.25);
}
#aimCursor .h{ width: 64px; height: 2px; transform: translate(-50%,-50%); }
#aimCursor .v{ width: 2px; height: 64px; transform: translate(-50%,-50%); }
#aimCursor .dot{
  position:absolute; left:50%; top:50%;
  width: 6px; height: 6px;
  border-radius: 999px;
  transform: translate(-50%,-50%);
  background: rgba(255,190,90,.95);
}


.cornerLogo{position:fixed;top:14px;right:14px;z-index:1000;width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));opacity:.95;pointer-events:none;}

/* v27 tweaks */
.topBrand{position:fixed;left:18px;top:14px;z-index:9999;pointer-events:none;opacity:.98;filter:drop-shadow(0 10px 24px rgba(0,0,0,.55));display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:14px;background:linear-gradient(180deg, rgba(18,24,33,.58), rgba(10,12,16,.35));border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(8px);}
    .modeGame .topBrand{ display:none; }
.topBrand img{height:34px;width:auto;border-radius:10px;display:block;}
.topBrand span{font-weight:800;font-size:13px;letter-spacing:.2px;color:rgba(255,255,255,.92);text-shadow:0 8px 22px rgba(0,0,0,.55);}
/* stronger 3D/parallax background */
.arenaBg{will-change:transform,filter;transform:translate3d(var(--bgx,0px),var(--bgy,0px),0) scale(1.10);filter:saturate(1.05) contrast(1.08);}
.arenaBg::after{content:"";position:absolute;inset:0;background:radial-gradient(1200px 600px at 40% 35%, rgba(255,255,255,.10), rgba(0,0,0,.45) 65%, rgba(0,0,0,.70));mix-blend-mode:overlay;pointer-events:none;}
.hudGoals{animation:goalFloat 3.8s ease-in-out infinite;}
@keyframes goalFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}


  .mediaImgWrap{display:flex;flex-direction:column;gap:8px}
  .mediaLink{display:inline-flex;align-items:center;gap:6px;color:var(--gold);text-decoration:none;font-weight:700}
  .mediaLink:hover{text-decoration:underline}
  .qImage{max-width:100%;max-height:240px;border-radius:14px;border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 30px rgba(0,0,0,.35);cursor:pointer}

.qImg{max-width:100%;max-height:240px;border-radius:14px;display:block;margin-top:12px;object-fit:contain;box-shadow:0 10px 30px rgba(0,0,0,.35);}

.fatalOverlay{position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.85);color:#fff;font:14px/1.4 system-ui,Segoe UI,Arial;padding:16px;overflow:auto;}
.fatalOverlay h2{margin:0 0 8px;font-size:18px;}
.fatalOverlay pre{white-space:pre-wrap;word-break:break-word;background:rgba(255,255,255,.08);padding:12px;border-radius:12px;}
</style>
</head>
<body>
  <div class="topBrand" aria-hidden="true">
    <img src="63.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'"/>
    <span>–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</span>
  </div>
<div id="root"></div>

<div class="toast" id="toast"></div>

<script>(function(){ 
  const showFatal = (err) => {
    try {
      console.error(err);
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      const el = document.createElement('div');
      el.className = 'fatalOverlay';
      el.innerHTML = '<h2>–û—à–∏–±–∫–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ (preview/editor –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å)</h2>' +
                     '<div>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –ø—Ä–∏—à–ª–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:</div>' +
                     '<pre></pre>';
      el.querySelector('pre').textContent = msg;
      document.body.appendChild(el);
    } catch(e) {}
  };
  window.addEventListener('error', (e)=>showFatal(e.error||e.message));
  window.addEventListener('unhandledrejection', (e)=>showFatal(e.reason||e));
  try {

// Global state for editor/game
let cfg = defaultCfg();
let questions = [];

  // Hide brand inside game iframe (keep only in editor)
  try {
    if (typeof isGameMode === 'function' && isGameMode()) {
      const tb = document.querySelector('.topBrand');
      if (tb) tb.style.display = 'none';
    }
  } catch (e) {}

/* ===========================
   –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä
   Version 23 ‚Äî editor+game
   =========================== */

const VERSION = 24;

/* ---------- helpers ---------- */
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('on');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1600);
}

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* base64url */
function b64uEncode(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64uDecode(str){
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  const json = decodeURIComponent(escape(atob(str)));
  return JSON.parse(json);
}

function urlOfSelf(){
  return location.origin + location.pathname;
}

/* ---------- Default config ---------- */
function defaultCfg(){
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamsCount: 2,
    autoNextTeam: true,
    latex: false,
    bg: "2.png",
    targetFile: "13.png",
    targetLineOffset: 0.5,
    targetLineJitter: 4,
    shot: { variant:"pif", volume:0.7 },
    questions: []
  };
}

/* ---------- LaTeX (optional) ---------- */
let katexLoaded = false;
async function ensureKatex(){
  if(katexLoaded) return;
  katexLoaded = true;
  const css = document.createElement('link');
  css.rel = 'stylesheet';
  css.href = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css";
  document.head.appendChild(css);

  const s1 = document.createElement('script');
  s1.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js";
  s1.defer = true;
  document.head.appendChild(s1);

  const s2 = document.createElement('script');
  s2.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js";
  s2.defer = true;
  document.head.appendChild(s2);

  await new Promise(res=> s2.onload = res);
}
function renderLatexIn(el){
  if(!window.renderMathInElement) return;
  try{
    window.renderMathInElement(el, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true},
      ]
    });
  }catch(e){}
}

/* ---------- Shot sound (WebAudio synth, no infinite loop) ---------- */
const AudioKit = (() => {
  let ctx = null;
  let master = null;

  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 1.2;
    master.connect(ctx.destination);
  }
  async function unlock(){
    ensure();
    if(ctx.state === 'suspended') await ctx.resume();
  }
  function setVolume(v){
    ensure();
    master.gain.value = clamp(v, 0, 1) * 3.2;
  }
  function noiseBuffer(){
    ensure();
    const bufferSize = ctx.sampleRate * 0.15;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * (1 - i/data.length);
    return buffer;
  }

  function playVariant(variant){
    ensure();
    const t0 = ctx.currentTime;
    const out = ctx.createGain();
    out.gain.value = 1.25;
    out.connect(master);

    if(variant === 'snap'){ // click
      const osc = ctx.createOscillator();
      osc.type = 'square';
      osc.frequency.setValueAtTime(220, t0);
      osc.frequency.exponentialRampToValueAtTime(880, t0+0.03);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.6, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.08);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.09);
    } else if(variant === 'boom'){ // low thump + noise
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(90, t0);
      osc.frequency.exponentialRampToValueAtTime(45, t0+0.12);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.9, t0+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.24);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const nf = ctx.createBiquadFilter();
      nf.type = 'lowpass'; nf.frequency.setValueAtTime(800, t0);
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.4, t0+0.015);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.18);
      n.connect(nf).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.19);
    } else {
    document.body.classList.add('modeEditor');
    document.body.classList.remove('modeGame'); // 'pif' default
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(520, t0);
      osc.frequency.exponentialRampToValueAtTime(220, t0+0.08);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.85, t0+0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.14);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.setValueAtTime(1800, t0); bp.Q.value = 3;
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      n.connect(bp).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.10);
    }

    out.gain.setValueAtTime(1, t0);
    out.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
    setTimeout(()=>{ try{out.disconnect()}catch(e){} }, 500);
  }

  return { ensure, unlock, setVolume, playVariant };
})();

/* ---------- App mode detection ---------- */
const params = new URLSearchParams(location.search);
const isGame = params.has('game');

// Hide editor branding inside the GAME iframe
if (isGame) {
    document.body.classList.add('modeGame');
    document.body.classList.remove('modeEditor');
  const hb = document.getElementById('headerBrand');
  if (hb) hb.style.display = 'none';
}


// ===== Crosshair overlay (needed for Genially where CSS cursor can be ignored) =====
function enableCrosshairOverlay(){
  if(document.getElementById('aimCursor')) return;
  document.body.classList.add('game-cursor');

  const el = document.createElement('div');
  el.id = 'aimCursor';
  el.innerHTML = '<div class="ring"></div><div class="h"></div><div class="v"></div><div class="dot"></div>';
  document.body.appendChild(el);

  const arena = document.getElementById('arena') || document.body;

  const show = () => { el.style.opacity = '1'; };
  const hide = () => { el.style.opacity = '0'; };

  const move = (e) => {
    // Use clientX/Y so it works in iframes and Genially embeds
    el.style.left = e.clientX + 'px';
    el.style.top  = e.clientY + 'px';
    // show on first move
    if(el.style.opacity !== '1') el.style.opacity = '1';
  };

  // Prefer listening on arena; also listen on window as fallback
  arena.addEventListener('mousemove', move, {passive:true});
  window.addEventListener('mousemove', move, {passive:true});

  arena.addEventListener('mouseenter', show, {passive:true});
  arena.addEventListener('mouseleave', hide, {passive:true});

  // Touch devices: keep default cursor (no-op)
  if('ontouchstart' in window){
    document.body.classList.remove('game-cursor');
    el.remove();
  }
}

if(isGame){
  // Delay to ensure #arena exists
  setTimeout(enableCrosshairOverlay, 0);
}


/* ===========================
   GAME MODE
   =========================== */
function mountGame(cfg){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div class="arenaBg arenaBg3d" id="arenaBg"></div>

        <div class="hud">
          <div class="hudLeft">
            <div class="gameTitle" id="gTitle"></div>
            <div class="gameHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
          </div>
          <div class="hudRight">
            <div class="hudStat" id="hudTurn">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b id="turnTeam">‚Äî</b></div>
            <div class="hudStat hudGoals">–¶–µ–ª–∏: <b id="hudTargets">0/0</b></div>
            <button class="pillBtn" id="btnHelp">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="pillBtn" id="btnReset">–°–±—Ä–æ—Å</button>
          </div>
        </div>

        <div class="teams" id="teams"></div>

        <div class="targets" id="targets"></div>

        <div class="modalBackdrop" id="modalBack">
          <div class="modal">
            <div class="timerBadge" id="timerBadge">‚è± <span id="timerText">30</span> —Å–µ–∫</div>
            <div class="modalHeader">
              <div class="h" id="qHeader">–í–æ–ø—Ä–æ—Å</div>
              <button class="modalClose" id="btnClose">Esc</button>
            </div>
            <div class="modalBody">
              <div class="qText" id="qText"></div>
              <div class="mediaRow" id="qMedia"></div>
              <div id="answersWrap"></div>
            </div>
          </div>
        </div>

        <div class="versionBadge">–í–µ—Ä—Å–∏—è ${VERSION} ‚Ä¢ game</div>
      </div>
    </div>
  `;

  const arena = document.getElementById('arena');
  const bg = document.getElementById('arenaBg');

  function assetUrl(u){
    if(!u) return u;
    const v = cfg._assetV || 0;
    const sep = u.includes('?') ? '&' : '?';
    return `${u}${sep}v=${v}`;
  }

  function setBg(){
    const u = cfg.bg || "";
    const uu = u ? assetUrl(u) : "";
    bg.style.backgroundImage = uu ? `url("${uu}")` : 'none';
  }
  setBg();

  // Parallax 3d
  arena.addEventListener('mousemove', (e)=>{
    const r = arena.getBoundingClientRect();
    const x = (e.clientX - r.left)/r.width - 0.5;
    const y = (e.clientY - r.top)/r.height - 0.5;
    bg.style.transform = `scale(1.08) translate(${x*10}px, ${y*10}px)`;
  });
  arena.addEventListener('mouseleave', ()=> bg.style.transform = `scale(1.06)`);

  document.getElementById('gTitle').textContent = cfg.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";

  // state
  const teamCount = clamp(Number(cfg.teamsCount||2),1,3);
  const teamNames = Array.from({length: teamCount}, (_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
  const scores = Array.from({length: teamCount}, ()=>0);
  let currentTeam = 0;

  // targets = one per question
  const questions = Array.isArray(cfg.questions)? cfg.questions : [];
  const hit = new Set();
  let activeQIndex = null;
  let countdownId = null;
  let timeLeft = 0;

  const teamsEl = document.getElementById('teams');
  const targetsEl = document.getElementById('targets');
  const hudTargets = document.getElementById('hudTargets');
  const turnTeamEl = document.getElementById('turnTeam');

  function renderTeams(){
    teamsEl.style.gridTemplateColumns = `repeat(${teamCount}, minmax(0,1fr))`;
    teamsEl.innerHTML = '';
    for(let i=0;i<teamCount;i++){
      const card = document.createElement('div');
      card.className = 'teamCard';
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input class="teamNameInput" value="${teamNames[i]}" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ${i+1}"/>
          <div class="teamNow"><span class="dot ${i===currentTeam?'on':''}"></span> ${i===currentTeam?'–°–µ–π—á–∞—Å':'–ù–µ —Å–µ–π—á–∞—Å'}</div>
        </div>
        <div class="teamScore" id="score_${i}">${scores[i]}</div>
      `;
      const inp = card.querySelector('input');
      inp.addEventListener('input', ()=>{ teamNames[i] = inp.value || `–ö–æ–º–∞–Ω–¥–∞ ${i+1}`; renderTurn(); });
      teamsEl.appendChild(card);
    }
  }
  function renderTurn(){
    turnTeamEl.textContent = teamNames[currentTeam] || `–ö–æ–º–∞–Ω–¥–∞ ${currentTeam+1}`;
    $$('.teamCard', teamsEl).forEach((c,idx)=>{
      const d = c.querySelector('.dot');
      d.classList.toggle('on', idx===currentTeam);
      c.querySelector('.teamNow').lastChild.textContent = idx===currentTeam ? ' –°–µ–π—á–∞—Å' : ' –ù–µ —Å–µ–π—á–∞—Å';
    });
  }
  function renderScores(){
    for(let i=0;i<teamCount;i++){
      const s = document.getElementById(`score_${i}`);
      if(s) s.textContent = scores[i];
    }
  }

  function countDone(){ return hit.size; }

  function positionTargets(){
    const n = questions.length;
    const pts = [];
    for(let i=0;i<n;i++){
      const col = (i % 6);
      const row = Math.floor(i / 6);
      const x = 12 + col*(76/5);
      const y = 22 + row*10;
      pts.push({x, y});
    }
    const maxY = pts.reduce((m,p)=>Math.max(m,p.y), 0);
    const scaleY = maxY > 55 ? (55-22)/(maxY-22) : 1;

    // User controls
    const offsetNorm = Math.max(0, Math.min(1, Number(cfg?.targetLineOffset ?? 0))); // 0..1
    const jitterNorm  = Math.max(0, Math.min(1, Number(cfg?.targetLineJitter ?? 0))); // 0..1

    // Slider meaning:
    // - Height: 0 -> targets at the very bottom of the picture, 1 -> at the very top.
    // - Scatter: 0 -> almost on one line, 1 -> –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ö–∞–æ—Ç–∏—á–Ω–æ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑.
    const TOP_Y = 18;   // % from top (safe header)
    const BOT_Y = 72;   // % from top
    const lineY = BOT_Y - offsetNorm * (BOT_Y - TOP_Y); // 0 bottom -> 1 top

    const patternY = pts.map(p => p.y);
    const avgY = patternY.reduce((a,b)=>a+b,0) / Math.max(1, patternY.length);
    const jitterAmp = jitterNorm * 18; // percent points

    pts.forEach((p,i)=>{
      p.y = 22 + (p.y-22)*scaleY;

      // deterministic micro-variation (stable in preview)
      const wobX = Math.sin((i+1)*1.37) * 2.2;
      const wobY = Math.cos((i+1)*1.91) * 1.2;

      // stagger line (not perfectly straight)
      const stagger = Math.sin((i+1)*0.9) * lineJitter;

      p.x += wobX;
      p.y += wobY + lineOffset + stagger;
    });
    return pts;
  }

  function renderTargets(){
    targetsEl.innerHTML = '';
    const n = questions.length;
    const pts = positionTargets();
    const targetFile = assetUrl((cfg.targetFile || '13.png').trim());
    for(let i=0;i<n;i++){
      const q = questions[i];
      const el = document.createElement('div');
      el.className = 'target' + (hit.has(i)?' hit':'');
      el.style.left = (pts[i]?.x ?? 50) + '%';
      el.style.top  = (pts[i]?.y ?? 40) + '%';

      // Target image layer (can be swapped from the editor)
      el.style.setProperty('--target-img', `url("${targetFile}")`);

      // Slight float / breathing effect with per-target phase
      const phase = (Math.random()*1.8).toFixed(2);
      el.style.setProperty('--float-delay', phase + 's');

      el.innerHTML = `
        <div class="tImg" aria-hidden="true"></div>
        <div class="tNum">${i+1}</div>
        <div class="tPts">${Number(q.points||10)} –æ—á–∫.</div>
      `;
      el.addEventListener('click', async ()=>{
        if(hit.has(i)) return;
        try { AudioKit.unlock(); AudioKit.setVolume(cfg.shotVolume ?? 1); AudioKit.playVariant(cfg.shotSound ?? 'snip'); } catch(e) {}
        await openQuestion(i);
      });
      targetsEl.appendChild(el);
    }
  }

  // modal logic
  const modalBack = document.getElementById('modalBack');
  const qHeader = document.getElementById('qHeader');
  const qText = document.getElementById('qText');
  const qMedia = document.getElementById('qMedia');
  const answersWrap = document.getElementById('answersWrap');
  const btnClose = document.getElementById('btnClose');
  const timerBadge = document.getElementById('timerBadge');
  const timerText = document.getElementById('timerText');

  function closeModal(){
    modalBack.classList.remove('on');
    activeQIndex = null;
    stopTimer();
  }

  function stopTimer(){
    if(countdownId){ clearInterval(countdownId); countdownId = null; }
    timerBadge.classList.remove('on');
  }

  function startTimer(seconds){
    stopTimer();
    timeLeft = seconds;
    timerText.textContent = String(timeLeft);
    timerBadge.classList.add('on');
    countdownId = setInterval(()=>{
      timeLeft--;
      timerText.textContent = String(timeLeft);
      if(timeLeft <= 0){
        stopTimer();
        finalizeQuestion(false, true);
      }
    }, 1000);
  }

  function finalizeQuestion(isCorrect, timedOut=false){
    if(activeQIndex === null) return;
    const idx = activeQIndex;
    const q = questions[idx];
    if(!hit.has(idx)){
      hit.add(idx);
      if(isCorrect){
        scores[currentTeam] += Number(q.points||10);
        renderScores();
      }
      const t = targetsEl.children[idx];
      if(t) t.classList.add('hit');
      hudTargets.textContent = `${countDone()}/${questions.length}`;
    }

    if(cfg.autoNextTeam){
      currentTeam = (currentTeam + 1) % teamCount;
      renderTeams();
      renderTurn();
      renderScores();
    }
    closeModal();
  }

  function makeMediaTag(icon, label, url){
    const span = document.createElement('span');
    span.className = 'mediaTag';
    span.innerHTML = `<span aria-hidden="true">${icon}</span> <span>${label}</span>`;
    span.title = url;
    return span;
  }

  async function openQuestion(i){
    activeQIndex = i;
    const q = questions[i];

    qHeader.textContent = `–í–æ–ø—Ä–æ—Å #${i+1}`;
    qText.textContent = q.text || '';
    qMedia.innerHTML = '';
    answersWrap.innerHTML = '';

    if(cfg.latex){
      await ensureKatex();
      qText.innerHTML = q.text ? String(q.text) : '';
    }

    if(q.image){
      qMedia.appendChild(makeMediaTag('üñºÔ∏è', '–∫–∞—Ä—Ç–∏–Ω–∫–∞', q.image));
    }
    if(q.audio){
      qMedia.appendChild(makeMediaTag('üéµ', '–º—É–∑—ã–∫–∞', q.audio));
      try{
        const a = new Audio(q.audio);
        a.volume = 0.9;
        a.play().catch(()=>{});
      }catch(e){}
    }

    if(q.type === 'input'){
      const wrap = document.createElement('div');
      wrap.className = 'inputRow';
      wrap.innerHTML = `
        <input id="ansInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶" autocomplete="off"/>
        <button class="primary" id="btnSend">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        <button class="secondary" id="btnSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      `;
      answersWrap.appendChild(wrap);

      const correctList = String(q.correct||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

      const check = ()=>{
        const v = (document.getElementById('ansInput').value||'').trim().toLowerCase();
        const ok = correctList.length ? correctList.includes(v) : (v.length>0);
        finalizeQuestion(ok);
      };
      document.getElementById('btnSend').addEventListener('click', check);
      document.getElementById('ansInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
      document.getElementById('btnSkip').addEventListener('click', ()=>finalizeQuestion(false));
    } else {
      const opts = Array.isArray(q.options) ? q.options : [];
      const grid = document.createElement('div');
      grid.className = 'answers';
      answersWrap.appendChild(grid);

      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      opts.forEach((opt, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ansBtn';
        btn.innerHTML = `<div class="ansKey">${letters[idx] || (idx+1)}</div><div class="ansText">${opt?.text ?? ''}</div>`;
        btn.addEventListener('click', ()=>{
          const ok = !!opt?.correct;
          finalizeQuestion(ok);
        });
        grid.appendChild(btn);
      });

      const foot = document.createElement('div');
      foot.style.display = 'flex';
      foot.style.justifyContent = 'flex-end';
      foot.style.marginTop = '8px';
      foot.innerHTML = `<button class="secondary" id="btnSkip2">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>`;
      answersWrap.appendChild(foot);
      document.getElementById('btnSkip2').addEventListener('click', ()=>finalizeQuestion(false));
    }

    modalBack.classList.add('on');

    if(q.timerEnabled && Number(q.timerSeconds||0) > 0){
      startTimer(Number(q.timerSeconds));
    } else {
      stopTimer();
    }

    if(cfg.latex){
      setTimeout(()=>{ renderLatexIn(document.querySelector('.modal')); }, 0);
    }
  }

  document.getElementById('btnHelp').addEventListener('click', ()=>{
    toast("–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ. –û—á–∫–∏ –∏–¥—É—Ç —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥–µ.");
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    hit.clear();
    for(let i=0;i<scores.length;i++) scores[i]=0;
    currentTeam = 0;
    renderTargets();
    renderTeams();
    renderTurn();
    renderScores();
    closeModal();
    toast("–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω");
  });
  btnClose.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  renderTeams();
  renderTurn();
  renderScores();
  renderTargets();
}

/* ===========================
   EDITOR MODE
   =========================== */


// [Removed legacy mountEditor block to fix template parsing]

function defaultCfg(){
  return {
    version: 41,
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamsCount: 2,
    autoRotate: true,
    latex: false,
    bg: 2,          // 1..8
    target: 13,     // 10..14
    targetHeight: 50, // 0..100 (0=–Ω–∏–∑, 100=–≤–µ—Ä—Ö)
    targetSpread: 30, // 0..100
    shotSound: "pif", // pif|snap|boom
    volume: 1
  };
}

function el(tag, attrs={}, children=[]){
  const n=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") n.className=v;
    else if(k==="html") n.innerHTML=v;
    else if(k==="text") n.textContent=v;
    else if(k.startsWith("on") && typeof v==="function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  (children||[]).forEach(c=> n.appendChild(typeof c==="string"?document.createTextNode(c):c));
  return n;
}

function toast(msg, ms=1600){
  const t = document.getElementById("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>t.classList.remove("show"), ms);
}

function safeParseGameParam(){
  const p=new URLSearchParams(location.search);
  const raw=p.get("game");
  if(!raw) return null;
  try{
    const jsonStr = decodeURIComponent(escape(atob(raw)));
    return JSON.parse(jsonStr);
  }catch(e){
    console.warn("game param parse failed", e);
    return null;
  }
}
function encodeGameParam(payload){
  const jsonStr = JSON.stringify(payload);
  return btoa(unescape(encodeURIComponent(jsonStr)));
}

function getBaseUrl(){
  // —Å—Å—ã–ª–∫–∞ –Ω–∞ —ç—Ç–æ—Ç –∂–µ index.html –±–µ–∑ query/hash
  return location.origin + location.pathname.replace(/\/$/, "/");
}

function buildIframeCode(){
  const payload = {cfg, questions};
  const game = encodeGameParam(payload);
  const url = getBaseUrl() + "?game=" + game;
  return `<iframe src="${url}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
}

/* -------------------- SOUND -------------------- */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state==="suspended"){
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}
function playShotSound(kind, vol=1){
  const ctx = ensureAudio();
  const t0 = ctx.currentTime;
  const master = ctx.createGain();
  // –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ç–Ω–æ –≥—Ä–æ–º—á–µ + –∑–∞–ø–∞—Å (–æ–≥—Ä–∞–Ω–∏—á–∏–º –∫–ª–∏–ø–ø–∏–Ω–≥–æ–º)
  master.gain.setValueAtTime(Math.min(1.5, 0.35 + 0.9*vol), t0);
  master.connect(ctx.destination);

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const filter = ctx.createBiquadFilter();
  filter.type = "lowpass";

  osc.connect(filter);
  filter.connect(gain);
  gain.connect(master);

  if(kind==="boom"){
    osc.type="sine";
    osc.frequency.setValueAtTime(120, t0);
    osc.frequency.exponentialRampToValueAtTime(55, t0+0.12);
    filter.frequency.setValueAtTime(600, t0);
    filter.frequency.exponentialRampToValueAtTime(180, t0+0.14);
    gain.gain.setValueAtTime(0.001, t0);
    gain.gain.exponentialRampToValueAtTime(1.0, t0+0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, t0+0.18);
    osc.start(t0);
    osc.stop(t0+0.19);
    // –∫–æ—Ä–æ—Ç–∫–∏–π —à—É–º "—Ö–ª–æ–ø–æ–∫"
    const noiseBuf = ctx.createBuffer(1, ctx.sampleRate*0.08, ctx.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1) * (1 - i/data.length);
    const noise = ctx.createBufferSource(); noise.buffer=noiseBuf;
    const ng = ctx.createGain(); ng.gain.setValueAtTime(0.15, t0);
    noise.connect(ng); ng.connect(master);
    noise.start(t0); noise.stop(t0+0.08);
    return;
  }

  if(kind==="snap"){
    osc.type="square";
    osc.frequency.setValueAtTime(420, t0);
    osc.frequency.exponentialRampToValueAtTime(220, t0+0.05);
    filter.frequency.setValueAtTime(1200, t0);
    filter.frequency.exponentialRampToValueAtTime(450, t0+0.06);
    gain.gain.setValueAtTime(0.001, t0);
    gain.gain.exponentialRampToValueAtTime(1.0, t0+0.003);
    gain.gain.exponentialRampToValueAtTime(0.001, t0+0.08);
    osc.start(t0);
    osc.stop(t0+0.085);
    return;
  }

  // pif (default)
  osc.type="triangle";
  osc.frequency.setValueAtTime(620, t0);
  osc.frequency.exponentialRampToValueAtTime(260, t0+0.045);
  filter.frequency.setValueAtTime(1600, t0);
  filter.frequency.exponentialRampToValueAtTime(600, t0+0.06);
  gain.gain.setValueAtTime(0.001, t0);
  gain.gain.exponentialRampToValueAtTime(1.0, t0+0.004);
  gain.gain.exponentialRampToValueAtTime(0.001, t0+0.09);
  osc.start(t0);
  osc.stop(t0+0.095);
}

/* -------------------- GAME RENDER -------------------- */
function bgUrl(n){ return `${n}.png`; }
function targetUrl(n){ return `${n}.png`; }

function computeTargetLineY(){
  // 0=–Ω–∏–∑, 100=–≤–µ—Ä—Ö
  const v = Math.max(0, Math.min(100, Number(cfg.targetHeight)||0));
  // y in 0..1 (0=top)
  const yBottom = 0.86;
  const yTop = 0.22;
  return yBottom - (yBottom - yTop) * (v/100);
}
function computeSpreadAmp(){
  const v = Math.max(0, Math.min(100, Number(cfg.targetSpread)||0));
  return 0.02 + 0.18*(v/100); // 0.02..0.20
}

function renderGame(container, opts={preview:false}){
  container.innerHTML="";
  const state = {
    teamNames: Array.from({length: cfg.teamsCount}, (_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`),
    scores: Array.from({length: cfg.teamsCount}, ()=>0),
    turn: 0,
    qIndex: 0,
    floatingT: 0,
    raf: null
  };

  const wrap = el("div",{class:"gameWrap"});
  const stage = el("div",{class:"gameStage"});
  stage.style.backgroundImage = `url('${bgUrl(cfg.bg)}')`;

  const hud = el("div",{class:"gameHud"});
  const title = el("div",{class:"gameTitle"});
  title.innerHTML = `<div class="gt1">${cfg.title||"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä"}</div><div class="gt2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>`;
  hud.appendChild(title);

  const right = el("div",{class:"hudRight"});
  const turnPill = el("div",{class:"pill", html:`–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b>${state.teamNames[state.turn]}</b>`});
  const goalsPill = el("div",{class:"pill", html:`–¶–µ–ª–∏: <b>0/${Math.max(questions.length,1)}</b>`});
  const btnInstr = el("button",{class:"pillBtn", text:"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", onclick:()=>openInfo()});
  const btnReset = el("button",{class:"pillBtn", text:"–°–±—Ä–æ—Å", onclick:()=>resetGame()});
  right.append(turnPill, goalsPill, btnInstr, btnReset);
  hud.appendChild(right);

  const teamsRow = el("div",{class:"teamsRow"});
  function renderTeams(){
    teamsRow.innerHTML="";
    for(let i=0;i<cfg.teamsCount;i++){
      const card = el("div",{class:"teamCard"+(i===state.turn?" active":"")});
      const nameInp = el("input",{class:"teamNameInp", value: state.teamNames[i]});
      nameInp.addEventListener("input", ()=>{
        state.teamNames[i]=nameInp.value||`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`;
        turnPill.innerHTML = `–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b>${state.teamNames[state.turn]}</b>`;
      });
      const score = el("div",{class:"teamScore", text:String(state.scores[i])});
      card.append(
        el("div",{class:"teamTop"},[
          el("div",{class:"teamLabel", text:`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`}),
          el("div",{class:"teamNow"},[
            el("span",{class:"dot"+(i===state.turn?" on":"")}),
            el("span",{text: i===state.turn?"–°–µ–π—á–∞—Å":"–ù–µ —Å–µ–π—á–∞—Å"})
          ])
        ]),
        el("div",{class:"teamMid"},[
          nameInp,
          el("div",{class:"scoreWrap"},[
            el("div",{class:"scoreLabel", text:"–û—á–∫–∏"}),
            score
          ])
        ])
      );
      card._scoreEl = score;
      teamsRow.appendChild(card);
    }
  }
  renderTeams();

  const targetsLayer = el("div",{class:"targetsLayer"});
  stage.append(hud, teamsRow, targetsLayer);

  const cross = el("div",{class:"crosshair"});
  stage.appendChild(cross);

  wrap.appendChild(stage);
  container.appendChild(wrap);

  // modal for question
  const modal = el("div",{class:"qModal hidden"});
  modal.innerHTML = `
    <div class="qModalInner">
      <div class="qModalHead">
        <div class="qModalTitle"></div>
        <div class="qModalTimer"></div>
        <button class="qModalClose">Esc</button>
      </div>
      <div class="qModalBody"></div>
      <div class="qModalFoot">
        <button class="qModalSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  `;
  stage.appendChild(modal);
  $(".qModalClose", modal).addEventListener("click", ()=>closeQuestion());
  $(".qModalSkip", modal).addEventListener("click", ()=>closeQuestion());

  let timerInt=null;
  function closeQuestion(){
    modal.classList.add("hidden");
    $(".qModalBody", modal).innerHTML="";
    $(".qModalTimer", modal).textContent="";
    if(timerInt){ clearInterval(timerInt); timerInt=null; }
  }
  function openQuestion(q, idx){
    if(!q){ toast("–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ"); return; }
    modal.classList.remove("hidden");
    $(".qModalTitle", modal).textContent = `–í–æ–ø—Ä–æ—Å #${idx+1}`;
    const body = $(".qModalBody", modal);
    body.innerHTML="";
    body.appendChild(el("div",{class:"qText", text:q.text||""}));

    if(q.imageUrl){
      const img = el("img",{class:"qImg", src:q.imageUrl});
      img.addEventListener("error", ()=>{ img.style.display="none"; toast("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É)"); });
      body.appendChild(img);
    }

    if(q.type==="input"){
      const inp = el("input",{class:"qAnswerInp", placeholder:"–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."});
      const btn = el("button",{class:"qBtn", text:"–û—Ç–≤–µ—Ç–∏—Ç—å"});
      btn.addEventListener("click", ()=>{
        // –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏: –Ω–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –∑–∞ —Ñ–∞–∫—Ç –æ—Ç–≤–µ—Ç–∞
        addScore(q.points||0);
        closeQuestion();
      });
      body.append(inp, btn);
    }else{
      const list = el("div",{class:"qOptions"});
      const opts = (q.options||[]).filter(o=>String(o.text||"").trim().length>0);
      const letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      opts.forEach((o,i)=>{
        const btn = el("button",{class:"qOpt"},[
          el("span",{class:"qOptL", text:letters[i]||String(i+1)}),
          el("span",{class:"qOptT", text:o.text})
        ]);
        btn.addEventListener("click", ()=>{
          if(o.correct){
            addScore(q.points||0);
            toast("–í–µ—Ä–Ω–æ!");
          }else{
            toast("–ù–µ–≤–µ—Ä–Ω–æ");
          }
          closeQuestion();
        });
        list.appendChild(btn);
      });
      body.appendChild(list);
    }

    // timer
    if(q.timerEnabled && Number(q.timerSec)>0){
      let left = Number(q.timerSec);
      const lab = $(".qModalTimer", modal);
      lab.textContent = `‚è± ${left}`;
      timerInt = setInterval(()=>{
        left -= 1;
        lab.textContent = `‚è± ${left}`;
        if(left<=0){
          clearInterval(timerInt); timerInt=null;
          toast("–í—Ä–µ–º—è –≤—ã—à–ª–æ");
          closeQuestion();
        }
      }, 1000);
    }
  }

  function addScore(pts){
    const t = state.turn;
    state.scores[t] = (state.scores[t]||0) + (Number(pts)||0);
    // update UI
    const card = teamsRow.children[t];
    const scoreEl = card && card.querySelector(".teamScore");
    if(scoreEl) scoreEl.textContent = String(state.scores[t]);
  }

  function resetGame(){
    state.scores = Array.from({length: cfg.teamsCount}, ()=>0);
    state.turn = 0;
    state.qIndex = 0;
    renderTeams();
    updatePills();
    rebuildTargets();
    closeQuestion();
  }

  function updatePills(){
    turnPill.innerHTML = `–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b>${state.teamNames[state.turn]}</b>`;
    goalsPill.innerHTML = `–¶–µ–ª–∏: <b>${Math.min(state.qIndex, Math.max(questions.length,1))}/${Math.max(questions.length,1)}</b>`;
  }

  function openInfo(){
    toast("–°—Ç—Ä–µ–ª—è–π—Ç–µ –ø–æ –º–∏—à–µ–Ω—è–º. –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Ö–æ–¥ (–ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ) –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥–µ.");
  }

  function nextTurn(){
    state.turn = (state.turn + 1) % cfg.teamsCount;
    renderTeams();
    updatePills();
  }

  function getQuestionForShot(){
    if(questions.length===0) return null;
    const q = questions[state.qIndex % questions.length];
    const idx = state.qIndex % questions.length;
    state.qIndex += 1;
    updatePills();
    if(cfg.autoRotate) nextTurn();
    return {q, idx};
  }

  function rebuildTargets(){
    targetsLayer.innerHTML="";
    const count = questions.length>0 ? Math.min(questions.length, 10) : 8; // –¥–∞–∂–µ –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å
    const y0 = computeTargetLineY();
    const amp = computeSpreadAmp();
    const stableRand01 = (k)=>{
      const seed = (cfg.bg||0)*17 + (cfg.target||0)*31 + (cfg.targetHeight||0)*0.23 + (cfg.targetSpread||0)*0.41;
      const v = Math.sin((k+1)*999.123 + seed) * 43758.5453123;
      return v - Math.floor(v);
    };

    for(let i=0;i<count;i++){
      const x = 0.12 + (i/(count-1||1))*0.76;
      const dy = (stableRand01(i)*2-1) * amp;
      const t = el("div",{class:"target"});
      t.style.backgroundImage = `url('${targetUrl(cfg.target)}')`;
      t.dataset.baseX = String(x);
      t.dataset.baseY = String(y0 + dy);
      t.dataset.floatPhase = String(Math.random()*Math.PI*2);
      t.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        // –∑–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É)
        playShotSound(cfg.shotSound, cfg.volume);
        const pack = getQuestionForShot();
        if(!pack){ toast("–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å"); return; }
        openQuestion(pack.q, pack.idx);
      });
      targetsLayer.appendChild(t);
    }
  }

  function tick(){
    state.floatingT += 0.016;
    const w = stage.clientWidth || 1000;
    const h = stage.clientHeight || 600;
    const targets = targetsLayer.querySelectorAll(".target");
    targets.forEach((t)=>{
      const bx = parseFloat(t.dataset.baseX||"0.5");
      const by = parseFloat(t.dataset.baseY||"0.6");
      const ph = parseFloat(t.dataset.floatPhase||"0");
      const floatY = Math.sin(state.floatingT*1.1 + ph) * 0.012; // –ª–µ–≥–∫–æ–µ –ø–ª–∞–≤–∞–Ω–∏–µ
      const floatX = Math.cos(state.floatingT*0.9 + ph) * 0.006;
      const px = bx + floatX;
      const py = by + floatY;
      t.style.left = (px*100) + "%";
      t.style.top = (py*100) + "%";
    });
    state.raf = requestAnimationFrame(tick);
  }

  // click stage to move crosshair
  stage.addEventListener("mousemove",(e)=>{
    const rect = stage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    cross.style.left = x+"px";
    cross.style.top = y+"px";
  });

  rebuildTargets();
  updatePills();
  state.raf = requestAnimationFrame(tick);

  // expose for editor live update
  return {
    updateFromNewCfg(newCfg, newQuestions){
      cfg = newCfg;
      questions = newQuestions;
      stage.style.backgroundImage = `url('${bgUrl(cfg.bg)}')`;
      title.querySelector(".gt1").textContent = cfg.title||"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
      // –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
      state.teamNames = Array.from({length: cfg.teamsCount}, (_,i)=>state.teamNames[i]||`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
      state.scores = Array.from({length: cfg.teamsCount}, (_,i)=>state.scores[i]||0);
      renderTeams();
      rebuildTargets();
      updatePills();
      closeQuestion();
    },
    destroy(){
      if(state.raf) cancelAnimationFrame(state.raf);
      closeQuestion();
    }
  };
}

/* -------------------- EDITOR -------------------- */
function renderEditor(container){
  container.innerHTML="";
  const shell = el("div",{class:"shell"});
  const left = el("div",{class:"panel left"});
  const right = el("div",{class:"panel right"});
  shell.append(left, right);
  container.appendChild(shell);

  // header
  const brand = el("div",{class:"editorBrand"},[
    el("div",{class:"brandRow"},[
      el("img",{class:"brandLogo", src:"63.png", alt:"logo", onerror:()=>{}}),
      el("div",{class:"brandName", text:"–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞"})
    ]),
    el("div",{class:"editorTitle", text:"–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª"})
  ]);
  const copyBtn = el("button",{class:"copyBtn", text:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"});
  copyBtn.addEventListener("click", async ()=>{
    const code = buildIframeCode();
    try{
      await navigator.clipboard.writeText(code);
      toast("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }catch(e){
      // fallback
      const ta = el("textarea",{class:"hiddenTa"});
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }
  });
  left.append(brand, copyBtn);

  // form
  const form = el("div",{class:"form"});
  left.appendChild(form);

  const titleInp = el("input",{class:"inp", value: cfg.title});
  titleInp.addEventListener("input", ()=>{ cfg.title = titleInp.value; sync(); });
  form.append(
    el("div",{class:"field"},[
      el("div",{class:"label", text:"–ù–∞–∑–≤–∞–Ω–∏–µ"}),
      el("div",{class:"hint", text:"–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ"}),
      titleInp
    ])
  );

  const teamsSel = el("select",{class:"inp"});
  [1,2,3].forEach(n=>teamsSel.appendChild(el("option",{value:String(n), text:String(n)})));
  teamsSel.value = String(cfg.teamsCount);
  teamsSel.addEventListener("change", ()=>{ cfg.teamsCount = Number(teamsSel.value); sync(); });
  const autoSel = el("select",{class:"inp"});
  [["–í–∫–ª—é—á—ë–Ω",true],["–í—ã–∫–ª—é—á–µ–Ω",false]].forEach(([t,v])=>autoSel.appendChild(el("option",{value:String(v), text:t})));
  autoSel.value = String(cfg.autoRotate);
  autoSel.addEventListener("change", ()=>{ cfg.autoRotate = (autoSel.value==="true"); sync(); });

  const latexSel = el("select",{class:"inp"});
  [["–í–∫–ª—é—á—ë–Ω",true],["–í—ã–∫–ª—é—á–µ–Ω",false]].forEach(([t,v])=>latexSel.appendChild(el("option",{value:String(v), text:t})));
  latexSel.value = String(cfg.latex);
  latexSel.addEventListener("change", ()=>{ cfg.latex = (latexSel.value==="true"); sync(); });

  const bgSel = el("select",{class:"inp"});
  for(let i=1;i<=8;i++) bgSel.appendChild(el("option",{value:String(i), text:String(i)}));
  bgSel.value = String(cfg.bg||2);
  bgSel.addEventListener("change", ()=>{ cfg.bg = Number(bgSel.value); sync(); });

  const targetSel = el("select",{class:"inp"});
  for(let i=10;i<=14;i++) targetSel.appendChild(el("option",{value:String(i), text:String(i)}));
  targetSel.value = String(cfg.target||13);
  targetSel.addEventListener("change", ()=>{ cfg.target = Number(targetSel.value); sync(); });

  const heightRange = el("input",{type:"range", min:"0", max:"100", value:String(cfg.targetHeight), class:"range"});
  heightRange.addEventListener("input", ()=>{ cfg.targetHeight = Number(heightRange.value); sync(); });

  const spreadRange = el("input",{type:"range", min:"0", max:"100", value:String(cfg.targetSpread), class:"range"});
  spreadRange.addEventListener("input", ()=>{ cfg.targetSpread = Number(spreadRange.value); sync(); });

  const soundSel = el("select",{class:"inp"});
  [["–ö–æ—Ä–æ—Ç–∫–∏–π ¬´–ø–∏—Ñ¬ª","pif"],["–©–µ–ª—á–æ–∫ ¬´—Å–Ω–∞–ø¬ª","snap"],["–ì–ª—É—Ö–æ–π ¬´–±—É–º¬ª","boom"]].forEach(([t,v])=>{
    soundSel.appendChild(el("option",{value:v, text:t}));
  });
  soundSel.value = cfg.shotSound;
  soundSel.addEventListener("change", ()=>{
    cfg.shotSound = soundSel.value;
    playShotSound(cfg.shotSound, cfg.volume);
    sync();
  });

  const volRange = el("input",{type:"range", min:"0", max:"1", step:"0.01", value:String(cfg.volume), class:"range"});
  volRange.addEventListener("input", ()=>{ cfg.volume = Number(volRange.value); sync(); });

  form.append(
    el("div",{class:"sectionTitle", text:"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã"}),
    el("div",{class:"grid2"},[
      el("div",{class:"field"},[el("div",{class:"label", text:"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)"}), teamsSel]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞"}), autoSel]),
      el("div",{class:"field"},[el("div",{class:"label", text:"LaTeX (–≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã)"}), latexSel]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–í—ã–±–µ—Ä–∏ —Ñ–æ–Ω"}), bgSel]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–í—ã–±–µ—Ä–∏ –º–∏—à–µ–Ω—å"}), targetSel]),
      el("div",{class:"field"},[
        el("div",{class:"label", text:"–í—ã—Å–æ—Ç–∞ –º–∏—à–µ–Ω–µ–π"}),
        heightRange
      ]),
      el("div",{class:"field"},[
        el("div",{class:"label", text:"–†–∞–∑–±—Ä–æ—Å –º–∏—à–µ–Ω–µ–π"}),
        spreadRange
      ])
    ]),
    el("div",{class:"sectionTitle", text:"–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞"}),
    el("div",{class:"grid2"},[
      el("div",{class:"field"},[el("div",{class:"label", text:"–í–∞—Ä–∏–∞–Ω—Ç"}), soundSel]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–ì—Ä–æ–º–∫–æ—Å—Ç—å"}), volRange])
    ])
  );

  // Questions list + controls
  const qWrap = el("div",{class:"qWrap"});
  const qHead = el("div",{class:"qHead"},[
    el("div",{class:"sectionTitle", text:"–í–æ–ø—Ä–æ—Å—ã"}),
    el("div",{class:"qCount", text:`–í—Å–µ–≥–æ: ${questions.length}`})
  ]);
  const qBtns = el("div",{class:"qBtns"},[
    el("button",{class:"btn add", text:"+ –î–æ–±–∞–≤–∏—Ç—å", onclick:()=>openQModal(null)}),
    el("button",{class:"btn clear", text:"‚úè –û—á–∏—Å—Ç–∏—Ç—å", onclick:()=>{questions=[]; renderQList(); sync();}})
  ]);
  const qList = el("div",{class:"qList"});
  qWrap.append(qHead, qBtns, qList);
  left.appendChild(qWrap);

  function renderQList(){
    qHead.querySelector(".qCount").textContent = `–í—Å–µ–≥–æ: ${questions.length}`;
    qList.innerHTML="";
    questions.forEach((q, i)=>{
      const card = el("div",{class:"qCard"});
      card.append(
        el("div",{class:"qCardTop"},[
          el("div",{class:"qNum", text:`${i+1}. ${q.text||"(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)"}`}),
          el("div",{class:"qCardBtns"},[
            el("button",{class:"iconBtn", text:"‚úé", onclick:()=>openQModal(i)}),
            el("button",{class:"iconBtn danger", text:"üóë", onclick:()=>{questions.splice(i,1); renderQList(); sync();}})
          ])
        ]),
        el("div",{class:"qMeta", text:`${q.type==="input"?"–í–≤–æ–¥":"–í—ã–±–æ—Ä"} ‚Ä¢ ${q.points||0} –æ—á. ‚Ä¢ ${q.timerEnabled? (q.timerSec||0)+" —Å–µ–∫":"–±–µ–∑ —Ç–∞–π–º–µ—Ä–∞"}`})
      );
      qList.appendChild(card);
    });
  }

  // Question modal editor
  const qModal = el("div",{class:"editorModal hidden"});
  qModal.innerHTML = `
    <div class="editorModalInner">
      <div class="emHead">
        <div class="emTitle">–í–æ–ø—Ä–æ—Å</div>
        <button class="emClose">√ó</button>
      </div>
      <div class="emBody"></div>
      <div class="emFoot">
        <button class="btn save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `;
  document.body.appendChild(qModal);
  $(".emClose", qModal).addEventListener("click", ()=>closeQModal());
  qModal.addEventListener("click",(e)=>{ if(e.target===qModal) closeQModal(); });

  let editingIndex = null;

  function openQModal(index){
    editingIndex = (index===null || index===undefined) ? null : index;
    const q = editingIndex===null ? {
      type:"mc",
      text:"",
      points:10,
      timerEnabled:false,
      timerSec:30,
      imageUrl:"",
      options:[
        {text:"", correct:true},
        {text:"", correct:false}
      ]
    } : JSON.parse(JSON.stringify(questions[editingIndex]));
    const body = $(".emBody", qModal);
    body.innerHTML="";

    const typeSel = el("select",{class:"inp"});
    [["–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞","mc"],["–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞","input"]].forEach(([t,v])=>typeSel.appendChild(el("option",{value:v,text:t})));
    typeSel.value = q.type;

    const pointsInp = el("input",{class:"inp", type:"number", min:"0", value:String(q.points||0)});
    const timerSel = el("select",{class:"inp"});
    [["–í—ã–∫–ª—é—á–µ–Ω", "0"],["–í–∫–ª—é—á—ë–Ω","1"]].forEach(([t,v])=>timerSel.appendChild(el("option",{value:v,text:t})));
    timerSel.value = q.timerEnabled ? "1":"0";
    const timerInp = el("input",{class:"inp", type:"number", min:"1", value:String(q.timerSec||30)});
    const textInp = el("textarea",{class:"ta", placeholder:"–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...", text:q.text||""});
    const imgInp = el("input",{class:"inp", placeholder:"–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", value:q.imageUrl||""});

    const optsWrap = el("div",{class:"optsWrap"});
    function renderOpts(){
      optsWrap.innerHTML="";
      if(typeSel.value!=="mc") return;
      (q.options||[]).forEach((o, i)=>{
        const row = el("div",{class:"optRow"});
        const radio = el("input",{type:"radio", name:"correctOpt"});
        radio.checked = !!o.correct;
        radio.addEventListener("change", ()=>{
          q.options.forEach(x=>x.correct=false);
          o.correct=true;
        });
        const inp = el("input",{class:"inp", placeholder:`–í–∞—Ä–∏–∞–Ω—Ç ${i+1}`, value:o.text||""});
        inp.addEventListener("input", ()=>{ o.text = inp.value; });
        const del = el("button",{class:"iconBtn danger", text:"√ó", onclick:()=>{ q.options.splice(i,1); if(!q.options.some(x=>x.correct)&&q.options[0]) q.options[0].correct=true; renderOpts(); }});
        row.append(radio, inp, del);
        optsWrap.appendChild(row);
      });
      const addBtn = el("button",{class:"btn addSmall", text:"+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç"});
      addBtn.addEventListener("click", ()=>{
        q.options.push({text:"", correct: q.options.length===0});
        renderOpts();
      });
      optsWrap.appendChild(addBtn);
    }
    renderOpts();
    typeSel.addEventListener("change", renderOpts);

    body.append(
      el("div",{class:"grid2"},[
        el("div",{class:"field"},[el("div",{class:"label", text:"–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞"}), typeSel]),
        el("div",{class:"field"},[el("div",{class:"label", text:"–û—á–∫–∏"}), pointsInp]),
        el("div",{class:"field"},[el("div",{class:"label", text:"–¢–∞–π–º–µ—Ä"}), timerSel]),
        el("div",{class:"field"},[el("div",{class:"label", text:"–°–µ–∫—É–Ω–¥—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)"}), timerInp])
      ]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞"}), textInp]),
      el("div",{class:"field"},[imgInp]),
      el("div",{class:"field"},[el("div",{class:"label", text:"–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞"}), optsWrap])
    );

    $(".btn.save", qModal).onclick = ()=>{
      q.type = typeSel.value;
      q.points = Number(pointsInp.value)||0;
      q.timerEnabled = (timerSel.value==="1");
      q.timerSec = Number(timerInp.value)||30;
      q.text = textInp.value||"";
      q.imageUrl = imgInp.value||"";
      if(q.type==="mc"){
        q.options = (q.options||[]).map(o=>({text:o.text||"", correct:!!o.correct}));
        if(!q.options.some(o=>o.correct) && q.options[0]) q.options[0].correct=true;
      }else{
        q.options = [];
      }

      if(editingIndex===null){
        questions.push(q);
      }else{
        questions[editingIndex]=q;
      }
      closeQModal();
      renderQList();
      sync();
      toast("–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    };

    qModal.classList.remove("hidden");
    // scroll safety
    qModal.querySelector(".editorModalInner").scrollTop = 0;
  }

  function closeQModal(){
    qModal.classList.add("hidden");
    $(".emBody", qModal).innerHTML="";
    editingIndex=null;
  }

  // right preview
  right.appendChild(el("div",{class:"previewHead", html:`<div class="ph1">–ü—Ä–æ—Å–º–æ—Ç—Ä</div><div class="ph2">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>`}));
  const previewBox = el("div",{class:"previewBox"});
  right.appendChild(previewBox);
  const gameApi = renderGame(previewBox, {preview:true});

  function sync(){
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã –∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏
    if(!cfg.bg) cfg.bg = 2;
    if(!cfg.target) cfg.target = 13;
    gameApi.updateFromNewCfg(cfg, questions);
  }

  renderQList();
  sync();
}

/* -------------------- BOOT -------------------- */
(function boot(){
  const root = document.getElementById("root");
  const payload = safeParseGameParam();
  if(payload && payload.cfg){
    cfg = Object.assign(defaultCfg(), payload.cfg||{});
    questions = Array.isArray(payload.questions)? payload.questions : [];
    // –≤ –∏–≥—Ä–µ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–µ–Ω–¥
    document.body.classList.add("modeGame");
    renderGame(root, {preview:false});
  }else{
    document.body.classList.add("modeEditor");
    // –¥–µ—Ñ–æ–ª—Ç—ã –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
    cfg.bg = 2;
    cfg.target = 13;
    renderEditor(root);
  }
})();

  } catch (err) {
    showFatal(err);
  }
})();</script>
</body>
</html>
