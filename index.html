<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Математический тир — editor+game</title>
  <script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=vAQSnmqvoU-az3uCUc5dGt1sVy4idcF5Sf6b_2pIWTrOZFbOdb1x03qCvkjdGE6-GYqCoRxkzSIsximsveC936ky_P3oUGlC2LwIrmK7cmRUXRTf7xBUziu9rTbRBYuMeF2_YEihzxw7WFYYru6tuC-o9RMU_cPFszq9NJj1_otMYtU4jBkwtWN2Pm4Sf9mZOK3ytdkHMLVHGgBMqFbw8ohY8mifQ0t6jf-ylsXj7kse4fsJFTEzPbhXczYZTgq6sQLte1SXq9HZ_bmHy4OJxg" charset="UTF-8"></script><style>
    :root{
      --bg0:#0b0f14;
      --card:rgba(20,28,38,.72);
      --card2:rgba(15,22,30,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.70);
      --gold: #caa24d;
      --gold2:#f1d089;
      --neon:#ff8a2a;
      --neon2:#ffb24d;
      --neonSoft: rgba(255,138,42,.18);
      --neonLine: rgba(255,138,42,.38);
      --danger:#ff5b6b;
      --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55);
      --r:18px;
      --qFont:'Roboto';
      --aFont:'Roboto';
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%),
                  radial-gradient(900px 520px at 70% 18%, rgba(255,190,90,.08), transparent 60%),
                  linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Layout (editor) ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 480px 1fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100%;}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--neonLine);
      border-radius: 22px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.20), 0 0 26px var(--neonSoft);
      overflow:hidden;
      position:relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0; /* важно для скролла внутри flex */
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 100% 0%, rgba(255,215,120,.07), transparent 65%),
                  repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 2px, transparent 2px 12px);
      opacity:.35;
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:1}

    .panel:hover{
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.32), 0 0 34px rgba(255,138,42,.20);
    }
    .section:hover{
      border-color: rgba(255,138,42,.42);
      box-shadow: 0 0 0 1px rgba(255,138,42,.18), 0 0 26px rgba(255,138,42,.14);
    }
    

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:800;
      font-size:22px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .btn{
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.13);
      background: rgba(25,35,46,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(30,43,58,.68); border-color: rgba(255,255,255,.18)}
    .btn:active{ transform: translateY(1px) }
    .btnGold{
      background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13));
      border-color: rgba(202,162,77,.45);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,91,107,.24), rgba(255,91,107,.12));
      border-color: rgba(255,91,107,.38);
    }

    .scroll{
      flex: 1;
      min-height: 0;
      overflow:auto;
      padding: 14px 18px 18px 18px;
    }
    .section{
      background: rgba(10,14,20,.22);
      border: 1px solid rgba(255,138,42,.28);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 18px rgba(255,138,42,.10);

    }
    .section h3{
      margin:0 0 10px 0;
      font-size:14px;
      color: rgba(255,255,255,.92);
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      outline:none;
      background: rgba(10,14,18,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{min-height: 84px; resize: vertical;}
    /* ====== Beautify form layout ====== */
    .section .row, .section .row1{ margin-top: 10px; }
    .section .row > div,
    .section .row1 > div{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,0));
      border:1px solid rgba(255,138,42,.22);
      border-radius: 16px;
      padding: 12px 12px 10px 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 0 14px rgba(255,138,42,.08);
      min-width: 0;
    }
    .section .row > div:hover,
    .section .row1 > div:hover{
      border-color: rgba(255,138,42,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 0 18px rgba(255,138,42,.12);
    }

    /* === СТИЛИ ДЛЯ КРАСИВЫХ БЕГУНКОВ (Радиус и Скорость) === */
    .field-card {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(255, 138, 42, 0.15) !important;
      border-radius: 16px !important;
      padding: 16px !important;
      margin-bottom: 12px !important;
    }
    .field-card label {
      display: block;
      font-weight: 800;
      font-size: 14px !important;
      color: #fff !important;
      margin-bottom: 12px !important;
      letter-spacing: 0.3px;
    }
    .field-card .hint {
      font-size: 12px;
      color: rgba(232, 238, 247, 0.55);
      margin-top: 10px;
      line-height: 1.4;
    }
    input[type="range"].range {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"].range::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, #ff8a2a var(--percent, 0%), rgba(255,255,255,0.1) var(--percent, 0%));
      border-radius: 3px;
    }
    input[type="range"].range::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: #ff8a2a;
      margin-top: -6px;
      box-shadow: 0 0 15px rgba(255, 138, 42, 0.8), 0 0 5px rgba(255, 255, 255, 0.5);
      border: 2px solid rgba(255,255,255,0.2);
      transition: transform 0.1s ease;
    }
    input[type="range"].range:active::-webkit-slider-thumb {
      transform: scale(1.2);
    }
    /* === КОНЕЦ СТИЛЕЙ БЕГУНКОВ === */

    .section label{ margin-bottom: 7px; font-size: 12.5px; letter-spacing: .15px; }
    input[type="text"], input[type="number"], select, textarea{
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{
      border-color: rgba(255,138,42,.55);
      box-shadow: 0 0 0 3px rgba(255,138,42,.16);
      background: rgba(10,14,18,.68);
    }
    select{
      appearance:none;
      padding-right: 38px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(232,238,247,.75) 50%),
        linear-gradient(135deg, rgba(232,238,247,.75) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 55%,
        calc(100% - 12px) 55%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    .help{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.35);
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .qItem{
      border-color: rgba(255,138,42,.18);
    }
    .qItem:hover{
      border-color: rgba(255,138,42,.36);
      box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 16px rgba(255,138,42,.10);
    }

    input[type="number"]{appearance:textfield}
    .help{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,238,247,.62);
      line-height:1.25;
    }
    .split{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }
    .qList{display:flex; flex-direction:column; gap:10px;}
    .qItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.48);
      align-items:center;
    }
    .qTitle{
      font-weight:700;
      font-size:13px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }
    .qMeta{
      font-size:12px;
      color: rgba(232,238,247,.62);
    }
    .iconBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(25,35,46,.45);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ background: rgba(25,35,46,.65) }
    .iconBtn.danger{ border-color: rgba(255,91,107,.45); background: rgba(255,91,107,.12)}
    .iconBtn.danger:hover{ background: rgba(255,91,107,.18)}
    .soundRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }

    /* ====== Preview ====== */
    .previewWrap{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .previewHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .previewHeader .title2{
      font-weight:800;
      font-size:18px;
    }
    .previewHeader .muted{
      font-size:12px; color:var(--muted);
    }
    .previewFrame{
      flex:1;
      min-height: 420px;
      border:0;
      width:100%;
      background: transparent;
    }

    /* ====== Version badge ====== */
    .versionBadge{
      display:none !important;
      position:fixed;
      right:14px; bottom:14px;
      z-index:50;
      font-size:12px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      pointer-events:none;
    }

    /* ====== GAME MODE ====== */
    .gameRoot{
      position:fixed;
      inset:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#000;
    }
    .arena{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      margin: 16px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background: #0b0f14;
    }

    /* Background image (non-transparent) */
    .arenaBg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      transform: scale(1.06);
      filter: saturate(1.05) contrast(1.03) brightness(1.02);
    }
    .arenaBg::after{
      /* cinematic + depth */
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,230,160,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 25%, rgba(100,180,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .arenaBg3d{
      /* subtle parallax */
      will-change: transform;
      transition: transform .08s linear;
    }

    .hud{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudLeft{
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      min-width: 260px;
      max-width: 460px;
    }
    .gameTitle{
      font-weight:900;
      font-size:22px;
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .gameHint{
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .hudRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pillBtn{
      pointer-events:auto;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-weight:650;
      font-size:13px;
      cursor:pointer;
    }
    .pillBtn:hover{ background: rgba(0,0,0,.40) }
    .hudStat{
      pointer-events:none;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      font-weight:650;
      font-size:13px;
    }

    /* Team bars */
    .teams{
      position:absolute;
      top:78px; left:14px; right:14px;
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      pointer-events:none;
    }
    .teamCard{
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      padding:10px 10px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
    }
    .teamNameInput{
      pointer-events:auto;
      width: 100%;
      max-width: 220px;
      font-weight:800;
      font-size:14px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      outline:none;
    }
    .teamNameInput:focus{ border-color: rgba(202,162,77,.50); box-shadow: 0 0 0 3px rgba(202,162,77,.12); }
    .teamScore{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.95);
      min-width: 40px;
      text-align:right;
    }
    .teamNow{
      display:flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.78);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.24);
      border: 1px solid rgba(255,255,255,.25);
    }
    .dot.on{ background: rgba(202,162,77,.95); border-color: rgba(202,162,77,.95); box-shadow: 0 0 0 4px rgba(202,162,77,.16); }

    /* Targets */
    .targets{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .target{
      position:absolute;
      width: 92px;
      height: 92px;
      border-radius: 999px;
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px));
      /* fallback if image missing */
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(240,200,120,.18), transparent 65%),
        rgba(0,0,0,.20);
      box-shadow:
        0 12px 30px rgba(0,0,0,.50),
        0 0 0 2px rgba(240,200,120,.16) inset,
        0 0 22px rgba(240,200,120,.18);
      backdrop-filter: blur(2px);
    }
    .target .tImg{
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background-image: var(--target-img);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
      animation: targetFloat 2.8s ease-in-out infinite;
      animation-delay: var(--float-delay, 0s);
      transform-origin: 50% 60%;
    }
    .target .tNum{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:22px;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      letter-spacing:.5px;
    }
    .target .tPts{
      position:absolute;
      left:50%;
      bottom:-18px;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight:700;
      color: rgba(240,200,120,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap;
      pointer-events:none;
    }
    .target.hit{ opacity:.25; filter: grayscale(1); }
    @keyframes targetFloat{
      0%{ transform: translateY(0px) scale(1); }
      50%{ transform: translateY(-7px) scale(1.02); }
      100%{ transform: translateY(0px) scale(1); }
    }
    .target:hover{ transform: translate(-50%,-50%) scale(1.05); }
    .target.hit{
      opacity:.38;
      filter: grayscale(1) brightness(.9);
      pointer-events:none;
    }
    .tNum{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 25px rgba(0,0,0,.65);
    }
    .tPts{
      position:absolute;
      bottom:-10px;
      left:50%;
      transform: translateX(-50%);
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.40);
      background: rgba(0,0,0,.35);
      color: rgba(255,232,190,.95);
      font-weight:800;
      font-size:11px;
      white-space:nowrap;
    }

    /* Modal (game question) */
    .modalBackdrop{
      position:absolute;
      inset:0;
      /* darker + soft orange aura */
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,138,42,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 15%, rgba(255,178,77,.10), transparent 62%),
        rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 40;
    }
    .modalBackdrop.on{ display:flex; }
    .modalBackdrop.on .modal{ animation: modalPop .18s ease-out; }
    @keyframes modalPop{
      from{ transform: translateY(10px) scale(.985); opacity:.0;}
      to{ transform: translateY(0) scale(1); opacity:1;}
    }
    .modal{
      width: min(980px, 96vw);
      border-radius: 22px;
      border:1px solid var(--neonLine);
      background:
        radial-gradient(800px 420px at 22% 8%, rgba(255,138,42,.10), transparent 55%),
        linear-gradient(180deg, rgba(10,13,18,.94), rgba(6,8,10,.90));
      box-shadow:
        0 28px 110px rgba(0,0,0,.78),
        0 0 0 1px rgba(255,138,42,.18),
        0 0 46px rgba(255,138,42,.18);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 36px);
      backdrop-filter: blur(8px);
    }
    .modal::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 24px;
      pointer-events:none;
      background: linear-gradient(135deg, rgba(255,138,42,.35), rgba(255,178,77,.10), rgba(255,138,42,.26));
      filter: blur(14px);
      opacity:.55;
    }
    .modal::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 22px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,138,42,.22), inset 0 0 34px rgba(255,138,42,.10);
    }
    .modal > *{ position:relative; }
    .modalHeader{
      padding: 14px 16px;
      background: linear-gradient(90deg, rgba(255,138,42,.18), rgba(255,138,42,.06) 40%, rgba(255,138,42,0));
      border-bottom:1px solid rgba(255,138,42,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader .h{
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }
    .modalClose{
      border-radius: 14px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .modalClose:hover{
      border-color: rgba(255,138,42,.40);
      background: rgba(255,138,42,.10);
      box-shadow: 0 0 0 1px rgba(255,138,42,.18), 0 0 18px rgba(255,138,42,.20);
    }
    .modalClose:focus-visible{
      outline:none;
      box-shadow: 0 0 0 2px rgba(255,138,42,.32), 0 0 22px rgba(255,138,42,.22);
    }
    .modalBody{
      padding: 16px;
      display:grid;
      gap:12px;
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .qText{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
      font-family: var(--qFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .mediaRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: rgba(255,255,255,.8);
      font-size:12px;
    }
    .mediaTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .answers{grid-template-columns:1fr}
    }
    .ansBtn{
      text-align:left;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      position:relative;
      display:flex;
      gap:12px;
      align-items:flex-start;
      font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .ansBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16);}
    .ansKey{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.50);
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,232,190,.95);
      flex:0 0 auto;
    }
    .ansText{ font-weight:700; line-height:1.25; font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputRow input{
      flex:1;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:700;
      outline:none;
      font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .primary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(202,162,77,.55);
      background: rgba(202,162,77,.18);
      color: rgba(255,245,225,.95);
      font-weight:900;
      cursor:pointer;
    }
    .secondary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:800;
      cursor:pointer;
    }

    /* Timer badge top-center */
    .timerBadge{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,166,60,.55);
      background: rgba(255,166,60,.12);
      color: rgba(255,230,190,.95);
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      display:none;
      align-items:center;
      gap:10px;
    }
    .timerBadge.on{
      display:flex;
      animation: pulseOrange 1.6s ease-in-out infinite;
    }
    @keyframes pulseOrange{
      0%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      35%{ box-shadow: 0 0 0 10px rgba(255,166,60,.14) }
      70%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      100%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
    }

    /* Small toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 60;
      font-weight:700;
      font-size:13px;
    }
    .toast.on{ display:block; }
  
/* --- Cursor: crosshair inside game/preview --- */
#previewFrame { cursor: crosshair; }
body[data-mode="game"] .gameRoot,
body[data-mode="game"] .gameRoot * { cursor: crosshair; }
body[data-mode="game"] .gameRoot input,
body[data-mode="game"] .gameRoot textarea { cursor: text; }
body[data-mode="game"] .gameRoot a { cursor: pointer; }


/* ==== Custom crosshair (works inside Genially overlays) ==== */
body.game-cursor { cursor: none !important; }
#aimCursor{
  position: fixed;
  left: -100px;
  top: -100px;
  width: 54px;
  height: 54px;
  transform: translate(-50%,-50%);
  pointer-events: none;
  z-index: 2147483647;
  opacity: 0;
  transition: opacity .12s ease;
}
#aimCursor .ring{
  position:absolute; inset:0;
  border: 2px solid rgba(255,190,90,.9);
  border-radius: 999px;
  box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 16px rgba(255,170,60,.18);
  background: radial-gradient(circle at 50% 50%, rgba(255,190,90,.08), transparent 60%);
}
#aimCursor .h, #aimCursor .v{
  position:absolute;
  left:50%; top:50%;
  background: rgba(255,190,90,.95);
  box-shadow: 0 0 10px rgba(255,170,60,.25);
}
#aimCursor .h{ width: 64px; height: 2px; transform: translate(-50%,-50%); }
#aimCursor .v{ width: 2px; height: 64px; transform: translate(-50%,-50%); }
#aimCursor .dot{
  position:absolute; left:50%; top:50%;
  width: 6px; height: 6px;
  border-radius: 999px;
  transform: translate(-50%,-50%);
  background: rgba(255,190,90,.95);
}


.cornerLogo{position:fixed;top:14px;right:14px;z-index:1000;width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));opacity:.95;pointer-events:none;}

/* v27 tweaks */
.topBrand{position:fixed;left:18px;top:14px;z-index:9999;pointer-events:none;opacity:.98;filter:drop-shadow(0 10px 24px rgba(0,0,0,.55));display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:14px;background:linear-gradient(180deg, rgba(18,24,33,.58), rgba(10,12,16,.35));border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(8px);}
    .modeGame .topBrand{ display:none; }
.topBrand img{height:34px;width:auto;border-radius:10px;display:block;}
.topBrand span{font-weight:800;font-size:13px;letter-spacing:.2px;color:rgba(255,255,255,.92);text-shadow:0 8px 22px rgba(0,0,0,.55);}
/* stronger 3D/parallax background */
.arenaBg{will-change:transform,filter;transform:translate3d(var(--bgx,0px),var(--bgy,0px),0) scale(1.10);filter:saturate(1.05) contrast(1.08);}
.arenaBg::after{content:"";position:absolute;inset:0;background:radial-gradient(1200px 600px at 40% 35%, rgba(255,255,255,.10), rgba(0,0,0,.45) 65%, rgba(0,0,0,.70));mix-blend-mode:overlay;pointer-events:none;}
.hudGoals{animation:goalFloat 3.8s ease-in-out infinite;}
@keyframes goalFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}


    /* Hit FX */
    .hitFx{
      position:absolute;
      width: 2px;
      height: 2px;
      transform: translate(-50%,-50%);
      pointer-events:none;
      mix-blend-mode: screen;
      animation: hitFxFade .52s ease-out forwards;
    }
    @keyframes hitFxFade{
      0%{ opacity:1; }
      100%{ opacity:0; }
    }
    .hitFx .hitCore{
      position:absolute;
      left:0; top:0;
      width: 10px; height: 10px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,200,80,.55) 45%, rgba(255,120,0,.0) 72%);
      filter: drop-shadow(0 0 10px rgba(255,140,0,.6));
      animation: hitCore .52s ease-out forwards;
    }
    @keyframes hitCore{
      0%{ transform: translate(-50%,-50%) scale(.9); opacity:1; }
      60%{ transform: translate(-50%,-50%) scale(1.3); opacity:.95; }
      100%{ transform: translate(-50%,-50%) scale(1.8); opacity:0; }
    }
    .hitFx .hitRing{
      position:absolute;
      left:0; top:0;
      width: 16px; height: 16px;
      border-radius: 999px;
      transform: translate(-50%,-50%) scale(.4);
      border: 2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 22px rgba(255,140,0,.45);
      animation: hitRingA .52s ease-out forwards;
    }
    .hitFx .hitRing.r2{
      width: 24px; height: 24px;
      border-color: rgba(255,180,80,.70);
      animation-name: hitRingB;
    }
    @keyframes hitRingA{
      0%{ transform: translate(-50%,-50%) scale(.35); opacity:.95; }
      100%{ transform: translate(-50%,-50%) scale(3.1); opacity:0; }
    }
    @keyframes hitRingB{
      0%{ transform: translate(-50%,-50%) scale(.25); opacity:.85; }
      100%{ transform: translate(-50%,-50%) scale(2.4); opacity:0; }
    }
    .hitFx .hitSparks{
      position:absolute;
      left:0; top:0;
      width: 1px; height: 1px;
      transform: translate(-50%,-50%);
    }
    .hitFx .hitSparks .sp{
      position:absolute;
      left:0; top:0;
      width: 4px; height: 14px;
      border-radius: 6px;
      transform: rotate(var(--a)) translateY(-8px);
      transform-origin: 0 0;
      background: linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,160,40,.75), rgba(255,120,0,0));
      filter: drop-shadow(0 0 10px rgba(255,140,0,.55));
      animation: spark .52s ease-out forwards;
    }
    @keyframes spark{
      0%{ opacity:1; transform: rotate(var(--a)) translateY(-6px) scaleY(.75); }
      100%{ opacity:0; transform: rotate(var(--a)) translateY(-46px) scaleY(1.1); }
    }
      100% { transform: translate(-50%,-50%) scale(2.6); opacity:0; }
    }

    .target.punch{
      animation: punch .14s ease-out;
    }
    @keyframes punch{
      0%   { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1); }
      60%  { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1.10); }
      100% { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1); }
    }

    /* When question is taken (hit), hide it completely */
    .target.hit{
      opacity: 0;
      transform: translate(-50%,-50%) scale(.2);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }

    /* Camera shake (very subtle) */
    .arena.shakeHit{ animation: shakeHit .12s linear; }
    .arena.shakeMiss{ animation: shakeMiss .14s linear; }
    @keyframes shakeHit{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(0.8px,-0.6px); }
      50%{ transform: translate(-0.7px,0.6px); }
      75%{ transform: translate(0.6px,0.5px); }
      100%{ transform: translate(0,0); }
    }
    @keyframes shakeMiss{
      0%{ transform: translate(0,0); }
      20%{ transform: translate(1.2px,0.2px); }
      40%{ transform: translate(-1.0px,-0.3px); }
      60%{ transform: translate(0.8px,0.3px); }
      80%{ transform: translate(-0.6px,-0.2px); }
      100%{ transform: translate(0,0); }
    }

    /* Modal image */
    .qImg{
      margin-top: 10px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .qImg img{
      display:block;
      width:100%;
      height:auto;
      max-height: 46vh;
      object-fit: contain;
      background: rgba(0,0,0,.15);
    }

  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700;800&family=Lato:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;700;900&family=Inter:wght@400;700;900&family=Noto+Sans:wght@400;700;900&family=Merriweather:wght@400;700;900&family=Caveat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topBrand" aria-hidden="true">
    <img src="63.png" alt="Логотип" onerror="this.style.display='none'"/>
    <span>Светлана Быкова</span>
  </div>
<div id="root"></div>

<div class="toast" id="toast"></div>

<script>
  // Hide brand inside game iframe (keep only in editor)
  try {
    if (typeof isGameMode === 'function' && isGameMode()) {
      const tb = document.querySelector('.topBrand');
      if (tb) tb.style.display = 'none';
    }
  } catch (e) {}

/* ===========================
   Математический тир
   Version 23 — editor+game
   =========================== */

const VERSION = 24;

/* ---------- helpers ---------- */
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('on');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1600);
}

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* base64url */
function b64uEncode(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64uDecode(str){
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  const json = decodeURIComponent(escape(atob(str)));
  return JSON.parse(json);
}

function urlOfSelf(){
  return location.origin + location.pathname;
}

/* ---------- Default config ---------- */
function defaultCfg(){
  return {
    title: "Математический тир",
    teamsCount: 2,
    autoNextTeam: true,
    latex: false,
    bg: "2.png",
    targetFile: "13.png",
    targetLineOffset: 0,
    targetLineJitter: 4,
    targetOrbitRadius: 0,
    targetOrbitSpeed: 0,
    shot: { variant:"pif", volume:0.7 },
    questions: [],
    qFont: 'Roboto',
    aFont: 'Roboto'
  };
}

/* ---------- LaTeX (optional) ---------- */
let katexLoaded = false;
async function ensureKatex(){
  if(katexLoaded) return;
  katexLoaded = true;
  const css = document.createElement('link');
  css.rel = 'stylesheet';
  css.href = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css";
  document.head.appendChild(css);

  const s1 = document.createElement('script');
  s1.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js";
  s1.defer = true;
  document.head.appendChild(s1);

  const s2 = document.createElement('script');
  s2.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js";
  s2.defer = true;
  document.head.appendChild(s2);

  await new Promise(res=> s2.onload = res);
}
function renderLatexIn(el){
  if(!window.renderMathInElement) return;
  try{
    window.renderMathInElement(el, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true},
      ]
    });
  }catch(e){}
}

/* ---------- Shot sound (WebAudio synth, no infinite loop) ---------- */
const AudioKit = (() => {
  let ctx = null;
  let master = null;

  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 1.2;
    master.connect(ctx.destination);
  }
  async function unlock(){
    ensure();
    if(ctx.state === 'suspended') await ctx.resume();
  }
  function setVolume(v){
    ensure();
    master.gain.value = clamp(v, 0, 1) * 2.2;
  }
  function noiseBuffer(){
    ensure();
    const bufferSize = ctx.sampleRate * 0.15;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * (1 - i/data.length);
    return buffer;
  }

  function playVariant(variant){
    ensure();
    const t0 = ctx.currentTime;
    const out = ctx.createGain();
    out.gain.value = 1.25;
    out.connect(master);

    if(variant === 'pif'){ // short 'pif'
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(620, t0);
      osc.frequency.exponentialRampToValueAtTime(260, t0+0.06);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.7, t0+0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      const f = ctx.createBiquadFilter();
      f.type = 'bandpass';
      f.frequency.setValueAtTime(900, t0);
      f.Q.value = 3.5;
      osc.connect(g).connect(f).connect(out);
      osc.start(t0);
      osc.stop(t0+0.10);
    } else if(variant === 'snap'){ // click
      const osc = ctx.createOscillator();
      osc.type = 'square';
      osc.frequency.setValueAtTime(220, t0);
      osc.frequency.exponentialRampToValueAtTime(880, t0+0.03);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.6, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.08);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.09);
    } else if(variant === 'boom'){ // low thump + noise
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(90, t0);
      osc.frequency.exponentialRampToValueAtTime(45, t0+0.12);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.9, t0+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.24);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const nf = ctx.createBiquadFilter();
      nf.type = 'lowpass'; nf.frequency.setValueAtTime(800, t0);
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.4, t0+0.015);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.18);
      n.connect(nf).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.19);
    } else {
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(520, t0);
      osc.frequency.exponentialRampToValueAtTime(220, t0+0.08);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.85, t0+0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.14);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.setValueAtTime(1800, t0); bp.Q.value = 3;
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      n.connect(bp).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.10);
    }

    out.gain.setValueAtTime(1, t0);
    out.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
    setTimeout(()=>{ try{out.disconnect()}catch(e){} }, 500);
  }

  return { ensure, unlock, setVolume, playVariant };
})();

/* ---------- App mode detection ---------- */
const params = new URLSearchParams(location.search);
const isGame = params.has('game');

// Hide editor branding inside the GAME iframe
if (isGame) {
    document.body.classList.add('modeGame');
    document.body.classList.remove('modeEditor');
  const hb = document.getElementById('headerBrand');
  if (hb) hb.style.display = 'none';
}


// ===== Crosshair overlay (needed for Genially where CSS cursor can be ignored) =====
function enableCrosshairOverlay(){
  if(document.getElementById('aimCursor')) return;
  document.body.classList.add('game-cursor');

  const el = document.createElement('div');
  el.id = 'aimCursor';
  el.innerHTML = '<div class="ring"></div><div class="h"></div><div class="v"></div><div class="dot"></div>';
  document.body.appendChild(el);

  const arena = document.getElementById('arena') || document.body;

  const show = () => { el.style.opacity = '1'; };
  const hide = () => { el.style.opacity = '0'; };

  const move = (e) => {
    // Use clientX/Y so it works in iframes and Genially embeds
    el.style.left = e.clientX + 'px';
    el.style.top  = e.clientY + 'px';
    // show on first move
    if(el.style.opacity !== '1') el.style.opacity = '1';
  };

  // Prefer listening on arena; also listen on window as fallback
  arena.addEventListener('mousemove', move, {passive:true});
  window.addEventListener('mousemove', move, {passive:true});

  arena.addEventListener('mouseenter', show, {passive:true});
  arena.addEventListener('mouseleave', hide, {passive:true});

  // Touch devices: keep default cursor (no-op)
  if('ontouchstart' in window){
    document.body.classList.remove('game-cursor');
    el.remove();
  }
}

if(isGame){
  // Delay to ensure #arena exists
  setTimeout(enableCrosshairOverlay, 0);
}


/* ===========================
   GAME MODE
   =========================== */
function mountGame(cfg){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div class="arenaBg arenaBg3d" id="arenaBg"></div>

        <div class="hud">
          <div class="hudLeft">
            <div class="gameTitle" id="gTitle"></div>
            <div class="gameHint">Выберите команду → наведите прицел → выстрелите → ответьте</div>
          </div>
          <div class="hudRight">
            <div class="hudStat" id="hudTurn">Сейчас стреляет: <b id="turnTeam">—</b></div>
            <div class="hudStat hudGoals">Цели: <b id="hudTargets">0/0</b></div>
            <button class="pillBtn" id="btnHelp">Инструкция</button>
            <button class="pillBtn" id="btnReset">Сброс</button>
          </div>
        </div>

        <div class="teams" id="teams"></div>

        <div class="targets" id="targets"></div>

        <div class="modalBackdrop" id="modalBack">
          <div class="modal">
            <div class="timerBadge" id="timerBadge">⏱ <span id="timerText">30</span> сек</div>
            <div class="modalHeader">
              <div class="h" id="qHeader">Вопрос</div>
              <button class="modalClose" id="btnClose">Esc</button>
            </div>
            <div class="modalBody">
              <div class="qText" id="qText"></div>
              <div class="mediaRow" id="qMedia"></div>
              <div id="answersWrap"></div>
            </div>
          </div>
        </div>

        <div class="versionBadge">Версия ${VERSION} • game</div>
      </div>
    </div>
  `;

  const arena = document.getElementById('arena');
  const bg = document.getElementById('arenaBg');

  function setBg(){
    const u = cfg.bg || "";
    bg.style.backgroundImage = u ? `url("${u}")` : 'none';
  }
  setBg();

  function setFonts(){
    const qf = (cfg.qFont || 'Roboto');
    const af = (cfg.aFont || 'Roboto');
    document.documentElement.style.setProperty('--qFont', qf);
    document.documentElement.style.setProperty('--aFont', af);
  }
  setFonts();

  // Parallax 3d
  arena.addEventListener('mousemove', (e)=>{
    const r = arena.getBoundingClientRect();
    const x = (e.clientX - r.left)/r.width - 0.5;
    const y = (e.clientY - r.top)/r.height - 0.5;
    bg.style.transform = `scale(1.08) translate(${x*10}px, ${y*10}px)`;
  });
  arena.addEventListener('mouseleave', ()=> bg.style.transform = `scale(1.06)`);

  document.getElementById('gTitle').textContent = cfg.title || "Математический тир";

  // state
  const teamCount = clamp(Number(cfg.teamsCount||2),1,3);
  const teamNames = Array.from({length: teamCount}, (_,i)=>`Команда ${i+1}`);
  const scores = Array.from({length: teamCount}, ()=>0);
  let currentTeam = 0;

  // targets = one per question
  const questions = Array.isArray(cfg.questions)? cfg.questions : [];
  const hit = new Set();
  let activeQIndex = null;
  let countdownId = null;
  let timeLeft = 0;

  
  const arenaEl = document.getElementById('arena') || document.querySelector('.arena');

  function shake(kind){
    if(!arenaEl) return;
    const cls = kind==='miss' ? 'shakeMiss' : 'shakeHit';
    arenaEl.classList.remove('shakeHit','shakeMiss');
    // restart animation
    void arenaEl.offsetWidth;
    arenaEl.classList.add(cls);
    setTimeout(()=>arenaEl.classList.remove(cls), 220);
  }

  function spawnHitFx(clientX, clientY){
    if(!arenaEl) return;
    const r = arenaEl.getBoundingClientRect();
    const x = clientX - r.left;
    const y = clientY - r.top;

    const fx = document.createElement('div');
    fx.className = 'hitFx';
    fx.style.left = x + 'px';
    fx.style.top = y + 'px';

    // Neon burst: rings + sparks
    let sparks = '';
    for(let i=0;i<10;i++){
      sparks += '<span class="sp" style="--a:' + (i*36) + 'deg"></span>';
    }
    fx.innerHTML = ''
      + '<div class="hitRing r1"></div>'
      + '<div class="hitRing r2"></div>'
      + '<div class="hitCore"></div>'
      + '<div class="hitSparks">' + sparks + '</div>';

    arenaEl.appendChild(fx);
    fx.addEventListener('animationend', ()=>fx.remove(), {once:true});
  }
const teamsEl = document.getElementById('teams');
  const targetsEl = document.getElementById('targets');
  const hudTargets = document.getElementById('hudTargets');
  const turnTeamEl = document.getElementById('turnTeam');

  function renderTeams(){
    teamsEl.style.gridTemplateColumns = `repeat(${teamCount}, minmax(0,1fr))`;
    teamsEl.innerHTML = '';
    for(let i=0;i<teamCount;i++){
      const card = document.createElement('div');
      card.className = 'teamCard';
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input class="teamNameInput" value="${teamNames[i]}" aria-label="Название команды ${i+1}"/>
          <div class="teamNow"><span class="dot ${i===currentTeam?'on':''}"></span> ${i===currentTeam?'Сейчас':'Не сейчас'}</div>
        </div>
        <div class="teamScore" id="score_${i}">${scores[i]}</div>
      `;
      const inp = card.querySelector('input');
      inp.addEventListener('input', ()=>{ teamNames[i] = inp.value || `Команда ${i+1}`; renderTurn(); });
      teamsEl.appendChild(card);
    }
  }
  function renderTurn(){
    turnTeamEl.textContent = teamNames[currentTeam] || `Команда ${currentTeam+1}`;
    $$('.teamCard', teamsEl).forEach((c,idx)=>{
      const d = c.querySelector('.dot');
      d.classList.toggle('on', idx===currentTeam);
      c.querySelector('.teamNow').lastChild.textContent = idx===currentTeam ? ' Сейчас' : ' Не сейчас';
    });
  }
  function renderScores(){
    for(let i=0;i<teamCount;i++){
      const s = document.getElementById(`score_${i}`);
      if(s) s.textContent = scores[i];
    }
  }

  function countDone(){ return hit.size; }

  function positionTargets(){
    const n = questions.length;
    const pts = [];
    for(let i=0;i<n;i++){
      const col = (i % 6);
      const row = Math.floor(i / 6);
      const x = 12 + col*(76/5);
      const y = 22 + row*10;
      pts.push({x, y});
    }
    const maxY = pts.reduce((m,p)=>Math.max(m,p.y), 0);
    const scaleY = maxY > 55 ? (55-22)/(maxY-22) : 1;

    // User controls
    const lineOffset = Number(cfg?.targetLineOffset ?? 0); // percent points
    const lineJitter = Number(cfg?.targetLineJitter ?? 4); // percent points

    // Precompute staggers and center them so "Разброс" doesn't move the whole line up/down
    const staggers = pts.map((_,i)=>Math.sin((i+1)*0.9) * lineJitter * 2.0);
    const meanStagger = staggers.reduce((a,b)=>a+b,0) / (staggers.length || 1);

    pts.forEach((p,i)=>{
      p.y = 22 + (p.y-22)*scaleY;

      // deterministic micro-variation (stable in preview)
      const wobX = Math.sin((i+1)*1.37) * 2.2;
      const wobY = Math.cos((i+1)*1.91) * 1.2;

      // centered stagger (spread around the same baseline)
      const stagger = staggers[i] - meanStagger;

      p.x += wobX;
      p.y += wobY + lineOffset + stagger;
    });
    return pts;
  }


  // --- Orbit movement (step-by-step along circle points) ---
  let _orbitTimer = null;
  function stopOrbitMotion(){
    if(_orbitTimer){ clearInterval(_orbitTimer); _orbitTimer = null; }
  }
  function startOrbitMotion(){
    stopOrbitMotion();
    const radius = Number(cfg?.targetOrbitRadius ?? 0);
    const speed = Number(cfg?.targetOrbitSpeed ?? 0);
    if(!(radius>0) || !(speed>0)) {
      // reset offsets
      $$('.target', targetsEl).forEach(el=>{
        el.style.setProperty('--orbit-x','0px');
        el.style.setProperty('--orbit-y','0px');
      });
      return;
    }
    const steps = 24; // points on circle
    const startT = Date.now();
    const phase = [];
    const els = $$('.target', targetsEl);
    for(let i=0;i<els.length;i++){
      // stable phase so targets don't stack
      phase[i] = (i/Math.max(1,els.length))*steps;
    }
    _orbitTimer = setInterval(()=>{
      const t = (Date.now()-startT)/1000;
      for(let i=0;i<els.length;i++){
        const k = Math.floor((t*speed) + phase[i]); // step index
        const ang = (k % steps) * (Math.PI*2/steps);
        const dx = Math.round(Math.cos(ang) * radius);
        const dy = Math.round(Math.sin(ang) * radius);
        els[i].style.setProperty('--orbit-x', dx + 'px');
        els[i].style.setProperty('--orbit-y', dy + 'px');
      }
    }, 60); // ~16 fps for "точечное" движение
  }
  function renderTargets(){
    targetsEl.innerHTML = '';
    const n = questions.length;
    const pts = positionTargets();
    const targetFile = (cfg.targetFile || '13.png').trim();
    for(let i=0;i<n;i++){
      const q = questions[i];
      const el = document.createElement('div');
      el.className = 'target' + (hit.has(i)?' hit':'');
      el.style.left = (pts[i]?.x ?? 50) + '%';
      el.style.top  = (pts[i]?.y ?? 40) + '%';

      // Target image layer (can be swapped from the editor)
      el.style.setProperty('--target-img', `url("${targetFile}")`);

      // Slight float / breathing effect with per-target phase
      const phase = (Math.random()*1.8).toFixed(2);
      el.style.setProperty('--float-delay', phase + 's');

      el.innerHTML = `
        <div class="tImg" aria-hidden="true"></div>
        <div class="tNum">${i+1}</div>
        <div class="tPts">${Number(q.points||10)} очк.</div>
      `;
      el.addEventListener('click', async (e)=>{
        if(hit.has(i)) return;
        try{ el.classList.remove('punch'); void el.offsetWidth; el.classList.add('punch'); }catch(err){}
        try{ if(e) spawnHitFx(e.clientX, e.clientY); }catch(err){}
        try{ shake('hit'); }catch(err){}
        try{
          await AudioKit.unlock();
          AudioKit.setVolume(cfg?.shot?.volume ?? 0.7);
          AudioKit.playVariant(cfg?.shot?.variant ?? 'pif');
        }catch(e){}
        await openQuestion(i);
      });
      targetsEl.appendChild(el);
    }
    startOrbitMotion();
  }

  // modal logic
  const modalBack = document.getElementById('modalBack');
  const qHeader = document.getElementById('qHeader');
  const qText = document.getElementById('qText');
  const qMedia = document.getElementById('qMedia');
  const answersWrap = document.getElementById('answersWrap');
  const btnClose = document.getElementById('btnClose');
  const timerBadge = document.getElementById('timerBadge');
  const timerText = document.getElementById('timerText');

  function closeModal(){
    modalBack.classList.remove('on');
    activeQIndex = null;
    stopTimer();
  }

  function stopTimer(){
    if(countdownId){ clearInterval(countdownId); countdownId = null; }
    timerBadge.classList.remove('on');
  }

  function startTimer(seconds){
    stopTimer();
    timeLeft = seconds;
    timerText.textContent = String(timeLeft);
    timerBadge.classList.add('on');
    countdownId = setInterval(()=>{
      timeLeft--;
      timerText.textContent = String(timeLeft);
      if(timeLeft <= 0){
        stopTimer();
        finalizeQuestion(false, true);
      }
    }, 1000);
  }

  function finalizeQuestion(isCorrect, timedOut=false){
    if(activeQIndex === null) return;
    const idx = activeQIndex;
    const q = questions[idx];
    if(!hit.has(idx)){
      hit.add(idx);
      if(isCorrect){
        scores[currentTeam] += Number(q.points||10);
        renderScores();
      }
      const t = targetsEl.children[idx];
      if(t) t.classList.add('hit');
      hudTargets.textContent = `${countDone()}/${questions.length}`;
    }

    if(cfg.autoNextTeam){
      currentTeam = (currentTeam + 1) % teamCount;
      renderTeams();
      renderTurn();
      renderScores();
    }
    closeModal();
  }

  function makeMediaTag(icon, label, url){
    const span = document.createElement('span');
    span.className = 'mediaTag';
    span.innerHTML = `<span aria-hidden="true">${icon}</span> <span>${label}</span>`;
    span.title = url;
    return span;
  }

  async function openQuestion(i){
    activeQIndex = i;
    const q = questions[i];

    qHeader.textContent = `Вопрос #${i+1}`;
    qText.textContent = q.text || '';
    qMedia.innerHTML = '';
    answersWrap.innerHTML = '';

    if(cfg.latex){
      await ensureKatex();
      qText.innerHTML = q.text ? String(q.text) : '';
    }

    // Show image inside the task (if provided)
    const oldImg = document.getElementById('qImgWrap');
    if(oldImg) oldImg.remove();
    if(q.image){
      const wrap = document.createElement('div');
      wrap.className = 'qImg';
      wrap.id = 'qImgWrap';
      const img = document.createElement('img');
      img.alt = 'Картинка к заданию';
      img.src = q.image;
      img.onerror = ()=>{ wrap.style.display='none'; };
      wrap.appendChild(img);
      qText.insertAdjacentElement('afterend', wrap);
    }


    if(q.image){
      qMedia.appendChild(makeMediaTag('🖼️', 'картинка', q.image));
    }

    if(q.type === 'input'){
      const wrap = document.createElement('div');
      wrap.className = 'inputRow';
      wrap.innerHTML = `
        <input id="ansInput" type="text" placeholder="Введите ответ…" autocomplete="off"/>
        <button class="primary" id="btnSend">Ответить</button>
        <button class="secondary" id="btnSkip">Пропустить</button>
      `;
      answersWrap.appendChild(wrap);

      const correctList = String(q.correct||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

      const check = ()=>{
        const v = (document.getElementById('ansInput').value||'').trim().toLowerCase();
        const ok = correctList.length ? correctList.includes(v) : (v.length>0);
        finalizeQuestion(ok);
      };
      document.getElementById('btnSend').addEventListener('click', check);
      document.getElementById('ansInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
      document.getElementById('btnSkip').addEventListener('click', ()=>finalizeQuestion(false));
    } else {
      const opts = Array.isArray(q.options) ? q.options : [];
      const grid = document.createElement('div');
      grid.className = 'answers';
      answersWrap.appendChild(grid);

      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      opts.forEach((opt, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ansBtn';
        btn.innerHTML = `<div class="ansKey">${letters[idx] || (idx+1)}</div><div class="ansText">${opt?.text ?? ''}</div>`;
        btn.addEventListener('click', ()=>{
          const ok = !!opt?.correct;
          finalizeQuestion(ok);
        });
        grid.appendChild(btn);
      });

      const foot = document.createElement('div');
      foot.style.display = 'flex';
      foot.style.justifyContent = 'flex-end';
      foot.style.marginTop = '8px';
      foot.innerHTML = `<button class="secondary" id="btnSkip2">Пропустить</button>`;
      answersWrap.appendChild(foot);
      document.getElementById('btnSkip2').addEventListener('click', ()=>finalizeQuestion(false));
    }

    modalBack.classList.add('on');

    if(q.timerEnabled && Number(q.timerSeconds||0) > 0){
      startTimer(Number(q.timerSeconds));
    } else {
      stopTimer();
    }

    if(cfg.latex){
      setTimeout(()=>{ renderLatexIn(document.querySelector('.modal')); }, 0);
    }
  }

  document.getElementById('btnHelp').addEventListener('click', ()=>{
    toast("Кликните по мишени → ответьте. Очки идут текущей команде.");
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    hit.clear();
    for(let i=0;i<scores.length;i++) scores[i]=0;
    currentTeam = 0;
    renderTargets();
    renderTeams();
    renderTurn();
    renderScores();
    closeModal();
    toast("Сброс выполнен");
  });
  btnClose.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  renderTeams();
  renderTurn();
  renderScores();
  renderTargets();
}

/* ===========================
   EDITOR MODE
   =========================== */
function mountEditor(){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="app">
      <div class="panel">
        <div class="panelHeader">
          <div>
            <div class="title">Редактор<br>«Математический тир»</div>
            <div class="subtitle"></div>
          </div>
          <button class="btn btnGold" id="copyIframe">📋 Скопировать код</button>
        </div>

        <div class="scroll">
          <div class="section">
            <h3>Название</h3>
            <div class="row1">
              <div>
                <label>Заголовок в игре</label>
                <input id="inpTitle" type="text" value="Математический тир"/>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Параметры</h3>
            <div class="row">
              <div>
                <label>Количество команд (1–3)</label>
                <select id="teamsCount">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div>
                <label>Автопереход команды после вопроса</label>
                <select id="autoNext">
                  <option value="true" selected>Включён</option>
                  <option value="false">Выключен</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>LaTeX (вопросы/ответы)</label>
                <select id="latexToggle">
                  <option value="false" selected>Выключен</option>
                  <option value="true">Включён</option>
                </select>
              </div>
              <div>
                <label>Выбери фон</label>
                <select id="bgSelect" class="select">
                  <option value="1.png">1</option>
                  <option value="2.png" selected>2</option>
                  <option value="3.png">3</option>
                  <option value="4.png">4</option>
                  <option value="5.png">5</option>
                  <option value="6.png">6</option>
                  <option value="7.png">7</option>
                  <option value="8.png">8</option>
                  <option value="__custom__">По ссылке</option>
                </select>
                <input id="bgInput" type="hidden" value="2.png"/>
                <div style="display:flex; gap:10px; margin-top:8px;">
                  <input id="bgUrl" type="text" placeholder="Ссылка на фон (png/jpg/webp)"/>
                  <button class="btn" id="btnBgApply" type="button">Применить</button>
                </div>
                <div class="help">Можно вставить ссылку на картинку. Подойдут https://… и относительные пути (например: images/bg.png).</div>
              </div>
            </div>
<div class="row">
              <div class="field">
                <label>Выбери мишень</label>
                <select id="targetSelect" class="select">
                  <option value="10.png">10</option>
                  <option value="11.png">11</option>
                  <option value="12.png">12</option>
                  <option value="13.png" selected>13</option>
                  <option value="14.png">14</option>
                  <option value="__custom__">По ссылке</option>
                </select>
                <input id="targetInput" type="hidden" value="13.png"/>
                <div style="display:flex; gap:10px; margin-top:8px;">
                  <input id="targetUrl" type="text" placeholder="Ссылка на мишень (png/webp с прозрачностью)"/>
                  <button class="btn" id="btnTargetApply" type="button">Применить</button>
                </div>
                <div class="help">Лучше использовать PNG/WebP с прозрачным фоном.</div>
              </div>
              <div class="field">
                <label>Позиции мишеней</label>
                <div class="hint">Мишени будут появляться в отмеченной зоне на фоне.</div>
              </div>
            </div>
            <div class="help">Файлы мишеней: 10.png … 14.png (рядом с index.html).</div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label>Высота мишени</label>
                <input id="targetLineY" class="range" type="range" min="0" max="100" step="1" value="50" />
                </div>
              <div class="field">
                <label>Разброс</label>
                <input id="targetLineJitter" class="range" type="range" min="0" max="40" step="1" value="8" />
                </div>

            <div class="row1" style="margin-top:10px;">
              <div class="field-card">
                <label>Радиус движения мишени</label>
                <input id="targetOrbitRadius" class="range" type="range" min="0" max="260" step="5" value="0" />
                <div class="hint">0 — мишени стоят на месте. Чем больше значение, тем больше радиус (в пикселях).</div>
              </div>
              <div class="field-card">
                <label>Скорость движения мишени</label>
                <input id="targetOrbitSpeed" class="range" type="range" min="0" max="12" step="1" value="0" />
                <div class="hint">0 — без движения. Чем больше, тем быстрее “шагают” по точкам окружности.</div>
              </div>
            </div>
            </div>

          </div>

          <div class="section">
            <h3>Звук выстрела</h3>
            <div class="soundRow">
              <div>
                <label>Вариант (прослушивается при выборе)</label>
                <select id="shotVariant">
                  <option value="pif" selected>Короткий «пиф»</option>
                  <option value="snap">Щелчок «снап»</option>
                  <option value="boom">Глухой «бум»</option>
                </select>
              </div>
              <div>
                <label>Громкость</label>
                <input id="shotVol" class="range" type="range" min="0" max="1" step="0.01" value="0.7"/>
              </div>
            </div>
            <div class="help">В игре звук выстрела звучит при клике по мишени.</div>
          </div>

          <div class="section">
            <div class="split">
              <h3 style="margin:0">Вопросы</h3>
              <span class="pill">Всего: <span id="qCount">0</span></span>
            </div>
            <div class="btnRow">
              <button class="btn btnGold" id="btnAdd">＋ Добавить</button>
              <button class="btn btnDanger" id="btnClear">🧹 Очистить</button>
            </div>
            <div class="help">Мишеней будет столько же, сколько вопросов.</div>
            <div style="height:10px"></div>
            <div class="qList" id="qList"></div>
          </div>
</div>
      </div>

      <div class="panel previewWrap">
        <div class="previewHeader">
          <div>
            <div class="title2">Просмотр</div>
            <div class="muted">Живое превью (как в Genially)</div>
          </div>
          <div class="muted">фон + мишени + вопросы</div>
        </div>
        <iframe class="previewFrame" id="previewFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>

    <div class="versionBadge">Версия ${VERSION} • editor+game</div>

    <div class="modalBackdrop" id="editBack" style="z-index:80;">
      <div class="modal">
        <div class="modalHeader">
          <div class="h" id="editHdr">Вопрос</div>
          <button class="modalClose" id="editClose">Esc</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div>
              <label>Очки</label>
              <input id="editPoints" type="number" min="0" step="1" value="10"/>
            </div>
            <div>
              <label>Таймер</label>
              <select id="editTimerMode">
                <option value="off" selected>Выключен</option>
                <option value="on">Включён</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Секунды (если включён)</label>
              <input id="editTimerSec" type="number" min="1" step="1" value="30"/>
            </div>
            <div>
              <label>Тип вопроса</label>
              <select id="editType">
                <option value="choice" selected>Выбор ответа</option>
                <option value="input">Ввод ответа</option>
              </select>
            </div>
          </div>

          <div class="row1">
            <div>
              <label>Текст вопроса</label>
              <textarea id="editText" placeholder="Напишите вопрос…"></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>🖼️ Картинка (URL, опционально)</label>
              <input id="editImg" type="text" placeholder="https://..."/>
            </div>
            <div>
              <label>Шрифт вопроса</label>
              <select id="qFontSelect"></select>
              <div class="help">Выберите, как будет выглядеть текст вопроса в игре.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Шрифт ответов</label>
              <select id="aFontSelect"></select>
              <div class="help">Применяется к вариантам ответа и полю ввода.</div>
            </div>
            <div></div>
          </div>

          <div id="choiceBox">
            <div class="split">
              <div style="font-weight:900;">Варианты ответа</div>
              <div class="pill">можно добавлять сколько нужно</div>
            </div>
            <div id="optList" class="qList" style="margin-top:10px;"></div>
            <div style="display:flex; gap:10px;">
              <button class="btn btnGold" id="btnAddOpt">＋ Добавить вариант</button>
            </div>
            <div class="help">Отметьте один вариант как «верный» (радио-кнопка).</div>
          </div>

          <div id="inputBox" style="display:none;">
            <label>Правильный ответ (можно несколько через запятую)</label>
            <input id="editCorrect" type="text" placeholder="например: 12, двенадцать"/>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:4px;">
            <button class="secondary" id="btnCancelQ">Отмена</button>
            <button class="primary" id="btnSaveQ">Сохранить вопрос</button>
          </div>
        </div>
      </div>
    </div>
  `;

  let cfg = defaultCfg();
  let editingIndex = null;

  const inpTitle = document.getElementById('inpTitle');
  const teamsCount = document.getElementById('teamsCount');
  const autoNext = document.getElementById('autoNext');
  const latexToggle = document.getElementById('latexToggle');
  const bgInput = document.getElementById('bgInput') || document.getElementById('bgSelect');
  const bgSelect = document.getElementById('bgSelect');
  const bgUrl = document.getElementById('bgUrl');
  const btnBgApply = document.getElementById('btnBgApply');

  // keep hidden input in sync (cfg читается из bgInput)
  bgSelect?.addEventListener('change', ()=>{ 
    try { if (bgSelect.value !== '__custom__') { if (bgInput) bgInput.value = bgSelect.value; } } catch(e) {}
    try{ if(!isGame) schedulePreviewUpdate(); }catch(e){} 
  });

const targetInput = document.getElementById('targetInput');
  const targetSelect = document.getElementById('targetSelect');
  const targetUrl = document.getElementById('targetUrl');
  const btnTargetApply = document.getElementById('btnTargetApply');
  const targetLineY = document.getElementById('targetLineY');
  const targetLineJitter = document.getElementById('targetLineJitter');
  const targetOrbitRadius = document.getElementById('targetOrbitRadius');
  const targetOrbitSpeed = document.getElementById('targetOrbitSpeed');

// Live-update preview when background/target change
bgSelect?.addEventListener('change', () => {
  try { if (typeof bgInput !== 'undefined' && bgInput && bgSelect.value !== '__custom__') bgInput.value = bgSelect.value; } catch(e) {}
  schedulePreviewUpdate();
});

targetSelect?.addEventListener('change', () => {
  // keep file input in sync (cfg читается из targetInput)
  try { if (targetInput && targetSelect.value !== '__custom__') targetInput.value = targetSelect.value; } catch(e) {}
  schedulePreviewUpdate();
});

targetLineY?.addEventListener('input', schedulePreviewUpdate);
targetLineJitter?.addEventListener('input', schedulePreviewUpdate);

// === КРАСИВЫЕ БЕГУНКИ: СИНХРОНИЗАЦИЯ ЦВЕТА ===
const syncRange = (el) => {
  if(!el) return;
  el.style.setProperty('--percent', (el.value / el.max * 100) + '%');
};

targetOrbitRadius?.addEventListener('input', (e) => {
  syncRange(e.target);
  schedulePreviewUpdate();
});
targetOrbitSpeed?.addEventListener('input', (e) => {
  syncRange(e.target);
  schedulePreviewUpdate();
});

// Инициализация при запуске редактора
setTimeout(() => {
  syncRange(targetOrbitRadius);
  syncRange(targetOrbitSpeed);
}, 50);

// Defaults
// Всегда стартуем с фона 2 (можно изменить в UI)
if (bgSelect) bgSelect.value = '2.png';
const _bgHidden = document.getElementById('bgInput');
if (_bgHidden) _bgHidden.value = '2.png';
try { if (bgInput) bgInput.value = bgSelect?.value || '2.png'; } catch(e) {}
if (targetSelect && !targetSelect.value) targetSelect.value = '13.png';
if (targetInput && !targetInput.value) targetInput.value = targetSelect?.value || '13.png';

  function normalizeAssetUrl(u){
    u = String(u||'').trim();
    if(!u) return '';
    return u;
  }
  function isSafeUrl(u){
    const s = String(u||'').trim();
    if(!s) return false;
    const low = s.toLowerCase();
    if(low.startsWith('javascript:') || low.startsWith('data:') || low.startsWith('vbscript:')) return false;
    // allow http(s) and relative paths (no other schemes)
    const hasScheme = low.includes('://');
    if(hasScheme && !(low.startsWith('http://') || low.startsWith('https://'))) return false;
    return true;
  }

  // Try to preload image to make sure the link реально ведёт на картинку
  function preloadImage(url, cb){
    try{
      const img = new Image();
      img.onload = ()=> cb(true);
      img.onerror = ()=> cb(false);
      img.src = url;
    }catch(e){ cb(false); }
  }

// Apply custom BG by URL
  btnBgApply?.addEventListener('click', ()=>{
    const u0 = normalizeAssetUrl(bgUrl?.value || '');
    if(!u0 || !isSafeUrl(u0)){
      toast('Ссылка на фон: вставь https://… или относительный путь');
      return;
    }
    toast('Пробую загрузить фон…');
    preloadImage(u0, (ok)=>{
      if(!ok){
        toast('Фон не загрузился. Часто причина: ссылка ведёт не на картинку или хостинг блокирует прямые ссылки.');
        return;
      }
      if(bgInput) bgInput.value = u0;
      if(bgSelect) bgSelect.value = '__custom__';
      schedulePreviewUpdate();
      toast('Фон применён');
    });
  });

// Apply custom target by URL
  btnTargetApply?.addEventListener('click', ()=>{
    const u0 = normalizeAssetUrl(targetUrl?.value || '');
    if(!u0 || !isSafeUrl(u0)){
      toast('Ссылка на мишень: вставь https://… или относительный путь');
      return;
    }
    toast('Пробую загрузить мишень…');
    preloadImage(u0, (ok)=>{
      if(!ok){
        toast('Мишень не загрузилась. Часто причина: ссылка ведёт не на картинку или хостинг блокирует прямые ссылки.');
        return;
      }
      if(targetInput) targetInput.value = u0;
      if(targetSelect) targetSelect.value = '__custom__';
      schedulePreviewUpdate();
      toast('Мишень применена');
    });
  });

// If user edits URL fields, keep select on "По ссылке" (but don't apply until button)
  bgUrl?.addEventListener('input', ()=>{ if(bgSelect) bgSelect.value = '__custom__'; });
  targetUrl?.addEventListener('input', ()=>{ if(targetSelect) targetSelect.value = '__custom__'; });

  // When switching back to built-in assets, clear URL fields
  bgSelect?.addEventListener('change', ()=>{
    if(bgSelect.value !== '__custom__'){
      try{ if(bgUrl) bgUrl.value = ''; }catch(e){}
      try{ if(bgInput) bgInput.value = bgSelect.value; }catch(e){}
    }
  });
  targetSelect?.addEventListener('change', ()=>{
    if(targetSelect.value !== '__custom__'){
      try{ if(targetUrl) targetUrl.value = ''; }catch(e){}
      try{ if(targetInput) targetInput.value = targetSelect.value; }catch(e){}
    }
  });

  const shotVariant = document.getElementById('shotVariant');
  const shotVol = document.getElementById('shotVol');
  const qCount = document.getElementById('qCount');
  const qList = document.getElementById('qList');
  const previewFrame = document.getElementById('previewFrame');

  // Fonts for question/answers (global)
  const qFontSelect = document.getElementById('qFontSelect');
  const aFontSelect = document.getElementById('aFontSelect');


  const FONT_CHOICES = [
    {label:'Roboto', css:'Roboto'},
    {label:'Open Sans', css:'"Open Sans"'},
    {label:'Lato', css:'Lato'},
    {label:'Montserrat', css:'Montserrat'},
    {label:'Poppins', css:'Poppins'},
    {label:'Inter', css:'Inter'},
    {label:'Noto Sans', css:'"Noto Sans"'},
    {label:'Merriweather', css:'Merriweather'},
    {label:'Caveat', css:'Caveat'},
    {label:'Pacifico', css:'Pacifico'}
  ];

  function fillFontSelect(sel, current){
    if(!sel) return;
    sel.innerHTML = '';
    FONT_CHOICES.forEach(f=>{
      const o = document.createElement('option');
      o.value = f.css;
      o.textContent = `пример шрифта — ${f.label}`;
      o.style.fontFamily = `${f.css}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      sel.appendChild(o);
    });
    // set current if matches, else first
    const want = current || 'Roboto';
    const found = Array.from(sel.options).some(o=>o.value===want);
    sel.value = found ? want : (sel.options[0]?.value || 'Roboto');
  }


// Fonts defaults
fillFontSelect(qFontSelect, cfg.qFont);
fillFontSelect(aFontSelect, cfg.aFont);
qFontSelect?.addEventListener('change', schedulePreviewUpdate);
aFontSelect?.addEventListener('change', schedulePreviewUpdate);

  function readCfgFromUI(){
    cfg.title = inpTitle.value || "Математический тир";
    cfg.teamsCount = clamp(Number(teamsCount.value||2),1,3);
    cfg.autoNextTeam = (autoNext.value === 'true');
    cfg.latex = (latexToggle.value === 'true');
    cfg.bg = (bgInput.value || "2.png").trim();
    cfg.targetFile = (targetInput?.value || "13.png").trim();
    cfg.targetLineOffset = (50 - Number(targetLineY?.value ?? 50));
    cfg.targetLineJitter = Number(targetLineJitter?.value ?? 4);
    cfg.targetOrbitRadius = Number(targetOrbitRadius?.value ?? 0);
    cfg.targetOrbitSpeed = Number(targetOrbitSpeed?.value ?? 0);
    cfg.shot.variant = shotVariant.value;
    cfg.shot.volume = clamp(Number(shotVol.value||0.7),0,1);
    cfg.qFont = (qFontSelect?.value || 'Roboto');
    cfg.aFont = (aFontSelect?.value || 'Roboto');
  }

  let _pvT = null;
function schedulePreviewUpdate() {
  if (_pvT) clearTimeout(_pvT);
  _pvT = setTimeout(() => {
    try { updatePreview(); } catch (e) {}
  }, 120);
}

function updatePreview(){
    readCfgFromUI();
    if(cfg.latex) ensureKatex();
    const gameUrl = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}&t=${Date.now()}`;
    previewFrame.src = gameUrl;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function renderQuestionList(){
    qCount.textContent = String(cfg.questions.length);
    qList.innerHTML = '';
    cfg.questions.forEach((q, idx)=>{
      const item = document.createElement('div');
      item.className = 'qItem';
      const t = (q.text || '').trim() || '(без текста)';
      const meta = `${q.type==='input'?'Ввод':'Выбор'} • ${Number(q.points||10)} очк. • ${q.timerEnabled? (q.timerSeconds+' сек') : 'без таймера'}`;
      item.innerHTML = `
        <div>
          <div class="qTitle">${idx+1}. ${escapeHtml(t)}</div>
          <div class="qMeta">${meta}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn" title="Редактировать">✏️</button>
          <button class="iconBtn danger" title="Удалить">🗑️</button>
        </div>
      `;
      item.querySelector('.iconBtn').addEventListener('click', ()=> openEdit(idx));
      item.querySelector('.iconBtn.danger').addEventListener('click', ()=>{
        cfg.questions.splice(idx,1);
        renderQuestionList();
        updatePreview();
      });
      qList.appendChild(item);
    });
  }

  async function playShotPreview(){
    readCfgFromUI();
    await AudioKit.unlock();
    AudioKit.setVolume(cfg.shot.volume);
    AudioKit.playVariant(cfg.shot.variant);
  }
  shotVariant.addEventListener('change', async ()=>{ await playShotPreview(); try{ if(!isGame) schedulePreviewUpdate(); }catch(e){} });
  shotVol.addEventListener('input', ()=>{ readCfgFromUI(); try{ AudioKit.setVolume(cfg.shot.volume); }catch(e){} try{ if(!isGame) schedulePreviewUpdate(); }catch(e){} });
document.getElementById('copyIframe').addEventListener('click', async ()=>{
    readCfgFromUI();
    const src = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}`;
    const code = `<iframe src="${src}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    try{
      await navigator.clipboard.writeText(code);
      toast("iframe скопирован");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = code;
      document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      ta.remove();
      toast("iframe скопирован");
    }
  });

  [inpTitle, teamsCount, autoNext, latexToggle, bgInput].forEach(el=>{
    el.addEventListener('change', updatePreview);
    el.addEventListener('input', ()=>{ if(el===inpTitle || el===bgInput) updatePreview(); });
  });

  document.getElementById('btnAdd').addEventListener('click', ()=> openEdit(null));
  document.getElementById('btnClear').addEventListener('click', ()=>{
    cfg.questions = [];
    renderQuestionList();
    updatePreview();
  });

  const editBack = document.getElementById('editBack');
  const editHdr = document.getElementById('editHdr');
  const editClose = document.getElementById('editClose');
  const editPoints = document.getElementById('editPoints');
  const editTimerMode = document.getElementById('editTimerMode');
  const editTimerSec = document.getElementById('editTimerSec');
  const editType = document.getElementById('editType');
  const editText = document.getElementById('editText');
  const editImg = document.getElementById('editImg');
  const choiceBox = document.getElementById('choiceBox');
  const inputBox = document.getElementById('inputBox');
  const editCorrect = document.getElementById('editCorrect');
  const optList = document.getElementById('optList');

  function closeEdit(){
    editBack.classList.remove('on');
    editingIndex = null;
  }
  editClose.addEventListener('click', closeEdit);
  document.getElementById('btnCancelQ').addEventListener('click', closeEdit);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editBack.classList.contains('on')) closeEdit(); });

  function newQuestion(){
    return {
      type: 'choice',
      text: '',
      points: 10,
      timerEnabled: false,
      timerSeconds: 30,
      image: '',
      options: [
        {text:'', correct:true},
        {text:'', correct:false},
        {text:'', correct:false}
      ],
      correct: ''
    };
  }

  function renderOptions(q){
    optList.innerHTML = '';
    q.options = Array.isArray(q.options) && q.options.length ? q.options : [{text:'', correct:true}];
    q.options.forEach((o, idx)=>{
      const row = document.createElement('div');
      row.className = 'qItem';
      row.style.gridTemplateColumns = "1fr auto";
      row.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input type="text" placeholder="Текст ответа" value="${escapeHtml(o.text||'')}" />
          <label style="margin:0; display:flex; align-items:center; gap:8px; white-space:nowrap; color:rgba(255,255,255,.78);">
            <input type="radio" name="correctOpt" ${o.correct?'checked':''}/>
            верный
          </label>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn" title="Вверх">↑</button>
          <button class="iconBtn" title="Вниз">↓</button>
          <button class="iconBtn danger" title="Удалить">✕</button>
        </div>
      `;
      const inp = row.querySelector('input[type="text"]');
      inp.addEventListener('input', ()=>{ o.text = inp.value; });
      const radio = row.querySelector('input[type="radio"]');
      radio.addEventListener('change', ()=>{
        q.options.forEach(x=>x.correct=false);
        o.correct = true;
      });
            // Reorder (keep the order exactly as you wrote)
      const btnUp = row.querySelector('.iconBtn[title="Вверх"]');
      const btnDown = row.querySelector('.iconBtn[title="Вниз"]');
      if(btnUp){
        btnUp.addEventListener('click', ()=>{
          if(idx<=0) return;
          const tmp = q.options[idx-1];
          q.options[idx-1] = q.options[idx];
          q.options[idx] = tmp;
          renderOptions(q);
        });
      }
      if(btnDown){
        btnDown.addEventListener('click', ()=>{
          if(idx>=q.options.length-1) return;
          const tmp = q.options[idx+1];
          q.options[idx+1] = q.options[idx];
          q.options[idx] = tmp;
          renderOptions(q);
        });
      }

row.querySelector('.iconBtn.danger').addEventListener('click', ()=>{
        q.options.splice(idx,1);
        if(!q.options.some(x=>x.correct) && q.options[0]) q.options[0].correct = true;
        renderOptions(q);
      });
      optList.appendChild(row);
    });
  }

  function syncTypeUI(){
    const t = editType.value;
    if(t === 'input'){
      choiceBox.style.display = 'none';
      inputBox.style.display = 'block';
    }else{
      choiceBox.style.display = 'block';
      inputBox.style.display = 'none';
    }
  }
  editType.addEventListener('change', syncTypeUI);

  function openEdit(index){
    editingIndex = index;
    const q = (index===null || index===undefined) ? newQuestion() : deepClone(cfg.questions[index]);

    editHdr.textContent = (index===null || index===undefined) ? "Новый вопрос" : `Вопрос #${index+1}`;
    editPoints.value = Number(q.points||10);
    editTimerMode.value = q.timerEnabled ? 'on' : 'off';
    editTimerSec.value = Number(q.timerSeconds||30);
    editType.value = q.type || 'choice';
    editText.value = q.text || '';
    editImg.value = q.image || '';
    editCorrect.value = q.correct || '';

    syncTypeUI();
    renderOptions(q);

    document.getElementById('btnAddOpt').onclick = ()=>{
      q.options.push({text:'', correct: q.options.length===0});
      renderOptions(q);
    };

    document.getElementById('btnSaveQ').onclick = ()=>{
      q.points = Number(editPoints.value||10);
      q.timerEnabled = (editTimerMode.value === 'on');
      q.timerSeconds = Number(editTimerSec.value||30);
      q.type = editType.value;
      q.text = editText.value || '';
      q.image = (editImg.value || '').trim();
      q.correct = (editCorrect.value || '').trim();

      if(q.type === 'choice'){
        q.options = (q.options||[]).map(x=>({text: x.text||'', correct: !!x.correct}));
        if(!q.options.length) q.options = [{text:'', correct:true}];
        if(!q.options.some(x=>x.correct)) q.options[0].correct = true;
      }else{
        q.options = [];
      }

      if(index===null || index===undefined){
        cfg.questions.push(q);
      }else{
        cfg.questions[index] = q;
      }
      renderQuestionList();
      updatePreview();
      closeEdit();
      toast("Вопрос сохранён");
    };

    editBack.classList.add('on');
  }

  renderQuestionList();
  updatePreview();
}

/* ---------- Boot ---------- */
(function boot(){
  const unlock = async ()=>{ try{ await AudioKit.unlock(); }catch(e){} };
  window.addEventListener('pointerdown', unlock, {once:true});

  if(isGame){
    let cfg = defaultCfg();
    try{
      cfg = b64uDecode(params.get('game'));
    }catch(e){}
    cfg = Object.assign(defaultCfg(), cfg || {});
    cfg.questions = Array.isArray(cfg.questions) ? cfg.questions : [];
    cfg.shot = Object.assign({variant:'pif', volume:0.7}, cfg.shot || {});
    mountGame(cfg);
  } else {
    mountEditor();
  }
})();
</script>
</body>
</html>
