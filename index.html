<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä + –∏–≥—Ä–∞</title>
<style>
:root{
  --bg1:#0b1220; --bg2:#070b12;
  --card:rgba(255,255,255,.06);
  --stroke:rgba(255,255,255,.12);
  --txt:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.65);
  --gold:#d6b25e;
  --orange:#ff9a3c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 650px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
    radial-gradient(900px 650px at 80% 30%, rgba(214,178,94,.10), transparent 65%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
}
a{color:inherit}
button,input,select,textarea{font:inherit}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0}

/* layout */
.shell{display:grid; grid-template-columns: 420px 1fr; gap:14px; padding:14px; height:100%}
@media (max-width:1100px){ .shell{grid-template-columns:1fr; height:auto} }
.panel{
  border:1px solid rgba(255,255,255,.10);
  border-radius:22px;
  background:rgba(0,0,0,.25);
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  overflow:hidden;
}
.panelHeader{
  padding:14px 16px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
  border-bottom:1px solid rgba(255,255,255,.08);
}
.panelHeader h1{margin:0;font-size:18px}
.panelBody{padding:14px 14px 90px; overflow:auto; max-height:calc(100vh - 28px)}
.card{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  margin-bottom:12px;
}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="text"], input[type="number"], select, textarea{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.28);
  color:var(--txt);
  outline:none;
}
textarea{min-height:86px; resize:vertical}
.row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
.row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
.inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:var(--txt);
  cursor:pointer;
}
.btn:hover{background:rgba(255,255,255,.08)}
.btnGold{
  border-color:rgba(214,178,94,.38);
  background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.06));
}
.btnDanger{
  border-color:rgba(255,90,90,.35);
  background:linear-gradient(180deg, rgba(255,90,90,.14), rgba(255,90,90,.05));
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:7px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  font-size:12px; color:var(--muted);
}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.25); color:rgba(255,255,255,.85)}
.list{display:flex;flex-direction:column;gap:10px}
.qItem{
  display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
  padding:12px; border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
}
.qTitle{font-weight:600}
.qMeta{margin-top:4px}
.iconBtn{
  width:40px; height:40px; border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  cursor:pointer;
}
.iconBtn:hover{background:rgba(255,255,255,.08)}
.iconRow{display:flex; gap:8px}

/* preview iframe */
.previewWrap{position:relative; height:100%}
.previewHead{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; gap:10px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0))}
.previewHead h2{margin:0;font-size:18px}
.previewBody{height:calc(100% - 60px)}
#previewFrame{width:100%; height:100%; border:0; display:block; background:#000}
@media (max-width:1100px){ .previewBody{height:70vh} }

/* modal editor */
.backdrop{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); backdrop-filter: blur(6px); z-index:50}
.modal{
  width:min(860px,calc(100vw - 20px));
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(12,18,30,.96), rgba(8,10,16,.96));
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.modalHead{padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(255,255,255,.08)}
.modalHead b{font-size:14px}
.modalBody{padding:14px}
.modalFoot{padding:12px 14px; border-top:1px solid rgba(255,255,255,.08); display:flex; justify-content:flex-end; gap:10px}
.timerPill{
  position:absolute; left:50%; top:10px; transform:translateX(-50%);
  padding:6px 10px; border-radius:999px;
  background:rgba(255,154,60,.18);
  border:1px solid rgba(255,154,60,.45);
  color:#ffd7b1;
  font-weight:700;
  letter-spacing:.2px;
  display:none;
  animation:pulse 1.2s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{filter:drop-shadow(0 0 0 rgba(255,154,60,.0)); transform:translateX(-50%) scale(1)}
  50%{filter:drop-shadow(0 0 14px rgba(255,154,60,.20)); transform:translateX(-50%) scale(1.03)}
}
.optLine{display:grid; grid-template-columns: 28px 1fr auto; gap:8px; align-items:center; margin-top:8px}
.optLine input[type="radio"]{transform:scale(1.05)}
.miniX{width:34px; height:34px; border-radius:12px}
.mediaLine{display:grid; grid-template-columns: 34px 1fr 34px; gap:8px; align-items:center}
.mediaIcon{
  width:34px; height:34px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
  display:grid; place-items:center; background:rgba(0,0,0,.25); color:rgba(255,255,255,.85)
}
.hintRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

/* version */
.versionTag{
  position:fixed; right:14px; bottom:14px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.32);
  font-size:12px;
  color:rgba(255,255,255,.80);
  z-index:60;
}
</style>
</head>
<body>

<script>
/* =======================================================================
   –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –¢–ò–† ‚Äî –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª:
   - –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: –†–ï–î–ê–ö–¢–û–† + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (iframe)
   - —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º ?game=... : –ò–ì–†–ê
   ======================================================================= */
const VERSION = 16;

/* ---------- helpers ---------- */
const $ = (id)=>document.getElementById(id);
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function base64UrlEncode(str){
  const utf8 = new TextEncoder().encode(str);
  let bin = "";
  utf8.forEach(b=>bin += String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function base64UrlDecode(b64url){
  let s = b64url.replace(/-/g,'+').replace(/_/g,'/');
  while(s.length%4) s+='=';
  const bin = atob(s);
  const bytes = new Uint8Array([...bin].map(ch=>ch.charCodeAt(0)));
  return new TextDecoder().decode(bytes);
}
function isProbablyUrl(s){
  return /^https?:\/\//i.test(s) || /^data:/i.test(s);
}
function normalizeBgUrl(s){
  if(!s) return "";
  if(isProbablyUrl(s)) return s;
  // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–∏–º—è —Ñ–∞–π–ª–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
  if(s.startsWith("./") || s.startsWith("../") || s.startsWith("/")) return s;
  return "./" + s;
}
function safeJsonParse(s, fallback){
  try{ return JSON.parse(s); }catch(e){ return fallback; }
}

/* ---------- config ---------- */
function defaultConfig(){
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamCount: 3,
    autoNextTeam: true,
    useLatex: false,
    // —Ñ–æ–Ω ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—â–µ–º —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:
    bgUrl: "bg_forest.jpg.png",
    shotPreset: "snap",
    shotVol: 0.70,
    questions: [] // –ë–ï–ó –ø—Ä–∏–º–µ—Ä–æ–≤ ‚Äî —á–µ–ª–æ–≤–µ–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–∞–º
  };
}
</script>

<div id="app"></div>

<script>
/* ============================ GAME MODE ============================ */
function renderGame(G){
  // ---- markup
  document.body.innerHTML = `
  <div class="gameRoot" style="display:block">
    <div class="gameStage" id="gameStage">
      <div class="gameHud" style="position:absolute; left:18px; right:18px; top:16px; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.32); backdrop-filter: blur(10px); box-shadow:0 14px 34px rgba(0,0,0,.42)">
        <div style="min-width:220px">
          <div id="gTitle" style="font-weight:900; letter-spacing:.2px; font-size:18px; line-height:1.1">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä</div>
          <div class="small" style="margin-top:3px;color:rgba(255,255,255,.72);font-size:12px">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <div class="pill" style="padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.28);font-weight:800;font-size:12px">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <span id="gActiveTeam">–ö–æ–º–∞–Ω–¥–∞ 1</span></div>
          <div class="pill" style="padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.28);font-weight:800;font-size:12px">–¶–µ–ª–∏: <span id="gLeft">0/0</span></div>
          <button id="btnHelp" class="btn" style="padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.28);color:rgba(255,255,255,.9);font-weight:800;font-size:12px;cursor:pointer">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
          <button id="btnReset" class="btn" style="padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:rgba(255,255,255,.9);font-weight:800;font-size:12px;cursor:pointer">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="teams t3" id="teams" style="position:absolute; left:18px; right:18px; top:86px; display:flex; gap:10px; align-items:stretch; justify-content:flex-start; flex-wrap:wrap"></div>

      <div class="arena" id="arena" style="position:absolute; left:18px; right:18px; bottom:18px; top:156px; border-radius:22px; border:1px solid rgba(255,255,255,.12); overflow:hidden; background:transparent; box-shadow:0 18px 44px rgba(0,0,0,.45)">
        <div class="targets" id="targets" style="position:absolute; inset:0"></div>
        <div class="cross" id="cross" style="position:absolute; width:72px; height:72px; border-radius:999px; border:2px solid rgba(214,178,94,.85); box-shadow:0 0 0 4px rgba(214,178,94,.10), 0 0 22px rgba(214,178,94,.14); pointer-events:none; transform:translate(-100px,-100px)"></div>
        <div id="shotFlash" style="position:absolute; inset:0; pointer-events:none; opacity:0; background:radial-gradient(140px 140px at 50% 50%, rgba(255,154,60,.22), rgba(0,0,0,0) 70%); transition:opacity .14s ease"></div>
      </div>

      <div class="qBackdrop" id="qBackdrop" style="position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.60); backdrop-filter: blur(6px); z-index:80">
        <div style="position:relative; width:min(860px,calc(100vw - 20px)); border-radius:22px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(12,18,30,.96), rgba(8,10,16,.96)); box-shadow:0 24px 70px rgba(0,0,0,.55); overflow:hidden">
          <div class="timerPill" id="qTimerFloat">30 —Å–µ–∫</div>
          <div style="padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(255,255,255,.08)">
            <b id="qHead">–í–æ–ø—Ä–æ—Å</b>
            <button class="btn" id="qClose" style="padding:8px 10px;border-radius:14px">‚úï</button>
          </div>
          <div style="padding:14px">
            <div id="qTextShow" style="font-size:16px; font-weight:700; line-height:1.25"></div>

            <div id="qMedia" style="display:none; margin-top:10px; gap:10px; align-items:center">
              <img id="qImg" alt="" style="max-width:240px; max-height:140px; border-radius:16px; border:1px solid rgba(255,255,255,.14); object-fit:cover; background:rgba(0,0,0,.2)"/>
              <audio id="qAudio" controls style="width:280px"></audio>
            </div>

            <div id="optGrid" style="margin-top:12px; display:grid; gap:10px"></div>

            <div id="inputWrap" style="margin-top:12px; display:none; gap:10px; align-items:center">
              <input id="answerInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." style="flex:1"/>
              <button class="btn btnGold" id="submitInput">–û—Ç–≤–µ—Ç</button>
            </div>

            <div class="small" style="margin-top:10px">A/B/C/D ‚Äî –≤—ã–±–æ—Ä ‚Ä¢ Enter ‚Äî –æ—Ç–≤–µ—Ç ‚Ä¢ Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="versionTag">–í–µ—Ä—Å–∏—è ${VERSION} ‚Ä¢ game</div>
  `;

  // ---- background (no transparency)
  const gameStage = document.getElementById('gameStage');
  const bgUrlStage = normalizeBgUrl(G.bgUrl);
  if(bgUrlStage){
    gameStage.classList.add('hasImg');
    gameStage.style.setProperty('--img', `url("${bgUrlStage}")`);
    gameStage.style.background = `
      radial-gradient(900px 650px at 65% 30%, rgba(0,0,0,.20), transparent 70%),
      linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.25)),
      url("${bgUrlArena}") center/cover no-repeat
    `;
  }else{
    gameStage.style.background = `
      radial-gradient(1100px 700px at 25% 15%, rgba(255,255,255,.10), transparent 55%),
      radial-gradient(900px 650px at 75% 30%, rgba(214,178,94,.14), transparent 60%),
      linear-gradient(180deg, #0a0f18, #070a10)
    `;
  }

  // ---- state
  const teamsEl = document.getElementById('teams');
  const targetsEl = document.getElementById('targets');
  const arena = document.getElementById('arena');
  // arena background (opaque photo + cinematic grade) + slight parallax for 3D feel
  const bgUrlArena = normalizeBgUrl((G && G.bgUrl) ? G.bgUrl : "");
  if(bgUrlArena){
    arena.style.background = `linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.18)), url("${bgUrlArena}") center/cover no-repeat`;
    arena.style.backgroundSize = "112% 112%";
    arena.dataset.hasbg = "1";
  }else{
    arena.style.background = `radial-gradient(900px 520px at 50% 15%, rgba(255,255,255,.06), transparent 60%), linear-gradient(180deg, #0b1018, #070a10)`;
    arena.style.backgroundSize = "auto";
    arena.dataset.hasbg = "0";
  }

  const cross = document.getElementById('cross');
  const shotFlash = document.getElementById('shotFlash');

  const qBackdrop = document.getElementById('qBackdrop');
  const qClose = document.getElementById('qClose');
  const qHead = document.getElementById('qHead');
  const qTextShow = document.getElementById('qTextShow');
  const qMedia = document.getElementById('qMedia');
  const qImg = document.getElementById('qImg');
  const qAudio = document.getElementById('qAudio');
  const optGrid = document.getElementById('optGrid');
  const inputWrap = document.getElementById('inputWrap');
  const answerInput = document.getElementById('answerInput');
  const submitInput = document.getElementById('submitInput');
  const qTimerFloat = document.getElementById('qTimerFloat');

  const gTitle = document.getElementById('gTitle');
  const gActiveTeam = document.getElementById('gActiveTeam');
  const gLeft = document.getElementById('gLeft');
  const gHelp = document.getElementById('gHelp');
  const gReset = document.getElementById('gReset');

  const teamCount = clamp(Number(G.teamCount)||3,1,3);
  const questions = Array.isArray(G.questions)? G.questions : [];
  let used = new Set();
  let scores = new Array(teamCount).fill(0);
  let activeTeam = 0;
  let currentQ = null;
  let timerId = null;
  let timerLeft = 0;

  // --- team names stored per game config hash
  const gameKey = "mtir_teamNames_" + base64UrlEncode(JSON.stringify({t:teamCount, q:questions.length})).slice(0,16);
  let teamNames = safeJsonParse(localStorage.getItem(gameKey), null);
  if(!Array.isArray(teamNames) || teamNames.length!==teamCount){
    teamNames = new Array(teamCount).fill(0).map((_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
  }

  function saveTeamNames(){
    try{ localStorage.setItem(gameKey, JSON.stringify(teamNames)); }catch(e){}
  }

  // ---- audio (shot + echo)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx = null;
  function ensureAudio(){
    if(!actx) actx = new AudioCtx();
    if(actx.state==="suspended") actx.resume();
  }
  function playShot(){
    ensureAudio();
    const t0 = actx.currentTime;
    const vol = clamp(Number(G.shotVol)||0.7, 0, 1);
    // preset synthesis
    const preset = G.shotPreset || "snap";
    const out = actx.createGain(); out.gain.value = vol*0.9; out.connect(actx.destination);

    const noise = actx.createBufferSource();
    const buf = actx.createBuffer(1, actx.sampleRate*0.08, actx.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * Math.exp(-i/(data.length/5));
    noise.buffer = buf;

    const nGain = actx.createGain(); nGain.gain.setValueAtTime(preset==="laser"?0.18:0.35, t0);
    nGain.gain.exponentialRampToValueAtTime(0.0001, t0 + (preset==="boom"?0.12:0.08));
    noise.connect(nGain).connect(out);
    noise.start(t0);

    if(preset!=="snap"){
      const osc = actx.createOscillator();
      osc.type = preset==="laser" ? "sawtooth" : "triangle";
      const oGain = actx.createGain();
      oGain.gain.setValueAtTime(preset==="laser"?0.18:0.14, t0);
      oGain.gain.exponentialRampToValueAtTime(0.0001, t0 + (preset==="boom"?0.18:0.10));
      const f0 = preset==="laser"? 880 : 220;
      osc.frequency.setValueAtTime(f0, t0);
      osc.frequency.exponentialRampToValueAtTime(preset==="laser"?240:120, t0 + (preset==="boom"?0.18:0.10));
      osc.connect(oGain).connect(out);
      osc.start(t0); osc.stop(t0 + 0.2);
    }

    // echo (quiet second short tone after 150ms)
    const echoT = t0 + 0.15;
    const osc2 = actx.createOscillator();
    const g2 = actx.createGain();
    g2.gain.setValueAtTime(vol*0.10, echoT);
    g2.gain.exponentialRampToValueAtTime(0.0001, echoT + 0.10);
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(560, echoT);
    osc2.connect(g2).connect(actx.destination);
    osc2.start(echoT);
    osc2.stop(echoT + 0.12);
  }
  function playHitOrMiss(hit){
    ensureAudio();
    const t0 = actx.currentTime;
    const g = actx.createGain(); g.gain.value = 0.18; g.connect(actx.destination);
    const osc = actx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(hit? 740: 220, t0);
    osc.frequency.exponentialRampToValueAtTime(hit? 980: 160, t0+0.12);
    osc.connect(g);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+0.16);
    osc.start(t0); osc.stop(t0+0.18);
  }

  // ---- UI
  gTitle.textContent = G.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";

  function setTeams(n){
    teamsEl.className = "teams t" + n;
    teamsEl.innerHTML = "";
    for(let i=0;i<n;i++){
      const card = document.createElement('div');
      card.className = "teamCard" + (i===activeTeam ? " active" : "");
      card.style.cssText = "background:rgba(0,0,0,.34);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:12px;box-shadow:0 10px 26px rgba(0,0,0,.35);cursor:pointer";
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <input class="teamName" data-i="${i}" value="${teamNames[i]||("–ö–æ–º–∞–Ω–¥–∞ "+(i+1))}"
            style="width:150px;max-width:52vw;padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.28);color:rgba(255,255,255,.92)"/>
          <span class="pill" style="padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);font-size:12px;color:rgba(255,255,255,.80)">${i===activeTeam?'üéØ –°–µ–π—á–∞—Å':'‚õî –ù–µ —Å–µ–π—á–∞—Å'}</span>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:space-between;color:rgba(255,255,255,.78)">
          <span>–û—á–∫–∏</span> <strong id="sc_${i}" style="color:rgba(255,255,255,.92)">${scores[i]||0}</strong>
        </div>
      `;
      card.addEventListener('click', (e)=>{
        // don't steal focus from input
        if(e.target && e.target.classList && e.target.classList.contains('teamName')) return;
        activeTeam = i;
        refreshTeams();
      });
      teamsEl.appendChild(card);
    }
    // input events
    teamsEl.querySelectorAll('.teamName').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const i = Number(inp.dataset.i);
        teamNames[i] = inp.value.trim() || ("–ö–æ–º–∞–Ω–¥–∞ "+(i+1));
        saveTeamNames();
        refreshTeams();
      });
      inp.addEventListener('click', (e)=>e.stopPropagation());
    });
    refreshTeams();
  }

  function refreshTeams(){
    [...teamsEl.children].forEach((c,i)=>{
      c.classList.toggle('active', i===activeTeam);
      const pill = c.querySelector('.pill');
      if(pill) pill.textContent = i===activeTeam ? 'üéØ –°–µ–π—á–∞—Å' : '‚õî –ù–µ —Å–µ–π—á–∞—Å';
      const sc = c.querySelector('#sc_'+i);
      if(sc) sc.textContent = scores[i]||0;
    });
    gActiveTeam.textContent = teamNames[activeTeam] || ("–ö–æ–º–∞–Ω–¥–∞ "+(activeTeam+1));
    gLeft.textContent = `${used.size}/${questions.length}`;
  }

  function placeTargets(){
    targetsEl.innerHTML = "";
    const N = questions.length;
    if(N===0){
      const msg = document.createElement('div');
      msg.style.cssText="position:absolute;inset:0;display:grid;place-items:center;color:rgba(255,255,255,.75);text-align:center;padding:20px";
      msg.innerHTML = `<div>
        <div style="font-weight:800;font-size:18px">–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>
        <div class="small" style="margin-top:8px">–û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã, –∑–∞—Ç–µ–º —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe.</div>
      </div>`;
      targetsEl.appendChild(msg);
      gLeft.textContent = `0/0`;
      return;
    }

    for(let i=0;i<N;i++){
      const t = document.createElement('button');
      t.className = "target";
      // upper part: 12%..48%
      const x = 8 + Math.random()*84;
      const y = 14 + Math.random()*24;
      const depth = 0.7 + Math.random()*0.6; // farther -> smaller
      const size = 70 * (1/depth);
      t.style.cssText = `
        position:absolute; left:${x}%; top:${y}%;
        width:${size}px; height:${size}px;
        border-radius:999px;
        border:2px solid rgba(214,178,94,1);
        background:radial-gradient(circle at 40% 35%, rgba(255,255,255,.30), rgba(255,255,255,.10) 45%, rgba(0,0,0,.55) 72%);
        box-shadow: 0 14px 28px rgba(0,0,0,.50), 0 0 0 7px rgba(214,178,94,.14), 0 0 26px rgba(214,178,94,.18);
        color:rgba(255,255,255,.90);
        font-weight:800;
        cursor:pointer;
        transform:translate(-50%,-50%);
        filter:contrast(1.15) saturate(1.05);
        
      `;
      t.dataset.q = String(i);
      t.innerHTML = `<span style="font-size:16px; text-shadow:0 2px 10px rgba(0,0,0,.55)">${i+1}</span>`;
      // float animation (parallax-ish)
      const dx = (Math.random()*14-7);
      const dur = 6 + Math.random()*6;
      t.animate([
        { transform:`translate(-50%,-50%) translate(${dx}px,0px)` },
        { transform:`translate(-50%,-50%) translate(${-dx}px,-10px)` },
        { transform:`translate(-50%,-50%) translate(${dx}px,0px)` },
      ], {duration:dur*1000, iterations:Infinity, easing:"ease-in-out"});

      t.addEventListener('click', ()=>{
        if(used.has(i)) return;
        playShot();
        shotFlash.style.opacity = "1";
        setTimeout(()=>shotFlash.style.opacity="0", 120);
        openQuestion(i);
      });

      targetsEl.appendChild(t);
    }
    refreshTeams();
  }

  // crosshair follows mouse
  arena.addEventListener('mousemove', (e)=>{
    const r = arena.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    
    if(arena.dataset.hasbg==="1"){
      const px = 50 + ((x / r.width) - 0.5) * 6;
      const py = 50 + ((y / r.height) - 0.5) * 6;
      arena.style.backgroundPosition = `${px}% ${py}%`;
    }
cross.style.transform = `translate(${x-36}px,${y-36}px)`;
  });
  arena.addEventListener('mouseleave', ()=>{
    cross.style.transform = "translate(-120px,-120px)";
  });

  // question modal logic
  function closeQuestion(){
    qBackdrop.style.display = "none";
    currentQ = null;
    if(timerId){ clearInterval(timerId); timerId=null; }
    qTimerFloat.style.display = "none";
    optGrid.innerHTML = "";
    inputWrap.style.display = "none";
    qMedia.style.display = "none";
    answerInput.value = "";
  }

  function startTimer(seconds){
    if(timerId) clearInterval(timerId);
    timerLeft = seconds;
    if(!seconds || seconds<=0){
      qTimerFloat.style.display = "none";
      return;
    }
    qTimerFloat.style.display = "block";
    qTimerFloat.textContent = `${timerLeft} —Å–µ–∫`;
    timerId = setInterval(()=>{
      timerLeft--;
      qTimerFloat.textContent = `${timerLeft} —Å–µ–∫`;
      if(timerLeft<=0){
        clearInterval(timerId); timerId=null;
        // timeout = miss
        answerResult(false, true);
      }
    }, 1000);
  }

  function openQuestion(i){
    currentQ = { idx:i, data:questions[i] };
    qBackdrop.style.display = "grid";

    const q = questions[i] || {};
    qHead.textContent = `–í–æ–ø—Ä–æ—Å ${i+1}`;
    qTextShow.textContent = q.text || "‚Äî";

    // media
    const img = q.img ? q.img.trim() : "";
    const audio = q.audio ? q.audio.trim() : "";
    if(img || audio){
      qMedia.style.display = "flex";
      if(img){ qImg.src = img; qImg.style.display="block"; }
      else{ qImg.removeAttribute('src'); qImg.style.display="none"; }
      if(audio){ qAudio.src = audio; qAudio.style.display="block"; }
      else{ qAudio.removeAttribute('src'); qAudio.style.display="none"; }
    }else{
      qMedia.style.display = "none";
    }

    // timer (can be disabled per question)
    const t = Number(q.timer||0);
    startTimer(t>0 ? t : 0);

    // type
    const type = q.type || "choice";
    optGrid.innerHTML = "";
    inputWrap.style.display = "none";

    if(type==="input"){
      inputWrap.style.display = "flex";
      answerInput.focus();
      const correct = Array.isArray(q.answers) ? q.answers : [];
      const correctNorm = correct.map(s=>String(s).trim().toLowerCase()).filter(Boolean);

      const submit = ()=>{
        const val = (answerInput.value||"").trim().toLowerCase();
        const ok = val && correctNorm.includes(val);
        answerResult(ok, false);
      };
      submitInput.onclick = submit;
      answerInput.onkeydown = (ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); submit(); } };
    }else{
      // choices
      const opts = Array.isArray(q.options) ? q.options : [];
      const correctIndex = Number(q.correctIndex||0);
      const shuffled = shuffle(opts.map((txt,idx)=>({txt:String(txt), idx})));
      // build
      let selected = null;

      shuffled.forEach((o, k)=>{
        const b = document.createElement('button');
        b.className="btn";
        b.style.cssText="text-align:left;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.24)";
        const letter = String.fromCharCode(65+k);
        b.innerHTML = `<span style="display:inline-flex;min-width:28px;justify-content:center;margin-right:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:4px 8px">${letter}</span> ${o.txt}`;
        b.addEventListener('click', ()=>{
          selected = o.idx;
          [...optGrid.children].forEach(x=>x.style.outline="none");
          b.style.outline = "2px solid rgba(214,178,94,.45)";
          // auto submit on click
          answerResult(selected===correctIndex, false);
        });
        optGrid.appendChild(b);
      });

      // keyboard A/B/C/D + Enter: (Enter does nothing because click submits)
      window.onkeydown = (ev)=>{
        if(qBackdrop.style.display!=="grid") return;
        if(ev.key==="Escape"){ closeQuestion(); return; }
        const k = ev.key.toUpperCase();
        const idx = k.charCodeAt(0)-65;
        if(idx>=0 && idx<optGrid.children.length){
          optGrid.children[idx].click();
        }
      };
    }
  }

  function answerResult(ok, timeout){
    if(!currentQ) return;
    // stop timer
    if(timerId){ clearInterval(timerId); timerId=null; }
    qTimerFloat.style.display = "none";

    // mark used
    used.add(currentQ.idx);

    // points
    const q = currentQ.data || {};
    const pts = Number(q.pts||10);
    if(ok) scores[activeTeam] = (scores[activeTeam]||0) + pts;

    // target fall animation
    const btn = targetsEl.querySelector(`[data-q="${currentQ.idx}"]`);
    if(btn){
      btn.style.pointerEvents="none";
      btn.animate([
        { transform:btn.style.transform || "translate(-50%,-50%)", opacity:1, filter:"contrast(1.15) saturate(1.05)" },
        { transform:"translate(-50%,-50%) rotate(" + (ok? "-14deg":"8deg") + ") scale(" + (ok?0.78:0.88) + ") translateY(" + (ok?28:16) + "px)", opacity: ok?0.35:0.55, filter:"grayscale(1) brightness(.85)" }
      ], {duration:320, easing:"ease-out", fill:"forwards"});
    }

    // shake on miss/timeout
    if(!ok){
      arena.animate([{transform:"translate(0,0)"},{transform:"translate(6px,-2px)"},{transform:"translate(-5px,2px)"},{transform:"translate(0,0)"}],
        {duration:220, easing:"ease-in-out"});
    }

    playHitOrMiss(ok);
    refreshTeams();
    closeQuestion();

    // auto next team
    if(G.autoNextTeam){
      activeTeam = (activeTeam + 1) % teamCount;
      refreshTeams();
    }

    // end
    if(used.size >= questions.length){
      setTimeout(()=>{
        alert("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n\n" + scores.map((s,i)=>`${teamNames[i]||("–ö–æ–º–∞–Ω–¥–∞ "+(i+1))}: ${s} –æ—á.`).join("\n"));
      }, 150);
    }
  }

  // help / reset
  gHelp.onclick = ()=>{
    alert("–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–º–∞–Ω–¥—ã)\n2) –ù–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n\n–ö–æ–º–∞–Ω–¥–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤–ø–∏—Å–∞—Ç—å –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–æ–º–∞–Ω–¥.");
  };
  gReset.onclick = ()=>{
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –æ—á–∫–∏ –∏ –º–∏—à–µ–Ω–∏?")) return;
    used.clear();
    scores = new Array(teamCount).fill(0);
    activeTeam = 0;
    placeTargets();
    refreshTeams();
  };

  // close modal
  qClose.onclick = closeQuestion;
  qBackdrop.addEventListener('click', (e)=>{ if(e.target===qBackdrop) closeQuestion(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==="Escape" && qBackdrop.style.display==="grid") closeQuestion(); });

  // init
  setTeams(teamCount);
  placeTargets();
  refreshTeams();
}

/* ============================ EDITOR MODE ============================ */
function renderEditor(){
  const root = document.getElementById('app');
  root.innerHTML = `
    <div class="shell">
      <div class="panel">
        <div class="panelHeader">
          <div>
            <h1>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</h1>
            <div class="small">–°–æ–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe –¥–ª—è Genially</div>
          </div>
          <button class="btn btnGold" id="copyIframe">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
        </div>
        <div class="panelBody" id="editorScroll">

          <div class="card">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="title" type="text" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä"/>
          </div>

          <div class="card">
            <label>–ö–æ–º–∞–Ω–¥—ã</label>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)</label>
            <input id="teamCount" type="number" min="1" max="3" value="3"/>
            <div class="row" style="margin-top:10px">
              <div>
                <label>–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞</label>
                <select id="autoNextTeam">
                  <option value="1" selected>–í–∫–ª—é—á—ë–Ω</option>
                  <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
                </select>
              </div>
              <div>
                <label>LaTeX (–≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã)</label>
                <select id="useLatex">
                  <option value="0" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
                  <option value="1">–í–∫–ª—é—á—ë–Ω</option>
                </select>
              </div>
            </div>
          </div>

          <div class="card">
            <label>–§–æ–Ω –∏–≥—Ä—ã (–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞)</label>
            <input id="bgUrl" type="text" value="bg_forest.jpg.png" placeholder="bg_forest.jpg.png –∏–ª–∏ https://..."/>
            <div class="small">–ï—Å–ª–∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å <span class="kbd">index.html</span>, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–µ–Ω–∏ (–∫–∞–∫ –≤—ã—à–µ).</div>
          </div>

          <div class="card">
            <label>–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞</label>
            <div class="row">
              <div>
                <label>–í–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</label>
                <select id="shotPreset">
                  <option value="snap" selected>–ö–æ—Ä–æ—Ç–∫–∏–π ‚Äú–ø–∏—Ñ‚Äù</option>
                  <option value="laser">–õ–∞–∑–µ—Ä–Ω—ã–π</option>
                  <option value="boom">–ì–ª—É—Ö–æ–π ‚Äú–±—É–º‚Äù</option>
                </select>
              </div>
              <div>
                <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
                <input id="shotVol" type="range" min="0" max="100" value="70"/>
              </div>
            </div>
            <div class="small">–í –∏–≥—Ä–µ –≤—ã—Å—Ç—Ä–µ–ª –∑–≤—É—á–∏—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∏—à–µ–Ω–∏.</div>
          </div>

          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
              <div>
                <div style="font-weight:800">–í–æ–ø—Ä–æ—Å—ã</div>
                <div class="small">–ú–∏—à–µ–Ω–µ–π –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.</div>
              </div>
              <span class="badge"><span>–í—Å–µ–≥–æ:</span> <b id="qCount">0</b></span>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
              <button class="btn btnGold" id="addQ">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btnDanger" id="clearQ">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="list" id="qList" style="margin-top:12px"></div>
          </div>

          <div class="card">
            <div style="font-weight:800;margin-bottom:6px">Genially</div>
            <div class="small">–ù–∞–∂–º–∏—Ç–µ <span class="kbd">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</span> ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –≤—Å—Ç–∞–≤–∫—É.</div>
            <div class="small" style="margin-top:6px">–ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É –ø–æ —Å—Å—ã–ª–∫–µ –≤–∏–¥–∞: <span class="kbd">index.html?game=...</span></div>
          </div>

        </div>
      </div>

      <div class="panel previewWrap">
        <div class="previewHead">
          <div>
            <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <div class="small">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>
          </div>
          <span class="badge">—Ñ–æ–Ω + –º–∏—à–µ–Ω–∏ + –≤–æ–ø—Ä–æ—Å—ã</span>
        </div>
        <div class="previewBody">
          <iframe id="previewFrame" allow="autoplay; fullscreen"></iframe>
        </div>
      </div>
    </div>

    <!-- modal -->
    <div class="backdrop" id="backdrop">
      <div class="modal">
        <div class="modalHead">
          <b id="mTitle">–í–æ–ø—Ä–æ—Å</b>
          <button class="btn" id="mClose" style="padding:8px 10px;border-radius:14px">‚úï</button>
        </div>
        <div class="modalBody" style="position:relative">
          <div class="timerPill" id="mTimerPreview">–¢–∞–π–º–µ—Ä: 30 —Å–µ–∫</div>

          <div class="row">
            <div>
              <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
              <select id="mType">
                <option value="choice" selected>–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
                <option value="input">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
              </select>
            </div>
            <div>
              <label>–û—á–∫–∏</label>
              <input id="mPts" type="number" min="0" value="10"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>–¢–∞–π–º–µ—Ä</label>
              <div class="inline">
                <label class="badge" style="cursor:pointer">
                  <input id="mTimerOn" type="checkbox" style="margin:0 8px 0 0"/> –≤–∫–ª—é—á–∏—Ç—å
                </label>
                <input id="mTimerSec" type="number" min="1" value="30" style="width:140px" disabled/>
                <span class="small">—Å–µ–∫</span>
              </div>
            </div>
            <div>
              <label>–ú–µ–¥–∏–∞ (–ø–æ —Å—Å—ã–ª–∫–µ)</label>
              <div class="row">
                <div class="mediaLine">
                  <div class="mediaIcon">üñºÔ∏è</div>
                  <input id="mImg" type="text" placeholder="—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É"/>
                  <button class="iconBtn miniX" id="mImgX" title="—É–±—Ä–∞—Ç—å">‚úï</button>
                </div>
                <div class="mediaLine">
                  <div class="mediaIcon">üéµ</div>
                  <input id="mAudio" type="text" placeholder="—Å—Å—ã–ª–∫–∞ –Ω–∞ –º—É–∑—ã–∫—É"/>
                  <button class="iconBtn miniX" id="mAudioX" title="—É–±—Ä–∞—Ç—å">‚úï</button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
            <textarea id="mText" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
          </div>

          <div id="choiceBox" style="margin-top:12px">
            <div class="inline" style="justify-content:space-between">
              <b>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</b>
              <button class="btn" id="addOpt">Ôºã –í–∞—Ä–∏–∞–Ω—Ç</button>
            </div>
            <div class="small">–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∫—Ä—É–∂–∫–æ–º —Å–ª–µ–≤–∞.</div>
            <div id="optList"></div>
          </div>

          <div id="inputBox" style="display:none; margin-top:12px">
            <div class="inline" style="justify-content:space-between">
              <b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</b>
              <button class="btn" id="addAns">Ôºã –û—Ç–≤–µ—Ç</button>
            </div>
            <div class="small">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è (—Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω).</div>
            <div id="ansList"></div>
          </div>

        </div>
        <div class="modalFoot">
          <button class="btn" id="mCancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btnGold" id="mSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="versionTag">–í–µ—Ä—Å–∏—è ${VERSION} ‚Ä¢ editor</div>
  `;

  // ---- state
  let CFG = defaultConfig();
  // restore draft
  const draft = safeJsonParse(localStorage.getItem("mtir_editor_draft"), null);
  if(draft && typeof draft==="object"){
    CFG = {...CFG, ...draft};
    if(!Array.isArray(CFG.questions)) CFG.questions = [];
  }

  // ---- audio preview for shot preset (same synth as game)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx = null;
  function ensureAudio(){
    if(!actx) actx = new AudioCtx();
    if(actx.state==="suspended") actx.resume();
  }
  function previewShot(preset, vol){
    ensureAudio();
    const t0 = actx.currentTime;
    const out = actx.createGain(); out.gain.value = vol*0.9; out.connect(actx.destination);

    const noise = actx.createBufferSource();
    const buf = actx.createBuffer(1, actx.sampleRate*0.08, actx.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * Math.exp(-i/(data.length/5));
    noise.buffer = buf;

    const nGain = actx.createGain(); nGain.gain.setValueAtTime(preset==="laser"?0.18:0.35, t0);
    nGain.gain.exponentialRampToValueAtTime(0.0001, t0 + (preset==="boom"?0.12:0.08));
    noise.connect(nGain).connect(out);
    noise.start(t0);

    if(preset!=="snap"){
      const osc = actx.createOscillator();
      osc.type = preset==="laser" ? "sawtooth" : "triangle";
      const oGain = actx.createGain();
      oGain.gain.setValueAtTime(preset==="laser"?0.18:0.14, t0);
      oGain.gain.exponentialRampToValueAtTime(0.0001, t0 + (preset==="boom"?0.18:0.10));
      const f0 = preset==="laser"? 880 : 220;
      osc.frequency.setValueAtTime(f0, t0);
      osc.frequency.exponentialRampToValueAtTime(preset==="laser"?240:120, t0 + (preset==="boom"?0.18:0.10));
      osc.connect(oGain).connect(out);
      osc.start(t0); osc.stop(t0 + 0.2);
    }

    // echo
    const echoT = t0 + 0.15;
    const osc2 = actx.createOscillator();
    const g2 = actx.createGain();
    g2.gain.setValueAtTime(vol*0.10, echoT);
    g2.gain.exponentialRampToValueAtTime(0.0001, echoT + 0.10);
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(560, echoT);
    osc2.connect(g2).connect(actx.destination);
    osc2.start(echoT);
    osc2.stop(echoT + 0.12);
  }

  // ---- elements
  const titleEl = $('title');
  const teamCountEl = $('teamCount');
  const autoNextEl = $('autoNextTeam');
  const latexEl = $('useLatex');
  const bgEl = $('bgUrl');
  const shotPresetEl = $('shotPreset');
  const shotVolEl = $('shotVol');
  const qCountEl = $('qCount');
  const qListEl = $('qList');
  const previewFrame = $('previewFrame');

  // modal
  const backdrop = $('backdrop');
  const mClose = $('mClose');
  const mCancel = $('mCancel');
  const mSave = $('mSave');
  const mType = $('mType');
  const mPts = $('mPts');
  const mTimerOn = $('mTimerOn');
  const mTimerSec = $('mTimerSec');
  const mTimerPreview = $('mTimerPreview');
  const mText = $('mText');
  const mImg = $('mImg');
  const mAudio = $('mAudio');
  const mImgX = $('mImgX');
  const mAudioX = $('mAudioX');
  const choiceBox = $('choiceBox');
  const inputBox = $('inputBox');
  const optList = $('optList');
  const ansList = $('ansList');
  const addOpt = $('addOpt');
  const addAns = $('addAns');

  // ---- bind initial
  titleEl.value = CFG.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
  teamCountEl.value = clamp(Number(CFG.teamCount)||3,1,3);
  autoNextEl.value = CFG.autoNextTeam ? "1" : "0";
  latexEl.value = CFG.useLatex ? "1" : "0";
  bgEl.value = CFG.bgUrl || "bg_forest.jpg.png";
  shotPresetEl.value = CFG.shotPreset || "snap";
  shotVolEl.value = String(Math.round((Number(CFG.shotVol)||0.7)*100));

  function persist(){
    try{ localStorage.setItem("mtir_editor_draft", JSON.stringify(CFG)); }catch(e){}
  }
  function syncCFG(){
    CFG.title = titleEl.value.trim() || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
    CFG.teamCount = clamp(Number(teamCountEl.value||3), 1, 3);
    CFG.autoNextTeam = autoNextEl.value==="1";
    CFG.useLatex = latexEl.value==="1";
    CFG.bgUrl = bgEl.value.trim();
    CFG.shotPreset = shotPresetEl.value;
    CFG.shotVol = clamp(Number(shotVolEl.value||70)/100, 0, 1);
    persist();
    refreshPreview();
  }

  titleEl.addEventListener('input', syncCFG);
  teamCountEl.addEventListener('input', syncCFG);
  autoNextEl.addEventListener('change', syncCFG);
  latexEl.addEventListener('change', syncCFG);
  bgEl.addEventListener('input', syncCFG);

  shotPresetEl.addEventListener('change', ()=>{
    syncCFG();
    previewShot(CFG.shotPreset, CFG.shotVol);
  });
  shotVolEl.addEventListener('input', syncCFG);

  // ---- questions list
  function renderQList(){
    qCountEl.textContent = String(CFG.questions.length);
    qListEl.innerHTML = "";
    if(CFG.questions.length===0){
      const empty = document.createElement('div');
      empty.className = "small";
      empty.style.padding = "8px 2px";
      empty.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª.";
      qListEl.appendChild(empty);
      return;
    }
    CFG.questions.forEach((q,idx)=>{
      const item = document.createElement('div');
      item.className = "qItem";
      const t = (q.text||"").trim();
      const head = t ? (t.length>62 ? t.slice(0,62)+"‚Ä¶" : t) : `–í–æ–ø—Ä–æ—Å ${idx+1}`;
      const meta = `${q.type==="input"?"–í–≤–æ–¥":"–í—ã–±–æ—Ä"} ‚Ä¢ ${Number(q.pts||10)} –æ—á.` + (q.timer?` ‚Ä¢ ${q.timer}—Å`:" ‚Ä¢ –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞");
      item.innerHTML = `
        <div>
          <div class="qTitle">${idx+1}. ${escapeHtml(head)}</div>
          <div class="small qMeta">${escapeHtml(meta)}</div>
        </div>
        <div class="iconRow">
          <button class="iconBtn" title="—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="iconBtn" title="—É–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        </div>
      `;
      const [editBtn, delBtn] = item.querySelectorAll('button');
      editBtn.onclick = ()=>openModal(idx);
      delBtn.onclick = ()=>{
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å?")) return;
        CFG.questions.splice(idx,1);
        persist(); renderQList(); refreshPreview();
      };
      qListEl.appendChild(item);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
  }

  $('addQ').onclick = ()=>openModal(null);
  $('clearQ').onclick = ()=>{
    if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã?")) return;
    CFG.questions = [];
    persist(); renderQList(); refreshPreview();
  };

  // ---- modal (question editor)
  let editingIndex = null;

  function buildOptLine(val, isCorrect, groupName){
    const wrap = document.createElement('div');
    wrap.className = "optLine";
    wrap.innerHTML = `
      <input type="radio" name="${groupName}"/>
      <input type="text" value="${escapeAttr(val||"")}" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."/>
      <button class="iconBtn miniX" title="—É–¥–∞–ª–∏—Ç—å">‚úï</button>
    `;
    const radio = wrap.querySelector('input[type="radio"]');
    const txt = wrap.querySelector('input[type="text"]');
    const del = wrap.querySelector('button');
    radio.checked = !!isCorrect;
    del.onclick = ()=>wrap.remove();
    return wrap;
  }
  function buildAnsLine(val){
    const wrap = document.createElement('div');
    wrap.className = "optLine";
    wrap.style.gridTemplateColumns = "1fr auto";
    wrap.innerHTML = `
      <input type="text" value="${escapeAttr(val||"")}" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç..."/>
      <button class="iconBtn miniX" title="—É–¥–∞–ª–∏—Ç—å">‚úï</button>
    `;
    wrap.querySelector('button').onclick = ()=>wrap.remove();
    return wrap;
  }
  function escapeAttr(s){
    return String(s).replace(/"/g,'&quot;');
  }

  function updateTimerPreview(){
    const on = mTimerOn.checked;
    mTimerSec.disabled = !on;
    if(on){
      const sec = clamp(Number(mTimerSec.value||30), 1, 999);
      mTimerPreview.style.display = "block";
      mTimerPreview.textContent = `–¢–∞–π–º–µ—Ä: ${sec} —Å–µ–∫`;
    }else{
      mTimerPreview.style.display = "none";
    }
  }

  mTimerOn.onchange = updateTimerPreview;
  mTimerSec.oninput = updateTimerPreview;

  mType.onchange = ()=>{
    const type = mType.value;
    choiceBox.style.display = type==="choice" ? "block" : "none";
    inputBox.style.display = type==="input" ? "block" : "none";
  };

  addOpt.onclick = ()=>{
    const group = "correctOpt";
    const line = buildOptLine("", false, group);
    optList.appendChild(line);
  };
  addAns.onclick = ()=>{
    ansList.appendChild(buildAnsLine(""));
  };

  mImgX.onclick = ()=>{ mImg.value=""; };
  mAudioX.onclick = ()=>{ mAudio.value=""; };

  function openModal(idx){
    editingIndex = idx;
    backdrop.style.display = "grid";
    const q = (idx==null) ? null : CFG.questions[idx];

    // defaults
    mType.value = q?.type || "choice";
    mPts.value = String(q?.pts ?? 10);
    mText.value = q?.text || "";
    mImg.value = q?.img || "";
    mAudio.value = q?.audio || "";

    // timer
    if(q && q.timer && Number(q.timer)>0){
      mTimerOn.checked = true;
      mTimerSec.value = String(q.timer);
    }else{
      mTimerOn.checked = false;
      mTimerSec.value = "30";
    }
    updateTimerPreview();

    // type boxes
    choiceBox.style.display = mType.value==="choice" ? "block" : "none";
    inputBox.style.display = mType.value==="input" ? "block" : "none";

    // options/answers
    optList.innerHTML = "";
    ansList.innerHTML = "";
    if(mType.value==="choice"){
      const opts = Array.isArray(q?.options) ? q.options : ["", ""];
      const ci = Number(q?.correctIndex ?? 0);
      const group = "correctOpt";
      opts.forEach((t,i)=>{
        optList.appendChild(buildOptLine(t, i===ci, group));
      });
      if(opts.length===0){
        optList.appendChild(buildOptLine("", true, group));
        optList.appendChild(buildOptLine("", false, group));
      }
    }else{
      const ans = Array.isArray(q?.answers) ? q.answers : [""];
      ans.forEach(a=>ansList.appendChild(buildAnsLine(a)));
      if(ans.length===0) ansList.appendChild(buildAnsLine(""));
    }
  }

  function closeModal(){
    backdrop.style.display = "none";
    editingIndex = null;
  }

  mClose.onclick = closeModal;
  mCancel.onclick = closeModal;
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });

  mSave.onclick = ()=>{
    const type = mType.value;
    const q = {
      type,
      pts: clamp(Number(mPts.value||10), 0, 9999),
      text: mText.value.trim(),
      timer: mTimerOn.checked ? clamp(Number(mTimerSec.value||30), 1, 9999) : 0,
      img: mImg.value.trim(),
      audio: mAudio.value.trim(),
    };

    if(type==="choice"){
      const lines = [...optList.querySelectorAll('.optLine')];
      const opts = [];
      let correctIndex = 0;
      lines.forEach((ln, i)=>{
        const radio = ln.querySelector('input[type="radio"]');
        const txt = ln.querySelector('input[type="text"]').value.trim();
        if(txt) opts.push(txt);
        if(radio && radio.checked) correctIndex = opts.length-1; // last pushed
      });
      // ensure at least 2 options
      while(opts.length<2) opts.push("...");
      q.options = opts;
      q.correctIndex = clamp(correctIndex, 0, opts.length-1);
    }else{
      const lines = [...ansList.querySelectorAll('.optLine input[type="text"]')];
      const answers = lines.map(i=>i.value.trim()).filter(Boolean);
      q.answers = answers;
    }

    if(editingIndex==null) CFG.questions.push(q);
    else CFG.questions[editingIndex] = q;

    persist();
    renderQList();
    refreshPreview();
    closeModal();
  };

  // ---- iframe build
  function buildGameUrl(){
    const g = {...CFG};
    // in iframe, we prefer relative bg (normalize at runtime in game)
    const enc = base64UrlEncode(JSON.stringify(g));
    const url = new URL(window.location.href);
    url.search = "";
    url.hash = "";
    url.searchParams.set("game", enc);
    url.searchParams.set("v", String(VERSION)); // cache buster
    return url.toString();
  }
  function refreshPreview(){
    syncCFG(); // updates CFG and persist; calls refreshPreview recursively? avoid
  }
  // prevent recursion: separate minimal refresh
  function refreshPreviewInner(){
    const src = buildGameUrl();
    if(previewFrame.src !== src) previewFrame.src = src;
  }
  // override syncCFG to call inner refresh
  function syncCFG(){
    CFG.title = titleEl.value.trim() || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
    CFG.teamCount = clamp(Number(teamCountEl.value||3), 1, 3);
    CFG.autoNextTeam = autoNextEl.value==="1";
    CFG.useLatex = latexEl.value==="1";
    CFG.bgUrl = bgEl.value.trim();
    CFG.shotPreset = shotPresetEl.value;
    CFG.shotVol = clamp(Number(shotVolEl.value||70)/100, 0, 1);
    persist();
    refreshPreviewInner();
  }

  // initial
  renderQList();
  refreshPreviewInner();

  // copy iframe
  $('copyIframe').onclick = async ()=>{
    const src = buildGameUrl();
    const code = `<iframe src="${src}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen"></iframe>`;
    try{
      await navigator.clipboard.writeText(code);
      alert("iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ ‚úÖ");
    }catch(e){
      prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe –≤—Ä—É—á–Ω—É—é:", code);
    }
  };
}

// route
(function main(){
  // kill SW caches that may block updates
  if('serviceWorker' in navigator){
    navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});
  }
  caches?.keys?.().then(keys=>keys.forEach(k=>caches.delete(k))).catch(()=>{});

  const url = new URL(window.location.href);
  const gameParam = url.searchParams.get("game");
  if(gameParam){
    let G = null;
    try{
      G = JSON.parse(base64UrlDecode(gameParam));
    }catch(e){
      G = defaultConfig();
    }
    // minimal sanitation
    if(!G || typeof G!=="object") G = defaultConfig();
    if(!Array.isArray(G.questions)) G.questions = [];
    renderGame(G);
  }else{
    renderEditor();
  }

  // version tag already in DOM for modes
})();
</script>
</body>
</html>
