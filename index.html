<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Математический тир — editor+game</title>
  <style>
    :root{
      --bg0:#0b0f14; --text:#e8eef7; --muted:rgba(232,238,247,.70);
      --neon:#ff8a2a; --neonLine: rgba(255,138,42,.38);
      --shadow: 0 14px 55px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, sans-serif; background: #080b10; color:var(--text); overflow:hidden;}

    /* Layout */
    .app{ height:100vh; display:grid; grid-template-columns: 480px 1fr; gap:16px; padding:16px; }
    .panel{ background: rgba(255,255,255,.05); border:1px solid var(--neonLine); border-radius: 22px; display:flex; flex-direction:column; overflow:hidden; }
    .scroll{ flex: 1; overflow:auto; padding: 18px; }
    .section{ background: rgba(10,14,20,.22); border: 1px solid rgba(255,138,42,.2); border-radius: 18px; padding: 14px; margin-bottom: 14px; }
    
    /* Бегунки и инпуты */
    .field-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 138, 42, 0.15); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
    input[type="range"].range { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type="range"].range::-webkit-slider-runnable-track { height: 6px; background: linear-gradient(90deg, #ff8a2a var(--percent, 0%), rgba(255,255,255,0.1) var(--percent, 0%)); border-radius: 3px; }
    input[type="range"].range::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #ff8a2a; margin-top: -6px; box-shadow: 0 0 15px rgba(255, 138, 42, 0.8); }

    /* Экраны игры */
    .gameRoot{ position:fixed; inset:0; display:flex; flex-direction:column; background:#000; }
    .arena{ position:relative; flex:1; margin: 16px; border-radius: 22px; overflow:hidden; border: 1px solid rgba(255,255,255,0.1); }
    .overlay-screen {
      position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);
    }
    .modal-box {
      width: 500px; padding: 30px; border-radius: 24px; text-align: center;
      border: 4px solid var(--box-color, #ff8a2a);
      box-shadow: var(--box-glow, none);
    }
    .btn { padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; background: #ff8a2a; color: #fff; }

    /* Остальные стили из оригинала */
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    textarea, input[type="text"] { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>

<div id="root"></div>

<script>
const VERSION = 26;
const b64uEncode = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const b64uDecode = (str) => JSON.parse(decodeURIComponent(escape(atob(str.replace(/-/g,'+').replace(/_/g,'/')))));

/* =========================== EDITOR =========================== */
function mountEditor() {
  document.getElementById('root').innerHTML = `
    <div class="app">
      <div class="panel">
        <div class="scroll">
          <div class="section">
            <h3>Стартовый экран</h3>
            <div class="field-card">
              <label>Цвет рамки</label>
              <input type="color" id="startColor" value="#ff8a2a" style="height:40px; cursor:pointer">
              <label style="margin-top:10px; display:block">
                <input type="checkbox" id="startGlow" checked> Включить свечение
              </label>
            </div>
            <div class="field-card">
              <label>Инструкция</label>
              <textarea id="startText">Выберите команду, наведите прицел на мишень и дайте правильный ответ!</textarea>
            </div>
          </div>

          <div class="section">
            <h3>Фидбек (Конец игры)</h3>
            <div class="field-card">
              <label>Ваше сообщение в конце</label>
              <textarea id="feedbackText">Отличная работа! Вы настоящие снайперы математики!</textarea>
            </div>
          </div>

          <div class="section">
            <h3>Движение мишеней</h3>
            <div class="row">
              <div class="field-card">
                <label>Радиус</label>
                <input id="targetOrbitRadius" class="range" type="range" min="0" max="200" value="0">
              </div>
              <div class="field-card">
                <label>Скорость</label>
                <input id="targetOrbitSpeed" class="range" type="range" min="0" max="10" value="0">
              </div>
            </div>
          </div>
          <button class="btn" style="width:100%" id="copyBtn">Скопировать код для Genially</button>
        </div>
      </div>
      <div class="panel"><iframe id="preview" style="width:100%; height:100%; border:0"></iframe></div>
    </div>
  `;

  const update = () => {
    const cfg = {
      startColor: document.getElementById('startColor').value,
      startGlow: document.getElementById('startGlow').checked,
      startText: document.getElementById('startText').value,
      feedbackText: document.getElementById('feedbackText').value,
      radius: document.getElementById('targetOrbitRadius').value,
      speed: document.getElementById('targetOrbitSpeed').value
    };
    document.getElementById('preview').src = location.href + '?game=' + b64uEncode(cfg);
  };

  document.querySelectorAll('input, textarea').forEach(el => el.oninput = update);
  update();
}

/* =========================== GAME =========================== */
function mountGame(cfg) {
  document.getElementById('root').innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div id="startScreen" class="overlay-screen">
          <div class="modal-box" style="--box-color:${cfg.startColor}; --box-glow:${cfg.startGlow ? '0 0 30px ' + cfg.startColor : 'none'}">
            <h2>Инструкция</h2>
            <p>${cfg.startText}</p>
            <button class="btn" onclick="document.getElementById('startScreen').remove()">Начать игру</button>
          </div>
        </div>
        
        <div id="endScreen" class="overlay-screen" style="display:none">
          <div class="modal-box" style="--box-color:${cfg.startColor}">
            <h2>Результаты</h2>
            <div id="resultsList"></div>
            <p style="margin-top:20px">${cfg.feedbackText}</p>
            <button class="btn" onclick="location.reload()">Играть снова</button>
          </div>
        </div>

        <div style="padding:20px">Здесь будет твое игровое поле... (имитация завершения через 3 сек)</div>
      </div>
    </div>
  `;

  // Пример логики окончания (в твоем коде это будет срабатывать, когда поражены все мишени)
  setTimeout(() => {
    document.getElementById('endScreen').style.display = 'flex';
    document.getElementById('resultsList').innerHTML = `
      <p>Команда "Альфа": 150 баллов</p>
      <p>Команда "Бета": 120 баллов</p>
    `;
  }, 5000);
}

const params = new URLSearchParams(location.search);
if (params.has('game')) {
  mountGame(b64uDecode(params.get('game')));
} else {
  mountEditor();
}
</script>
</body>
</html>
