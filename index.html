<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä + –∏–≥—Ä–∞</title>
<style>
  :root{
    --bg1:#0b1220; --bg2:#0a0f1a; --card:rgba(255,255,255,.06);
    --stroke:rgba(255,255,255,.10); --txt:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65); --gold:#d6b25e; --orange:#ff9a3c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.08), transparent 55%),
      radial-gradient(900px 600px at 80% 30%, rgba(214,178,94,.10), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    overflow:hidden;
  }
  .grid:before{
    content:""; position:fixed; inset:0;
    background:
      linear-gradient(to right, rgba(255,255,255,.04) 1px, transparent 1px) 0 0/120px 120px,
      linear-gradient(to bottom, rgba(255,255,255,.035) 1px, transparent 1px) 0 0/120px 120px;
    pointer-events:none;
    opacity:.55;
    mask-image: radial-gradient(900px 600px at 50% 45%, black 60%, transparent 100%);
  }
  .wrap{position:relative; height:100%; padding:16px; display:grid; grid-template-columns:420px 1fr; gap:16px}
  @media (max-width:1100px){ body{overflow:auto} .wrap{grid-template-columns:1fr; height:auto; overflow:auto} }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke);
    border-radius:22px;
    box-shadow:0 14px 40px rgba(0,0,0,.45);
    overflow:hidden;
  }
  .panel .head{
    padding:18px 18px 12px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  }
  h1{font-size:18px; margin:0; letter-spacing:.2px}
  .sub{font-size:12px; color:var(--muted); margin-top:4px}
  .btn{
    appearance:none; border:1px solid rgba(214,178,94,.35);
    background:linear-gradient(180deg, rgba(214,178,94,.18), rgba(214,178,94,.10));
    color:var(--txt); border-radius:14px; padding:10px 12px; cursor:pointer;
    font-weight:650; display:inline-flex; gap:8px; align-items:center;
  }
  .btn:hover{filter:brightness(1.05)}
  .content{padding:0 14px 14px; overflow:auto; height:calc(100% - 64px)}
  .card{
    background:var(--card);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    padding:14px;
    margin-bottom:12px;
  }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.25); color:var(--txt);
    padding:12px 12px; outline:none;
  }
  textarea{min-height:80px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.25}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.22);
    color:var(--muted); font-size:12px;
  }
  .qlist{display:flex; flex-direction:column; gap:10px}
  .qitem{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    padding:12px; border-radius:16px;
    background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08);
  }
  .qtitle{min-width:0}
  .qtitle b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .qtitle span{display:block; font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:8px}
  .iconbtn{
    width:36px; height:36px; border-radius:12px; cursor:pointer;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.22); color:var(--txt);
    display:grid; place-items:center;
  }
  .iconbtn:hover{filter:brightness(1.06)}
  .right .content{padding:14px; height:100%}
  .previewHead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; padding:18px}
  .previewHead h2{margin:0; font-size:18px}
  .iframeWrap{
    height:calc(100% - 76px);
    padding:0 14px 14px;
  }
  iframe{
    width:100%; height:100%;
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    background:#000;
  }
  /* Modal editor */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
  .modal{width:min(860px, 100%); border-radius:20px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(20,26,38,.96), rgba(10,14,22,.96));
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .modalHead{padding:12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,.08)}
  .modalHead b{font-size:14px}
  .modalBody{padding:14px; display:flex; flex-direction:column; gap:10px}
  .line{display:flex; gap:10px; align-items:center}
  .line .grow{flex:1}
  .badgeTimer{
    margin:0 auto 6px auto;
    display:inline-flex; align-items:center; justify-content:center;
    padding:8px 14px; border-radius:999px;
    border:1px solid rgba(255,154,60,.45);
    background:rgba(255,154,60,.12);
    color:rgba(255,255,255,.92);
    font-weight:800; letter-spacing:.4px;
    animation:pulse 1.8s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{box-shadow:0 0 0 rgba(255,154,60,0)}
    50%{box-shadow:0 0 22px rgba(255,154,60,.35)}
  }
  .answers{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .mediaRow{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .mini{
    display:flex; align-items:center; gap:10px;
    padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.20);
  }
  .mini input{padding:10px}
  .mini .x{margin-left:auto}
  .x{width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--txt);cursor:pointer}
  .x:hover{filter:brightness(1.06)}
  .footerBtns{display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-top:1px solid rgba(255,255,255,.08)}
  .btn2{appearance:none;border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:var(--txt); border-radius:14px; padding:10px 12px; cursor:pointer; font-weight:650}
  .btn2.primary{border-color:rgba(214,178,94,.35); background:linear-gradient(180deg, rgba(214,178,94,.18), rgba(214,178,94,.10))}
  /* Version badge */
  .ver{
    position:fixed; right:14px; bottom:14px;
    background:rgba(0,0,0,.40);
    border:1px solid rgba(255,255,255,.14);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
    color:rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    z-index:9999;
  }

  /* ---- GAME UI (inside iframe in ?game mode OR embedded preview) ---- */
  .gameRoot{position:fixed; inset:0; display:none}
  .gameStage{
    position:absolute; inset:0;
    background:
      radial-gradient(1100px 700px at 25% 15%, rgba(255,255,255,.10), transparent 55%),
      radial-gradient(900px 650px at 75% 30%, rgba(214,178,94,.14), transparent 60%),
      linear-gradient(180deg, #0a0f18, #070a10);
  }
  .gameStage.hasImg{
    background:
      radial-gradient(900px 650px at 65% 30%, rgba(0,0,0,.35), transparent 70%),
      linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.55)),
      var(--img) center/cover no-repeat;
  }
  .gameHud{position:absolute; left:18px; right:18px; top:14px; display:flex; gap:10px; align-items:flex-start}
  .gameTitle{
    flex:1;
    background:rgba(0,0,0,.38);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    padding:14px 14px;
    box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  .gameTitle h3{margin:0; font-size:18px}
  .gameTitle .hint{color:rgba(255,255,255,.70); font-size:12px; margin-top:4px}
  .hudBtns{display:flex; gap:10px}
  .chip{
    background:rgba(0,0,0,.40);
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    padding:10px 12px;
    color:rgba(255,255,255,.9);
    font-weight:650;
    display:inline-flex; gap:8px; align-items:center;
  }
  .chip button{all:unset; cursor:pointer}
  .teams{
    position:absolute; left:18px; right:18px; top:90px;
    display:grid; gap:10px;
  }
  .teams.t1{grid-template-columns:1fr}
  .teams.t2{grid-template-columns:1fr 1fr}
  .teams.t3{grid-template-columns:1fr 1fr 1fr}
  .teamCard{
    background:rgba(0,0,0,.34);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 26px rgba(0,0,0,.35);
    cursor:pointer;
  }
  .teamCard.active{border-color:rgba(214,178,94,.55); box-shadow:0 0 0 2px rgba(214,178,94,.15), 0 10px 28px rgba(0,0,0,.45)}
  .teamTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .teamTop b{font-size:14px}
  .score{margin-top:8px; display:flex; justify-content:space-between; color:rgba(255,255,255,.78)}
  .score strong{color:rgba(255,255,255,.92)}
  .arena{
    position:absolute; left:18px; right:18px; bottom:18px; top:210px;
    background:rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.10);
    border-radius:22px;
    overflow:hidden;
  }
  .arena:before{
    content:""; position:absolute; inset:0;
    background:
      radial-gradient(700px 360px at 20% 30%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(700px 360px at 85% 45%, rgba(214,178,94,.12), transparent 60%),
      linear-gradient(to bottom, rgba(255,255,255,.04), rgba(0,0,0,.45));
    pointer-events:none;
  }
  .targets{position:absolute; inset:0}
  .target{
    position:absolute;
    width:92px; height:92px;
    border-radius:999px;
    border:2px solid rgba(255,255,255,.14);
    background:radial-gradient(circle at 35% 30%, rgba(255,255,255,.12), rgba(0,0,0,.35) 55%, rgba(0,0,0,.55) 100%);
    backdrop-filter: blur(6px);
    box-shadow:0 10px 26px rgba(0,0,0,.45);
    display:grid; place-items:center;
    cursor:pointer;
    transform:translate3d(0,0,0);
    transition:transform .18s ease, filter .18s ease, opacity .25s ease;
    user-select:none;
  }
  .target:hover{filter:brightness(1.05)}
  .target .n{font-weight:900; color:rgba(255,255,255,.88)}
  .target .pts{
    position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
    font-size:12px; font-weight:800; color:rgba(255,214,130,.95);
    background:rgba(0,0,0,.55); border:1px solid rgba(255,214,130,.22);
    padding:4px 8px; border-radius:999px;
    white-space:nowrap;
  }
  .target.hit{
    opacity:.35;
    transform:rotate(-10deg) scale(.9);
    filter:saturate(.8);
    pointer-events:none;
  }
  .cross{
    position:absolute; width:120px; height:120px; pointer-events:none;
    border-radius:999px;
    border:2px solid rgba(214,178,94,.75);
    box-shadow:0 0 22px rgba(214,178,94,.18);
    transform:translate(-50%,-50%);
  }
  .cross:before, .cross:after{
    content:""; position:absolute; left:50%; top:50%; background:rgba(214,178,94,.75);
    transform:translate(-50%,-50%);
  }
  .cross:before{width:2px; height:72px}
  .cross:after{height:2px; width:72px}
  .shotFlash{
    position:absolute; inset:0; pointer-events:none;
    background:radial-gradient(240px 180px at var(--sx) var(--sy), rgba(255,220,150,.14), transparent 65%);
    opacity:0;
    transition:opacity .18s ease;
  }
  .shake{animation:shake .25s ease}
  @keyframes shake{
    0%{transform:translate(0,0)}
    25%{transform:translate(3px,-2px)}
    50%{transform:translate(-2px,3px)}
    75%{transform:translate(2px,2px)}
    100%{transform:translate(0,0)}
  }
  /* Game question modal */
  .qBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
  .qModal{width:min(760px,100%); border-radius:20px; border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(16,20,30,.96), rgba(8,10,16,.96));
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .qTop{padding:12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,.08)}
  .qTop b{font-size:14px}
  .qBody{padding:14px}
  .qText{font-size:16px; line-height:1.35; margin:0 0 12px 0}
  .qMedia{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
  .qMedia a{color:rgba(255,255,255,.9)}
  .optGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .opt{
    padding:12px; border-radius:16px; cursor:pointer;
    border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.22);
    color:rgba(255,255,255,.88); font-weight:650;
    transition:transform .1s ease, filter .1s ease;
  }
  .opt:hover{filter:brightness(1.06); transform:translateY(-1px)}
  .qTimerFloat{
    position:absolute; left:50%; top:-14px; transform:translateX(-50%);
    z-index:3;
  }
  .qTimerFloat .badgeTimer{margin:0}
</style>
</head>
<body class="grid">
<div class="wrap">
  <!-- EDITOR -->
  <section class="panel left" id="editorPanel">
    <div class="head">
      <div>
        <h1>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</h1>
        <div class="sub">–°–æ–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe –¥–ª—è Genially</div>
      </div>
      <button class="btn" id="copyIframeBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
    </div>

    <div class="content">
      <div class="card">
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
        <input id="titleInput" type="text" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä"/>
      </div>

      <div class="card">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)</label>
        <input id="teamsCount" type="number" min="1" max="3" value="3"/>
        <div class="row" style="margin-top:10px">
          <div>
            <label>–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞</label>
            <select id="autoRotate">
              <option value="1" selected>–í–∫–ª—é—á—ë–Ω</option>
              <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
            </select>
          </div>
          <div>
            <label>LaTeX</label>
            <select id="latexMode">
              <option value="0" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
              <option value="1">–í–∫–ª—é—á–µ–Ω</option>
            </select>
          </div>
        </div>
        <div class="small">–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –∏–≥—Ä—ã (–≤ —ç—Ç–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –Ω–µ –∑–∞–Ω–∏–º–∞–µ–º –º–µ—Å—Ç–æ).</div>
      </div>

      <div class="card">
        <label>–§–æ–Ω (URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="bgUrl" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: https://.../bg_forest.jpg.png"/>
        <div class="small">–ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π ‚Äú–∫–∏–Ω–æ—à–Ω—ã–π‚Äù —Ñ–æ–Ω.</div>
      </div>

      <div class="card">
        <label>–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞</label>
        <div class="row">
          <div>
            <label>–í–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</label>
            <select id="shotPreset">
              <option value="snap" selected>–ö–æ—Ä–æ—Ç–∫–∏–π ‚Äú–ø–∏—Ñ‚Äù</option>
              <option value="laser">–õ–∞–∑–µ—Ä–Ω—ã–π</option>
              <option value="boom">–ì–ª—É—Ö–æ–π ‚Äú–±—É–º‚Äù</option>
            </select>
          </div>
          <div>
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
            <input id="shotVol" type="range" min="0" max="100" value="70"/>
          </div>
        </div>
        <div class="small">–í –∏–≥—Ä–µ –≤—ã—Å—Ç—Ä–µ–ª –∑–≤—É—á–∏—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∏—à–µ–Ω–∏ (–∏ –≤ —Ä–µ–∂–∏–º–µ ‚Äú–ø—Ä–æ–º–∞—Ö‚Äù —Ç–æ–∂–µ).</div>
      </div>

      <div class="card">
        <div class="row">
          <button class="btn2 primary" id="addQ">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn2" id="clearQ">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="small" style="margin-top:10px">–ú–∏—à–µ–Ω–µ–π –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–µ—Ç).</div>
        <div style="margin-top:10px" class="qlist" id="qList"></div>
      </div>

      <div class="card">
        <label>Genially</label>
        <div class="pill" id="iframeOut" style="width:100%; justify-content:space-between">
          <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis" id="iframeText">–ù–∞–∂–º–∏ ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</span>
          <span style="opacity:.7">‚Üó</span>
        </div>
        <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –∫—ç—à –æ–ø—è—Ç—å ‚Äú–∑–∞–ª–∏–ø–Ω–µ—Ç‚Äù, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å <b>?v=15</b>.</div>
      </div>
    </div>
  </section>

  <!-- PREVIEW -->
  <section class="panel right">
    <div class="previewHead">
      <div>
        <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä</h2>
        <div class="sub">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>
      </div>
      <div class="sub">—Ñ–æ–Ω + –º–∏—à–µ–Ω–∏ + –≤–æ–ø—Ä–æ—Å—ã</div>
    </div>
    <div class="iframeWrap">
      <iframe id="previewFrame" title="preview" allow="autoplay"></iframe>
    </div>
  </section>
</div>

<!-- QUESTION EDIT MODAL -->
<div class="backdrop" id="editBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <b id="modalTitle">–í–æ–ø—Ä–æ—Å</b>
      <button class="iconbtn" id="closeModal" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="badgeTimer" title="–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞">‚è± <span id="timerLabel">30</span> —Å–µ–∫</div>

      <div class="line">
        <div class="grow">
          <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
          <textarea id="qText"></textarea>
        </div>
      </div>

      <div class="line">
        <div class="grow">
          <label>–û—á–∫–∏</label>
          <input id="qPts" type="number" min="1" max="999" value="10"/>
        </div>
        <div class="grow">
          <label>–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
          <input id="qTimer" type="number" min="0" max="999" value="30"/>
        </div>
      </div>

      <div class="mediaRow">
        <div class="mini">
          <span title="–ö–∞—Ä—Ç–∏–Ω–∫–∞">üñºÔ∏è</span>
          <input class="grow" id="qImg" type="text" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"/>
          <button class="x" id="clrImg" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>
        <div class="mini">
          <span title="–ú—É–∑—ã–∫–∞">üéµ</span>
          <input class="grow" id="qAud" type="text" placeholder="URL –º—É–∑—ã–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"/>
          <button class="x" id="clrAud" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>
      </div>

      <label>–û—Ç–≤–µ—Ç—ã (A‚ÄìD). –û—Ç–º–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.</label>
      <div class="answers">
        <input id="a0" type="text" placeholder="A"/>
        <input id="a1" type="text" placeholder="B"/>
        <input id="a2" type="text" placeholder="C"/>
        <input id="a3" type="text" placeholder="D"/>
      </div>
      <div class="line" style="margin-top:8px">
        <label style="margin:0">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π:</label>
        <select id="correctPick" style="width:140px">
          <option value="0">A</option>
          <option value="1">B</option>
          <option value="2">C</option>
          <option value="3">D</option>
        </select>
        <span class="small" style="margin:0">–û—Ç–≤–µ—Ç—ã –≤ –∏–≥—Ä–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—é—Ç—Å—è.</span>
      </div>
    </div>
    <div class="footerBtns">
      <button class="btn2" id="cancelEdit">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn2 primary" id="saveEdit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- GAME ROOT (used in ?game mode only) -->
<div class="gameRoot" id="gameRoot">
  <div class="gameStage" id="gameStage"></div>
  <div class="shotFlash" id="shotFlash"></div>
  <div class="gameHud">
    <div class="gameTitle">
      <h3 id="gTitle">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä</h3>
      <div class="hint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
    </div>
    <div class="hudBtns">
      <span class="chip">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b id="gActiveTeam">–ö–æ–º–∞–Ω–¥–∞ 1</b></span>
      <span class="chip">–¶–µ–ª–∏: <b id="gLeft">0/0</b></span>
      <span class="chip"><button id="gHelp">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button></span>
      <span class="chip"><button id="gReset">–°–±—Ä–æ—Å</button></span>
    </div>
  </div>
  <div class="teams t3" id="teams"></div>

  <div class="arena" id="arena">
    <div class="targets" id="targets"></div>
    <div class="cross" id="cross"></div>
  </div>

  <div class="qBackdrop" id="qBackdrop">
    <div class="qModal">
      <div class="qTop">
        <b id="qHead">–í–æ–ø—Ä–æ—Å</b>
        <button class="iconbtn" id="qClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="qBody" style="position:relative">
        <div class="qTimerFloat" id="qTimerFloat" style="display:none">
          <div class="badgeTimer">‚è± <span id="qTimerLeft">30</span> —Å–µ–∫</div>
        </div>
        <p class="qText" id="qTextShow"></p>
        <div class="qMedia" id="qMedia"></div>
        <div class="optGrid" id="optGrid"></div>
      </div>
    </div>
  </div>
</div>

<div class="ver" id="ver">–í–µ—Ä—Å–∏—è 15 ‚Ä¢ <span id="utc"></span></div>

<script>
(() => {
  // --- hard anti-cache: unregister SW + clear caches (safe in modern browsers)
  if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())).catch(()=>{});
  if (window.caches && caches.keys) caches.keys().then(keys => keys.forEach(k => caches.delete(k))).catch(()=>{});

  // --- version time
  document.getElementById('utc').textContent = new Date().toISOString().replace('T',' ').slice(0,19) + ' UTC';

  const qs = new URLSearchParams(location.search);
  const isGameMode = qs.has('game');

  const editorPanel = document.getElementById('editorPanel');
  const previewFrame = document.getElementById('previewFrame');
  const iframeText = document.getElementById('iframeText');

  const state = {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamsCount: 3,
    autoRotate: true,
    latex: false,
    bgUrl: "",
    shotPreset: "snap",
    shotVol: 0.70,
    questions: []
  };

  // --- simple defaults
  const makeSample = () => ([
    {text:"–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 7√ó8?", pts:20, timer:30, img:"", aud:"", answers:["54","56","58","48"], correct:1},
    {text:"–ù–∞–π–¥–∏ –∑–Ω–∞—á–µ–Ω–∏–µ: 12^2", pts:10, timer:25, img:"", aud:"", answers:["144","124","154","132"], correct:0},
    {text:"–°–∫–æ–ª—å–∫–æ –≥—Ä–∞–¥—É—Å–æ–≤ –≤ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–º —É–≥–ª–µ?", pts:30, timer:20, img:"", aud:"", answers:["180","90","360","45"], correct:0}
  ]);

  state.questions = makeSample();

  // --- audio (WebAudio tiny synth shots)
  let AC = null;
  function beep(freq, dur, type="sine", vol=0.2, when=0){
    AC = AC || new (window.AudioContext||window.webkitAudioContext)();
    const t0 = AC.currentTime + when;
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(vol, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g).connect(AC.destination);
    o.start(t0); o.stop(t0+dur+0.02);
  }
  function playShot(preset){
    const v = state.shotVol;
    if(preset==="snap"){
      beep(880, 0.06, "square", 0.20*v);
      beep(520, 0.08, "triangle", 0.18*v, 0.03);
    } else if(preset==="laser"){
      AC = AC || new (window.AudioContext||window.webkitAudioContext)();
      const t0 = AC.currentTime;
      const o = AC.createOscillator();
      const g = AC.createGain();
      o.type="sawtooth";
      o.frequency.setValueAtTime(1400, t0);
      o.frequency.exponentialRampToValueAtTime(220, t0+0.12);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.22*v, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.14);
      o.connect(g).connect(AC.destination);
      o.start(t0); o.stop(t0+0.16);
      beep(260, 0.10, "sine", 0.12*v, 0.10);
    } else { // boom
      beep(160, 0.14, "square", 0.22*v);
      beep(90,  0.20, "sine",   0.18*v);
      // echo
      beep(120, 0.10, "triangle", 0.10*v, 0.16);
    }
  }

  // --- editor bindings
  const $ = (id)=>document.getElementById(id);
  const titleInput = $('titleInput');
  const teamsCount = $('teamsCount');
  const autoRotate = $('autoRotate');
  const latexMode = $('latexMode');
  const bgUrl = $('bgUrl');
  const shotPreset = $('shotPreset');
  const shotVol = $('shotVol');
  const qList = $('qList');

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function renderList(){
    qList.innerHTML = "";
    state.questions.forEach((q, idx)=>{
      const el = document.createElement('div');
      el.className='qitem';
      el.innerHTML = `
        <div class="qtitle">
          <b>${idx+1}. ${escapeHtml(q.text||"(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)")}</b>
          <span>üéØ ${q.pts||0} –æ—á–∫. ‚Ä¢ ‚è± ${q.timer||0} —Å–µ–∫</span>
        </div>
        <div class="actions">
          <button class="iconbtn" title="–ü–æ–∫–∞–∑–∞—Ç—å" data-act="view">üëÅÔ∏è</button>
          <button class="iconbtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" data-act="edit">‚úèÔ∏è</button>
          <button class="iconbtn" title="–£–¥–∞–ª–∏—Ç—å" data-act="del">üóëÔ∏è</button>
        </div>`;
      el.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const act = btn.dataset.act;
          if(act==='del'){ state.questions.splice(idx,1); sync(); }
          if(act==='edit'){ openEdit(idx); }
          if(act==='view'){ openEdit(idx,true); }
        });
      });
      qList.appendChild(el);
    });
  }

  // modal edit
  let editingIndex = -1;
  let viewOnly = false;

  const editBackdrop = $('editBackdrop');
  const modalTitle = $('modalTitle');
  const qText = $('qText');
  const qPts = $('qPts');
  const qTimer = $('qTimer');
  const qImg = $('qImg');
  const qAud = $('qAud');
  const correctPick = $('correctPick');
  const timerLabel = $('timerLabel');
  const a0=$('a0'),a1=$('a1'),a2=$('a2'),a3=$('a3');

  function openEdit(idx, ro=false){
    editingIndex = idx;
    viewOnly = !!ro;
    const q = state.questions[idx];
    modalTitle.textContent = ro ? `–í–æ–ø—Ä–æ—Å ${idx+1} (–ø—Ä–æ—Å–º–æ—Ç—Ä)` : `–í–æ–ø—Ä–æ—Å ${idx+1} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)`;
    qText.value = q.text||"";
    qPts.value = q.pts ?? 10;
    qTimer.value = q.timer ?? 30;
    qImg.value = q.img||"";
    qAud.value = q.aud||"";
    a0.value = (q.answers&&q.answers[0])||"";
    a1.value = (q.answers&&q.answers[1])||"";
    a2.value = (q.answers&&q.answers[2])||"";
    a3.value = (q.answers&&q.answers[3])||"";
    correctPick.value = String(q.correct ?? 0);
    timerLabel.textContent = qTimer.value || "0";

    // lock inputs if view
    editBackdrop.style.display='flex';
    [...editBackdrop.querySelectorAll('input,textarea,select')].forEach(x=>x.disabled=viewOnly);
    $('saveEdit').style.display = viewOnly ? 'none' : 'inline-block';
  }
  function closeEdit(){ editBackdrop.style.display='none'; editingIndex=-1; viewOnly=false; }
  $('closeModal').onclick = closeEdit;
  $('cancelEdit').onclick = closeEdit;
  $('clrImg').onclick = ()=>{ if(!viewOnly) qImg.value=""; };
  $('clrAud').onclick = ()=>{ if(!viewOnly) qAud.value=""; };
  qTimer.addEventListener('input', ()=> timerLabel.textContent = qTimer.value||"0");
  $('saveEdit').onclick = ()=>{
    const idx = editingIndex;
    if(idx<0) return;
    state.questions[idx] = {
      text: qText.value.trim(),
      pts: clamp(parseInt(qPts.value||"0",10), 0, 999),
      timer: clamp(parseInt(qTimer.value||"0",10), 0, 999),
      img: qImg.value.trim(),
      aud: qAud.value.trim(),
      answers: [a0.value,a1.value,a2.value,a3.value].map(s=>s.trim()),
      correct: clamp(parseInt(correctPick.value||"0",10), 0, 3)
    };
    closeEdit();
    sync();
  };
  editBackdrop.addEventListener('click', (e)=>{ if(e.target===editBackdrop) closeEdit(); });

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // editor inputs
  titleInput.addEventListener('input', ()=>{ state.title = titleInput.value; sync(); });
  teamsCount.addEventListener('input', ()=>{
    state.teamsCount = clamp(parseInt(teamsCount.value||"1",10), 1, 3);
    teamsCount.value = state.teamsCount;
    sync();
  });
  autoRotate.addEventListener('change', ()=>{ state.autoRotate = autoRotate.value==="1"; sync(); });
  latexMode.addEventListener('change', ()=>{ state.latex = latexMode.value==="1"; sync(); });
  bgUrl.addEventListener('input', ()=>{ state.bgUrl = bgUrl.value.trim(); sync(); });
  shotPreset.addEventListener('change', ()=>{ state.shotPreset = shotPreset.value; playShot(state.shotPreset); sync(); });
  shotVol.addEventListener('input', ()=>{ state.shotVol = (parseInt(shotVol.value,10)||0)/100; });

  $('addQ').onclick = ()=>{
    state.questions.push({text:"", pts:10, timer:30, img:"", aud:"", answers:["","","",""], correct:0});
    sync();
    openEdit(state.questions.length-1,false);
  };
  $('clearQ').onclick = ()=>{
    state.questions = [];
    sync();
  };

  // encode/decode game payload
  function encodeGame(obj){
    const json = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function decodeGame(b64){
    const s = b64.replace(/-/g,'+').replace(/_/g,'/');
    const pad = s + "===".slice((s.length+3)%4);
    const json = decodeURIComponent(escape(atob(pad)));
    return JSON.parse(json);
  }

  function gameUrl(){
    const payload = encodeGame({
      title: state.title,
      teamsCount: state.teamsCount,
      autoRotate: state.autoRotate,
      latex: state.latex,
      bgUrl: state.bgUrl,
      shotPreset: state.shotPreset,
      shotVol: state.shotVol,
      questions: state.questions
    });
    const base = location.origin + location.pathname;
    return base + "?game=" + payload + "&_v=15";
  }

  function buildIframe(){
    const src = gameUrl();
    const code = `<iframe src="${src}" style="width:100%;height:100%;border:0;border-radius:16px" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    return {src, code};
  }

  $('copyIframeBtn').onclick = async ()=>{
    const {code} = buildIframe();
    try{
      await navigator.clipboard.writeText(code);
      iframeText.textContent = "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ";
      setTimeout(()=>iframeText.textContent = code, 700);
    }catch{
      iframeText.textContent = code;
    }
  };

  function sync(){
    renderList();
    const {src, code} = buildIframe();
    iframeText.textContent = code;
    // IMPORTANT: preview is ALWAYS iframe to prevent layout mismatch
    previewFrame.src = src + "&_pv=" + Date.now();
  }

  // ============ GAME RUNTIME ============
  const gameRoot = $('gameRoot');
  const gameStage = $('gameStage');
  const cross = $('cross');
  const targetsEl = $('targets');
  const teamsEl = $('teams');
  const arena = $('arena');
  const shotFlash = $('shotFlash');

  const qBackdrop = $('qBackdrop');
  const qClose = $('qClose');
  const qHead = $('qHead');
  const qTextShow = $('qTextShow');
  const optGrid = $('optGrid');
  const qMedia = $('qMedia');
  const qTimerFloat = $('qTimerFloat');
  const qTimerLeft = $('qTimerLeft');

  const gTitle = $('gTitle');
  const gActiveTeam = $('gActiveTeam');
  const gLeft = $('gLeft');

  let G = null;
  let scores = [];
  let activeTeam = 0;
  let used = new Set();
  let currentQ = null;
  let timerId = null;
  let timerLeft = 0;

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function setTeams(n){
    teamsEl.className = "teams t" + n;
    teamsEl.innerHTML="";
    for(let i=0;i<n;i++){
      const card = document.createElement('div');
      card.className='teamCard' + (i===activeTeam?' active':'');
      card.innerHTML = `
        <div class="teamTop"><b>–ö–æ–º–∞–Ω–¥–∞ ${i+1}</b><span class="pill" style="padding:6px 10px;border-radius:999px">${i===activeTeam?'üéØ –°–µ–π—á–∞—Å':'‚õî –ù–µ —Å–µ–π—á–∞—Å'}</span></div>
        <div class="score"><span>–û—á–∫–∏</span> <strong id="sc_${i}">${scores[i]||0}</strong></div>
      `;
      card.addEventListener('click', ()=>{ activeTeam=i; refreshTeams(); });
      teamsEl.appendChild(card);
    }
    refreshTeams();
  }
  function refreshTeams(){
    [...teamsEl.children].forEach((c,i)=>{
      c.classList.toggle('active', i===activeTeam);
      c.querySelector('.pill').textContent = i===activeTeam ? 'üéØ –°–µ–π—á–∞—Å' : '‚õî –ù–µ —Å–µ–π—á–∞—Å';
      const sc = c.querySelector('#sc_'+i);
      if(sc) sc.textContent = scores[i]||0;
    });
    gActiveTeam.textContent = "–ö–æ–º–∞–Ω–¥–∞ " + (activeTeam+1);
  }

  function spawnTargets(){
    targetsEl.innerHTML="";
    used.forEach(()=>{});
    const qs = (G.questions||[]).length;
    gLeft.textContent = `${used.size}/${qs}`;
    // Put targets in upper half for realism
    const area = arena.getBoundingClientRect();
    const W = area.width, H = area.height;
    const count = qs;
    for(let i=0;i<count;i++){
      const t = document.createElement('div');
      t.className='target';
      t.dataset.idx = String(i);
      t.innerHTML = `<div class="n">${i+1}</div><div class="pts">${(G.questions[i]?.pts||10)} –æ—á–∫.</div>`;
      // random with padding, upper ~55%
      const x = 40 + Math.random()*(W-160);
      const y = 40 + Math.random()*(Math.max(140, H*0.55)-120);
      t.style.left = x+"px";
      t.style.top = y+"px";
      if(used.has(i)) t.classList.add('hit');
      // subtle float
      const dur = 6 + Math.random()*6;
      const amp = 10 + Math.random()*14;
      t.animate([
        {transform:"translate3d(0,0,0)"},
        {transform:`translate3d(${(Math.random()>.5?1:-1)*amp}px, ${-amp*.6}px, 0)`},
        {transform:"translate3d(0,0,0)"}
      ], {duration:dur*1000, iterations:Infinity, easing:"ease-in-out"});
      t.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        onShootTarget(i, ev.clientX, ev.clientY);
      });
      targetsEl.appendChild(t);
    }
  }

  function showFlash(x,y){
    const r = arena.getBoundingClientRect();
    const px = ((x-r.left)/r.width)*100;
    const py = ((y-r.top)/r.height)*100;
    shotFlash.style.setProperty('--sx', px+'%');
    shotFlash.style.setProperty('--sy', py+'%');
    shotFlash.style.opacity = '1';
    setTimeout(()=>shotFlash.style.opacity='0', 160);
  }

  function onShootAnywhere(ev){
    // miss
    showFlash(ev.clientX, ev.clientY);
    playShot(G.shotPreset||'snap');
  }

  function openQuestion(idx){
    currentQ = idx;
    const q = G.questions[idx];
    qHead.textContent = `–í–æ–ø—Ä–æ—Å ${idx+1} ‚Ä¢ +${q.pts||0} –æ—á–∫.`;
    qTextShow.textContent = q.text || "";
    qMedia.innerHTML = "";
    if(q.img){
      const a = document.createElement('a');
      a.href = q.img; a.target="_blank"; a.textContent="üñºÔ∏è –∫–∞—Ä—Ç–∏–Ω–∫–∞";
      qMedia.appendChild(a);
    }
    if(q.aud){
      const a = document.createElement('a');
      a.href = q.aud; a.target="_blank"; a.textContent="üéµ –º—É–∑—ã–∫–∞";
      qMedia.appendChild(a);
    }

    // shuffle answers but keep correct mapping
    const answers = (q.answers||[]).map((txt, i)=>({txt:txt||"", i}));
    const shuffled = shuffle(answers);
    optGrid.innerHTML="";
    shuffled.forEach(opt=>{
      const btn = document.createElement('button');
      btn.className='opt';
      btn.textContent = opt.txt || "(–ø—É—Å—Ç–æ)";
      btn.addEventListener('click', ()=> {
        const isCorrect = opt.i === (q.correct ?? 0);
        resolveAnswer(isCorrect);
      });
      optGrid.appendChild(btn);
    });

    // timer
    const sec = parseInt(q.timer||0,10);
    if(sec>0){
      timerLeft = sec;
      qTimerLeft.textContent = String(timerLeft);
      qTimerFloat.style.display = 'block';
      clearInterval(timerId);
      timerId = setInterval(()=>{
        timerLeft--;
        qTimerLeft.textContent = String(Math.max(0,timerLeft));
        if(timerLeft<=0){
          clearInterval(timerId);
          resolveAnswer(false, true);
        }
      }, 1000);
    }else{
      qTimerFloat.style.display = 'none';
      clearInterval(timerId);
    }

    qBackdrop.style.display='flex';
  }

  function closeQuestion(){
    qBackdrop.style.display='none';
    clearInterval(timerId);
    timerId=null;
  }

  function resolveAnswer(correct, timeout=false){
    const q = G.questions[currentQ];
    closeQuestion();

    // hit animation
    const el = targetsEl.querySelector(`.target[data-idx="${currentQ}"]`);
    if(el) el.classList.add('hit');

    if(correct){
      scores[activeTeam] = (scores[activeTeam]||0) + (q.pts||0);
      refreshTeams();
      used.add(currentQ);
      gLeft.textContent = `${used.size}/${(G.questions||[]).length}`;
      // cinematic shake small
      arena.classList.add('shake');
      setTimeout(()=>arena.classList.remove('shake'), 260);

      if(G.autoRotate){
        activeTeam = (activeTeam + 1) % scores.length;
        refreshTeams();
      }
    }else{
      // miss feedback
      arena.classList.add('shake');
      setTimeout(()=>arena.classList.remove('shake'), 220);
    }
  }

  function onShootTarget(idx, x, y){
    if(used.has(idx)) return;
    showFlash(x,y);
    playShot(G.shotPreset||'snap');
    // open Q
    openQuestion(idx);
  }

  qClose.onclick = closeQuestion;
  qBackdrop.addEventListener('click', (e)=>{ if(e.target===qBackdrop) closeQuestion(); });

  function initGame(payload){
    G = payload;
    scores = Array.from({length: clamp(parseInt(G.teamsCount||3,10),1,3)}, ()=>0);
    activeTeam = 0;
    used = new Set();
    gTitle.textContent = G.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
    if(G.bgUrl){
      gameStage.classList.add('hasImg');
      gameStage.style.setProperty('--img', `url("${G.bgUrl}")`);
    }else{
      gameStage.classList.remove('hasImg');
      gameStage.style.removeProperty('--img');
    }
    // volume
    if(typeof G.shotVol === 'number') state.shotVol = G.shotVol;

    setTeams(scores.length);
    spawnTargets();
    gLeft.textContent = `${used.size}/${(G.questions||[]).length}`;

    // crosshair follow
    arena.addEventListener('mousemove', (e)=>{
      const r = arena.getBoundingClientRect();
      cross.style.left = (e.clientX - r.left) + "px";
      cross.style.top  = (e.clientY - r.top) + "px";
    });
    arena.addEventListener('mouseleave', ()=>{
      cross.style.left = "92%"; cross.style.top = "72%";
    });

    arena.addEventListener('click', onShootAnywhere);

    $('gReset').onclick = ()=>{
      scores = scores.map(()=>0);
      used = new Set();
      refreshTeams();
      spawnTargets();
      gLeft.textContent = `${used.size}/${(G.questions||[]).length}`;
    };
    $('gHelp').onclick = ()=>{
      alert("–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:\n1) –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–º–∞–Ω–¥—ã (–∫—Ç–æ —Å—Ç—Ä–µ–ª—è–µ—Ç).\n2) –ù–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏.\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –æ—á–∫–∏.\n\n–û—Ç–≤–µ—Ç—ã –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—é—Ç—Å—è, —Ç–∞–π–º–µ—Ä –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤—Ä–µ–º—è.");
    };

    // initial cross pos
    cross.style.left="92%"; cross.style.top="72%";
  }

  // ============ BOOT ============
  if(isGameMode){
    // game only view for Genially
    editorPanel.style.display = "none";
    document.querySelector('.right').style.display = "none";
    document.querySelector('.wrap').style.display = "block";
    gameRoot.style.display = "block";

    try{
      const payload = decodeGame(qs.get('game'));
      initGame(payload);
    }catch(err){
      document.body.innerHTML = "<div style='padding:20px;color:white;font-family:system-ui'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å –ø–∞—Ä–∞–º–µ—Ç—Ä game.</div>";
      console.error(err);
    }
  }else{
    // editor mode
    gameRoot.style.display = "none";
    titleInput.value = state.title;
    teamsCount.value = state.teamsCount;
    autoRotate.value = state.autoRotate ? "1" : "0";
    latexMode.value = state.latex ? "1" : "0";
    bgUrl.value = state.bgUrl;
    shotPreset.value = state.shotPreset;
    shotVol.value = String(Math.round(state.shotVol*100));

    sync();
  }
})();
</script>
</body>
</html>
