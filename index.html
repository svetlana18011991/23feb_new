<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä + –∏–≥—Ä–∞</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(20,30,45,.72);
      --panel2:rgba(15,22,34,.66);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.64);
      --gold:rgba(227,186,95,.95);
      --good:rgba(79, 214, 161, .95);
      --bad:rgba(255, 88, 88, .95);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 900px at 20% 0%, rgba(70,110,180,.25), transparent 60%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(140,90,190,.18), transparent 55%),
                  linear-gradient(160deg, #060a12, #0b1220 45%, #060a12);
      min-height:100vh;
    }
    .wrap{
      display:grid;
      grid-template-columns: 420px minmax(520px, 1fr);
      gap:18px;
      padding:16px;
    }
    @media (max-width: 1100px){
      .wrap{grid-template-columns:1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:""; position:absolute; inset:0;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.035) 0 2px, transparent 2px 12px);
      opacity:.55; pointer-events:none;
    }
    .card > *{position:relative}
    .head{
      padding:16px 16px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:18px;}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .btn{
      appearance:none; border:1px solid rgba(227,186,95,.35);
      background: linear-gradient(180deg, rgba(227,186,95,.22), rgba(227,186,95,.10));
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      border-color: rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      font-weight:700;
    }
    .pane{padding: 0 16px 16px;}
    .section{
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:14px;
      margin: 0 0 12px 0;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .hint{font-size:12px;color:var(--muted); margin-top:8px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }
    .list{display:flex; flex-direction:column; gap:10px;}
    .qitem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .qtitle{font-weight:800}
    .qmeta{font-size:12px; color:var(--muted); margin-top:2px}
    .qactions{display:flex; gap:8px}
    .iconbtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconbtn.danger{border-color: rgba(255,88,88,.35); background: rgba(255,88,88,.08)}
    .mini{font-size:12px}

    /* Preview */
    .previewWrap{padding: 0 16px 16px;}
    .previewTop{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      padding:12px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
    }
    .pvLeft .pvTitle{font-weight:900; font-size:18px; line-height:1.15}
    .pvLeft .pvHelp{margin-top:4px; font-size:12px; color:var(--muted)}
    .pvRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:800;
      font-size:12px;
      color:var(--text);
      display:inline-flex; gap:8px; align-items:center;
    }
    .badge b{color:var(--gold)}
    .pvBtns{display:flex; gap:8px}
    .pvBtns .btn{padding:8px 10px; border-radius: 14px; font-size:12px}
    .teamsBar{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      padding:10px 14px;
      background: rgba(0,0,0,.12);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .teamCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      min-height:58px;
    }
    .teamCard.active{
      border-color: rgba(227,186,95,.40);
      box-shadow: 0 0 0 2px rgba(227,186,95,.12) inset;
    }
    .teamNameInput{
      width:100%;
      font-weight:900;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    .teamScore{
      font-weight:900;
      font-size:18px;
      min-width:44px;
      text-align:right;
      color: var(--gold);
    }

    .arena{
      position:relative;
      height: 520px;
      border-radius: 18px;
      margin: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      background-color:#111;
      background-image: var(--arena-bg);
      background-size: cover;
      background-position: var(--bg-x, 50%) var(--bg-y, 50%);
    }
    @media (max-width: 1100px){
      .arena{height: 420px;}
    }
    .arena::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 50% 0%, rgba(0,0,0,.20), rgba(0,0,0,.70)),
        linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.52));
      pointer-events:none;
    }
    .gridOverlay{
      position:absolute; inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.04) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity:.22;
      pointer-events:none;
    }
    .crosshair{
      position:absolute;
      width:110px; height:110px;
      border-radius: 999px;
      border:2px solid rgba(227,186,95,.70);
      transform: translate(-50%,-50%);
      pointer-events:none;
      display:grid; place-items:center;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.55));
      mix-blend-mode: screen;
    }
    .crosshair::before,.crosshair::after{content:""; position:absolute; background: rgba(227,186,95,.75);}
    .crosshair::before{width:2px; height:86px;}
    .crosshair::after{height:2px; width:86px;}
    .target{
      position:absolute;
      width:86px; height:86px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      border:2px solid rgba(227,186,95,.55);
      background: radial-gradient(circle at 45% 35%, rgba(255,255,255,.18), rgba(0,0,0,.35) 55%, rgba(0,0,0,.55));
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(2px);
    }
    .target::after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 999px;
      border:2px solid rgba(227,186,95,.30);
    }
    .target .num{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,255,255,.85);
      text-shadow: 0 8px 18px rgba(0,0,0,.6);
    }
    .target .pts{
      position:absolute; left:50%; top:100%;
      transform: translate(-50%, 8px);
      background: rgba(0,0,0,.44);
      border:1px solid rgba(227,186,95,.35);
      color: var(--gold);
      padding:4px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .target.hit{opacity:.55; filter: grayscale(.6); pointer-events:none}

    .shake{animation: shake .24s linear;}
    @keyframes shake{
      0%{transform: translate(0,0)}
      25%{transform: translate(6px,-2px)}
      50%{transform: translate(-4px,3px)}
      75%{transform: translate(5px,2px)}
      100%{transform: translate(0,0)}
    }

    /* Modal */
    .backdrop{position:fixed; inset:0; background: rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000;}
    .modal{
      width:min(860px, 96vw);
      background: rgba(20,26,38,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 18px;
      box-shadow: 0 24px 70px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .modalHead .mhTitle{font-weight:900}
    .modalBody{padding:14px}
    .modalGrid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;}
    @media (max-width: 900px){.modalGrid{grid-template-columns:1fr}}
    .inlineRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chk{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .timerBadge{
      margin: 0 auto 10px;
      width: fit-content;
      padding:8px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,170,80,.40);
      background: rgba(255,170,80,.12);
      color: rgba(255,200,140,.95);
      font-weight:900;
      animation: pulse 1.35s ease-in-out infinite;
      display:none;
    }
    .timerBadge.show{display:block}
    @keyframes pulse{
      0%,100%{transform:scale(1); box-shadow: 0 0 0 0 rgba(255,170,80,.0)}
      50%{transform:scale(1.03); box-shadow: 0 0 0 10px rgba(255,170,80,.06)}
    }
    .answers{display:flex; flex-direction:column; gap:8px; margin-top:10px;}
    .ansRow{display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;}
    .ansRow input[type="text"]{padding:9px 10px; border-radius: 12px}
    .tag{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size:12px; color:var(--muted)
    }
    .mediaLine{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px;}
    .mediaLine .micon{
      width:34px; height:34px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      display:grid; place-items:center;
    }
    .mediaLine input[type="text"]{flex:1; min-width:260px}
    .modalFoot{
      padding:12px 14px;
      display:flex; justify-content:flex-end; gap:10px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }

    .ver{
      position:fixed;
      right:14px; bottom:14px;
      font-size:12px;
      color:rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      padding:8px 10px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      z-index:999;
    }
    .ver b{color:var(--gold)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div>
          <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</div>
          <div class="sub">–°–æ–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe –¥–ª—è Genially</div>
        </div>
        <button class="btn" id="btnCopy"><span>üìã</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
      </div>
      <div class="pane">
        <div class="section">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ)</label>
          <input id="gameTitle" type="text" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä"/>
        </div>

        <div class="section">
          <div class="row">
            <div>
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)</label>
              <select id="teamCount">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
              </select>
            </div>
            <div>
              <label>–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞</label>
              <select id="autoNext">
                <option value="1" selected>–í–∫–ª—é—á—ë–Ω</option>
                <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>LaTeX (–≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã)</label>
              <select id="latex">
                <option value="0" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
                <option value="1">–í–∫–ª—é—á–µ–Ω (MathJax)</option>
              </select>
            </div>
            <div>
              <label>–§–æ–Ω –∏–≥—Ä—ã (–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞)</label>
              <input id="bgUrl" type="text" value="bg_forest.jpg.png"/>
            </div>
          </div>
          <div class="hint">–ï—Å–ª–∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å <b>index.html</b>, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–µ–Ω–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: <b>bg_forest.jpg.png</b> –∏–ª–∏ <b>bg_forest.jpg.png.png</b> ‚Äî –≤–∞–∂–Ω–æ —Ç–æ—á–Ω–æ–µ –∏–º—è.</div>
        </div>

        <div class="section">
          <div class="row">
            <div>
              <label>–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</label>
              <select id="shotSound">
                <option value="pip" selected>–ö–æ—Ä–æ—Ç–∫–∏–π ‚Äú–ø–∏—Ñ‚Äù</option>
                <option value="click">–©–µ–ª—á–æ–∫ (–ª–∞–∑–µ—Ä)</option>
                <option value="boom">–ì–ª—É—Ö–æ–π ‚Äú–±—É–º‚Äù</option>
              </select>
            </div>
            <div>
              <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
              <input id="shotVol" type="range" min="0" max="1" step="0.05" value="0.6"/>
            </div>
          </div>
          <div class="hint">–í –∏–≥—Ä–µ –∑–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ –∑–≤—É—á–∏—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∏—à–µ–Ω–∏.</div>
        </div>

        <div class="section">
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <div>
              <div style="font-weight:900">–í–æ–ø—Ä–æ—Å—ã</div>
              <div class="hint" style="margin-top:4px">–ú–∏—à–µ–Ω–µ–π –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.</div>
            </div>
            <span class="pill">–í—Å–µ–≥–æ: <b id="qCount">0</b></span>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
            <button class="btn secondary" id="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn secondary" id="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="list" id="qList" style="margin-top:12px"></div>
        </div>

        <div class="section">
          <div style="font-weight:900">Genially</div>
          <div class="hint">–ö–Ω–æ–ø–∫–∞ ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª –≤—Å—Ç–∞–≤–∏—Ç —Å—Å—ã–ª–∫—É –≤–∏–¥–∞: <span class="tag">.../index.html?game=...</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div>
          <div class="title">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="sub">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>
        </div>
        <span class="pill">–º–∏—à–µ–Ω–∏ + –≤–æ–ø—Ä–æ—Å—ã</span>
      </div>
      <div class="previewWrap" id="previewHost"></div>
    </div>
  </div>

  <div class="backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="mhTitle" id="modalTitle">–í–æ–ø—Ä–æ—Å</div>
        <button class="btn secondary" id="btnClose">Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modalBody">
        <div class="timerBadge" id="timerBadge">‚è± –¢–∞–π–º–µ—Ä: <span id="timerBadgeVal">‚Äî</span> —Å–µ–∫</div>
        <div class="modalGrid">
          <div>
            <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
            <textarea id="qText"></textarea>

            <div class="mediaLine">
              <div class="micon" title="–ö–∞—Ä—Ç–∏–Ω–∫–∞">üñºÔ∏è</div>
              <input id="qImg" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"/>
              <button class="iconbtn" id="btnDelImg" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
            </div>
            <div class="mediaLine">
              <div class="micon" title="–ú—É–∑—ã–∫–∞/–∑–≤—É–∫">üéµ</div>
              <input id="qAud" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –º—É–∑—ã–∫—É/–∑–≤—É–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"/>
              <button class="iconbtn" id="btnDelAud" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
            </div>

            <div id="answersBox" style="margin-top:10px"></div>
          </div>

          <div>
            <div class="row">
              <div>
                <label>–û—á–∫–∏</label>
                <input id="qPts" type="number" min="0" value="10"/>
              </div>
              <div>
                <label>–¢–∏–ø</label>
                <select id="qType">
                  <option value="mcq" selected>–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
                  <option value="input">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="chk"><input id="timerOn" type="checkbox"/> <span>–¢–∞–π–º–µ—Ä –≤–∫–ª—é—á—ë–Ω</span></div>
              <div>
                <label>–°–µ–∫—É–Ω–¥</label>
                <input id="qSec" type="number" min="5" value="30"/>
              </div>
            </div>

            <div class="hint">–¢–∞–π–º–µ—Ä –º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å ‚Äî —Ç–æ–≥–¥–∞ –≤ –∏–≥—Ä–µ –µ–≥–æ –Ω–µ –±—É–¥–µ—Ç.</div>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn" id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="ver">–í–µ—Ä—Å–∏—è <b>19</b> ‚Ä¢ editor+game</div>

<script>
(()=> {
  const $ = (id)=>document.getElementById(id);

  function b64urlEncode(str){
    return btoa(unescape(encodeURIComponent(str))).replace(/\\+/g,'-').replace(/\\//g,'_').replace(/=+$/,'');
  }
  function b64urlDecode(b64url){
    const pad = b64url.length % 4 ? '='.repeat(4 - (b64url.length % 4)) : '';
    const b64 = (b64url + pad).replace(/-/g,'+').replace(/_/g,'/');
    return decodeURIComponent(escape(atob(b64)));
  }

  // ===== Sound (procedural) =====
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
  }
  function playShot(kind, vol){
    try{
      ensureAudio();
      const t0 = audioCtx.currentTime;
      const gain = audioCtx.createGain();
      gain.gain.value = vol;
      gain.connect(audioCtx.destination);

      const o1 = audioCtx.createOscillator();
      const o2 = audioCtx.createOscillator();
      const n = audioCtx.createBufferSource();
      const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.08, audioCtx.sampleRate);
      const data = buf.getChannelData(0);
      for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * (1 - i/data.length); }
      n.buffer = buf;

      const ng = audioCtx.createGain();
      ng.gain.value = (kind==='boom') ? 0.85 : 0.55;
      n.connect(ng).connect(gain);

      o1.type = 'square';
      o2.type = 'sine';

      if(kind==='pip'){
        o1.frequency.setValueAtTime(820, t0);
        o1.frequency.exponentialRampToValueAtTime(240, t0+0.07);
        o2.frequency.setValueAtTime(1200, t0);
        o2.frequency.exponentialRampToValueAtTime(360, t0+0.08);
      }else if(kind==='click'){
        o1.frequency.setValueAtTime(1200, t0);
        o1.frequency.exponentialRampToValueAtTime(700, t0+0.05);
        o2.frequency.setValueAtTime(1800, t0);
        o2.frequency.exponentialRampToValueAtTime(900, t0+0.06);
      }else{
        o1.frequency.setValueAtTime(220, t0);
        o1.frequency.exponentialRampToValueAtTime(80, t0+0.10);
        o2.frequency.setValueAtTime(120, t0);
        o2.frequency.exponentialRampToValueAtTime(50, t0+0.12);
      }

      const g1 = audioCtx.createGain();
      g1.gain.setValueAtTime(0.0001, t0);
      g1.gain.exponentialRampToValueAtTime(1.0, t0+0.01);
      g1.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);

      o1.connect(g1).connect(gain);
      o2.connect(g1).connect(gain);

      o1.start(t0); o2.start(t0); n.start(t0);
      o1.stop(t0+0.14); o2.stop(t0+0.14); n.stop(t0+0.10);
    }catch(e){}
  }

  const DEFAULT = {
    title:"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teams:3,
    autoNext:true,
    latex:false,
    bgUrl:"bg_forest.jpg.png",
    shotSound:"pip",
    shotVol:0.6,
    questions:[]
  };

  function loadConfigFromQuery(){
    const p = new URLSearchParams(location.search);
    const g = p.get('game');
    if(!g) return null;
    try{ return JSON.parse(b64urlDecode(g)); }catch(e){ return null; }
  }
  function normalizeBg(bg){
    let s = (bg||"").trim() || DEFAULT.bgUrl;
    const isUrl = /^https?:\\/\\//i.test(s) || /^data:/i.test(s);
    return isUrl ? s : ('./' + s.replace(/^\\.\\//,''));
  }
  function normalizeQuestion(q){
    if(!q || typeof q!=='object') return null;
    const qq = {
      text: String(q.text||'').trim(),
      type: (q.type==='input') ? 'input' : 'mcq',
      points: Number.isFinite(q.points) ? Math.max(0, Math.round(q.points)) : 10,
      timerOn: !!q.timerOn,
      seconds: Number.isFinite(q.seconds) ? Math.max(5, Math.round(q.seconds)) : 30,
      image: (q.image||'').trim(),
      audio: (q.audio||'').trim(),
      answers: []
    };
    if(!qq.text) return null;
    if(qq.type==='mcq'){
      const arr = Array.isArray(q.answers) ? q.answers : [];
      qq.answers = arr.map(a=>({text:String(a?.text||'').trim(), correct:!!a?.correct})).filter(a=>a.text);
      if(qq.answers.length===0) qq.answers=[{text:"–í–∞—Ä–∏–∞–Ω—Ç A", correct:true},{text:"–í–∞—Ä–∏–∞–Ω—Ç B", correct:false}];
      if(!qq.answers.some(a=>a.correct)) qq.answers[0].correct=true;
    }else{
      const t = (Array.isArray(q.answers) ? q.answers[0]?.text : q.answer) || '';
      qq.answers=[{text:String(t||'').trim(), correct:true}];
    }
    return qq;
  }
  function normalizeConfig(cfg){
    const out = JSON.parse(JSON.stringify(DEFAULT));
    if(cfg && typeof cfg==='object'){
      if(typeof cfg.title==='string') out.title=cfg.title;
      if([1,2,3].includes(Number(cfg.teams))) out.teams=Number(cfg.teams);
      if(typeof cfg.autoNext==='boolean') out.autoNext=cfg.autoNext;
      if(typeof cfg.latex==='boolean') out.latex=cfg.latex;
      if(typeof cfg.bgUrl==='string') out.bgUrl=cfg.bgUrl;
      if(typeof cfg.shotSound==='string') out.shotSound=cfg.shotSound;
      if(typeof cfg.shotVol==='number') out.shotVol=Math.max(0,Math.min(1,cfg.shotVol));
      if(Array.isArray(cfg.questions)) out.questions = cfg.questions.map(normalizeQuestion).filter(Boolean);
    }
    return out;
  }
  function loadConfig(){
    const q = loadConfigFromQuery();
    if(q) return normalizeConfig(q);
    const raw = localStorage.getItem('math_tir_cfg_v19');
    if(raw){ try{ return normalizeConfig(JSON.parse(raw)); }catch(e){} }
    return normalizeConfig(DEFAULT);
  }
  function saveConfig(cfg){ localStorage.setItem('math_tir_cfg_v19', JSON.stringify(cfg)); }

  let CFG = loadConfig();

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  function shorten(s,n){ s=String(s||''); return s.length>n ? (s.slice(0,n-1)+'‚Ä¶') : s; }

  // Editor bindings
  function bindEditor(){
    $('gameTitle').value = CFG.title;
    $('teamCount').value = String(CFG.teams);
    $('autoNext').value = CFG.autoNext ? '1':'0';
    $('latex').value = CFG.latex ? '1':'0';
    $('bgUrl').value = CFG.bgUrl || DEFAULT.bgUrl;
    $('shotSound').value = CFG.shotSound || 'pip';
    $('shotVol').value = String(CFG.shotVol ?? 0.6);

    $('gameTitle').addEventListener('input', ()=>{ CFG.title = $('gameTitle').value.trim() || DEFAULT.title; persist(); });
    $('teamCount').addEventListener('change', ()=>{ CFG.teams = Number($('teamCount').value); persist(); });
    $('autoNext').addEventListener('change', ()=>{ CFG.autoNext = $('autoNext').value==='1'; persist(); });
    $('latex').addEventListener('change', ()=>{ CFG.latex = $('latex').value==='1'; persist(true); });
    $('bgUrl').addEventListener('input', ()=>{ CFG.bgUrl = $('bgUrl').value.trim(); persist(); });

    $('shotVol').addEventListener('input', ()=>{ CFG.shotVol = Number($('shotVol').value); persist(); });
    $('shotSound').addEventListener('change', ()=>{ CFG.shotSound = $('shotSound').value; persist(); playShot(CFG.shotSound, CFG.shotVol); });

    $('btnAdd').addEventListener('click', ()=>openModalForNew());
    $('btnClear').addEventListener('click', ()=>{ CFG.questions=[]; persist(); });
    $('btnCopy').addEventListener('click', copyIframe);

    document.addEventListener('pointerdown', ()=>ensureAudio(), {once:true});
  }

  function persist(reloadMathJax=false){
    saveConfig(CFG);
    renderQuestionList();
    renderPreview();
    if(reloadMathJax && window.MathJax){ try{ window.MathJax.typesetPromise?.(); }catch(e){} }
  }

  // Questions list
  function renderQuestionList(){
    const host = $('qList');
    host.innerHTML='';
    $('qCount').textContent = String(CFG.questions.length);

    CFG.questions.forEach((q, idx)=>{
      const el = document.createElement('div');
      el.className='qitem';
      const meta = [q.type==='mcq'?'–í—ã–±–æ—Ä':'–í–≤–æ–¥', (q.points||0)+' –æ—á–∫.', q.timerOn?('—Ç–∞–π–º–µ—Ä '+q.seconds+'—Å'):'–±–µ–∑ —Ç–∞–π–º–µ—Ä–∞'].join(' ‚Ä¢ ');
      el.innerHTML = `
        <div>
          <div class="qtitle">${escapeHtml(shorten(q.text, 44) || ('–í–æ–ø—Ä–æ—Å '+(idx+1)))}</div>
          <div class="qmeta">${escapeHtml(meta)}</div>
        </div>
        <div class="qactions">
          <button class="iconbtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="iconbtn danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        </div>`;
      const [btnEdit, btnDel] = el.querySelectorAll('button');
      btnEdit.addEventListener('click', ()=>openModal(idx));
      btnDel.addEventListener('click', ()=>{ CFG.questions.splice(idx,1); persist(); });
      host.appendChild(el);
    });
  }

  // Modal for editor
  let editingIndex = null;
  function showModal(on){
    const bd = $('backdrop');
    bd.style.display = on ? 'flex' : 'none';
    bd.setAttribute('aria-hidden', on ? 'false' : 'true');
  }
  function updateTimerBadge(){
    const on = $('timerOn').checked;
    const badge = $('timerBadge');
    if(on){
      badge.classList.add('show');
      $('timerBadgeVal').textContent = String(Math.max(5, Math.round(Number($('qSec').value||30))));
    }else badge.classList.remove('show');
  }
  function makeAnsRow(text, correct){
    const row = document.createElement('div');
    row.className = 'ansRow';
    row.innerHTML = `
      <input type="text" value="${escapeHtml(text)}" placeholder="–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞"/>
      <label class="chk" style="margin:0"><input type="checkbox" ${correct?'checked':''}/> <span>–≤–µ—Ä–Ω—ã–π</span></label>
      <button class="iconbtn danger" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>`;
    row.querySelector('button').addEventListener('click', ()=>row.remove());
    row.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
      if(e.target.checked){
        document.querySelectorAll('.ansRow input[type="checkbox"]').forEach(chk=>{ if(chk!==e.target) chk.checked=false; });
      }
    });
    return row;
  }
  function renderAnswersUI(q){
    const box = $('answersBox');
    box.innerHTML='';
    const currentType = $('qType').value;
    if(currentType==='input'){
      box.innerHTML = `
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–≤–≤–æ–¥)</label>
        <input data-input-answer type="text" value="${escapeHtml(q.answers?.[0]?.text||'')}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 42"/>`;
      return;
    }
    const head = document.createElement('div');
    head.className='inlineRow';
    head.innerHTML = `<span class="tag">–í–∞—Ä–∏–∞–Ω—Ç—ã (–º–æ–∂–Ω–æ —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ)</span><button class="btn secondary mini" id="btnAddAns">+ –í–∞—Ä–∏–∞–Ω—Ç</button>`;
    box.appendChild(head);
    const list = document.createElement('div');
    list.className='answers';
    list.id='ansList';
    (q.answers||[]).forEach(a=>list.appendChild(makeAnsRow(a.text||'', !!a.correct)));
    if(!list.children.length) list.appendChild(makeAnsRow('', true));
    box.appendChild(list);
    $('btnAddAns').addEventListener('click', ()=>list.appendChild(makeAnsRow('', false)));
  }
  function fillModal(q){
    $('modalTitle').textContent = (editingIndex===null ? '–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞');
    $('qText').value = q.text || '';
    $('qPts').value = String(q.points ?? 10);
    $('qType').value = q.type === 'input' ? 'input' : 'mcq';
    $('timerOn').checked = !!q.timerOn;
    $('qSec').value = String(q.seconds ?? 30);
    $('qImg').value = q.image || '';
    $('qAud').value = q.audio || '';
    updateTimerBadge();
    renderAnswersUI(q);
  }
  function readModal(){
    const type = $('qType').value;
    const text = $('qText').value.trim();
    const points = Math.max(0, Math.round(Number($('qPts').value||0)));
    const timerOn = $('timerOn').checked;
    const seconds = Math.max(5, Math.round(Number($('qSec').value||30)));
    const image = $('qImg').value.trim();
    const audio = $('qAud').value.trim();

    const q = { text, type, points, timerOn, seconds, image, audio, answers: [] };
    if(!text) return null;

    if(type==='mcq'){
      const rows = Array.from(document.querySelectorAll('.ansRow'));
      rows.forEach(r=>{
        const inp = r.querySelector('input[type="text"]');
        const chk = r.querySelector('input[type="checkbox"]');
        const t = inp.value.trim();
        if(t) q.answers.push({text:t, correct: chk.checked});
      });
      if(!q.answers.length) q.answers = [{text:'–í–∞—Ä–∏–∞–Ω—Ç A', correct:true}];
      if(!q.answers.some(a=>a.correct)) q.answers[0].correct=true;
    }else{
      const correct = document.querySelector('input[data-input-answer]')?.value?.trim() || '';
      q.answers = [{text: correct, correct:true}];
    }
    return q;
  }

  function openModalForNew(){
    editingIndex = null;
    fillModal({text:'', type:'mcq', points:10, timerOn:false, seconds:30, image:'', audio:'', answers:[{text:'', correct:true},{text:'', correct:false}]});
    showModal(true);
  }
  function openModal(idx){
    editingIndex = idx;
    fillModal(CFG.questions[idx]);
    showModal(true);
  }
  function bindModal(){
    $('btnClose').addEventListener('click', ()=>showModal(false));
    $('btnCancel').addEventListener('click', ()=>showModal(false));
    $('backdrop').addEventListener('click', (e)=>{ if(e.target===$('backdrop')) showModal(false); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $('backdrop').style.display==='flex') showModal(false); });

    $('qType').addEventListener('change', ()=>{
      const tmp = readModal() || {text:$('qText').value.trim(), type:$('qType').value, answers:[]};
      renderAnswersUI(tmp);
    });
    $('timerOn').addEventListener('change', updateTimerBadge);
    $('qSec').addEventListener('input', updateTimerBadge);
    $('btnDelImg').addEventListener('click', ()=>{$('qImg').value='';});
    $('btnDelAud').addEventListener('click', ()=>{$('qAud').value='';});

    $('btnSave').addEventListener('click', ()=>{
      const q = readModal();
      if(!q){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞'); return; }
      const norm = normalizeQuestion(q);
      if(editingIndex===null) CFG.questions.push(norm);
      else CFG.questions[editingIndex]=norm;
      showModal(false);
      persist();
    });
  }

  // ===== Preview game =====
  let gameState = null;
  function cssEscapeUrl(url){ return String(url).replace(/\\\\/g,'\\\\\\\\').replace(/'/g,"\\\\'"); }

  function renderPreview(){
    const host = $('previewHost');
    host.innerHTML='';
    const bgUrlArena = normalizeBg(CFG.bgUrl);
    const teams = CFG.teams;

    const shell = document.createElement('div');
    shell.className='card';
    shell.style.borderRadius='22px';
    shell.style.overflow='hidden';
    shell.style.boxShadow='none';
    shell.style.border='1px solid rgba(255,255,255,.10)';
    shell.innerHTML = `
      <div class="previewTop">
        <div class="pvLeft">
          <div class="pvTitle">${escapeHtml(CFG.title)}</div>
          <div class="pvHelp">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
        </div>
        <div class="pvRight">
          <span class="badge">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b id="pvTeamNow">–ö–æ–º–∞–Ω–¥–∞ 1</b></span>
          <span class="badge">–¶–µ–ª–∏: <span id="pvDone">0</span>/<span id="pvTotal">0</span></span>
          <div class="pvBtns">
            <button class="btn secondary" id="pvHelpBtn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="btn secondary" id="pvResetBtn">–°–±—Ä–æ—Å</button>
          </div>
        </div>
      </div>
      <div class="teamsBar" id="teamsBar"></div>
      <div class="arena" id="arena" style="--arena-bg: url('${cssEscapeUrl(bgUrlArena)}');">
        <div class="gridOverlay"></div>
        <div class="crosshair" id="crosshair" style="left:92%; top:70%"></div>
      </div>`;
    host.appendChild(shell);

    gameState = { teamNow:0, scores:[0,0,0], names:['–ö–æ–º–∞–Ω–¥–∞ 1','–ö–æ–º–∞–Ω–¥–∞ 2','–ö–æ–º–∞–Ω–¥–∞ 3'], used:new Set() };

    const bar = shell.querySelector('#teamsBar');
    bar.style.gridTemplateColumns = `repeat(${teams}, minmax(0,1fr))`;
    bar.innerHTML='';
    for(let i=0;i<teams;i++){
      const tc = document.createElement('div');
      tc.className = 'teamCard' + (i===0?' active':'');
      tc.innerHTML = `<div><input class="teamNameInput" value="${escapeHtml(gameState.names[i])}" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ${i+1}"/></div>
                      <div class="teamScore" id="score_${i}">0</div>`;
      const inp = tc.querySelector('input');
      inp.addEventListener('input', ()=>{ gameState.names[i] = inp.value.trim() || ('–ö–æ–º–∞–Ω–¥–∞ '+(i+1)); updateHeaderNow(shell); });
      tc.addEventListener('click', (e)=>{ if(e.target.tagName==='INPUT') return; setActiveTeam(shell,i); });
      bar.appendChild(tc);
    }

    shell.querySelector('#pvTotal').textContent = String(CFG.questions.length);
    shell.querySelector('#pvDone').textContent = '0';

    const arena = shell.querySelector('#arena');
    const crosshair = shell.querySelector('#crosshair');
    arena.addEventListener('mousemove', (e)=>{
      const r = arena.getBoundingClientRect();
      const x = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
      const y = Math.max(0, Math.min(1, (e.clientY - r.top) / r.height));
      crosshair.style.left = (x*100).toFixed(1)+'%';
      crosshair.style.top  = (y*100).toFixed(1)+'%';
      const dx = (x - 0.5) * 14;
      const dy = (y - 0.5) * 10;
      arena.style.setProperty('--bg-x', `calc(50% + ${dx}px)`);
      arena.style.setProperty('--bg-y', `calc(50% + ${dy}px)`);
    });

    buildTargets(arena, shell);

    shell.querySelector('#pvResetBtn').addEventListener('click', ()=>{
      gameState.scores=[0,0,0]; gameState.used.clear();
      setActiveTeam(shell,0);
      shell.querySelector('#pvDone').textContent='0';
      for(let i=0;i<teams;i++) shell.querySelector('#score_'+i).textContent='0';
      arena.querySelectorAll('.target').forEach(t=>t.classList.remove('hit'));
    });
    shell.querySelector('#pvHelpBtn').addEventListener('click', ()=>{
      alert('–ü—Ä–∞–≤–∏–ª–∞:\\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\\n2) –ö–ª–∏–∫ –ø–æ –º–∏—à–µ–Ω–∏ ‚Äî –≤—ã—Å—Ç—Ä–µ–ª\\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\\n4) –û—á–∫–∏ –∏–¥—É—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ');
    });

    updateHeaderNow(shell);
  }

  function setActiveTeam(shell, idx){
    gameState.teamNow=idx;
    shell.querySelectorAll('.teamCard').forEach((c,i)=>c.classList.toggle('active', i===idx));
    updateHeaderNow(shell);
  }
  function updateHeaderNow(shell){
    shell.querySelector('#pvTeamNow').textContent = gameState.names[gameState.teamNow] || ('–ö–æ–º–∞–Ω–¥–∞ '+(gameState.teamNow+1));
  }

  function buildTargets(arena, shell){
    arena.querySelectorAll('.target').forEach(n=>n.remove());
    const qs = CFG.questions;

    if(qs.length===0){
      const t = document.createElement('div');
      t.className='target';
      t.style.left='50%'; t.style.top='26%';
      t.innerHTML = `<div class="num">+</div><div class="pts">–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã</div>`;
      t.addEventListener('click', ()=>playShot(CFG.shotSound, CFG.shotVol));
      arena.appendChild(t);
      shell.querySelector('#pvTotal').textContent='0';
      shell.querySelector('#pvDone').textContent='0';
      return;
    }

    const yMin=14, yMax=38, xMin=12, xMax=92;
    for(let i=0;i<qs.length;i++){
      const q = qs[i];
      const t = document.createElement('div');
      t.className='target';
      const x = xMin + ((i*37)%100)/100 * (xMax-xMin);
      const y = yMin + ((i*53)%100)/100 * (yMax-yMin);
      t.style.left = x.toFixed(1)+'%';
      t.style.top  = y.toFixed(1)+'%';
      t.innerHTML = `<div class="num">${i+1}</div><div class="pts">${q.points||0} –æ—á–∫.</div>`;
      t.addEventListener('click', ()=>onShootTarget(t, i, q, arena, shell));
      arena.appendChild(t);
    }
    shell.querySelector('#pvTotal').textContent = String(qs.length);
    shell.querySelector('#pvDone').textContent = String(gameState.used.size);
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function onShootTarget(el, idx, q, arena, shell){
    playShot(CFG.shotSound, CFG.shotVol);
    openPlayQuestion(q, (ok)=>{
      if(ok){
        gameState.scores[gameState.teamNow] += (q.points||0);
        shell.querySelector('#score_'+gameState.teamNow).textContent = String(gameState.scores[gameState.teamNow]);
        gameState.used.add(idx);
        shell.querySelector('#pvDone').textContent = String(gameState.used.size);
        el.classList.add('hit');
      }else{
        arena.classList.remove('shake'); void arena.offsetWidth; arena.classList.add('shake');
      }
      if(CFG.autoNext){
        setActiveTeam(shell, (gameState.teamNow+1)%CFG.teams);
      }
    });
  }

  // Play question modal (separate)
  let playBackdrop = null;
  function openPlayQuestion(q, doneCb){
    if(!playBackdrop){
      playBackdrop = document.createElement('div');
      playBackdrop.className='backdrop';
      playBackdrop.style.display='flex';
      playBackdrop.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true">
          <div class="modalHead">
            <div class="mhTitle">–í–æ–ø—Ä–æ—Å</div>
            <button class="btn secondary" data-close>Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å</button>
          </div>
          <div class="modalBody">
            <div class="timerBadge" id="pTimer">‚è± <span id="pTimerVal">‚Äî</span></div>
            <div id="pContent"></div>
          </div>
          <div class="modalFoot">
            <button class="btn secondary" data-wrong>–ù–µ–≤–µ—Ä–Ω–æ</button>
            <button class="btn" data-right>–í–µ—Ä–Ω–æ</button>
          </div>
        </div>`;
      document.body.appendChild(playBackdrop);
      playBackdrop.addEventListener('click', (e)=>{ if(e.target===playBackdrop) close(false); });
      playBackdrop.querySelector('[data-close]').addEventListener('click', ()=>close(false));
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && playBackdrop.style.display==='flex') close(false); });
    }

    const content = playBackdrop.querySelector('#pContent');
    content.innerHTML = `<div style="font-weight:900; font-size:16px">${escapeHtml(q.text)}</div>`;

    if(q.image){
      const img = document.createElement('img');
      img.src=q.image;
      img.style.maxWidth='100%';
      img.style.borderRadius='14px';
      img.style.marginTop='10px';
      img.style.border='1px solid rgba(255,255,255,.12)';
      content.appendChild(img);
    }
    if(q.audio){
      const aud = document.createElement('audio');
      aud.controls=true;
      aud.src=q.audio;
      aud.style.width='100%';
      aud.style.marginTop='10px';
      content.appendChild(aud);
    }

    const block = document.createElement('div');
    block.style.marginTop='12px';
    content.appendChild(block);

    // timer
    const timerBox = playBackdrop.querySelector('#pTimer');
    const timerVal = playBackdrop.querySelector('#pTimerVal');
    let left = q.seconds || 30;
    let tId = null;
    timerBox.classList.remove('show');
    if(q.timerOn){
      timerBox.classList.add('show');
      timerVal.textContent = left + ' —Å–µ–∫';
      tId = setInterval(()=>{
        left--;
        timerVal.textContent = left + ' —Å–µ–∫';
        if(left<=0){ clearInterval(tId); close(false); }
      }, 1000);
    }

    // answers
    const rightBtn = playBackdrop.querySelector('[data-right]');
    const wrongBtn = playBackdrop.querySelector('[data-wrong]');
    rightBtn.style.display=''; wrongBtn.style.display='';
    rightBtn.onclick = null; wrongBtn.onclick = null;

    if(q.type==='input'){
      block.innerHTML = `
        <label style="display:block; margin:0 0 6px; color:rgba(255,255,255,.70); font-size:12px">–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç</label>
        <input id="pInput" type="text" placeholder="–û—Ç–≤–µ—Ç..." style="width:100%; padding:10px 12px; border-radius:14px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); color:rgba(255,255,255,.92)"/>`;
      rightBtn.onclick = ()=>{
        const val = (playBackdrop.querySelector('#pInput')?.value||'').trim().toLowerCase();
        const correct = (q.answers?.[0]?.text||'').trim().toLowerCase();
        close(correct ? (val===correct) : true);
      };
      wrongBtn.onclick = ()=>close(false);
    }else{
      const answers = (q.answers||[]).map(a=>({text:a.text, correct:!!a.correct}));
      const shuffled = shuffle(answers.slice());
      block.innerHTML = `<div class="hint">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:</div>`;
      const opts = document.createElement('div');
      opts.style.display='grid';
      opts.style.gridTemplateColumns='1fr';
      opts.style.gap='8px';
      opts.style.marginTop='8px';
      shuffled.forEach(a=>{
        const b = document.createElement('button');
        b.className='btn secondary';
        b.style.justifyContent='flex-start';
        b.style.width='100%';
        b.textContent=a.text;
        b.addEventListener('click', ()=>{
          opts.querySelectorAll('button').forEach(x=>x.disabled=true);
          close(!!a.correct);
        });
        opts.appendChild(b);
      });
      block.appendChild(opts);
      rightBtn.style.display='none';
      wrongBtn.style.display='none';
    }

    function close(ok){
      if(tId) clearInterval(tId);
      playBackdrop.style.display='none';
      // restore buttons
      rightBtn.style.display=''; wrongBtn.style.display='';
      doneCb(!!ok);
    }

    playBackdrop.style.display='flex';
  }

  // iframe copy
  function copyIframe(){
    const url = new URL(location.href);
    url.searchParams.delete('game');
    url.searchParams.set('game', b64urlEncode(JSON.stringify(CFG)));
    const iframe = `<iframe src="${url.toString()}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    navigator.clipboard.writeText(iframe).then(()=>{ 
      const b=$('btnCopy'); const old=b.textContent; b.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ'; setTimeout(()=>b.textContent=old,1200);
    }).catch(()=>prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe:', iframe));
  }

  function ensureMathJax(){
    if(!CFG.latex || window.MathJax) return;
    const s=document.createElement('script');
    s.async=true;
    s.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
    document.head.appendChild(s);
  }

  function boot(){
    const fromQ = !!loadConfigFromQuery();
    if(fromQ){
      document.querySelector('.wrap').style.gridTemplateColumns='1fr';
      document.querySelector('.wrap').children[0].style.display='none';
    }
    ensureMathJax();
    bindEditor();
    bindModal();
    renderQuestionList();
    renderPreview();
  }
  boot();
})();
</script>
</body>
</html>
