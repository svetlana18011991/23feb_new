<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>23feb_new ‚Äî –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä (—Ä–µ–¥–∞–∫—Ç–æ—Ä+–∏–≥—Ä–∞)</title>
  <style>
    :root{
      --bg1:#0b1420; --bg2:#0b1d30; --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08); --stroke:rgba(255,255,255,.12);
      --text:#eaf1ff; --muted:rgba(234,241,255,.70);
      --gold:#d8b65c; --gold2:#f0d38a; --danger:#ff4d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 20% 20%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(216,182,92,.08), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      padding:14px;
    }
    .panel{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .panelHeader h1{
      font-size:18px;
      margin:0 0 4px 0;
      letter-spacing:.2px;
      font-weight:800;
    }
    .panelHeader .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(216,182,92,.40);
      background:linear-gradient(180deg, rgba(216,182,92,.22), rgba(216,182,92,.10));
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      transition:.15s transform, .15s filter, .15s background;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .content{
      padding:12px 14px 16px;
      overflow:auto;
      height:calc(100% - 64px);
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.12));
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
    }
    .cardTitle{
      font-size:13px;
      font-weight:800;
      margin:0 0 8px 0;
      color:rgba(234,241,255,.92);
      letter-spacing:.2px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .hint{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.2;}
    .divider{height:1px; background:rgba(255,255,255,.08); margin:10px 0;}
    .qTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:rgba(234,241,255,.85);
    }
    .qList{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .qItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .qItem .meta{min-width:0}
    .qItem .title{font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .qItem .sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .iconBtn{
      width:36px; height:36px; display:grid; place-items:center;
      border-radius:12px; cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      user-select:none;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .iconBtn.danger{border-color: rgba(255,77,77,.35);}
    /* Preview */
    .previewHeader{
      padding:12px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .previewHeader .ttl{
      font-weight:900; font-size:16px; margin:0;
    }
    .previewHeader .sub{
      font-size:12px; color:var(--muted);
    }
    .previewBody{
      position:relative;
      height:calc(100% - 52px);
      padding:14px;
      overflow:hidden;
    }
    .stage{
      position:relative;
      width:100%;
      height:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 540px at 20% 30%, rgba(255,255,255,.04), transparent 60%),
        radial-gradient(900px 540px at 80% 20%, rgba(216,182,92,.07), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.45) inset;
      cursor:none;
    }
    /* photobg + 3D parallax */
    .bg3d{
      position:absolute; inset:0;
      pointer-events:none;
      transform-style:preserve-3d;
      will-change:transform;
    }
    .bgLayer{
      position:absolute; inset:-40px;
      background-position:center;
      background-size:cover;
      filter:saturate(1.12) contrast(1.06) brightness(1.02);
      transform: translateZ(-1px) scale(1.06);
      opacity:1;
    }
    .bgShade{
      position:absolute; inset:0;
      background:
        radial-gradient(1100px 680px at 20% 20%, rgba(0,0,0,.10), transparent 55%),
        radial-gradient(1100px 680px at 80% 20%, rgba(0,0,0,.08), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.30));
      pointer-events:none;
    }
    .vignette{
      position:absolute; inset:0; pointer-events:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset,
                  0 0 120px rgba(0,0,0,.65) inset;
    }
    /* top HUD - compact */
    .hud{
      position:absolute;
      left:14px; right:14px; top:14px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      pointer-events:auto;
    }
    .hudLeft{min-width:0}
    .gameTitle{
      font-weight:900;
      font-size:20px;
      line-height:1.1;
      margin:0;
      text-shadow: 0 10px 24px rgba(0,0,0,.55);
    }
    .gameHint{
      margin-top:4px;
      font-size:12px;
      color:rgba(234,241,255,.82);
      text-shadow: 0 10px 24px rgba(0,0,0,.55);
    }
    .hudRight{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .chip{
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.24);
      backdrop-filter: blur(6px);
      font-size:12px;
      font-weight:800;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .chip .k{color:rgba(234,241,255,.75); font-weight:700}
    .chipBtn{
      cursor:pointer;
      transition:.15s filter,.15s transform;
    }
    .chipBtn:hover{filter:brightness(1.08)}
    .chipBtn:active{transform:translateY(1px)}
    /* teams row (under HUD, compact) */
    .teamsBar{
      position:absolute;
      left:14px; right:14px; top:74px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      pointer-events:auto;
    }
    .teamCard{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      border-radius:14px;
      padding:10px;
      min-width:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .teamCard.active{
      border-color: rgba(216,182,92,.55);
      box-shadow: 0 0 0 1px rgba(216,182,92,.18) inset;
    }
    .teamName{
      display:flex; flex-direction:column; gap:6px; min-width:0; flex:1;
    }
    .teamName input{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:800;
      width:100%;
    }
    .teamName .lbl{
      font-size:11px; color:rgba(234,241,255,.70);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .teamScore{
      font-weight:900;
      font-size:16px;
      color:rgba(234,241,255,.95);
      min-width:34px;
      text-align:right;
    }
    /* crosshair */
    .crosshair{
      position:absolute;
      width:58px; height:58px;
      margin-left:-29px; margin-top:-29px;
      pointer-events:none;
      border-radius:50%;
      border:2px solid rgba(216,182,92,.80);
      box-shadow: 0 0 0 2px rgba(0,0,0,.30), 0 12px 30px rgba(0,0,0,.35);
      opacity:.95;
      mix-blend-mode:screen;
    }
    .crosshair:before,.crosshair:after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:rgba(216,182,92,.85);
      border-radius:2px;
    }
    .crosshair:before{width:2px; height:48px;}
    .crosshair:after{width:48px; height:2px;}
    .crosshair .dot{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:6px; height:6px; border-radius:50%;
      background:rgba(216,182,92,.95);
      box-shadow:0 0 20px rgba(216,182,92,.35);
    }
    /* targets */
    .targets{
      position:absolute;
      left:0; right:0; top:0; bottom:0;
      pointer-events:auto;
    }
    .target{
      position:absolute;
      width:86px; height:86px;
      margin-left:-43px; margin-top:-43px;
      border-radius:50%;
      border:2px solid rgba(216,182,92,.45);
      background:
        radial-gradient(circle at 50% 50%, rgba(216,182,92,.12), rgba(0,0,0,.22) 55%, rgba(0,0,0,.08) 100%);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .25s ease, filter .25s ease, opacity .25s ease;
      backdrop-filter: blur(1px);
    }
    .target:hover{transform:translateZ(0) scale(1.06); filter:brightness(1.06)}
    .target .num{
      font-weight:1000;
      font-size:18px;
      color:rgba(234,241,255,.92);
      text-shadow: 0 8px 22px rgba(0,0,0,.5);
    }
    .target .pts{
      position:absolute;
      bottom:-18px;
      left:50%;
      transform:translateX(-50%);
      font-size:12px;
      font-weight:900;
      color:rgba(240,211,138,.95);
      background:rgba(0,0,0,.28);
      border:1px solid rgba(216,182,92,.35);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      box-shadow: 0 10px 30px rgba(0,0,0,.40);
    }
    .target.hit{
      pointer-events:none;
      opacity:.35;
      filter:grayscale(1) blur(.3px);
      transform: rotate(-10deg) scale(.86);
    }
    /* question modal */
    .backdrop{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{width:min(980px,96vw);max-height:92vh;overflow:auto;border-radius:18px;background:rgba(10,12,14,.96);border:1px solid rgba(255,255,255,.08);box-shadow:0 18px 60px rgba(0,0,0,.55)}
    .modalTop{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop .left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .modalTop .qTitle{
      font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .modalTop .timer{
      min-width:84px;
      text-align:center;
      font-weight:1000;
      border-radius:999px;
      padding:7px 10px;
      border:1px solid rgba(255,165,0,.45);
      background:rgba(255,165,0,.10);
      color:rgba(255,215,160,.98);
      box-shadow: 0 0 0 1px rgba(255,165,0,.12) inset;
      animation: pulseOrange 1.6s ease-in-out infinite;
      display:none;
    }
    @keyframes pulseOrange{
      0%,100%{transform:scale(1); filter:brightness(1)}
      50%{transform:scale(1.05); filter:brightness(1.08)}
    }
    .modalBody{padding:14px}
    .qText{font-size:16px; font-weight:900; margin:0 0 10px 0; line-height:1.25}
    .qMedia{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px}
    .qMedia a{color:rgba(234,241,255,.9)}
    .mediaChip{
      display:flex; align-items:center; gap:8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:7px 10px;
      font-size:12px;
    }
    .choices{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .choiceBtn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:12px 12px;
      cursor:pointer;
      font-weight:900;
      text-align:left;
      min-height:48px;
      display:flex;
      align-items:center;
      gap:10px;
      transition:.15s filter,.15s transform,.15s border-color;
    }
    .choiceBtn:hover{filter:brightness(1.07)}
    .choiceBtn:active{transform:translateY(1px)}
    .choiceBtn .badge{
      width:26px; height:26px; border-radius:10px;
      border:1px solid rgba(216,182,92,.35);
      display:grid; place-items:center;
      color:rgba(240,211,138,.95);
      font-size:12px;
    }
    .answerRow{
      display:flex; gap:10px; align-items:center;
    }
    .answerInput{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      padding:12px;
      color:var(--text);
      font-weight:800;
    }
    .modalActions{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap:10px;
    }
    .btn2{
      appearance:none; cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:900;
    }
    .btn2.primary{
      border-color: rgba(216,182,92,.45);
      background:linear-gradient(180deg, rgba(216,182,92,.20), rgba(216,182,92,.08));
    }
    .toast{
      position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(234,241,255,.92);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index:60;
      max-width: min(720px, calc(100% - 30px));
    }
    .ver{
      position:absolute; right:14px; bottom:14px;
      font-size:12px; color:rgba(234,241,255,.82);
      border-radius:12px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      z-index:10;
    }
    /* small */
    @media (max-width: 980px){
      body{overflow:auto}
      .wrap{grid-template-columns:1fr; height:auto; overflow:visible}
      .panel{height:auto}
      .previewBody{height:70vh}
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- EDITOR -->
  <section class="panel" id="editorPanel">
    <div class="panelHeader">
      <div>
        <h1>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</h1>
        <div class="sub">–°–æ–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe –¥–ª—è Genially</div>
      </div>
      <button class="btn" id="copyIframeBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
    </div>
    <div class="content">
      <div class="card">
        <div class="cardTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
        <input id="gameTitleInput" type="text" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä" />
      </div>

      <div class="card">
        <div class="cardTitle">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        <div class="row">
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)</label>
            <select id="teamsCountSelect">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
            </select>
          </div>
          <div>
            <label>–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞</label>
            <select id="autoNextTeamSelect">
              <option value="1" selected>–í–∫–ª—é—á—ë–Ω</option>
              <option value="0">–í—ã–∫–ª—é—á–µ–Ω</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>LaTeX (–≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã)</label>
            <select id="latexSelect">
              <option value="0" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
              <option value="1">–í–∫–ª—é—á—ë–Ω</option>
            </select>
          </div>
          <div>
            <label>–§–æ–Ω –∏–≥—Ä—ã (–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞)</label>
            <input id="bgInput" type="text" value="bg_forest.jpg.png" />
            <div class="hint">–ï—Å–ª–∏ —Ñ–æ–Ω —Ä—è–¥–æ–º —Å <b>index.html</b> ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–µ–Ω–∏. –í–∞–∂–Ω–æ —Ç–æ—á–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞</div>
        <div class="row">
          <div>
            <label>–í–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</label>
            <select id="shotSelect">
              <option value="pew" selected>–ö–æ—Ä–æ—Ç–∫–∏–π ¬´–ø–∏—Ñ¬ª</option>
              <option value="snap">–©–µ–ª—á–æ–∫ ¬´—Å–Ω–∞–ø¬ª</option>
              <option value="boom">–ì–ª—É—Ö–æ–π ¬´–±—É–º¬ª</option>
            </select>
            <div class="hint">–í –∏–≥—Ä–µ –≤—ã—Å—Ç—Ä–µ–ª –∑–≤—É—á–∏—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∏—à–µ–Ω–∏.</div>
          </div>
          <div>
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
            <input id="volumeRange" type="range" min="0" max="100" value="70" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="qTop">
          <div>
            <div class="cardTitle" style="margin:0">–í–æ–ø—Ä–æ—Å—ã</div>
            <div class="hint">–ú–∏—à–µ–Ω–µ–π –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.</div>
          </div>
          <div class="pill" id="qCountPill">–í—Å–µ–≥–æ: 0</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn2 primary" id="addQuestionBtn">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn2" id="clearQuestionsBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="qList" id="qList"></div>
      </div>

      <div class="card">
        <div class="cardTitle">Genially</div>
        <div class="hint">–ö–Ω–æ–ø–∫–∞ ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª —Å–æ–∑–¥–∞—Å—Ç —Å—Å—ã–ª–∫—É –≤–∏–¥–∞: <br/><code>.../index.html?game=...</code></div>
      </div>

      <div class="hint" style="opacity:.9">
        <b>–í–µ—Ä—Å–∏—è 20</b> ‚Ä¢ editor+game ‚Ä¢ (–µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äú–Ω–µ –≤–∏–¥–Ω—ã‚Äù, –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∞–¥—Ä–µ—Å <code>?v=20</code>)
      </div>
    </div>
  </section>

  <!-- PREVIEW / GAME -->
  <section class="panel">
    <div class="previewHeader">
      <div>
        <div class="ttl">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
        <div class="sub">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>
      </div>
      <div class="sub">—Ñ–æ–Ω + –º–∏—à–µ–Ω–∏ + –≤–æ–ø—Ä–æ—Å—ã</div>
    </div>
    <div class="previewBody">
      <div class="stage" id="stage">
        <div class="bg3d" id="bg3d">
          <div class="bgLayer" id="bgLayer"></div>
          <div class="bgShade"></div>
        </div>
        <div class="vignette"></div>

        <div class="hud">
          <div class="hudLeft">
            <h2 class="gameTitle" id="gameTitle">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä</h2>
            <div class="gameHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
          </div>
          <div class="hudRight">
            <div class="chip"><span class="k">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç:</span> <span id="activeTeamLabel">–ö–æ–º–∞–Ω–¥–∞ 1</span></div>
            <div class="chip"><span class="k">–¶–µ–ª–∏:</span> <span id="targetsDone">0</span>/<span id="targetsAll">0</span></div>
            <div class="chip chipBtn" id="helpBtn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
            <div class="chip chipBtn" id="resetBtn">–°–±—Ä–æ—Å</div>
          </div>
        </div>

        <div class="teamsBar" id="teamsBar"></div>

        <div class="targets" id="targets"></div>

        <div class="crosshair" id="crosshair"><div class="dot"></div></div>

        <div class="ver" id="versionBadge">–í–µ—Ä—Å–∏—è 21 ‚Ä¢ game</div>

        <div class="backdrop" id="backdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <div class="modalTop">
              <div class="left">
                <div class="qTitle" id="modalTitle">–í–æ–ø—Ä–æ—Å</div>
                <div class="timer" id="modalTimer">30</div>
              </div>
              <button class="btn2" id="closeModalBtn">Esc</button>
            </div>
            <div class="modalBody" id="modalBody">
              <p class="qText" id="qText">‚Ä¶</p>
              <div class="qMedia" id="qMedia"></div>

              <div id="choicesWrap" class="choices" style="display:none"></div>

              <div id="inputWrap" style="display:none">
                <div class="answerRow">
                  <input class="answerInput" id="textAnswerInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ Enter" />
                  <button class="btn2 primary" id="submitTextAnswerBtn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                </div>
                <div class="hint" style="margin-top:8px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
              </div>
            </div>
            <div class="modalActions">
              <button class="btn2" id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </section>
</div>

<script>
/* ========= SAFE HELPERS (no regex pitfalls) ========= */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function safeBase64Encode(obj){
  const json = JSON.stringify(obj);
  const utf8 = new TextEncoder().encode(json);
  let bin = "";
  utf8.forEach(b=>bin += String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function safeBase64Decode(s){
  s = (s||"").replace(/-/g,"+").replace(/_/g,"/");
  while (s.length % 4) s += "=";
  const bin = atob(s);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
  const json = new TextDecoder().decode(bytes);
  return JSON.parse(json);
}

/* ========= STATE ========= */
const DEFAULT_BG = "bg_forest.jpg.png"; // <-- –≤–∞—à —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
const DEFAULT_GAME = {
  v: 20,
  title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
  teams: 3,
  autoNextTeam: true,
  latex: false,
  bg: DEFAULT_BG,
  shot: { type: "pew", volume: 0.70 },
  questions: [] // –ø—É—Å—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
};

let game = structuredClone(DEFAULT_GAME);
let runtime = {
  activeTeam: 0,
  scores: [0,0,0],
  teamNames: ["–ö–æ–º–∞–Ω–¥–∞ 1","–ö–æ–º–∞–Ω–¥–∞ 2","–ö–æ–º–∞–Ω–¥–∞ 3"],
  hit: new Set(),
  currentQ: null,
  timerId: null,
  timeLeft: 0,
};

/* ========= DOM ========= */
const $ = (sel,root=document)=>root.querySelector(sel);
const stage = $("#stage");
const bgLayer = $("#bgLayer");
const bg3d = $("#bg3d");
const crosshair = $("#crosshair");
const targetsEl = $("#targets");
const teamsBar = $("#teamsBar");
const targetsDone = $("#targetsDone");
const targetsAll = $("#targetsAll");
const activeTeamLabel = $("#activeTeamLabel");
const toast = $("#toast");

const gameTitleInput = $("#gameTitleInput");
const teamsCountSelect = $("#teamsCountSelect");
const autoNextTeamSelect = $("#autoNextTeamSelect");
const latexSelect = $("#latexSelect");
const bgInput = $("#bgInput");
const shotSelect = $("#shotSelect");
const volumeRange = $("#volumeRange");

const addQuestionBtn = $("#addQuestionBtn");
const clearQuestionsBtn = $("#clearQuestionsBtn");
const qList = $("#qList");
const qCountPill = $("#qCountPill");
const copyIframeBtn = $("#copyIframeBtn");

const backdrop = $("#backdrop");
const modalTitle = $("#modalTitle");
const modalTimer = $("#modalTimer");
const qText = $("#qText");
const qMedia = $("#qMedia");
const choicesWrap = $("#choicesWrap");
const inputWrap = $("#inputWrap");
const textAnswerInput = $("#textAnswerInput");
const submitTextAnswerBtn = $("#submitTextAnswerBtn");
const closeModalBtn = $("#closeModalBtn");
const skipBtn = $("#skipBtn");

const helpBtn = $("#helpBtn");
const resetBtn = $("#resetBtn");

const gameTitle = $("#gameTitle");
const versionBadge = $("#versionBadge");

/* ========= AUDIO (simple synth) ========= */
let audioCtx = null;
function ensureAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playShotPreview(){
  // called when user selects a variant in editor
  playShot(cfg.shotVariant, cfg.shotVolume);
}

function playShot(variant="pew", volume=0.85){
  try{
    ensureAudio();
    if(!audioCtx) return;

    const t0 = audioCtx.currentTime;
    const out = audioCtx.createGain();
    out.gain.setValueAtTime(Math.max(0.0001, volume), t0);
    out.connect(masterGain);

    const stopAt = t0 + 0.55;

    if(variant === "pew"){
      const o = audioCtx.createOscillator();
      o.type = "square";
      o.frequency.setValueAtTime(980, t0);
      o.frequency.exponentialRampToValueAtTime(220, t0 + 0.12);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.9, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

      o.connect(g); g.connect(out);
      o.start(t0); o.stop(stopAt);

      const b = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.02, audioCtx.sampleRate);
      const ch = b.getChannelData(0);
      for(let i=0;i<ch.length;i++){ ch[i] = (Math.random()*2-1) * (1 - i/ch.length) * 0.55; }
      const n = audioCtx.createBufferSource(); n.buffer = b;
      const ng = audioCtx.createGain();
      ng.gain.setValueAtTime(0.28, t0);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.03);
      n.connect(ng); ng.connect(out);
      n.start(t0);
    } else if(variant === "bang"){
      const o = audioCtx.createOscillator();
      o.type="triangle";
      o.frequency.setValueAtTime(190, t0);
      o.frequency.exponentialRampToValueAtTime(55, t0+0.18);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.98, t0+0.008);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);

      o.connect(g); g.connect(out);
      o.start(t0); o.stop(stopAt);

      const o2 = audioCtx.createOscillator();
      o2.type="sawtooth";
      o2.frequency.setValueAtTime(560, t0);
      o2.frequency.exponentialRampToValueAtTime(140, t0+0.08);

      const g2 = audioCtx.createGain();
      g2.gain.setValueAtTime(0.0001, t0);
      g2.gain.exponentialRampToValueAtTime(0.55, t0+0.01);
      g2.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);

      o2.connect(g2); g2.connect(out);
      o2.start(t0); o2.stop(stopAt);
    } else {
      const o = audioCtx.createOscillator();
      o.type="sine";
      o.frequency.setValueAtTime(125, t0);
      o.frequency.exponentialRampToValueAtTime(38, t0+0.26);

      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.95, t0+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.38);

      o.connect(g); g.connect(out);
      o.start(t0); o.stop(stopAt);
    }

    out.gain.exponentialRampToValueAtTime(0.0001, stopAt);
    setTimeout(()=>{ try{ out.disconnect(); }catch(e){} }, 800);
  }catch(e){}
}


function resolveBgUrl(bg){
  const val = (bg||"").trim() || DEFAULT_BG;
  // absolute url?
  if (/^https?:\/\//i.test(val)) return val;
  // relative in same folder
  return val;
}
function applyBg(){
  const url = resolveBgUrl(game.bg);
  bgLayer.style.backgroundImage = `url("${url}")`;
}
function renderHUD(){
  gameTitle.textContent = game.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
  versionBadge.textContent = `–í–µ—Ä—Å–∏—è 21 ‚Ä¢ game`;
  activeTeamLabel.textContent = runtime.teamNames[runtime.activeTeam] || `–ö–æ–º–∞–Ω–¥–∞ ${runtime.activeTeam+1}`;
}
function renderTeams(){
  teamsBar.innerHTML = "";
  const n = clamp(parseInt(game.teams||3,10)||3,1,3);
  // grid columns
  teamsBar.style.gridTemplateColumns = `repeat(${n}, 1fr)`;

  // adjust runtime arrays
  runtime.scores = runtime.scores.slice(0,n);
  while(runtime.scores.length<n) runtime.scores.push(0);
  runtime.teamNames = runtime.teamNames.slice(0,n);
  while(runtime.teamNames.length<n) runtime.teamNames.push(`–ö–æ–º–∞–Ω–¥–∞ ${runtime.teamNames.length+1}`);

  for(let i=0;i<n;i++){
    const card = document.createElement("div");
    card.className = "teamCard" + (i===runtime.activeTeam ? " active":"");
    card.dataset.i = String(i);

    const nameWrap = document.createElement("div");
    nameWrap.className = "teamName";

    const lbl = document.createElement("div");
    lbl.className = "lbl";
    lbl.textContent = `–ö–æ–º–∞–Ω–¥–∞ ${i+1}`;

    const inp = document.createElement("input");
    inp.value = runtime.teamNames[i];
    inp.addEventListener("input", ()=>{
      runtime.teamNames[i] = inp.value || `–ö–æ–º–∞–Ω–¥–∞ ${i+1}`;
      renderHUD();
    });

    nameWrap.appendChild(lbl);
    nameWrap.appendChild(inp);

    const score = document.createElement("div");
    score.className = "teamScore";
    score.textContent = String(runtime.scores[i]||0);

    card.appendChild(nameWrap);
    card.appendChild(score);

    card.addEventListener("click", ()=>{
      runtime.activeTeam = i;
      renderTeams();
      renderHUD();
    });

    teamsBar.appendChild(card);
  }
  renderHUD();
}
function computeTargetPositions(count){
  // Place in upper part near background targets area:
  // We'll distribute in a wide arc band between 26%..58% height and 14%..86% width.
  const positions=[];
  const cols = Math.ceil(Math.sqrt(count));
  const rows = Math.ceil(count/cols);
  for(let idx=0; idx<count; idx++){
    const r = Math.floor(idx/cols);
    const c = idx%cols;
    const x = ( (c+0.5)/cols ) * 72 + 14; // 14..86
    const y = ( (r+0.4)/rows ) * 32 + 26; // 26..58
    // jitter
    const jx = (Math.random()-0.5)*6;
    const jy = (Math.random()-0.5)*5;
    positions.push({x:x+jx, y:y+jy});
  }
  return positions;
}
function renderTargets(){
  targetsEl.innerHTML = "";
  const qs = game.questions || [];
  targetsAll.textContent = String(qs.length);
  targetsDone.textContent = String(runtime.hit.size);

  const pos = computeTargetPositions(qs.length);

  qs.forEach((q, idx)=>{
    const t = document.createElement("div");
    t.className = "target";
    t.dataset.qid = q.id;
    if (runtime.hit.has(q.id)) t.classList.add("hit");
    t.style.left = pos[idx].x + "%";
    t.style.top  = pos[idx].y + "%";

    // subtle floating
    t.animate(
      [
        { transform:`translateZ(0) translateY(0px)` },
        { transform:`translateZ(0) translateY(-6px)` },
        { transform:`translateZ(0) translateY(0px)` },
      ],
      { duration: 4200 + Math.random()*1600, iterations: Infinity, easing:"ease-in-out", delay: Math.random()*900 }
    );

    const num = document.createElement("div");
    num.className = "num";
    num.textContent = String(idx+1);

    const pts = document.createElement("div");
    pts.className = "pts";
    pts.textContent = (q.points||10) + " –æ—á–∫.";

    t.appendChild(num);
    t.appendChild(pts);

    t.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      if (runtime.hit.has(q.id)) return;
      playShot(false);
      // screen shake a bit
      stage.animate(
        [{ transform:"translate(0,0)"},{ transform:"translate(2px,-2px)"},{ transform:"translate(-2px,2px)"},{ transform:"translate(0,0)"}],
        { duration: 220, easing:"ease-out" }
      );
      openQuestion(q);
    });

    targetsEl.appendChild(t);
  });
}
function toastMsg(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.style.display="none", 1800);
}

/* ========= MODAL (question) ========= */
function stopTimer(){
  if (runtime.timerId) clearInterval(runtime.timerId);
  runtime.timerId = null;
  runtime.timeLeft = 0;
  modalTimer.style.display = "none";
}
function startTimer(seconds){
  stopTimer();
  if (!seconds || seconds<=0) return;
  runtime.timeLeft = seconds;
  modalTimer.textContent = String(runtime.timeLeft);
  modalTimer.style.display = "inline-block";
  runtime.timerId = setInterval(()=>{
    runtime.timeLeft--;
    modalTimer.textContent = String(runtime.timeLeft);
    if (runtime.timeLeft <= 0){
      stopTimer();
      // timeout -> wrong
      answer(false, "–í—Ä–µ–º—è –≤—ã—à–ª–æ");
    }
  }, 1000);
}

function openQuestion(q){
  runtime.currentQ = q;

  modalTitle.textContent = `–í–æ–ø—Ä–æ—Å #${(game.questions||[]).findIndex(x=>x.id===q.id)+1}`;
  qMedia.innerHTML = "";
  qText.innerHTML = renderText(q.text || "");
  // media chips (optional)
  if (q.imageUrl){
    const chip = document.createElement("div");
    chip.className = "mediaChip";
    chip.innerHTML = "üñºÔ∏è <a href='"+escapeHtml(q.imageUrl)+"' target='_blank' rel='noreferrer'>–∫–∞—Ä—Ç–∏–Ω–∫–∞</a>";
    qMedia.appendChild(chip);
  }
  if (q.audioUrl){
    const chip = document.createElement("div");
    chip.className = "mediaChip";
    chip.innerHTML = "üéµ <a href='"+escapeHtml(q.audioUrl)+"' target='_blank' rel='noreferrer'>–º—É–∑—ã–∫–∞</a>";
    qMedia.appendChild(chip);
  }

  // timer
  if (q.timerEnabled && (q.timerSeconds||0)>0){
    startTimer(clamp(parseInt(q.timerSeconds,10)||0, 1, 999));
  } else {
    stopTimer();
  }

  // render by type
  const type = q.type || "choice";
  choicesWrap.style.display = "none";
  inputWrap.style.display = "none";
  choicesWrap.innerHTML = "";

  if (type === "text"){
    inputWrap.style.display = "block";
    textAnswerInput.value = "";
    textAnswerInput.focus({preventScroll:true});
  } else {
    choicesWrap.style.display = "grid";
    // answers: shuffle so correct not first
    const opts = (q.options||[]).map((t,i)=>({text:t, correct: (i===q.correctIndex)}));
    const shuffled = shuffle(opts);
    const labels = ["A","B","C","D","E","F","G","H","I","J"];
    shuffled.forEach((opt, i)=>{
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.innerHTML = `<span class="badge">${labels[i]||""}</span><span>${renderText(opt.text||"")}</span>`;
      btn.addEventListener("click", ()=> answer(!!opt.correct));
      choicesWrap.appendChild(btn);
    });
  }

  backdrop.style.display = "flex";
}
function closeQuestion(){
  backdrop.style.display = "none";
  stopTimer();
  runtime.currentQ = null;
}
function normalizeAnswer(s){
  return (s||"").toString().trim().toLowerCase();
}
function answer(isCorrect, reason){
  const q = runtime.currentQ;
  if (!q) return;
  stopTimer();

  // mark hit regardless? -> only mark when answered (correct or not) so game progresses
  runtime.hit.add(q.id);
  renderTargets();

  if (isCorrect){
    runtime.scores[runtime.activeTeam] = (runtime.scores[runtime.activeTeam]||0) + (q.points||10);
    toastMsg("‚úÖ –í–µ—Ä–Ω–æ! +" + (q.points||10));
    // mark target fall / hit animation
    const el = targetsEl.querySelector(`[data-qid="${CSS.escape(q.id)}"]`);
    if (el) el.classList.add("hit");
  } else {
    toastMsg("‚ùå –ù–µ–≤–µ—Ä–Ω–æ" + (reason?(" ‚Ä¢ "+reason):""));
  }
  renderTeams();

  // auto next team
  if (game.autoNextTeam){
    runtime.activeTeam = (runtime.activeTeam + 1) % clamp(game.teams||3,1,3);
    renderTeams();
  }

  closeQuestion();
}
function submitTextAnswer(){
  const q = runtime.currentQ;
  if (!q) return;
  const user = normalizeAnswer(textAnswerInput.value);
  const corr = normalizeAnswer(q.correctText || "");
  const ok = user && corr && (user === corr);
  answer(ok);
}

/* ========= SIMPLE HTML escape / latex placeholder ========= */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function renderText(s){
  // keep it safe; if latex enabled, we just show raw with $...$ (katex can be added later)
  return escapeHtml(s).replaceAll("\n","<br/>");
}

/* ========= EDITOR: QUESTIONS MODAL (builder) ========= */
function openQuestionEditor(existing){
  // Build a small editor modal on the fly (compact, like your sample)
  const back = document.createElement("div");
  back.className = "backdrop";
  back.style.display = "flex";
  back.style.zIndex = 80;

  const m = document.createElement("div");
  m.className = "modal";
  m.innerHTML = `
    <div class="modalTop">
      <div class="left">
        <div class="qTitle">${existing ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å" : "–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å"}</div>
        <div class="timer" id="edTimerBadge" style="display:none">—Ç–∞–π–º–µ—Ä</div>
      </div>
      <button class="btn2" id="edClose">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <div>
          <label>–û—á–∫–∏</label>
          <input id="edPoints" type="number" min="1" max="999" value="${existing?.points ?? 10}"/>
        </div>
        <div>
          <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
          <select id="edType">
            <option value="choice" ${(!existing || existing.type!=="text")?"selected":""}>–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
            <option value="text" ${(existing?.type==="text")?"selected":""}>–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>–¢–∞–π–º–µ—Ä</label>
          <select id="edTimerEnabled">
            <option value="0" ${(existing?.timerEnabled)? "" : "selected"}>–í—ã–∫–ª—é—á–µ–Ω</option>
            <option value="1" ${(existing?.timerEnabled)? "selected" : ""}>–í–∫–ª—é—á—ë–Ω</option>
          </select>
        </div>
        <div>
          <label>–°–µ–∫—É–Ω–¥—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)</label>
          <input id="edSeconds" type="number" min="1" max="999" value="${existing?.timerSeconds ?? 30}"/>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
        <textarea id="edText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...">${existing?.text ?? ""}</textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="edImg" type="text" value="${existing?.imageUrl ?? ""}" placeholder="https://..."/>
        </div>
        <div>
          <label>üéµ –ú—É–∑—ã–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="edAud" type="text" value="${existing?.audioUrl ?? ""}" placeholder="https://..."/>
        </div>
      </div>

      <div class="divider"></div>

      <div id="edChoiceBlock">
        <div class="qTop" style="margin-bottom:8px">
          <div class="cardTitle" style="margin:0">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
          <div class="pill">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</div>
        </div>
        <div id="edOpts"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn2 primary" id="edAddOpt">Ôºã –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
          <button class="btn2" id="edAuto4">–°–¥–µ–ª–∞—Ç—å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞</button>
        </div>
        <div class="hint" style="margin-top:8px">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–µ—Ä–Ω—ã–π (—Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∞).</div>
      </div>

      <div id="edTextBlock" style="display:none">
        <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–≤–≤–æ–¥)</label>
        <input id="edCorrectText" type="text" value="${existing?.correctText ?? ""}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12"/>
        <div class="hint">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞/–ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ –∫—Ä–∞—è–º.</div>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn2" id="edCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn2 primary" id="edSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  `;
  back.appendChild(m);
  stage.parentElement.appendChild(back);

  const edClose = m.querySelector("#edClose");
  const edCancel = m.querySelector("#edCancel");
  const edSave = m.querySelector("#edSave");
  const edType = m.querySelector("#edType");
  const edTimerEnabled = m.querySelector("#edTimerEnabled");
  const edChoiceBlock = m.querySelector("#edChoiceBlock");
  const edTextBlock = m.querySelector("#edTextBlock");
  const edOpts = m.querySelector("#edOpts");

  function remove(){ back.remove(); }
  edClose.onclick = remove;
  edCancel.onclick = remove;
  back.addEventListener("click",(e)=>{ if(e.target===back) remove(); });

  function renderOpts(opts, correctIndex){
    edOpts.innerHTML = "";
    opts.forEach((t, i)=>{
      const row = document.createElement("div");
      row.className = "qItem";
      row.innerHTML = `
        <div class="meta" style="flex:1; min-width:0">
          <div class="title">–í–∞—Ä–∏–∞–Ω—Ç ${i+1}</div>
          <div class="sub"><input type="text" class="optInput" value="${escapeHtml(t)}" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞"/></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <label style="margin:0; display:flex; align-items:center; gap:6px; cursor:pointer">
            <input type="radio" name="correctOpt" ${i===correctIndex?"checked":""}/>
            <span style="font-size:12px; color:rgba(234,241,255,.78)">–≤–µ—Ä–Ω—ã–π</span>
          </label>
          <div class="iconBtn danger" title="–£–¥–∞–ª–∏—Ç—å">‚úï</div>
        </div>
      `;
      const inp = row.querySelector(".optInput");
      inp.addEventListener("input", ()=>{ opts[i] = inp.value; });

      const radio = row.querySelector('input[type="radio"]');
      radio.addEventListener("change", ()=>{ correctIndex = i; });

      row.querySelector(".iconBtn.danger").addEventListener("click", ()=>{
        opts.splice(i,1);
        if (correctIndex >= opts.length) correctIndex = opts.length-1;
        if (correctIndex < 0) correctIndex = 0;
        renderOpts(opts, correctIndex);
      });

      edOpts.appendChild(row);
    });

    // store current correct index in dataset
    edOpts.dataset.correctIndex = String(correctIndex ?? 0);
  }

  // init options
  const opts = (existing?.options?.slice?.() || []);
  if (!opts.length && (!existing || existing.type!=="text")){
    // start with 2 empty options (no example text)
    opts.push("","");
  }
  let correctIndex = existing?.correctIndex ?? 0;
  renderOpts(opts, correctIndex);

  function syncType(){
    const t = edType.value;
    if (t==="text"){
      edChoiceBlock.style.display = "none";
      edTextBlock.style.display = "block";
    } else {
      edChoiceBlock.style.display = "block";
      edTextBlock.style.display = "none";
    }
  }
  edType.addEventListener("change", syncType);
  syncType();

  m.querySelector("#edAddOpt").addEventListener("click", ()=>{
    opts.push("");
    renderOpts(opts, parseInt(edOpts.dataset.correctIndex||"0",10)||0);
  });
  m.querySelector("#edAuto4").addEventListener("click", ()=>{
    while(opts.length<4) opts.push("");
    if (opts.length>4) opts.splice(4);
    renderOpts(opts, parseInt(edOpts.dataset.correctIndex||"0",10)||0);
  });

  edSave.addEventListener("click", ()=>{
    const q = {
      id: existing?.id || uid(),
      text: m.querySelector("#edText").value || "",
      points: clamp(parseInt(m.querySelector("#edPoints").value,10)||10, 1, 999),
      type: edType.value,
      timerEnabled: m.querySelector("#edTimerEnabled").value === "1",
      timerSeconds: clamp(parseInt(m.querySelector("#edSeconds").value,10)||30, 1, 999),
      imageUrl: (m.querySelector("#edImg").value || "").trim(),
      audioUrl: (m.querySelector("#edAud").value || "").trim(),
      options: [],
      correctIndex: 0,
      correctText: ""
    };

    if (q.type === "text"){
      q.correctText = (m.querySelector("#edCorrectText").value || "").trim();
    } else {
      q.options = opts.map(x=>x||"");
      q.correctIndex = clamp(parseInt(edOpts.dataset.correctIndex||"0",10)||0, 0, Math.max(0,q.options.length-1));
    }

    // write
    if (existing){
      const idx = game.questions.findIndex(x=>x.id===existing.id);
      if (idx>=0) game.questions[idx] = q;
    } else {
      game.questions.push(q);
    }

    syncEditorToState();
    remove();
  });
}

/* ========= EDITOR RENDER ========= */
function renderQuestionsList(){
  qList.innerHTML = "";
  const qs = game.questions || [];
  qCountPill.textContent = "–í—Å–µ–≥–æ: " + qs.length;

  qs.forEach((q, idx)=>{
    const item = document.createElement("div");
    item.className = "qItem";
    const typeLbl = (q.type==="text") ? "–í–≤–æ–¥" : "–í—ã–±–æ—Ä";
    const timerLbl = (q.timerEnabled) ? (q.timerSeconds+" —Å–µ–∫") : "–±–µ–∑ —Ç–∞–π–º–µ—Ä–∞";
    item.innerHTML = `
      <div class="meta">
        <div class="title">${idx+1}. ${escapeHtml((q.text||"").trim()||"(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)")}</div>
        <div class="sub">${typeLbl} ‚Ä¢ ${q.points||10} –æ—á–∫. ‚Ä¢ ${timerLbl}</div>
      </div>
      <div style="display:flex; gap:8px;">
        <div class="iconBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</div>
        <div class="iconBtn danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</div>
      </div>
    `;
    item.querySelector(".iconBtn").addEventListener("click", ()=> openQuestionEditor(q));
    item.querySelector(".iconBtn.danger").addEventListener("click", ()=>{
      game.questions = game.questions.filter(x=>x.id!==q.id);
      // also remove hits
      runtime.hit.delete(q.id);
      syncEditorToState();
    });
    qList.appendChild(item);
  });

  // update game view
  renderTargets();
}

/* ========= SYNC / URL ========= */
function syncFromEditor(){
  game.title = gameTitleInput.value || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
  game.teams = clamp(parseInt(teamsCountSelect.value,10)||3,1,3);
  game.autoNextTeam = (autoNextTeamSelect.value === "1");
  game.latex = (latexSelect.value === "1");
  game.bg = (bgInput.value||"").trim() || DEFAULT_BG;

  game.shot.type = shotSelect.value;
  game.shot.volume = clamp(parseInt(volumeRange.value,10)/100, 0, 1);

  applyBg();
  renderHUD();
  renderTeams();
  renderTargets();
}
function syncEditorToState(){
  // update UI fields from game state (minimal)
  gameTitleInput.value = game.title;
  teamsCountSelect.value = String(game.teams);
  autoNextTeamSelect.value = game.autoNextTeam ? "1" : "0";
  latexSelect.value = game.latex ? "1" : "0";
  bgInput.value = game.bg || DEFAULT_BG;
  shotSelect.value = game.shot.type || "pew";
  volumeRange.value = String(Math.round((game.shot.volume||0.7)*100));

  // rerender lists & game
  renderQuestionsList();
  syncFromEditor();
}
function setUrlGame(){
  const payload = structuredClone(game);
  payload.v = 20;
  const encoded = safeBase64Encode(payload);
  const url = new URL(location.href);
  url.searchParams.set("game", encoded);
  url.searchParams.set("v","20");
  history.replaceState(null,"", url.toString());
}
function loadFromUrl(){
  const url = new URL(location.href);
  const g = url.searchParams.get("game");
  if (!g) return false;
  try{
    const decoded = safeBase64Decode(g);
    // shallow validate
    if (!decoded || typeof decoded !== "object") return false;
    game = Object.assign(structuredClone(DEFAULT_GAME), decoded);
    // ensure bg default
    if (!game.bg) game.bg = DEFAULT_BG;
    return true;
  }catch(e){
    console.warn("bad game param", e);
    return false;
  }
}

/* ========= EVENTS ========= */
gameTitleInput.addEventListener("input", ()=>{ syncFromEditor(); setUrlGame(); });
teamsCountSelect.addEventListener("change", ()=>{ syncFromEditor(); setUrlGame(); });
autoNextTeamSelect.addEventListener("change", ()=>{ syncFromEditor(); setUrlGame(); });
latexSelect.addEventListener("change", ()=>{ syncFromEditor(); setUrlGame(); });
bgInput.addEventListener("input", ()=>{ syncFromEditor(); setUrlGame(); });

shotSelect.addEventListener("change", ()=>{
  syncFromEditor();
  playShotPreview();
  setUrlGame();
});
volumeRange.addEventListener("input", ()=>{ syncFromEditor(); setUrlGame(); });

addQuestionBtn.addEventListener("click", ()=> openQuestionEditor(null));
clearQuestionsBtn.addEventListener("click", ()=>{
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã?")) return;
  game.questions = [];
  runtime.hit.clear();
  syncEditorToState();
  setUrlGame();
});

copyIframeBtn.addEventListener("click", async ()=>{
  setUrlGame();
  const url = new URL(location.href);
  // always keep game param
  const iframe = `<iframe src="${url.toString()}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
  try{
    await navigator.clipboard.writeText(iframe);
    toastMsg("üìã iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
  }catch(e){
    // fallback
    prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe:", iframe);
  }
});

helpBtn.addEventListener("click", ()=>{
  toastMsg("üõà –ö–ª–∏–∫ –ø–æ –º–∏—à–µ–Ω–∏ ‚Üí –≤–æ–ø—Ä–æ—Å. –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–∞—ë—Ç –æ—á–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ.");
});
resetBtn.addEventListener("click", ()=>{
  runtime.hit.clear();
  runtime.scores = runtime.scores.map(()=>0);
  runtime.activeTeam = 0;
  renderTeams();
  renderTargets();
  toastMsg("–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω");
});

closeModalBtn.addEventListener("click", closeQuestion);
skipBtn.addEventListener("click", ()=>{
  // mark hit but no score
  answer(false, "–ü—Ä–æ–ø—É—Å–∫");
});
submitTextAnswerBtn.addEventListener("click", submitTextAnswer);
textAnswerInput.addEventListener("keydown", (e)=>{
  if (e.key === "Enter") submitTextAnswer();
});

window.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") closeQuestion();
});

/* ========= CROSSHAIR + PARALLAX ========= */
stage.addEventListener("mousemove", (e)=>{
  const r = stage.getBoundingClientRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  crosshair.style.left = x+"px";
  crosshair.style.top  = y+"px";

  // 3D parallax background
  const nx = (x / r.width - 0.5) * 2;
  const ny = (y / r.height - 0.5) * 2;
  bg3d.style.transform = `rotateY(${nx*3}deg) rotateX(${-ny*3}deg)`;
  bgLayer.style.transform = `translate(${nx*10}px, ${ny*10}px) scale(1.06)`;
});
stage.addEventListener("mouseleave", ()=>{
  crosshair.style.left = "-200px";
  crosshair.style.top  = "-200px";
  bg3d.style.transform = "rotateY(0deg) rotateX(0deg)";
  bgLayer.style.transform = "translate(0px,0px) scale(1.06)";
});
stage.addEventListener("click", ()=>{
  // ensure audio is unlocked by user gesture
  try{ ensureAudio(); if (audioCtx.state==="suspended") audioCtx.resume(); }catch(e){}
});

/* ========= INIT ========= */
(function init(){
  // load game from URL if any
  loadFromUrl();
  // ensure bg default: your file is bg_forest.jpg.png
  if (!game.bg) game.bg = DEFAULT_BG;

  // Editor: DO NOT show team name fields (as requested earlier),
  // but in game we keep team inputs in top row.
  syncEditorToState();
  applyBg();

  // If no questions yet ‚Äî keep empty, but show targetsAll=0
  renderTargets();

  // always keep url up to date
  setUrlGame();
})();
</script>
</body>
</html>
