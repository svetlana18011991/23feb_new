<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî editor+game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Pacifico&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#0b0f14; --card:rgba(20,28,38,.72); --text:#e8eef7; --muted:rgba(232,238,247,.70);
      --gold: #caa24d; --neon:#ff8a2a; --danger:#ff5b6b; --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55); --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, sans-serif; background: #0a0f15; color:var(--text); overflow:hidden;}
    
    .app{ height:100vh; display:grid; grid-template-columns: 480px 1fr; gap:16px; padding:16px; }
    .panel{ background: rgba(255,255,255,.05); border:1px solid rgba(255,138,42,.3); border-radius: 22px; display:flex; flex-direction:column; overflow:hidden; }
    .panelHeader{ padding:18px; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center; }
    .scroll{ flex: 1; overflow:auto; padding: 18px; }
    .section{ background: rgba(10,14,20,.22); border: 1px solid rgba(255,138,42,.2); border-radius: 18px; padding: 14px; margin-bottom: 14px; }
    
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(25,35,46,.6); color:#fff; cursor:pointer; }
    .btnGold{ background: rgba(202,162,77,.3); border-color: #caa24d; }
    
    input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#000; color:#fff; margin-top:5px; }
    label { font-size:12px; color:var(--muted); }

    .previewWrap{ display:flex; flex-direction:column; }
    .previewFrame{ flex:1; border:0; width:100%; background: #000; border-radius:18px; }

    /* –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ */
    .qItem { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,.03); padding:10px; border-radius:12px; margin-bottom:8px; border:1px solid rgba(255,255,255,.05); }
    .iconBtn { background:none; border:none; color:var(--muted); cursor:pointer; font-size:18px; }

    .topBrand{position:fixed;left:18px;top:14px;z-index:9999; display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:14px;background:rgba(18,24,33,.6);border:1px solid rgba(255,255,255,.1);backdrop-filter: blur(8px);}
    .topBrand img{height:30px; border-radius:5px;}

    /* –°—Ç–∏–ª–∏ –º–∏—à–µ–Ω–µ–π –≤ –ø—Ä–µ–≤—å—é (–∫–æ–≥–¥–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞) */
    .mode-edit-pos .target { cursor: move !important; border: 2px dashed #ff8a2a !important; }
  </style>
</head>
<body>

<div class="topBrand">
  <img src="63.png" onerror="this.style.display='none'"/>
  <span>–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</span>
</div>

<div id="root"></div>

<script>
const VERSION = "25-Drag";
const params = new URLSearchParams(location.search);
const isGame = params.has('game');

function b64uEncode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function b64uDecode(str){ return JSON.parse(decodeURIComponent(escape(atob(str.replace(/-/g,'+').replace(/_/g,'/'))))); }

/* --- EDITOR --- */
if (!isGame) {
  let cfg = {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    bg: "2.png",
    targetFile: "13.png",
    questions: [],
    teamsCount: 2
  };

  function renderEditor() {
    document.getElementById('root').innerHTML = `
      <div class="app">
        <div class="panel">
          <div class="panelHeader">
            <div style="font-weight:900">–†–ï–î–ê–ö–¢–û–†</div>
            <button class="btn btnGold" id="copyCode">üìã –ö–æ–¥ –¥–ª—è Genially</button>
          </div>
          <div class="scroll">
            <div class="section">
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input type="text" id="edTitle" value="${cfg.title}">
              <label style="margin-top:10px; display:block">–§–æ–Ω (URL –∏–ª–∏ 1.png - 8.png)</label>
              <input type="text" id="edBg" value="${cfg.bg}">
              <label style="margin-top:10px; display:block">–ú–∏—à–µ–Ω—å (URL –∏–ª–∏ 10.png - 14.png)</label>
              <input type="text" id="edTarget" value="${cfg.targetFile}">
            </div>
            <div class="section">
              <div style="display:flex; justify-content:space-between; align-items:center">
                <h3 style="margin:0">–í–æ–ø—Ä–æ—Å—ã</h3>
                <button class="btn" id="addQ">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
              <p style="font-size:11px; color:orange">üí° –¢–µ–ø–µ—Ä—å –º–∏—à–µ–Ω–∏ –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å –º—ã—à–∫–æ–π –ø—Ä—è–º–æ –≤ –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞!</p>
              <div id="qList" style="margin-top:15px"></div>
            </div>
          </div>
        </div>
        <div class="previewWrap">
          <iframe id="pFrame" class="previewFrame"></iframe>
        </div>
      </div>
    `;

    document.getElementById('edTitle').oninput = e => { cfg.title = e.target.value; updatePreview(); };
    document.getElementById('edBg').onchange = e => { cfg.bg = e.target.value; updatePreview(); };
    document.getElementById('edTarget').onchange = e => { cfg.targetFile = e.target.value; updatePreview(); };
    document.getElementById('addQ').onclick = () => {
      cfg.questions.push({ text: "–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å", x: 50, y: 50, points: 10, options: [{text:"–î–∞", correct:true}] });
      renderQList();
      updatePreview();
    };
    document.getElementById('copyCode').onclick = () => {
      const url = location.origin + location.pathname + "?game=" + b64uEncode(cfg);
      const code = `<iframe src="${url}" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`;
      navigator.clipboard.writeText(code);
      alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    };

    renderQList();
    updatePreview();
  }

  function renderQList() {
    const list = document.getElementById('qList');
    list.innerHTML = "";
    cfg.questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'qItem';
      div.innerHTML = `
        <span style="font-size:13px">${i+1}. ${q.text.substring(0,15)}... (${q.x}%, ${q.y}%)</span>
        <button class="iconBtn" onclick="removeQ(${i})">üóëÔ∏è</button>
      `;
      list.appendChild(div);
    });
  }

  window.removeQ = (i) => { cfg.questions.splice(i, 1); renderQList(); updatePreview(); };

  function updatePreview() {
    const frame = document.getElementById('pFrame');
    const data = b64uEncode(cfg);
    frame.src = location.origin + location.pathname + "?game=" + data + "&editMode=1";
  }

  // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç iframe –æ —Å–º–µ–Ω–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  window.addEventListener('message', e => {
    if (e.data.type === 'updatePos') {
      const { index, x, y } = e.data;
      if (cfg.questions[index]) {
        cfg.questions[index].x = Math.round(x);
        cfg.questions[index].y = Math.round(y);
        renderQList();
      }
    }
  });

  renderEditor();
}

/* --- GAME / PREVIEW --- */
if (isGame) {
  const gameCfg = b64uDecode(params.get('game'));
  const editMode = params.has('editMode');

  document.body.innerHTML = `
    <div id="gameArena" style="position:relative; width:100vw; height:100vh; background: #000; overflow:hidden">
      <div id="bg" style="position:absolute; inset:0; background-size:cover; background-position:center"></div>
      <div id="targets"></div>
      <div id="ui" style="position:absolute; top:20px; left:20px; pointer-events:none">
        <h1 style="margin:0; text-shadow: 0 2px 10px #000">${gameCfg.title}</h1>
      </div>
    </div>
  `;

  const bg = document.getElementById('bg');
  bg.style.backgroundImage = `url(${gameCfg.bg})`;
  if (editMode) document.body.classList.add('mode-edit-pos');

  const targetsCont = document.getElementById('targets');

  function renderTargets() {
    targetsCont.innerHTML = "";
    gameCfg.questions.forEach((q, i) => {
      const t = document.createElement('div');
      t.className = 'target';
      t.style.cssText = `
        position:absolute; width:80px; height:80px; left:${q.x}%; top:${q.y}%;
        transform: translate(-50%,-50%); cursor:pointer;
        background: url(${gameCfg.targetFile}) no-repeat center/contain;
        display:flex; align-items:center; justify-content:center;
        color:#fff; font-weight:900; font-size:20px; text-shadow:0 2px 4px #000;
        z-index: 10;
      `;
      t.innerHTML = i + 1;

      if (editMode) {
        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (Drag)
        t.onmousedown = (e) => {
          e.preventDefault();
          const arena = document.getElementById('gameArena');
          const rect = arena.getBoundingClientRect();

          function move(ev) {
            let px = ((ev.clientX - rect.left) / rect.width) * 100;
            let py = ((ev.clientY - rect.top) / rect.height) * 100;
            px = Math.max(0, Math.min(100, px));
            py = Math.max(0, Math.min(100, py));
            
            t.style.left = px + "%";
            t.style.top = py + "%";

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—é –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            window.parent.postMessage({ type: 'updatePos', index: i, x: px, y: py }, "*");
          }

          function stop() {
            window.removeEventListener('mousemove', move);
            window.removeEventListener('mouseup', stop);
          }

          window.addEventListener('mousemove', move);
          window.addEventListener('mouseup', stop);
        };
      }

      targetsCont.appendChild(t);
    });
  }

  renderTargets();
}
</script>
</body>
</html>
