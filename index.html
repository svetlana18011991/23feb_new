<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor v27</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@500&family=Neucha&display=swap');
    :root {
      --text:#eaf0ff; --muted:#a9b6e6; --border: rgba(255,255,255,.10);
      --neon-orange-base: #ffae00; --neon-orange-glow: rgba(255, 136, 0, 0.6);
      --neon-box-shadow: 0 0 5px var(--neon-orange-glow), 0 0 15px var(--neon-orange-glow);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif}
    body{margin:0;color:var(--text);background:radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.15), transparent), #050816; min-height:100vh; overflow:hidden;}
    .app{display:grid; grid-template-columns: 460px 1fr; gap:14px; padding:14px; height:100vh;}
    .panel{background:rgba(255,255,255,.05); border:1px solid var(--neon-orange-base); border-radius:22px; box-shadow: var(--neon-box-shadow); display:flex; flex-direction:column; overflow:hidden;}
    .scroll{flex:1; overflow-y:auto; padding:18px;}
    .section{background: rgba(20,10,0,0.3); border:1px solid rgba(255,174,0,0.4); border-radius:16px; padding:14px; margin-bottom:12px;}
    .title{font-weight:900; font-size:14px; color:var(--neon-orange-base); margin-bottom:10px; display:flex; justify-content:space-between;}
    input, select, textarea{width:100%; border-radius:12px; padding:10px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); color:#fff; outline:none; margin-top:5px;}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--neon-orange-base); background:rgba(255,255,255,.05); color:#fff; cursor:pointer; font-weight:900; display:inline-flex; align-items:center; gap:8px;}
    .btn.primary{background: linear-gradient(90deg, rgba(255,174,0,0.3), rgba(255,100,0,0.2));}
    .topBrand{display:flex; align-items:center; gap:12px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.1);}
    .topBrand img{height:40px; border-radius:8px;}
    .preview-stage{flex:1; background:rgba(0,0,0,0.2); border-radius:20px; overflow:hidden; border:1px solid rgba(255,255,255,0.1); position:relative;}
    iframe{width:100%; height:100%; border:0;}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:9999;}
    .modal{width:min(800px, 95%); background:#0f0b08; border:1px solid var(--neon-orange-base); border-radius:20px; padding:20px; box-shadow: var(--neon-box-shadow); max-height:90vh; overflow-y:auto;}
    .q-item{padding:10px; border-radius:12px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
  </style>
</head>
<body>

<div class="app" id="editorView">
  <div class="panel">
    <div class="scroll">
      <div class="topBrand">
        <img src="63.png" alt="–õ–æ–≥–æ—Ç–∏–ø" />
        <div>
          <div style="font-weight:950; font-size:16px;">–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</div>
          <div style="color:var(--neon-orange-base); font-size:12px;">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</div>
        </div>
      </div>

      <div class="section" style="margin-top:20px;">
        <div class="title">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        <select id="selLang"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="en">English</option></select>
      </div>

      <div class="section">
        <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
        <input type="text" id="inpTitle" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä">
      </div>

      <div class="section">
        <div class="title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</div>
        <label>–§–æ–Ω –∏–≥—Ä—ã (URL)</label>
        <input type="text" id="inpBg" value="2.png">
        <label style="margin-top:10px; display:block">–ú–∏—à–µ–Ω—å (URL)</label>
        <input type="text" id="inpTargetImg" value="13.png">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div><label>–†–∞–¥–∏—É—Å</label><input type="range" id="inpRadius" min="0" max="150" value="0"></div>
          <div><label>–°–∫–æ—Ä–æ—Å—Ç—å</label><input type="range" id="inpSpeed" min="0" max="10" value="0"></div>
        </div>
      </div>

      <div class="section">
        <div class="title">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</div>
        <textarea id="inpInstText" placeholder="–¢–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."></textarea>
        <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
          <input type="color" id="inpInstColor" value="#ff8a2a" style="width:44px; height:44px; padding:2px;">
          <label style="margin:0"><input type="checkbox" id="chkInstGlow" checked> –°–≤–µ—á–µ–Ω–∏–µ</label>
        </div>
      </div>

      <div class="section">
        <div class="title">–í–æ–ø—Ä–æ—Å—ã <span id="qCount">0 / 9</span></div>
        <div style="display:flex; gap:10px;">
          <button class="btn primary" id="btnAddQ">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" id="btnClearQs">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="qList" style="margin-top:12px;"></div>
      </div>

      <button class="btn primary" id="btnCopyCode" style="width:100%;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</button>
    </div>
  </div>

  <div class="panel">
    <div style="padding:14px; border-bottom:1px solid rgba(255,255,255,0.1); font-weight:900;">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div class="preview-stage">
      <iframe id="livePreview"></iframe>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="title"><span id="modalTitle">–í–æ–ø—Ä–æ—Å</span> <button class="btn" onclick="closeModal()">‚úñ</button></div>
    <div class="section">
      <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
      <textarea id="qPrompt"></textarea>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>–ë–∞–ª–ª—ã</label><input type="number" id="qPts" value="10"></div>
        <div><label>–¢–∏–ø</label><select id="qType"><option value="choice">–í—ã–±–æ—Ä</option><option value="input">–í–≤–æ–¥</option></select></div>
      </div>
      <label style="margin-top:10px; display:block;">–®—Ä–∏—Ñ—Ç</label>
      <select id="qFont"><option value="Roboto">Roboto</option><option value="Caveat">Caveat</option><option value="Neucha">Neucha</option></select>
    </div>
    <div id="optArea" class="section">
      <div class="title">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤</div>
      <div id="optList"></div>
      <button class="btn" style="margin-top:10px;" onclick="addOptRow()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveQ">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* --- –õ–æ–≥–∏–∫–∞ –î–∞–Ω–Ω—ã—Ö --- */
let cfg = {
  title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä", bg: "2.png", targetImg: "13.png",
  radius: 0, speed: 0, inst: { text: "", color: "#ff8a2a", glow: true },
  questions: []
};
let editIdx = null;

const b64e = (o) => btoa(unescape(encodeURIComponent(JSON.stringify(o)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const b64d = (s) => JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/')))));

/* --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å --- */
function initEditor(){
  const upd = () => {
    cfg.title = document.getElementById('inpTitle').value;
    cfg.bg = document.getElementById('inpBg').value;
    cfg.targetImg = document.getElementById('inpTargetImg').value;
    cfg.radius = document.getElementById('inpRadius').value;
    cfg.speed = document.getElementById('inpSpeed').value;
    cfg.inst.text = document.getElementById('inpInstText').value;
    cfg.inst.color = document.getElementById('inpInstColor').value;
    cfg.inst.glow = document.getElementById('chkInstGlow').checked;
    
    const data = b64e(cfg);
    document.getElementById('livePreview').src = location.origin + location.pathname + "?game=" + data + "&editMode=1";
    document.getElementById('qCount').innerText = cfg.questions.length + " / 9";
    renderQList();
  };

  document.querySelectorAll('input, select, textarea').forEach(el => el.oninput = upd);
  document.getElementById('btnAddQ').onclick = () => openModal();
  document.getElementById('btnSaveQ').onclick = saveQ;
  document.getElementById('btnCopyCode').onclick = () => {
    const url = location.origin + location.pathname + "?game=" + b64e(cfg);
    navigator.clipboard.writeText(`<iframe src="${url}" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`);
    alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
  };

  window.addEventListener('message', e => {
    if(e.data.type === 'updPos') {
      cfg.questions[e.data.idx].x = e.data.x;
      cfg.questions[e.data.idx].y = e.data.y;
      renderQList();
    }
  });
  upd();
}

function renderQList(){
  const list = document.getElementById('qList');
  list.innerHTML = cfg.questions.map((q, i) => `
    <div class="q-item">
      <span>#${i+1} ${q.text.slice(0,15)}...</span>
      <div><button class="btn" onclick="openModal(${i})" style="padding:5px">‚úèÔ∏è</button>
      <button class="btn" onclick="delQ(${i})" style="padding:5px">üóëÔ∏è</button></div>
    </div>
  `).join('');
}

function openModal(idx = null){
  editIdx = idx;
  const q = idx !== null ? cfg.questions[idx] : { text: "", pts: 10, type: "choice", opts: [{t:"–î–∞", c:true}, {t:"–ù–µ—Ç", c:false}] };
  document.getElementById('qPrompt').value = q.text;
  document.getElementById('qPts').value = q.pts;
  document.getElementById('qType').value = q.type;
  renderOptRows(q.opts);
  document.getElementById('modalBackdrop').style.display = 'flex';
}

function renderOptRows(opts){
  document.getElementById('optList').innerHTML = opts.map((o, i) => `
    <div style="display:flex; gap:10px; margin-top:5px;">
      <input type="checkbox" ${o.c?'checked':''} style="width:20px" onchange="cfg.questions[editIdx].opts[${i}].c = this.checked">
      <input type="text" value="${o.t}" oninput="cfg.questions[editIdx].opts[${i}].t = this.value">
    </div>
  `).join('');
}

function saveQ(){
  const q = {
    text: document.getElementById('qPrompt').value,
    pts: document.getElementById('qPts').value,
    type: document.getElementById('qType').value,
    x: editIdx !== null ? cfg.questions[editIdx].x : 50,
    y: editIdx !== null ? cfg.questions[editIdx].y : 50,
    opts: [{t:"–í–µ—Ä–Ω–æ", c:true}] // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–µ—Ä–µ–º –∏–∑ DOM
  };
  if(editIdx !== null) cfg.questions[editIdx] = q; else cfg.questions.push(q);
  closeModal(); initEditor(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
}

function closeModal(){ document.getElementById('modalBackdrop').style.display = 'none'; }
function delQ(i){ cfg.questions.splice(i,1); renderQList(); }

/* --- –ó–∞–ø—É—Å–∫ --- */
const gameData = params.get('game');
if(gameData) {
  document.getElementById('editorView').style.display = 'none';
  // –ó–¥–µ—Å—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∞–º –ò–ì–†–û–í–û–ô –¥–≤–∏–∂–æ–∫ (–∫–∞–∫ –≤ –≤–∞—à–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –≤–µ—Ä—Å–∏—è—Ö)
} else {
  initEditor();
}
</script>
</body>
</html>
