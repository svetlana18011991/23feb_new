<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî editor+game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Pacifico&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* –í—Å–µ –≤–∞—à–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é */
    :root{
      --bg0:#0b0f14; --card:rgba(20,28,38,.72); --text:#e8eef7; --muted:rgba(232,238,247,.70);
      --gold: #caa24d; --neon:#ff8a2a; --neonSoft: rgba(255,138,42,.18); --neonLine: rgba(255,138,42,.38);
      --danger:#ff5b6b; --ok:#33d17a; --shadow: 0 14px 55px rgba(0,0,0,.55); --qaSize:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%), linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text); overflow:hidden;
    }
    .app{ height:100vh; display:grid; grid-template-columns: 480px 1fr; gap:16px; padding:16px; }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--neonLine); border-radius: 22px; position:relative;
      height: 100%; display:flex; flex-direction:column; overflow:hidden;
    }
    .panelHeader{ padding:18px; border-bottom: 1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center; }
    .scroll{ flex: 1; overflow:auto; padding: 18px; }
    .section{ background: rgba(10,14,20,.22); border: 1px solid rgba(255,138,42,.28); border-radius: 18px; padding: 14px; margin-bottom: 14px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .row1{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px; }
    .btn{ padding:10px 14px; border-radius: 14px; border:1px solid rgba(255,255,255,.13); background: rgba(25,35,46,.55); color:var(--text); cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .btnGold{ background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13)); border-color: rgba(202,162,77,.45); }
    input, select, textarea{ width:100%; padding:11px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background: rgba(10,14,18,.55); color: #fff; }
    .qItem{ display:grid; grid-template-columns: 1fr auto; gap:10px; padding:10px; border-radius:16px; background: rgba(10,14,18,.48); align-items:center; margin-bottom:10px; }
    .previewFrame{ flex:1; border:0; width:100%; background: transparent; }
    .topBrand{ position:fixed; left:18px; top:14px; z-index:9999; display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background:rgba(18,24,33,0.6); border:1px solid rgba(255,255,255,0.12); backdrop-filter: blur(8px); }
    .topBrand img{ height:34px; border-radius:10px; }
    .topBrand span{ font-weight:800; color:#fff; }
    
    /* –°—Ç–∏–ª–∏ –∏–≥—Ä–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏ –º–æ–¥–∞–ª–æ–∫ */
    .modalBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); display:none; align-items:center; justify-content:center; z-index:100; }
    .modalBackdrop.on{ display:flex; }
    .modal{ width:min(900px, 95vw); background:#0a0d12; border-radius:22px; border:1px solid var(--neonLine); padding:20px; max-height:90vh; overflow:auto; }
    .target{ position:absolute; width: 92px; height: 92px; transform: translate(-50%, -50%); cursor:pointer; }
    .edit-mode .target { cursor: move !important; }
  </style>
</head>
<body>
  <div class="topBrand">
    <img src="63.png" onerror="this.style.display='none'"/>
    <span>–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</span>
  </div>
  <div id="root"></div>

<script>
const $ = (s, e=document) => e.querySelector(s);
const $$ = (s, e=document) => Array.from(e.querySelectorAll(s));

function b64uEncode(o){ return btoa(unescape(encodeURIComponent(JSON.stringify(o)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function b64uDecode(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return JSON.parse(decodeURIComponent(escape(atob(s)))); }

const AudioKit = (() => {
  let ctx, master;
  function ensure(){ if(ctx)return; ctx=new(window.AudioContext||window.webkitAudioContext)(); master=ctx.createGain(); master.connect(ctx.destination); }
  return {
    play: (variant, vol) => {
      ensure(); master.gain.value = vol * 2;
      const t = ctx.currentTime, osc = ctx.createOscillator(), g = ctx.createGain();
      osc.type = variant === 'boom' ? 'sine' : 'triangle';
      osc.frequency.setValueAtTime(variant === 'boom' ? 90 : 600, t);
      osc.frequency.exponentialRampToValueAtTime(40, t+0.1);
      g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
      osc.connect(g).connect(master); osc.start(); osc.stop(t+0.12);
    }
  };
})();

function defaultCfg(){
  return { title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä", teamsCount: 2, autoNextTeam: true, bg: "2.png", targetFile: "13.png", questions: [], shot: { variant:"pif", volume:0.7 }, startScreen: { enabled: false, text: "" }, feedbackScreen: { enabled: true, extraText: "" } };
}

const params = new URLSearchParams(location.search);
const isGame = params.has('game');
const isEdit = params.has('edit');

if(!isGame) {
  /* –†–ï–î–ê–ö–¢–û–† */
  let cfg = defaultCfg();
  let editIdx = null;

  function mountEditor(){
    $('#root').innerHTML = `
      <div class="app">
        <div class="panel">
          <div class="panelHeader"><div style="font-weight:900; font-size:20px;">–†–µ–¥–∞–∫—Ç–æ—Ä</div><button class="btn btnGold" id="copyCode">üìã –ö–æ–¥</button></div>
          <div class="scroll">
            <div class="section"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
              <div class="row1"><div><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input id="inpTitle" type="text" value="${cfg.title}"/></div></div>
              <div class="row"><div><label>–§–æ–Ω</label><input id="inpBg" type="text" value="${cfg.bg}"/></div><div><label>–ú–∏—à–µ–Ω—å</label><input id="inpTarget" type="text" value="${cfg.targetFile}"/></div></div>
              <div class="row"><div><label>–ö–æ–º–∞–Ω–¥</label><select id="inpTeams"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select></div><div><label>–ê–≤—Ç–æ—Ö–æ–¥</label><select id="inpAuto"><option value="true">–í–∫–ª</option><option value="false">–í—ã–∫–ª</option></select></div></div>
            </div>
            <div class="section"><h3>–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞</h3>
              <div class="row"><div><label>–í–∞—Ä–∏–∞–Ω—Ç</label><select id="inpShot"><option value="pif">–ü–∏—Ñ</option><option value="snap">–©–µ–ª—á–æ–∫</option><option value="boom">–ë—É–º</option></select></div><div><label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label><input id="inpVol" type="range" min="0" max="1" step="0.1" value="0.7"/></div></div>
            </div>
            <div class="section"><div style="display:flex; justify-content:space-between;"><h3>–í–æ–ø—Ä–æ—Å—ã</h3><button class="btn btnGold" id="btnAdd">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button></div><div id="qList" style="margin-top:10px"></div></div>
          </div>
        </div>
        <div class="previewWrap"><iframe id="pFrame" class="previewFrame"></iframe></div>
      </div>
      <div id="mEdit" class="modalBackdrop"><div class="modal"><h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</h3><div class="row1"><div><label>–¢–µ–∫—Å—Ç</label><textarea id="qTxt"></textarea></div></div><div class="row"><div><label>–ë–∞–ª–ª—ã</label><input id="qPts" type="number" value="10"/></div><div><label>–¢–∏–ø</label><select id="qType"><option value="choice">–í—ã–±–æ—Ä</option><option value="input">–í–≤–æ–¥</option></select></div></div><div id="optBox" style="margin-top:15px"></div><button class="btn btnGold" id="qSave" style="margin-top:15px">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
    `;
    
    $('#btnAdd').onclick = () => { cfg.questions.push({text:"–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å", x:50, y:50, points:10, type:"choice", options:[{text:"–î–∞", correct:true}]}); renderList(); updatePreview(); };
    $('#qSave').onclick = () => { cfg.questions[editIdx].text = $('#qTxt').value; cfg.questions[editIdx].points = $('#qPts').value; cfg.questions[editIdx].type = $('#qType').value; editIdx=null; $('#mEdit').classList.remove('on'); renderList(); updatePreview(); };
    $('#inpShot').onchange = () => { AudioKit.play($('#inpShot').value, $('#inpVol').value); updatePreview(); };
    $('#inpVol').oninput = updatePreview;
    $('#copyCode').onclick = () => { const url = location.origin+location.pathname+'?game='+b64uEncode(cfg); navigator.clipboard.writeText(url); alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"); };
    
    window.addEventListener('message', e => { if(e.data.type==='upd'){ cfg.questions[e.data.i].x=e.data.x; cfg.questions[e.data.i].y=e.data.y; renderList(); } });
    $$('input, select, textarea').forEach(el => el.oninput = updatePreview);
    renderList(); updatePreview();
  }

  window.editQ = (i) => { editIdx=i; const q=cfg.questions[i]; $('#qTxt').value=q.text; $('#qPts').value=q.points; $('#qType').value=q.type; $('#mEdit').classList.add('on'); };
  window.delQ = (i) => { cfg.questions.splice(i,1); renderList(); updatePreview(); };

  function renderList(){
    $('#qList').innerHTML = cfg.questions.map((q,i) => `<div class="qItem"><span>#${i+1} ${q.text.slice(0,15)}</span><div><button class="btn" onclick="editQ(${i})">‚öôÔ∏è</button><button class="btn" onclick="delQ(${i})">üóëÔ∏è</button></div></div>`).join('');
  }
  function updatePreview(){
    cfg.title=$('#inpTitle').value; cfg.bg=$('#inpBg').value; cfg.targetFile=$('#inpTarget').value; cfg.teamsCount=$('#inpTeams').value;
    $('#pFrame').src = location.origin+location.pathname+'?game='+b64uEncode(cfg)+'&edit=1';
  }
  mountEditor();
} else {
  /* –ò–ì–†–ê */
  const cfg = b64uDecode(params.get('game'));
  let curTeam = 0, scores = Array(Number(cfg.teamsCount)).fill(0);
  
  document.body.innerHTML = `
    <div style="position:relative; height:100vh; background:url('${cfg.bg}') center/cover;" id="arena" class="${isEdit?'edit-mode':''}">
      <div style="position:absolute; top:80px; left:20px; right:20px; display:grid; grid-template-columns:repeat(${cfg.teamsCount}, 1fr); gap:10px;" id="teams"></div>
      <div id="targets"></div>
    </div>
  `;

  function renderTeams(){
    $('#teams').innerHTML = scores.map((s,i) => `<div style="background:rgba(0,0,0,0.5); padding:10px; border-radius:15px; border:1px solid ${i===curTeam?'var(--neon)':'#333'}">
      <input style="background:none; border:none; color:#fff; font-weight:900" value="–ö–æ–º–∞–Ω–¥–∞ ${i+1}"/>
      <div style="font-size:20px">–û—á–∫–∏: ${s}</div>
    </div>`).join('');
  }

  cfg.questions.forEach((q, i) => {
    const t = document.createElement('div'); t.className='target';
    t.style.cssText = `left:${q.x}%; top:${q.y}%; background:url('${cfg.targetFile}') center/contain no-repeat; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900;`;
    t.innerHTML = i+1;
    if(isEdit){
      t.onmousedown = (e) => {
        const r = $('#arena').getBoundingClientRect();
        function move(ev){
          let x = Math.round((ev.clientX-r.left)/r.width*100), y = Math.round((ev.clientY-r.top)/r.height*100);
          t.style.left=x+'%'; t.style.top=y+'%'; window.parent.postMessage({type:'upd', i, x, y}, '*');
        }
        function stop(){ window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); }
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
      };
    } else {
      t.onclick = () => { AudioKit.play(cfg.shot.variant, cfg.shot.volume); alert(q.text); };
    }
    $('#targets').appendChild(t);
  });
  renderTeams();
}
</script>
</body>
</html>
