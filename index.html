<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor + Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Neucha&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --text: #eaf0ff; --muted: #a9b6e6;
      --neon-orange-base: #ffae00;
      --neon-orange-glow: rgba(255, 136, 0, 0.6);
      --neon-box-shadow: 0 0 5px var(--neon-orange-glow), 0 0 15px var(--neon-orange-glow), inset 0 0 5px rgba(255, 136, 0, 0.2);
      --shadow: 0 14px 40px rgba(0,0,0,0.5);
      --qFont: 'Roboto'; --aFont: 'Roboto'; --qaSize: 18px;
    }
    
    * { box-sizing: border-box; font-family: 'Roboto', system-ui, sans-serif; }
    html, body { height: 100%; margin: 0; background: #0a0f15; color: var(--text); overflow: hidden; }
    
    /* --- EDITOR UI --- */
    body.editor-mode { background: radial-gradient(1100px 700px at 12% 18%, rgba(255, 170, 0, 0.15) 0%, rgba(5,8,22,0) 58%), #050816; }
    body.game-mode { background: #000; }

    .app { display: grid; grid-template-columns: 460px 1fr; gap: 14px; padding: 14px; height: 100vh; max-width: 1600px; margin: 0 auto; }
    @media (max-width: 1020px) { .app { grid-template-columns: 1fr; } }
    
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--neon-orange-base); border-radius: 22px;
      box-shadow: var(--neon-box-shadow); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-header { padding: 12px 14px; border-bottom: 1px solid rgba(255, 174, 0, 0.4); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .panel-body { padding: 14px; overflow-y: auto; flex: 1; }
    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-thumb { background: rgba(255, 174, 0, 0.4); border-radius: 4px; }
    
    .section { background: rgba(20, 10, 0, 0.3); border: 1px solid rgba(255, 174, 0, 0.5); border-radius: 16px; padding: 12px; margin-bottom: 12px; }
    .section .title { font-weight: 900; font-size: 14px; color: var(--neon-orange-base); margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    label { display: block; font-size: 12px; color: rgba(255,255,255,.8); margin: 8px 0 4px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.3); color: #fff; outline: none; }
    input:focus, select:focus, textarea:focus { border-color: var(--neon-orange-base); box-shadow: 0 0 8px var(--neon-orange-glow); }
    textarea { resize: vertical; min-height: 70px; }
    input[type="range"] { width: 100%; accent-color: var(--neon-orange-base); }
    input[type="color"] { width: 40px; height: 40px; padding: 2px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: transparent; }
    
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 120px; }
    
    .btn {
      padding: 10px 14px; border-radius: 12px; border: 1px solid var(--neon-orange-base);
      background: rgba(255, 136, 0, 0.1); color: #fff; cursor: pointer; font-weight: 900; font-size: 14px;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
    }
    .btn:hover { background: rgba(255, 136, 0, 0.25); box-shadow: 0 0 10px var(--neon-orange-glow); }
    .btn.primary { background: linear-gradient(90deg, rgba(255, 174, 0, 0.4), rgba(255, 136, 0, 0.3)); }
    .btn.danger { border-color: #ff4d4d; background: rgba(255, 77, 77, 0.1); }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 10px; }
    
    .preview-stage { flex: 1; background: rgba(0,0,0,.3); border-radius: 20px; overflow: hidden; position: relative; }
    iframe { width: 100%; height: 100%; border: 0; background: #000; }
    
    .q-list { display: flex; flex-direction: column; gap: 8px; }
    .q-item { padding: 10px; border-radius: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .q-item:hover { border-color: rgba(255, 174, 0, 0.5); }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-backdrop.show { display: flex; }
    .modal { width: min(800px, 95%); background: #16110c; border: 1px solid var(--neon-orange-base); border-radius: 20px; box-shadow: var(--neon-box-shadow); max-height: 90vh; display: flex; flex-direction: column; }
    .modal-head { padding: 14px 20px; border-bottom: 1px solid rgba(255, 174, 0, 0.3); display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 18px; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-foot { padding: 14px 20px; border-top: 1px solid rgba(255, 174, 0, 0.3); display: flex; justify-content: flex-end; gap: 10px; }
    
    .topBrand { display: flex; align-items: center; gap: 10px; }
    .topBrand img { height: 36px; width: 36px; object-fit: contain; border-radius: 8px; }
    
    /* --- GAME UI --- */
    .gameRoot { position: absolute; inset: 0; overflow: hidden; background: #000; font-family: 'Roboto', sans-serif; }
    .arenaBg { position: absolute; inset: 0; background-size: cover; background-position: center; transform: scale(1.05); }
    .hud { position: absolute; top: 14px; left: 14px; right: 14px; pointer-events: none; z-index: 10; display:flex; justify-content:space-between; align-items:center; }
    .gameTitle { font-weight: 900; font-size: 24px; text-shadow: 0 4px 15px #000; color: #fff; }
    .teams { display: grid; gap: 10px; margin-top: 54px; padding:0 14px; pointer-events: auto; position:relative; z-index:10;}
    .teamCard { background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 10px; backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: space-between; transition: 0.3s; }
    .teamInput { background: transparent; border: none; outline: none; color: #fff; font-weight: 900; font-size: 16px; width: 100%; max-width: 150px; }
    
    /* Targets & Drag */
    .targets { position: absolute; inset: 0; pointer-events: none; }
    .target { position: absolute; width: 90px; height: 90px; transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); cursor: pointer; pointer-events: auto; z-index: 5; transition: transform 0.1s; }
    .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)) scale(1.1); }
    .target .img { position: absolute; inset: 0; background-image: var(--target-img); background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.6)); }
    .target .num { position: absolute; inset: 0; display: grid; place-items: center; font-weight: 900; font-size: 24px; color: #fff; text-shadow: 0 2px 8px #000; }
    .target.hit { opacity: 0; pointer-events: none; transform: translate(-50%, -50%) scale(0); transition: 0.3s ease; }
    
    .edit-mode .target { cursor: move !important; border: 2px dashed rgba(255, 174, 0, 0.9); border-radius: 50%; }
    .edit-mode .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); }

    /* Modals & Screens in Game */
    .game-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 50; }
    .game-modal.on { display: flex; }
    .game-modal-content { background: #0a0d12; border: 1px solid #ffae00; border-radius: 20px; padding: 24px; width: min(800px, 90%); box-shadow: 0 0 30px rgba(255,174,0,0.3); position:relative; max-height:90vh; overflow-y:auto; }
    .game-ans-btn { width: 100%; text-align: left; padding: 14px; margin-top: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; color: #fff; font-size: 18px; cursor: pointer; transition: 0.2s; }
    .game-ans-btn:hover { background: rgba(255,255,255,0.1); }
    
    .screen { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; text-align: center; }
    .screen.on { display: flex; }
    .screenCard { background: #111; border-radius: 20px; padding: 30px; border: 1px solid; max-width: 600px; width: 90%; }
    .resultRow { display:flex; justify-content:space-between; background:rgba(255,255,255,0.1); padding:12px 20px; border-radius:12px; margin-bottom:10px; font-size:18px; font-weight:bold; }
  </style>
</head>
<body>

<div class="app" id="editorApp" style="display:none;">
  <div class="panel">
    <div class="panel-header">
      <div class="topBrand">
        <img src="63.png" alt="Logo" onerror="this.style.display='none'">
        <div>
          <div style="font-weight:900; font-size:16px;">–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</div>
          <div style="color:var(--neon-orange-base); font-size:12px;" data-i18n="edTitle">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</div>
        </div>
      </div>
      <button class="btn primary" id="btnCopyCodeTop" data-i18n="btnCopy">üìã –ö–æ–¥</button>
    </div>
    
    <div class="panel-body">
      <div class="section">
        <div class="title" data-i18n="sLang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        <select id="selLang">
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </div>

      <div class="section">
        <div class="title" data-i18n="sName">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</div>
        <input type="text" id="inpTitle" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä">
      </div>

      <div class="section">
        <div class="title" data-i18n="sDesign">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</div>
        <label data-i18n="lBg">–§–æ–Ω –∏–≥—Ä—ã</label>
        <select id="selBg">
          <option value="1.png">–§–æ–Ω 1</option>
          <option value="2.png" selected>–§–æ–Ω 2</option>
          <option value="3.png">–§–æ–Ω 3</option>
          <option value="4.png">–§–æ–Ω 4</option>
          <option value="5.png">–§–æ–Ω 5</option>
          <option value="6.png">–§–æ–Ω 6</option>
          <option value="7.png">–§–æ–Ω 7</option>
          <option value="8.png">–§–æ–Ω 8</option>
          <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
        </select>
        <input type="text" id="inpBgCustom" placeholder="https://..." style="display:none; margin-top:8px;">

        <label data-i18n="lTarget" style="margin-top:10px;">–ú–∏—à–µ–Ω—å</label>
        <select id="selTarget">
          <option value="10.png">–ú–∏—à–µ–Ω—å 10</option>
          <option value="11.png">–ú–∏—à–µ–Ω—å 11</option>
          <option value="12.png">–ú–∏—à–µ–Ω—å 12</option>
          <option value="13.png" selected>–ú–∏—à–µ–Ω—å 13</option>
          <option value="14.png">–ú–∏—à–µ–Ω—å 14</option>
          <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
        </select>
        <input type="text" id="inpTargetCustom" placeholder="https://..." style="display:none; margin-top:8px;">

        <div class="row" style="margin-top:10px;">
          <div><label data-i18n="lRadius">–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpRadius" min="0" max="250" value="0"></div>
          <div><label data-i18n="lSpeed">–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpSpeed" min="0" max="10" value="0"></div>
        </div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</div>
        <div class="row">
          <div><label data-i18n="lTeams">–ö–æ–º–∞–Ω–¥ (1-3)</label><select id="inpTeams"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select></div>
          <div><label data-i18n="lSound">–í—ã—Å—Ç—Ä–µ–ª</label><select id="inpSound"><option value="pif">–ü–∏—Ñ</option><option value="snap">–©–µ–ª—á–æ–∫</option><option value="boom">–ë—É–º</option></select></div>
          <div><label data-i18n="lVol">–ì—Ä–æ–º–∫–æ—Å—Ç—å</label><input type="range" id="inpVol" min="0" max="1" step="0.1" value="0.7"></div>
        </div>
        <label data-i18n="lTeamColors" style="margin-top:10px;">–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥</label>
        <div id="teamColorsWrap" style="display:flex; gap:10px; margin-top:5px;"></div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</div>
        <div class="row">
          <div><label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</label><select id="startEnabled"><option value="true">–í–∫–ª—é—á–µ–Ω</option><option value="false">–í—ã–∫–ª—é—á–µ–Ω</option></select></div>
          <div><label data-i18n="lInstructionColor">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label><input type="color" id="inpStartColor" value="#ff8a2a"></div>
        </div>
        <label style="display:flex; align-items:center; gap:5px; margin-top:10px;"><input type="checkbox" id="chkStartGlow" checked> <span data-i18n="lGlow">–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏</span></label>
        <textarea id="inpStartText" style="margin-top:10px;" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."></textarea>
      </div>
      
      <div class="section">
        <div class="title" data-i18n="sEnd">–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)</div>
        <label>–≠–∫—Ä–∞–Ω —Ñ–∏–¥–±–µ–∫–∞</label><select id="feedEnabled"><option value="true">–í–∫–ª—é—á–µ–Ω</option><option value="false">–í—ã–∫–ª—é—á–µ–Ω</option></select>
        <textarea id="inpEndText" style="margin-top:10px;" placeholder="–î–æ–ø. —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."></textarea>
      </div>

      <div class="section">
        <div class="title"><span data-i18n="sQ">–í–æ–ø—Ä–æ—Å—ã</span> <span id="qCount" style="color:#fff">0</span></div>
        <div class="row" style="margin-bottom:12px;">
          <button class="btn primary" id="btnAddQ" data-i18n="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" id="btnClearQ" data-i18n="btnClr">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div style="font-size:11px; color:var(--neon-orange-base); margin-bottom:8px;" data-i18n="lDragHint">üí° –î–≤–∏–≥–∞–π—Ç–µ –º–∏—à–µ–Ω–∏ –ø—Ä—è–º–æ –≤ –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞!</div>
        <div id="qList" class="q-list"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div style="font-weight:900" data-i18n="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
      <div style="font-size:12px; color:var(--muted)" data-i18n="previewHint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)</div>
    </div>
    <div class="panel-body" style="display:flex; flex-direction:column; padding:0;">
      <div class="preview-stage" style="border-radius:0; border:none;">
        <iframe id="previewFrame"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-head">
      <span id="modalTitle" data-i18n="mTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</span>
      <button class="btn small danger" onclick="closeModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <div><label data-i18n="lQType">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label><select id="modType"><option value="choice" data-i18n="oChoice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option><option value="input" data-i18n="oInput">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option></select></div>
        <div><label data-i18n="lPts">–û—á–∫–∏</label><input type="number" id="modPts" value="10"></div>
      </div>
      <div class="row">
        <div><label data-i18n="lTimer">–¢–∞–π–º–µ—Ä</label><select id="modTimerOn"><option value="false">–í—ã–∫–ª</option><option value="true">–í–∫–ª</option></select></div>
        <div><label data-i18n="lSec">–°–µ–∫—É–Ω–¥—ã</label><input type="number" id="modTimerSec" value="30"></div>
      </div>
      <label data-i18n="lImg">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)</label>
      <input type="text" id="modImg" placeholder="https://...">
      <label data-i18n="lQText">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
      <textarea id="modPrompt"></textarea>
      <div class="row" style="margin-top:10px;">
        <div><label data-i18n="lFont">–®—Ä–∏—Ñ—Ç</label><select id="modFont"><option value="Roboto">Roboto</option><option value="Caveat">Caveat (—Ä—É–∫–æ–ø–∏—Å–Ω—ã–π)</option><option value="Neucha">Neucha (—Ä—É–∫–æ–ø–∏—Å–Ω—ã–π)</option></select></div>
        <div><label data-i18n="lFontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label><input type="number" id="modFontSize" value="20"></div>
      </div>

      <div class="section" style="margin-top:15px;">
        <div class="title" data-i18n="lAnsOpts">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
        <div id="modOptsList"></div>
        <button class="btn small" style="margin-top:10px;" onclick="addOptRow()" id="btnAddOpt" data-i18n="btnAddOpt">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal()" data-i18n="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveQ" data-i18n="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="gameRoot" style="display:none;">
  <div class="gameRoot" id="gArena">
    <div class="arenaBg" id="gBg"></div>
    <div class="hud">
      <div class="gameTitle" id="gTitle"></div>
      <button class="btn small" id="btnReset" style="pointer-events:auto;">–°–±—Ä–æ—Å</button>
    </div>
    <div class="teams" id="gTeams"></div>
    <div class="targets" id="gTargets"></div>

    <div class="game-modal" id="gModal">
      <div class="game-modal-content">
        <div id="gTimer" style="position:absolute; top:10px; right:20px; font-weight:900; font-size:24px; color:#ffae00; display:none;">30</div>
        <h2 id="gQText" style="color:#fff; margin-top:0; padding-right:40px;"></h2>
        <div id="gQImgWrap" style="text-align:center; margin-bottom:15px; display:none;"><img id="gQImg" style="max-width:100%; max-height:300px; border-radius:10px;"></div>
        <div id="gAnswers"></div>
        <div id="gInputWrap" style="display:none; gap:10px; margin-top:15px;">
          <input type="text" id="gInput" style="flex:1; font-size:18px; padding:10px; border-radius:10px;">
          <button class="btn primary" id="gSubmitBtn">OK</button>
        </div>
      </div>
    </div>

    <div class="screen" id="gStartScreen">
      <div class="screenCard" id="gStartCard">
        <h1 id="gStartTitle" style="color:#fff; margin-top:0;"></h1>
        <p id="gStartText" style="color:#ccc; font-size:18px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnPlay" style="font-size:20px; padding:12px 24px; margin-top:20px;">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
      </div>
    </div>

    <div class="screen" id="gEndScreen">
      <div class="screenCard">
        <h1 style="color:#ffae00; margin-top:0;" data-i18n="lGameOver">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h1>
        <div id="gEndStats" style="width:100%; margin:20px 0;"></div>
        <p id="gEndText" style="color:#ccc; font-size:16px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnRestart" style="margin-top:15px;" data-i18n="btnRestart">‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================
   –°–ª–æ–≤–∞—Ä—å (i18n)
   ======================== */
const dict = {
  ru: {
    edTitle: "–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª", btnCopy: "üìã –ö–æ–¥ –¥–ª—è Genially", sLang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", sName: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã", sDesign: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", lBg: "–§–æ–Ω –∏–≥—Ä—ã", lTarget: "–ú–∏—à–µ–Ω—å", optCustom: "–ü–æ —Å—Å—ã–ª–∫–µ...", lRadius: "–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è", lSpeed: "–°–∫–æ—Ä–æ—Å—Ç—å", sGame: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã", lTeams: "–ö–æ–º–∞–Ω–¥ (1-3)", lTeamColors: "–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥", lSound: "–í—ã—Å—Ç—Ä–µ–ª", lVol: "–ì—Ä–æ–º–∫–æ—Å—Ç—å", sStart: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω", lGlow: "–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏", sEnd: "–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)", sQ: "–í–æ–ø—Ä–æ—Å—ã", btnAdd: "‚ûï –î–æ–±–∞–≤–∏—Ç—å", btnClr: "üßπ –û—á–∏—Å—Ç–∏—Ç—å", lDragHint: "üí° –î–≤–∏–≥–∞–π—Ç–µ –º–∏—à–µ–Ω–∏ –ø—Ä—è–º–æ –≤ –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞!", previewTitle: "–ü—Ä–æ—Å–º–æ—Ç—Ä", previewHint: "–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)", mTitle: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å", lQType: "–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞", oChoice: "–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞", oInput: "–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞", lPts: "–û—á–∫–∏", lTimer: "–¢–∞–π–º–µ—Ä", lSec: "–°–µ–∫—É–Ω–¥—ã", lImg: "üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)", lQText: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞", lFont: "–®—Ä–∏—Ñ—Ç", lFontSize: "–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞", lAnsOpts: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", btnAddOpt: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç", btnCancel: "–û—Ç–º–µ–Ω–∞", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", lRightAns: "–í–µ—Ä–Ω—ã–π", lOptText: "–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞", lDel: "–£–¥–∞–ª–∏—Ç—å", lGameOver: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã", btnRestart: "‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑", lTeam: "–ö–æ–º–∞–Ω–¥–∞"
  },
  en: {
    edTitle: "Math Shooter Editor", btnCopy: "üìã Copy Code", sLang: "Interface Language", sName: "Game Title", sDesign: "Design", lBg: "Background", lTarget: "Target", optCustom: "Custom URL...", lRadius: "Orbit Radius", lSpeed: "Speed", sGame: "Game Settings", lTeams: "Teams (1-3)", lTeamColors: "Team Frame Colors", lSound: "Shot Sound", lVol: "Volume", sStart: "Start Screen", lGlow: "Border Glow", sEnd: "Feedback Screen", sQ: "Questions", btnAdd: "‚ûï Add", btnClr: "üßπ Clear", lDragHint: "üí° Drag targets directly in the preview on the right!", previewTitle: "Preview", previewHint: "Live preview (coordinates are saved)", mTitle: "Edit Question", lQType: "Question Type", oChoice: "Multiple Choice", oInput: "Text Input", lPts: "Points", lTimer: "Timer", lSec: "Seconds", lImg: "üñºÔ∏è Image (URL)", lQText: "Question Text", lFont: "Font", lFontSize: "Font Size", lAnsOpts: "Answer Options", btnAddOpt: "‚ûï Add Option", btnCancel: "Cancel", btnSave: "üíæ Save", lRightAns: "Correct", lOptText: "Option Text", lDel: "Delete", lGameOver: "Game Results", btnRestart: "‚Üª Play Again", lTeam: "Team"
  }
};
let lang = "ru";
function t(key) { return (dict[lang] && dict[lang][key]) ? dict[lang][key] : (dict["ru"][key] || key); }
function applyLang() {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const k = el.getAttribute("data-i18n");
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA") el.placeholder = t(k);
    else el.innerText = t(k);
  });
  if(typeof renderQList === 'function') renderQList();
}

/* ========================
   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Config)
   ======================== */
function defaultCfg() {
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä", bg: "2.png", bgUrl: "", target: "13.png", targetUrl: "",
    radius: 0, speed: 0, teams: 2, teamCols: ["#ffae00", "#33d17a", "#ff5b6b"], sound: "pif", vol: 0.7,
    start: { enabled: true, text: "–ò–ù–°–¢–†–£–ö–¶–ò–Ø\n\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\n2) –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n\n–ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–∏.", color: "#ffae00", glow: true },
    end: { enabled: true, text: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É." },
    questions: []
  };
}
let cfg = defaultCfg();
let editIdx = null;

const b64e = (o) => btoa(unescape(encodeURIComponent(JSON.stringify(o)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const b64d = (s) => JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/')))));

/* ========================
   –ó–≤—É–∫–æ–≤–æ–π –¥–≤–∏–∂–æ–∫ (WebAudio)
   ======================== */
const AudioSys = (() => {
  let ctx, master;
  function init(){ if(!ctx){ ctx=new(window.AudioContext||window.webkitAudioContext)(); master=ctx.createGain(); master.connect(ctx.destination); } }
  return {
    play: (type, v) => {
      init(); if(ctx.state==='suspended') ctx.resume();
      master.gain.value = v * 2; const t = ctx.currentTime;
      const osc = ctx.createOscillator(), g = ctx.createGain();
      if(type==='boom'){ osc.type='sine'; osc.frequency.setValueAtTime(90,t); osc.frequency.exponentialRampToValueAtTime(40,t+0.2); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.25); }
      else if(type==='snap'){ osc.type='square'; osc.frequency.setValueAtTime(220,t); osc.frequency.exponentialRampToValueAtTime(880,t+0.05); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.08); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.1); }
      else { osc.type='triangle'; osc.frequency.setValueAtTime(600,t); osc.frequency.exponentialRampToValueAtTime(200,t+0.1); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.15); }
    }
  };
})();

/* ========================
   –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê
   ======================== */
function bootEditor() {
  document.body.classList.add('editor-mode');
  document.getElementById('editorApp').style.display = 'grid';

  const upd = () => updateEditor();
  document.getElementById('selLang').onchange = (e) => { lang = e.target.value; applyLang(); upd(); };
  document.getElementById('selBg').onchange = (e) => { document.getElementById('inpBgCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; upd(); };
  document.getElementById('selTarget').onchange = (e) => { document.getElementById('inpTargetCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; upd(); };
  document.getElementById('inpTeams').onchange = () => { renderTeamColsUI(); upd(); };
  document.getElementById('inpSound').onchange = (e) => { AudioSys.play(e.target.value, document.getElementById('inpVol').value); upd(); };

  document.querySelectorAll('#editorApp input:not(#inpBgCustom):not(#inpTargetCustom), #editorApp textarea, #editorApp select:not(#selBg):not(#selTarget):not(#inpTeams):not(#selLang)').forEach(el => {
    el.addEventListener('input', upd); el.addEventListener('change', upd);
  });

  document.getElementById('btnAddQ').onclick = () => openMod();
  document.getElementById('btnClearQ').onclick = () => { cfg.questions=[]; upd(); };
  document.getElementById('btnSaveQ').onclick = saveMod;
  document.getElementById('btnCopyCodeTop').onclick = () => {
    const url = location.origin + location.pathname + "?game=" + b64e(cfg);
    navigator.clipboard.writeText(`<iframe src="${url}" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`).then(()=>alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
  };

  window.addEventListener('message', e => {
    if(e.data && e.data.type==='updPos' && cfg.questions[e.data.idx]) {
      cfg.questions[e.data.idx].x = e.data.x; cfg.questions[e.data.idx].y = e.data.y;
      renderQList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å–ª–µ–≤–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ iframe
    }
  });

  renderTeamColsUI();
  applyLang();
  upd();
}

function renderTeamColsUI() {
  const c = Number(document.getElementById('inpTeams').value);
  const wrap = document.getElementById('teamColorsWrap');
  wrap.innerHTML = '';
  for(let i=0; i<c; i++){
    const col = cfg.teamCols[i] || ['#ffae00', '#33d17a', '#ff5b6b'][i];
    wrap.innerHTML += `<input type="color" id="tc_${i}" value="${col}">`;
  }
  for(let i=0; i<c; i++){
    document.getElementById(`tc_${i}`).oninput = (e) => { cfg.teamCols[i] = e.target.value; updateEditor(); };
  }
}

let _prevTid = null;
function updateEditor() {
  cfg.title = document.getElementById('inpTitle').value;
  cfg.bg = document.getElementById('selBg').value; cfg.bgUrl = document.getElementById('inpBgCustom').value;
  cfg.target = document.getElementById('selTarget').value; cfg.targetUrl = document.getElementById('inpTargetCustom').value;
  cfg.radius = Number(document.getElementById('inpRadius').value); cfg.speed = Number(document.getElementById('inpSpeed').value);
  cfg.teams = Number(document.getElementById('inpTeams').value); cfg.sound = document.getElementById('inpSound').value; cfg.vol = Number(document.getElementById('inpVol').value);
  cfg.start.enabled = document.getElementById('startEnabled').value === 'true'; cfg.start.color = document.getElementById('inpStartColor').value; cfg.start.neon = document.getElementById('chkStartGlow').checked; cfg.start.text = document.getElementById('inpStartText').value;
  cfg.end.enabled = document.getElementById('feedEnabled').value === 'true'; cfg.end.text = document.getElementById('inpEndText').value;

  document.getElementById('qCount').innerText = cfg.questions.length;
  renderQList();

  if(_prevTid) clearTimeout(_prevTid);
  _prevTid = setTimeout(() => {
    const data = b64e(cfg);
    document.getElementById('previewFrame').src = location.origin + location.pathname + "?game=" + data + "&edit=1&lang=" + lang;
  }, 400);
}

function renderQList() {
  document.getElementById('qList').innerHTML = cfg.questions.map((q, i) => `
    <div class="q-item">
      <div><b>#${i+1}</b> ${q.text.substring(0,25)}... <div style="font-size:11px; color:#aaa">x:${q.x ?? 50}%, y:${q.y ?? 50}%</div></div>
      <div><button class="btn small" onclick="openMod(${i})">‚öôÔ∏è</button> <button class="btn small danger" onclick="delQ(${i})">üóëÔ∏è</button></div>
    </div>
  `).join('');
}
window.delQ = (i) => { cfg.questions.splice(i,1); updateEditor(); };

// --- Modal ---
function openMod(idx = null) {
  editIdx = idx;
  const q = idx !== null ? cfg.questions[idx] : { type: "choice", text: "", pts: 10, font: "Roboto", size: 20, timer: false, sec: 30, img: "", opts: [{t:"–î–∞", c:true}, {t:"–ù–µ—Ç", c:false}], acc: ["–û—Ç–≤–µ—Ç"] };
  document.getElementById('modType').value = q.type; document.getElementById('modPts').value = q.pts;
  document.getElementById('modTimerOn').value = q.timer ? "true" : "false"; document.getElementById('modTimerSec').value = q.sec;
  document.getElementById('modImg').value = q.img || ""; document.getElementById('modPrompt').value = q.text;
  document.getElementById('modFont').value = q.font; document.getElementById('modFontSize').value = q.size;
  syncModType(); document.getElementById('modType').onchange = syncModType;
  function syncModType() { if(document.getElementById('modType').value === 'choice') renderOpts(q.opts || [{t:"1", c:true}]); else renderAccs(q.acc || [""]); }
  document.getElementById('modalBackdrop').classList.add('show');
}
function renderOpts(opts) {
  document.getElementById('modOptsList').innerHTML = opts.map((o, i) => `<div class="row" style="margin-bottom:6px;"><input type="checkbox" style="width:24px;height:24px;" ${o.c?'checked':''} id="optC_${i}"><input type="text" value="${o.t}" id="optT_${i}" placeholder="${t('lOptText')}"><button class="btn small danger" onclick="delOptRow(${i}, 'choice')">‚úñ</button></div>`).join('');
}
function renderAccs(acc) {
  document.getElementById('modOptsList').innerHTML = acc.map((a, i) => `<div class="row" style="margin-bottom:6px;"><input type="text" value="${a}" id="accT_${i}" placeholder="${t('lRightAns')}"><button class="btn small danger" onclick="delOptRow(${i}, 'input')">‚úñ</button></div>`).join('');
}
window.addOptRow = () => { const type = document.getElementById('modType').value; if(type==='choice') { const o = collectOpts(); o.push({t:"", c:false}); renderOpts(o); } else { const a = collectAccs(); a.push(""); renderAccs(a); } };
window.delOptRow = (i, type) => { if(type==='choice'){ const o=collectOpts(); o.splice(i,1); renderOpts(o); } else { const a=collectAccs(); a.splice(i,1); renderAccs(a); } };
function collectOpts() { const arr=[]; let i=0; while(document.getElementById(`optT_${i}`)) { arr.push({ c: document.getElementById(`optC_${i}`).checked, t: document.getElementById(`optT_${i}`).value }); i++; } return arr; }
function collectAccs() { const arr=[]; let i=0; while(document.getElementById(`accT_${i}`)) { arr.push(document.getElementById(`accT_${i}`).value); i++; } return arr; }

function saveMod() {
  const q = {
    type: document.getElementById('modType').value, text: document.getElementById('modPrompt').value,
    pts: Number(document.getElementById('modPts').value), timer: document.getElementById('modTimerOn').value === "true", sec: Number(document.getElementById('modTimerSec').value),
    img: document.getElementById('modImg').value, font: document.getElementById('modFont').value, size: Number(document.getElementById('modFontSize').value),
    x: editIdx !== null ? (cfg.questions[editIdx].x ?? 50) : 50,
    y: editIdx !== null ? (cfg.questions[editIdx].y ?? 50) : 50
  };
  if(q.type==='choice') q.opts = collectOpts(); else q.acc = collectAccs();
  if(editIdx !== null) cfg.questions[editIdx] = q; else cfg.questions.push(q);
  closeModal(); updateEditor();
}
window.closeModal = () => document.getElementById('modalBackdrop').classList.remove('show');

/* ========================
   –†–ï–ñ–ò–ú –ò–ì–†–´ (–ò –ü–†–ï–í–¨–Æ)
   ======================== */
function bootGame() {
  const qs = new URLSearchParams(location.search);
  document.body.classList.add('game-mode');
  document.getElementById('gameRoot').style.display = 'block';
  lang = qs.get('lang') || 'ru'; applyLang();
  
  let gCfg = cfg;
  if(qs.get('game')) { try { gCfg = b64d(qs.get('game')); } catch(e){} }
  const isEdit = qs.get('edit') === '1';

  const bgImg = gCfg.bg === 'custom' ? gCfg.bgUrl : gCfg.bg;
  document.getElementById('gBg').style.backgroundImage = `url("${bgImg}")`;
  const tgtImg = gCfg.target === 'custom' ? gCfg.targetUrl : gCfg.target;
  document.getElementById('gTitle').innerText = gCfg.title;

  const tDiv = document.getElementById('gTeams');
  tDiv.style.gridTemplateColumns = `repeat(${gCfg.teams}, 1fr)`;
  let scores = Array(gCfg.teams).fill(0);
  let curTeam = 0;
  
  function drawTeams() {
    tDiv.innerHTML = scores.map((s, i) => {
      const col = gCfg.teamCols[i] || '#ffffff';
      return `<div class="teamCard" style="${i===curTeam ? `border-color:${col}; box-shadow: 0 0 15px ${col}66;` : ''}">
        <input type="text" class="teamInput" value="${t('lTeam')} ${i+1}">
        <b style="color:#fff; font-size:20px;">${s}</b>
      </div>`;
    }).join('');
  }
  drawTeams();

  const tgtDiv = document.getElementById('gTargets');
  tgtDiv.className = isEdit ? "targets edit-mode" : "targets";
  let targetsHit = 0;

  gCfg.questions.forEach((q, i) => {
    const el = document.createElement('div');
    el.className = 'target';
    
    // –ë–∞–∑–æ–≤–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –µ—â–µ –Ω–µ—Ç)
    if(q.x === undefined) q.x = 15 + (i % 5) * 16;
    if(q.y === undefined) q.y = 30 + Math.floor(i / 5) * 20;

    el.style.left = q.x + '%';
    el.style.top = q.y + '%';
    el.innerHTML = `<div class="img" style="background-image:url('${tgtImg}')"></div><div class="num">${i+1}</div>`;
    
    // –û—Ä–±–∏—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ, —Ü–µ–Ω—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
    if(gCfg.radius > 0 && gCfg.speed > 0) {
      let ang = (i / gCfg.questions.length) * Math.PI * 2;
      setInterval(() => {
        ang += (gCfg.speed * 0.01);
        el.style.setProperty('--orbit-x', Math.round(Math.cos(ang) * gCfg.radius) + 'px');
        el.style.setProperty('--orbit-y', Math.round(Math.sin(ang) * gCfg.radius) + 'px');
      }, 30);
    }

    if(isEdit) {
      el.onmousedown = (e) => {
        e.preventDefault();
        const rect = document.getElementById('gArena').getBoundingClientRect();
        function move(ev) {
          let nx = Math.round(((ev.clientX - rect.left) / rect.width) * 100);
          let ny = Math.round(((ev.clientY - rect.top) / rect.height) * 100);
          nx = Math.max(0, Math.min(100, nx)); ny = Math.max(0, Math.min(100, ny));
          el.style.left = nx + "%"; el.style.top = ny + "%";
          window.parent.postMessage({ type: 'updPos', idx: i, x: nx, y: ny }, '*');
        }
        function stop() { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); }
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
      };
    } else {
      el.onclick = () => {
        AudioSys.play(gCfg.sound, gCfg.vol);
        el.classList.add('hit');
        openGameQuestion(q, () => {
          targetsHit++;
          if(targetsHit >= gCfg.questions.length && gCfg.end.enabled) showEndScreen();
        });
      };
    }
    tgtDiv.appendChild(el);
  });

  let timerId = null;
  function openGameQuestion(q, onDone) {
    document.getElementById('gModal').classList.add('on');
    const txt = document.getElementById('gQText');
    txt.innerText = q.text; txt.style.fontFamily = q.font || 'Roboto'; txt.style.fontSize = (q.size || 20) + "px";
    
    const imgWrap = document.getElementById('gQImgWrap');
    if(q.img) { document.getElementById('gQImg').src = q.img; imgWrap.style.display = 'block'; } else { imgWrap.style.display = 'none'; }

    const ansDiv = document.getElementById('gAnswers'); const inpWrap = document.getElementById('gInputWrap');
    ansDiv.innerHTML = "";
    
    const timerEl = document.getElementById('gTimer');
    if(q.timer && q.sec > 0) {
      timerEl.style.display = 'block'; let timeLeft = q.sec; timerEl.innerText = timeLeft;
      timerId = setInterval(() => { timeLeft--; timerEl.innerText = timeLeft; if(timeLeft <= 0) finishTurn(false); }, 1000);
    } else { timerEl.style.display = 'none'; }

    if(q.type === 'choice') {
      inpWrap.style.display = 'none'; ansDiv.style.display = 'block';
      let opts = [...q.opts].sort(() => Math.random() - 0.5);
      opts.forEach(o => {
        const b = document.createElement('button'); b.className = 'game-ans-btn'; b.innerText = o.t; b.style.fontFamily = q.font || 'Roboto';
        b.onclick = () => finishTurn(o.c);
        ansDiv.appendChild(b);
      });
    } else {
      ansDiv.style.display = 'none'; inpWrap.style.display = 'flex';
      const inp = document.getElementById('gInput'); inp.value = ""; inp.style.fontFamily = q.font || 'Roboto';
      document.getElementById('gSubmitBtn').onclick = () => {
        const user = inp.value.trim().toLowerCase(); const accs = q.acc.map(a=>a.trim().toLowerCase());
        finishTurn(accs.includes(user));
      };
    }

    function finishTurn(isCorrect) {
      clearInterval(timerId); document.getElementById('gModal').classList.remove('on');
      if(isCorrect) scores[curTeam] += Number(q.pts || 10);
      curTeam = (curTeam + 1) % gCfg.teams;
      drawTeams(); onDone();
    }
  }

  if(!isEdit && gCfg.start.enabled && gCfg.start.text) {
    const sCard = document.getElementById('gStartCard');
    document.getElementById('gStartScreen').classList.add('on');
    document.getElementById('gStartTitle').innerText = gCfg.title;
    document.getElementById('gStartText').innerText = gCfg.start.text;
    sCard.style.borderColor = gCfg.start.color;
    if(gCfg.start.neon) sCard.style.boxShadow = `0 0 25px ${gCfg.start.color}, inset 0 0 10px ${gCfg.start.color}`;
    document.getElementById('gBtnPlay').onclick = () => { AudioSys.init(); document.getElementById('gStartScreen').classList.remove('on'); };
  }

  function showEndScreen() {
    document.getElementById('gEndScreen').classList.add('on');
    document.getElementById('gEndText').innerText = gCfg.end.text;
    const tNames = Array.from(document.querySelectorAll('.teamInput')).map(i => i.value);
    document.getElementById('gEndStats').innerHTML = scores.map((s,i) => `
      <div class="resultRow">
        <span>${tNames[i] || '–ö–æ–º–∞–Ω–¥–∞ '+(i+1)}</span>
        <span style="color:#ffae00">${s}</span>
      </div>
    `).join('');
    document.getElementById('gBtnRestart').onclick = () => location.reload();
  }
  
  document.getElementById('btnReset').onclick = () => location.reload();
}

/* --- –ó–∞–ø—É—Å–∫ --- */
const p = new URLSearchParams(location.search);
if(p.has('game') && p.get('edit') !== '1') bootGame();
else { bootEditor(); if(p.get('edit') === '1') bootGame(); }
</script>
</body>
</html>
