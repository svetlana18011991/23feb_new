<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor + Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Neucha&family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Lato:wght@400;700&family=Oswald:wght@400;700&family=Poppins:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --text: #eaf0ff; --muted: #a9b6e6;
      --neon-orange-base: #d99a29; 
      --neon-orange-glow: rgba(217, 154, 41, 0.35);
      --neon-box-shadow: 0 0 4px var(--neon-orange-glow), 0 0 12px var(--neon-orange-glow), inset 0 0 4px rgba(217, 154, 41, 0.15);
      --shadow: 0 14px 40px rgba(0,0,0,0.5);
    }
    
    * { box-sizing: border-box; font-family: 'Roboto', system-ui, sans-serif; }
    html, body { height: 100%; margin: 0; background: #0a0f15; color: var(--text); overflow: hidden; }
    
    body.editor-mode { background: radial-gradient(1100px 700px at 12% 18%, rgba(217, 154, 41, 0.12) 0%, rgba(5,8,22,0) 58%), #050816; }
    body.game-mode { background: #000; }

    /* --- EDITOR UI --- */
    .app { display: grid; grid-template-columns: 480px 1fr; gap: 14px; padding: 14px; height: 100vh; max-width: 1600px; margin: 0 auto; }
    @media (max-width: 1020px) { .app { grid-template-columns: 1fr; } }
    
    .panel { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border: 1px solid rgba(217, 154, 41, 0.6); border-radius: 22px; box-shadow: var(--neon-box-shadow); backdrop-filter: blur(10px); display: flex; flex-direction: column; overflow: hidden; }
    .panel-header { padding: 12px 14px; border-bottom: 1px solid rgba(217, 154, 41, 0.3); display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap:wrap;}
    .panel-body { padding: 14px; overflow-y: auto; flex: 1; }
    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-thumb { background: rgba(217, 154, 41, 0.4); border-radius: 4px; }
    
    .section { background: rgba(15, 10, 5, 0.4); border: 1px solid rgba(217, 154, 41, 0.3); border-radius: 16px; padding: 12px; margin-bottom: 12px; }
    .section .title { font-weight: 900; font-size: 14px; color: var(--neon-orange-base); margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    label { display: block; font-size: 12px; color: rgba(255,255,255,.8); margin: 8px 0 4px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.3); color: #fff; outline: none; }
    input:focus, select:focus, textarea:focus { border-color: var(--neon-orange-base); box-shadow: 0 0 6px var(--neon-orange-glow); }
    textarea { resize: vertical; min-height: 70px; }
    input[type="range"] { width: 100%; accent-color: var(--neon-orange-base); }
    input[type="color"] { width: 40px; height: 40px; padding: 2px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: transparent; }
    
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 100px; }
    
    .btn { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(217, 154, 41, 0.5); background: rgba(217, 154, 41, 0.1); color: #fff; cursor: pointer; font-weight: 900; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn:hover { background: rgba(217, 154, 41, 0.2); box-shadow: 0 0 8px var(--neon-orange-glow); }
    .btn.primary { background: linear-gradient(90deg, rgba(217, 154, 41, 0.4), rgba(217, 120, 41, 0.3)); border-color: var(--neon-orange-base); }
    .btn.danger { border-color: #ff4d4d; background: rgba(255, 77, 77, 0.1); }
    .btn.danger:hover { background: rgba(255, 77, 77, 0.25); box-shadow: 0 0 10px rgba(255,77,77,0.4); }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 10px; }
    
    .preview-stage { flex: 1; background: #000; border-radius: 20px; overflow: hidden; position: relative; }
    iframe { width: 100%; height: 100%; border: 0; background: #000; pointer-events: auto; }
    
    .q-list { display: flex; flex-direction: column; gap: 8px; }
    .q-item { padding: 10px; border-radius: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .q-item:hover { border-color: rgba(217, 154, 41, 0.4); }
    .q-item.drag-over { border-color: var(--neon-orange-base); background: rgba(217, 154, 41, 0.15); transform: scale(1.02); }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-backdrop.show { display: flex; }
    .modal { width: min(800px, 95%); background: #16110c; border: 1px solid var(--neon-orange-base); border-radius: 20px; box-shadow: var(--neon-box-shadow); max-height: 90vh; display: flex; flex-direction: column; }
    .modal-head { padding: 14px 20px; border-bottom: 1px solid rgba(217, 154, 41, 0.3); display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 18px; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-foot { padding: 14px 20px; border-top: 1px solid rgba(217, 154, 41, 0.3); display: flex; justify-content: flex-end; gap: 10px; }
    
    .topBrand { display: flex; align-items: center; gap: 10px; }
    .topBrand img { height: 36px; width: 36px; object-fit: contain; border-radius: 8px; }
    
    /* --- GAME UI --- */
    .gameRoot { position: absolute; inset: 0; overflow: hidden; background: #000; font-family: 'Roboto', sans-serif; cursor: var(--game-cursor, default); perspective: 1000px; }
    .arenaBg { position: absolute; inset: -25px; background-size: cover; background-position: center; transition: transform 0.15s ease-out; will-change: transform; cursor: var(--game-cursor, default); }
    
    .hud { position: absolute; top: 14px; left: 14px; right: 14px; pointer-events: none; z-index: 10; display:flex; justify-content:space-between; align-items:center; }
    .gameTitle { font-weight: 900; text-shadow: 0 4px 15px #000; color: #fff; }
    .teams { display: grid; gap: 10px; margin-top: 54px; padding:0 14px; pointer-events: auto; position:relative; z-index:10; cursor: default; }
    .teamCard { background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 10px; backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: space-between; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .teamInput { background: transparent; border: none; outline: none; color: #fff; font-weight: 900; font-size: 16px; width: 100%; max-width: 150px; }
    
    /* Targets */
    .targets { position: absolute; inset: 0; pointer-events: none; z-index: 5; }
    .target { position: absolute; transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); pointer-events: auto; transition: transform 0.1s; cursor: var(--game-cursor, pointer); }
    .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)) scale(1.1); }
    .target .img { position: absolute; inset: 0; background-image: var(--target-img); background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.6)); }
    .target .pts { position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 1px solid rgba(217,154,41,0.5); color: var(--neon-orange-base); padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 900; white-space: nowrap; pointer-events: none; backdrop-filter: blur(4px); text-shadow: 0 2px 4px #000; }
    .target.hit { pointer-events: none; animation: targetHitAnim 0.3s forwards; }
    @keyframes targetHitAnim {
        0% { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)) scale(1); opacity: 1; filter: brightness(2); }
        100% { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)) scale(0); opacity: 0; filter: brightness(1); }
    }
    
    .edit-mode .target { cursor: move !important; border: 2px dashed rgba(217, 154, 41, 0.8); border-radius: 50%; }
    .edit-mode .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); }

    /* Crosshair */
    #gArena.aiming, #gArena.aiming * { cursor: none !important; }
    #aimCursor { position: absolute; pointer-events: none; z-index: 45; transform: translate(-50%, -50%); display: none; }
    #gArena.aiming #aimCursor { display: block; }

    /* –≠—Ñ—Ñ–µ–∫—Ç—ã –≤–∑—Ä—ã–≤–∞ */
    .fx-ring { position: absolute; border-radius: 50%; border: 4px solid currentColor; transform: translate(-50%, -50%); pointer-events: none; z-index: 39; animation: shockwaveAnim 0.4s cubic-bezier(0.1, 0.8, 0.3, 1) forwards; }
    .fx-particle { position: absolute; width: 12px; height: 12px; border-radius: 50%; pointer-events: none; z-index: 40; filter: drop-shadow(0 0 4px currentColor); animation: fxPartAnim 0.5s cubic-bezier(0.1, 0.8, 0.3, 1) forwards;}
    @keyframes shockwaveAnim { 0% { width: 10px; height: 10px; opacity: 1; border-width: 6px; } 100% { width: var(--explosion-size); height: var(--explosion-size); opacity: 0; border-width: 1px; } }
    @keyframes fxPartAnim { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; filter: brightness(2); } 100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0); opacity: 0; filter: brightness(1); } }

    /* =========================================
       –†–û–°–ö–û–®–ù–´–ô –î–ò–ó–ê–ô–ù –û–ö–ù–ê –° –í–û–ü–†–û–°–û–ú 
       ========================================= */
    @keyframes modalPopIn {
      0% { opacity: 0; transform: scale(0.8) translateY(40px) rotateX(15deg); }
      70% { transform: scale(1.02) translateY(-5px) rotateX(-2deg); }
      100% { opacity: 1; transform: scale(1) translateY(0) rotateX(0); }
    }

    .game-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 50; cursor: default; perspective: 1000px; padding: 20px; }
    .game-modal.on { display: flex; }
    
    .game-modal-content {
      background: linear-gradient(135deg, rgba(20, 25, 30, 0.85), rgba(10, 12, 15, 0.95));
      border-radius: 30px;
      padding: 50px 40px;
      width: min(850px, 100%);
      box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 50px var(--team-color-alpha, rgba(217, 154, 41, 0.15));
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      --team-color: var(--neon-orange-base); 
    }
    .game-modal-content::-webkit-scrollbar { width: 6px; }
    .game-modal-content::-webkit-scrollbar-thumb { background: var(--team-color); border-radius: 4px; }

    .game-modal-content::after {
      content: ''; position: absolute; inset: 0; border-radius: 30px; pointer-events: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
      z-index: 20;
    }

    .game-modal-content::before {
      content: ''; position: absolute; inset: -4px; border-radius: 34px;
      background: linear-gradient(45deg, var(--team-color), transparent 40%, transparent 60%, var(--team-color));
      z-index: -1; filter: blur(15px); opacity: 0.6;
      animation: borderPulse 3s ease-in-out infinite alternate;
    }
    @keyframes borderPulse { 0% { opacity: 0.4; filter: blur(12px); } 100% { opacity: 0.8; filter: blur(20px); } }

    .modal-sparkle {
      position: absolute; border-radius: 50%; background: var(--team-color);
      filter: blur(2px); animation: floatSparkle 4s infinite ease-in-out alternate; z-index: 25; pointer-events: none;
    }
    @keyframes floatSparkle { 0% { transform: translateY(0) scale(1); opacity: 0.4; } 100% { transform: translateY(-20px) scale(1.5); opacity: 0.9; box-shadow: 0 0 15px var(--team-color); } }

    /* –ö–Ω–æ–ø–∫–∞ –ß–µ—Ä–Ω–æ–≤–∏–∫–∞ */
    #gDrawToggle {
      position: absolute; top: 20px; right: 20px; font-size: 24px; 
      background: rgba(0,0,0,0.5); border: 2px solid var(--team-color);
      border-radius: 50%; width: 46px; height: 46px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s; z-index: 40; padding: 0; box-shadow: 0 0 10px var(--team-color-alpha);
    }
    #gDrawToggle:hover { transform: scale(1.1); }
    /* –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è - —Å–≤–µ—Ç–∏–º –∫–Ω–æ–ø–∫—É */
    .game-modal-content.draw-mode #gDrawToggle { background: var(--team-color); box-shadow: 0 0 20px var(--team-color); transform: scale(1.1); }

    #gTimerContainer { display: flex; justify-content: center; margin-bottom: 24px; position: relative; z-index: 30; }
    #gTimerWrap { background: var(--team-color); color: #000; padding: 6px 30px; border-radius: 30px; box-shadow: 0 5px 25px var(--team-color); display: flex; align-items: center; gap: 8px; border: 2px solid rgba(255,255,255,0.5); transition: 0.3s; }
    #gTimer { font-weight: 900; font-size: 28px; text-shadow: 0 2px 4px rgba(255,255,255,0.5); }
    .timer-icon { font-size: 22px; color: #000; }

    #gQText { color: #fff; margin-top: 10px; margin-bottom: 30px; text-align: center; line-height: 1.4; text-shadow: 0 4px 15px rgba(0,0,0,0.8); word-wrap: break-word; position: relative; z-index: 10; }
    #gQImgWrap { text-align: center; margin-bottom: 30px; position: relative; z-index: 10; }
    #gQImgWrap img { max-width: 100%; max-height: 40vh; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.1); }

    #gAnswers { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; position: relative; z-index: 10; }
    
    .game-ans-btn {
      width: 100%; text-align: center; padding: 20px 24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.15); border-radius: 20px;
      color: #fff; font-size: 20px; font-weight: bold; cursor: pointer;
      transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); word-wrap: break-word; position: relative; z-index:10;
    }
    .game-ans-btn:hover:not(:disabled) {
      background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border-color: var(--team-color); transform: translateY(-4px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.4), 0 0 25px var(--team-color-alpha, rgba(217, 154, 41, 0.3));
    }
    .game-ans-btn:active:not(:disabled) { transform: translateY(0); }

    #gInputWrap { display: flex; gap: 12px; margin-top: 10px; justify-content: center; position: relative; z-index: 10; }
    #gInput { width: 100%; max-width: 450px; font-size: 24px; padding: 18px 24px; border-radius: 20px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.15); color: #fff; text-align: center; outline: none; transition: 0.3s; box-shadow: inset 0 4px 10px rgba(0,0,0,0.5); }
    #gInput:focus { border-color: var(--team-color); background: rgba(0,0,0,0.7); box-shadow: 0 0 25px var(--team-color-alpha, rgba(217, 154, 41, 0.3)), inset 0 4px 10px rgba(0,0,0,0.5); }
    #gSubmitBtn { border-radius: 20px; padding: 0 40px; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; background: var(--team-color); color: #000; border: none; font-weight: 900; box-shadow: 0 4px 15px var(--team-color); cursor:pointer;}
    #gSubmitBtn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-2px); }

    /* –ü—Ä—è—á–µ–º –æ—Ç–≤–µ—Ç—ã, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ */
    .game-modal-content.draw-mode #gAnswers,
    .game-modal-content.draw-mode #gInputWrap { display: none !important; }
    
    .game-modal-content.draw-mode #gDrawArea { display: block; }

    /* –û–±–ª–∞—Å—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–û–ì–†–û–ú–ù–ê–Ø) */
    #gDrawArea {
      display: none; width: 100%; height: 50vh; min-height: 300px; margin-top: 10px;
      border-radius: 16px; border: 3px solid var(--team-color);
      background-color: #fdfdfc;
      background-image: linear-gradient(#b0d4e3 1px, transparent 1px), linear-gradient(90deg, #b0d4e3 1px, transparent 1px);
      background-size: 25px 25px;
      position: relative; z-index: 10; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
    }
    #gCanvas { width: 100%; height: 100%; touch-action: none; cursor: crosshair; border-radius: 12px; }

    /* –ö–õ–ê–°–°–´ –û–ë–†–ê–¢–ù–û–ô –°–í–Ø–ó–ò */
    .ans-correct { background: #33d17a !important; border-color: #33d17a !important; color: #000 !important; box-shadow: 0 0 30px rgba(51,209,122,0.8) !important; transform: scale(1.05) !important; z-index: 20; }
    .ans-wrong { background: #ff5b6b !important; border-color: #ff5b6b !important; color: #fff !important; box-shadow: 0 0 30px rgba(255,91,107,0.8) !important; z-index: 20; }
    @keyframes shakeErr { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
    .shake-err { animation: shakeErr 0.25s ease-in-out 2; }

    .screen { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; text-align: center; cursor: default; }
    .screen.on { display: flex; }
    .screenCard { background: linear-gradient(135deg, rgba(30, 35, 45, 0.95), rgba(15, 20, 25, 0.98)); border-radius: 30px; padding: 40px; border: 1px solid var(--neon-orange-base); max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 40px rgba(217, 154, 41, 0.2); animation: modalPopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;}
    .resultRow { display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:16px 24px; border-radius:16px; margin-bottom:12px; font-size:22px; font-weight:bold; border: 1px solid rgba(255,255,255,0.1); }
  </style>
</head>
<body>

<div class="app" id="editorApp" style="display:none;">
  <div class="panel">
    <div class="panel-header">
      <div class="topBrand">
        <img src="63.png" alt="Logo" onerror="this.style.display='none'">
        <div style="font-weight:900; font-size:16px;">–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin-right:5px;">
           <span id="lblSizeText" style="font-size:11px; font-weight:900; color:#33d17a;" data-i18n="lSizeOk">üü¢ –ö–æ–¥ –≤ –Ω–æ—Ä–º–µ</span>
           <div style="width:80px; background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.1); height:6px; border-radius:3px; overflow:hidden;">
              <div id="barSize" style="width:0%; height:100%; background:#33d17a; transition: width 0.3s, background 0.3s;"></div>
           </div>
        </div>
        <button class="btn danger small" id="btnResetProject" data-i18n="btnResetProj">üóë –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        <button class="btn primary small" id="btnCopyCodeTop" data-i18n="btnCopy">üìã –ö–æ–¥</button>
      </div>
    </div>
    
    <div class="panel-body">
      <div class="section">
        <div class="title" data-i18n="sLang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        <select id="selLang">
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </div>

      <div class="section">
        <div class="title" data-i18n="sName">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</div>
        <input type="text" id="inpTitle" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä">
        <div class="row" style="margin-top:10px;">
          <div>
            <label data-i18n="lFont">–®—Ä–∏—Ñ—Ç</label>
            <select id="inpTitleFont" onchange="this.style.fontFamily=this.value">
              <option value="Roboto" style="font-family: 'Roboto';">Roboto</option>
              <option value="Open Sans" style="font-family: 'Open Sans';">Open Sans</option>
              <option value="Montserrat" style="font-family: 'Montserrat';">Montserrat</option>
              <option value="Lato" style="font-family: 'Lato';">Lato</option>
              <option value="Oswald" style="font-family: 'Oswald';">Oswald</option>
              <option value="Poppins" style="font-family: 'Poppins';">Poppins</option>
              <option value="Merriweather" style="font-family: 'Merriweather';">Merriweather</option>
              <option value="Playfair Display" style="font-family: 'Playfair Display';">Playfair Display</option>
              <option value="Lora" style="font-family: 'Lora';">Lora</option>
              <option value="Courier New" style="font-family: 'Courier New';">Courier New</option>
              <option value="Caveat" style="font-family: 'Caveat', cursive;">Caveat (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
              <option value="Neucha" style="font-family: 'Neucha', cursive;">Neucha (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
            </select>
          </div>
          <div>
            <label data-i18n="lFontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label>
            <input type="number" id="inpTitleSize" value="24">
          </div>
          <div>
            <label data-i18n="lTitleColor">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
            <input type="color" id="inpTitleColor" value="#ffffff" style="height:44px; padding:8px 10px;">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sDesign">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</div>
        <div class="row">
          <div>
            <label data-i18n="lBg">–§–æ–Ω –∏–≥—Ä—ã</label>
            <select id="selBg">
              <option value="1.png" data-i18n="bg1">üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –¥–∞–ª–∏</option>
              <option value="2.png" selected data-i18n="bg2">üå≤ –°–∫–∞–∑–æ—á–Ω—ã–π –ª–µ—Å</option>
              <option value="3.png" data-i18n="bg3">üåä –ú–æ—Ä—Å–∫–æ–µ –¥–Ω–æ</option>
              <option value="4.png" data-i18n="bg4">üíß –í–æ–¥–Ω—ã–π –º–∏—Ä</option>
              <option value="5.png" data-i18n="bg5">üå≥ –°—Ç–∞—Ä—ã–π –ø–∞—Ä–∫</option>
              <option value="6.png" data-i18n="bg6">üèúÔ∏è –î—Ä–µ–≤–Ω–∏–π –ï–≥–∏–ø–µ—Ç</option>
              <option value="7.png" data-i18n="bg7">üèôÔ∏è –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥</option>
              <option value="8.png" data-i18n="bg8">üåµ –î–∏–∫–∏–π –ó–∞–ø–∞–¥</option>
              <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
            </select>
            <input type="text" id="inpBgCustom" placeholder="https://..." style="display:none; margin-top:8px;">
          </div>
          <div>
            <label data-i18n="lTarget">–ú–∏—à–µ–Ω—å (–æ–±—â–∞—è)</label>
            <select id="selTarget">
              <option value="10.png" data-i18n="tgt10">üîò –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –º–∏—à–µ–Ω—å</option>
              <option value="11.png" data-i18n="tgt11">üí† –ú–æ–¥–µ—Ä–Ω</option>
              <option value="12.png" data-i18n="tgt12">üõ∏ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å</option>
              <option value="13.png" selected data-i18n="tgt13">üéØ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å</option>
              <option value="14.png" data-i18n="tgt14">‚≠ê –ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞</option>
              <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
            </select>
            <input type="text" id="inpTargetCustom" placeholder="https://..." style="display:none; margin-top:8px;">
          </div>
        </div>
        
        <div class="row" style="margin-top:10px;">
          <div>
            <label data-i18n="lTargetSize">–†–∞–∑–º–µ—Ä –º–∏—à–µ–Ω–∏</label>
            <input type="range" id="inpTargetSize" min="30" max="300" value="90">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label data-i18n="lCursor">–ü—Ä–∏—Ü–µ–ª (–∫—É—Ä—Å–æ—Ä)</label>
            <select id="selCursor">
              <option value="crosshair" data-i18n="oCrosshair">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫</option>
              <option value="sniper" data-i18n="oSniper">–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π (—á—ë—Ä–Ω—ã–π –æ–ø—Ç–∏—á–µ—Å–∫–∏–π)</option>
              <option value="reddot" data-i18n="oRedDot">–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞)</option>
              <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
            </select>
            <input type="text" id="inpCursorCustom" placeholder="https://... (.png)" style="display:none; margin-top:8px;">
          </div>
          <div>
            <label data-i18n="lCursorSize">–†–∞–∑–º–µ—Ä –ø—Ä–∏—Ü–µ–ª–∞</label>
            <input type="range" id="inpCursorSize" min="10" max="250" value="40">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div><label data-i18n="lRadius">–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpRadius" min="0" max="250" value="0"></div>
          <div><label data-i18n="lSpeed">–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpSpeed" min="0" max="10" value="0"></div>
        </div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</div>
        <div class="row">
          <div><label data-i18n="lTeams">–ö–æ–º–∞–Ω–¥ (1-3)</label>
            <select id="inpTeams">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
            </select>
          </div>
          <div>
            <label data-i18n="lSound">–í—ã—Å—Ç—Ä–µ–ª</label>
            <select id="inpSound">
              <option value="pif">–ü–∏—Ñ</option>
              <option value="snap">–©–µ–ª—á–æ–∫</option>
              <option value="boom">–ë—É–º</option>
              <option value="magic" data-i18n="oMagic">‚ú® –í–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞</option>
              <option value="ding" data-i18n="oDing">üîî –î–∑—ã–Ω—å (–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫)</option>
            </select>
          </div>
          <div><label data-i18n="lVol">–ì—Ä–æ–º–∫–æ—Å—Ç—å</label><input type="range" id="inpVol" min="0" max="1" step="0.1" value="0.7"></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div><label data-i18n="lPenaltyOn">–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–º–∞—Ö (–º–∏–º–æ –º–∏—à–µ–Ω–∏)</label><select id="inpPenaltyOn"><option value="false" data-i18n="oOff">–í—ã–∫–ª</option><option value="true" data-i18n="oOn">–í–∫–ª</option></select></div>
          <div><label data-i18n="lPenaltyPts">–í—ã—á–∏—Ç–∞—Ç—å –æ—á–∫–æ–≤</label><input type="number" id="inpPenaltyPts" value="5"></div>
        </div>
        <label data-i18n="lTeamColors" style="margin-top:10px;">–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥</label>
        <div id="teamColorsWrap" style="display:flex; gap:10px; margin-top:5px;"></div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</div>
        <div class="row">
          <div><label data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</label><select id="startEnabled"><option value="false" data-i18n="oOff">–í—ã–∫–ª—é—á–µ–Ω</option><option value="true" data-i18n="oOn">–í–∫–ª—é—á–µ–Ω</option></select></div>
          <div><label data-i18n="lInstructionColor">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label><input type="color" id="inpStartColor" value="#d99a29"></div>
        </div>
        <label style="display:flex; align-items:center; gap:5px; margin-top:10px;"><input type="checkbox" id="chkStartGlow" checked> <span data-i18n="lGlow">–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏</span></label>
        <textarea id="inpStartText" style="margin-top:10px;" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."></textarea>
      </div>
      
      <div class="section">
        <div class="title" data-i18n="sEnd">–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)</div>
        <label data-i18n="sEnd">–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</label><select id="feedEnabled"><option value="true" data-i18n="oOn">–í–∫–ª—é—á–µ–Ω</option><option value="false" data-i18n="oOff">–í—ã–∫–ª—é—á–µ–Ω</option></select>
        <textarea id="inpEndText" style="margin-top:10px;" placeholder="–î–æ–ø. —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."></textarea>
      </div>

      <div class="section">
        <div class="title"><span data-i18n="sQ">–í–æ–ø—Ä–æ—Å—ã</span> <span id="qCount" style="color:#fff">0</span></div>
        <div class="row" style="margin-bottom:12px;">
          <button class="btn primary" id="btnAddQ" data-i18n="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn primary" id="btnImportQ" data-i18n="btnImportQ" style="background: linear-gradient(90deg, #33d17a, #28a745); border-color: #28a745;">üì• –ò–º–ø–æ—Ä—Ç</button>
          <button class="btn" id="btnClearQ" data-i18n="btnClr">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div style="font-size:11px; color:var(--neon-orange-base); margin-bottom:8px;" data-i18n="lDragHint">üí° –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã (–∑–∞ –∑–Ω–∞—á–æ–∫ ‚ò∞), —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –∏—Ö –ø–æ—Ä—è–¥–æ–∫.</div>
        <div id="qList" class="q-list"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div>
        <div style="font-weight:900" data-i18n="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
      </div>
      <div style="display:flex; background:rgba(0,0,0,0.4); border-radius:12px; padding:4px; gap:4px; border:1px solid rgba(255,255,255,0.1);">
        <button id="btnModeEdit" class="btn small" style="background:var(--neon-orange-base); color:#000; border:none;" data-i18n="btnModeEdit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        <button id="btnModePlay" class="btn small" style="background:transparent; color:#fff; border:none;" data-i18n="btnModePlay">‚ñ∂Ô∏è –¢–µ—Å—Ç</button>
      </div>
    </div>
    <div class="panel-body" style="display:flex; flex-direction:column; padding:0;">
      <div class="preview-stage" style="border-radius:0; border:none;">
        <iframe id="previewFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-head">
      <span id="modalTitle" data-i18n="mTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</span>
      <button class="btn small danger" onclick="closeModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <div><label data-i18n="lQType">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label><select id="modType"><option value="choice" data-i18n="oChoice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option><option value="input" data-i18n="oInput">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option></select></div>
        <div><label data-i18n="lPts">–û—á–∫–∏</label><input type="number" id="modPts" value="10"></div>
      </div>
      <div class="row">
        <div><label data-i18n="lTimer">–¢–∞–π–º–µ—Ä</label><select id="modTimerOn"><option value="false" data-i18n="oOff">–í—ã–∫–ª</option><option value="true" data-i18n="oOn">–í–∫–ª</option></select></div>
        <div><label data-i18n="lSec">–°–µ–∫—É–Ω–¥—ã</label><input type="number" id="modTimerSec" value="30"></div>
      </div>
      <label data-i18n="lImg">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
      <input type="text" id="modImg" placeholder="https://..." oninput="checkImgLink(this)">
      <div id="modImgWarn" style="color:#ff4d4d; font-size:11px; margin-top:4px; display:none;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ö–∞–∂–µ—Ç—Å—è, –≤—ã –≤—Å—Ç–∞–≤–∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–π –∫–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –∏–≥—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (URL).</div>
      
      <label data-i18n="lQText">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
      <textarea id="modPrompt"></textarea>
      
      <div class="row" style="margin-top:10px;">
        <div>
          <label data-i18n="lFont">–®—Ä–∏—Ñ—Ç</label>
          <select id="modFont" onchange="this.style.fontFamily=this.value">
            <option value="Roboto" style="font-family: 'Roboto';">Roboto</option>
            <option value="Open Sans" style="font-family: 'Open Sans';">Open Sans</option>
            <option value="Montserrat" style="font-family: 'Montserrat';">Montserrat</option>
            <option value="Lato" style="font-family: 'Lato';">Lato</option>
            <option value="Oswald" style="font-family: 'Oswald';">Oswald</option>
            <option value="Poppins" style="font-family: 'Poppins';">Poppins</option>
            <option value="Merriweather" style="font-family: 'Merriweather';">Merriweather</option>
            <option value="Playfair Display" style="font-family: 'Playfair Display';">Playfair Display</option>
            <option value="Lora" style="font-family: 'Lora';">Lora</option>
            <option value="Courier New" style="font-family: 'Courier New';">Courier New</option>
            <option value="Caveat" style="font-family: 'Caveat', cursive;">Caveat (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
            <option value="Neucha" style="font-family: 'Neucha', cursive;">Neucha (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
          </select>
        </div>
        <div><label data-i18n="lFontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label><input type="number" id="modFontSize" value="20"></div>
      </div>
      
      <div class="row" style="margin-top:10px;">
        <div style="flex:1;">
          <label data-i18n="lQTarget">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –º–∏—à–µ–Ω—å</label>
          <select id="modTarget" onchange="document.getElementById('modTargetCustom').style.display = this.value === 'custom' ? 'block' : 'none'">
            <option value="default" data-i18n="oDefault">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            <option value="10.png" data-i18n="tgt10">üîò –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –º–∏—à–µ–Ω—å</option>
            <option value="11.png" data-i18n="tgt11">üí† –ú–æ–¥–µ—Ä–Ω</option>
            <option value="12.png" data-i18n="tgt12">üõ∏ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å</option>
            <option value="13.png" data-i18n="tgt13">üéØ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å</option>
            <option value="14.png" data-i18n="tgt14">‚≠ê –ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞</option>
            <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
          </select>
          <input type="text" id="modTargetCustom" placeholder="https://..." style="display:none; margin-top:8px;">
        </div>
      </div>

      <div class="section" style="margin-top:15px;">
        <div class="title" data-i18n="lAnsOpts">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
        <div id="modOptsList"></div>
        <button class="btn small" style="margin-top:10px;" onclick="addOptRow()" id="btnAddOpt" data-i18n="btnAddOpt">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal()" data-i18n="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveQ" data-i18n="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="importBackdrop">
  <div class="modal">
    <div class="modal-head">
      <span style="font-weight:900; color:#33d17a;">üì• –£–º–Ω—ã–π –ò–º–ø–æ—Ä—Ç</span>
      <button class="btn small danger" onclick="closeImport()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="row" style="margin-bottom:15px; align-items:flex-end;">
        <div>
          <label>–†–µ–∂–∏–º –∏–º–ø–æ—Ä—Ç–∞ —Ç–µ–∫—Å—Ç–∞:</label>
          <select id="importMode" style="border-color:#33d17a;">
            <option value="ege">–¢–µ–∫—Å—Ç —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–†–µ—à—É –ï–ì–≠)</option>
            <option value="line">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å)</option>
          </select>
        </div>
        <div>
          <label>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑:</label>
          <select id="importTemplate" style="border-color:#d99a29;">
            <option value="-1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
          </select>
        </div>
      </div>

      <div style="font-size:12px; color:rgba(255,255,255,0.7); margin-bottom:10px; line-height:1.4;">
        <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∫–∞–∫ —à–∞–±–ª–æ–Ω, –∏ –≤—Å–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç –µ–≥–æ —à—Ä–∏—Ñ—Ç, —Ä–∞–∑–º–µ—Ä, —Ç–∞–π–º–µ—Ä –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –º–∏—à–µ–Ω–∏!
      </div>
      
      <button class="btn small" style="background:#4a4a4a; margin-bottom: 10px; width: 100%; border-color:#888;" onclick="fixEgeText()" title="–ù–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å –†–µ—à—É –ï–ì–≠ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è –∫—Ä–∞–∫–æ–∑—è–±—Ä–∞–º–∏ (–í–µ—Ä–®—è—Ç–Ω–®—Å—Ç—å)">
        üõ† –ü–æ—á–∏–Ω–∏—Ç—å –∫—Ä–∞–∫–æ–∑—è–±—Ä—ã (–†–µ—à—É –ï–ì–≠)
      </button>

      <textarea id="importText" style="height:250px; font-family:'Courier New', monospace; font-size:14px;" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—é–¥–∞..."></textarea>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeImport()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" style="background: linear-gradient(90deg, #33d17a, #28a745); border-color: #28a745;" onclick="processImport()">‚ú® –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="gameRoot" style="display:none;">
  <div class="gameRoot" id="gArena">
    <div class="arenaBg" id="gBg"></div>
    <div id="aimCursor"></div>

    <div class="hud">
      <div class="gameTitle" id="gTitle"></div>
      <button class="btn small" id="btnReset" style="pointer-events:auto; z-index: 100;" data-i18n="btnReset">–°–±—Ä–æ—Å</button>
    </div>
    <div class="teams" id="gTeams"></div>
    <div class="targets" id="gTargets"></div>

    <div class="game-modal" id="gModal">
      <div class="game-modal-content">
        <div class="modal-sparkle" style="top:10%; left:5%; width:12px; height:12px; animation-delay:0s;"></div>
        <div class="modal-sparkle" style="bottom:15%; right:8%; width:18px; height:18px; animation-delay:1.5s;"></div>
        <div class="modal-sparkle" style="top:50%; right:3%; width:8px; height:8px; animation-delay:0.7s;"></div>
        <div class="modal-sparkle" style="bottom:5%; left:12%; width:10px; height:10px; animation-delay:2.2s;"></div>
        
        <button id="gDrawToggle" title="–û—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫">‚úèÔ∏è</button>

        <div id="gTimerContainer" style="display:none;">
           <div id="gTimerWrap">
              <span class="timer-icon">‚è±</span> <span id="gTimer">30</span>
           </div>
        </div>
        <h2 id="gQText"></h2>
        <div id="gQImgWrap" style="display:none;"><img id="gQImg"></div>
        <div id="gAnswers"></div>
        <div id="gInputWrap" style="display:none;">
          <input type="text" id="gInput" autocomplete="off" placeholder="...">
          <button id="gSubmitBtn" data-i18n="btnOK">OK</button>
        </div>
        
        <div id="gDrawArea">
          <canvas id="gCanvas"></canvas>
          <button class="btn small danger" id="gCanvasClear" style="position:absolute; top:10px; right:10px; z-index:15;">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

      </div>
    </div>

    <div class="screen" id="gStartScreen">
      <div class="screenCard" id="gStartCard">
        <h1 id="gStartTitle" style="color:#fff; margin-top:0;"></h1>
        <p id="gStartText" style="color:#ccc; font-size:18px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnPlay" style="font-size:20px; padding:12px 24px; margin-top:20px;" data-i18n="btnPlay">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
      </div>
    </div>

    <div class="screen" id="gEndScreen">
      <div class="screenCard" id="gEndCard">
        <h1 id="gEndTitle" style="color:var(--neon-orange-base); margin-top:0;" data-i18n="lGameOver">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h1>
        <div id="gEndStats" style="width:100%; margin:20px 0;"></div>
        <p id="gEndText" style="color:#ccc; font-size:16px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnRestart" style="margin-top:15px;" data-i18n="btnRestart">‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================
   –°–∂–∞—Ç–∏–µ LZString (–ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä)
   ======================== */
var LZString=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-=$";var n={compressToEncodedURIComponent:function(r){return n.compress(r,6,function(r){return o.charAt(r)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:r.replace(/ /g,"+"),n.decompress(r.length,32,function(n){return o.indexOf(r.charAt(n))})},compress:function(o,n,t){if(null==o)return"";var e,i,u,s={},c={},a="",p="",f="",l=2,d=3,h=2,v=[],m=0,g=0,w;for(u=0;u<o.length;u+=1)if(a=o.charAt(u),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=d++,c[a]=!0),p=f+a,Object.prototype.hasOwnProperty.call(s,p))f=p;else{if(Object.prototype.hasOwnProperty.call(c,f)){if(256>f.charCodeAt(0)){for(e=0;h>e;e++)m=m<<1,g==n-1?(g=0,v.push(t(m)),m=0):g++;for(i=f.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}else{for(i=1,e=0;h>e;e++)m=m<<1|i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i=0;for(i=f.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[f]}else for(i=s[f],e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[p]=d++,f=String(a)}if(""!==f){if(Object.prototype.hasOwnProperty.call(c,f)){if(256>f.charCodeAt(0)){for(e=0;h>e;e++)m=m<<1,g==n-1?(g=0,v.push(t(m)),m=0):g++;for(i=f.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}else{for(i=1,e=0;h>e;e++)m=m<<1|i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i=0;for(i=f.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[f]}else for(i=s[f],e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(i=2,e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;for(;;)if(m<<=1,g==n-1){v.push(t(m));break}else g++;return v.join("")},decompress:function(o,n,t){var e,i,u,s,c,a,p,f=[],l=4,d=4,h=3,v="",m=[],g={val:t(0),position:n,index:1};for(e=0;3>e;e+=1)f[e]=e;for(u=0,c=Math.pow(2,2),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;switch(u){case 0:for(u=0,c=Math.pow(2,8),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;p=r(u);break;case 1:for(u=0,c=Math.pow(2,16),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;p=r(u);break;case 2:return""}for(f[3]=p,i=p,m.push(p);;){if(g.index>o)return"";for(u=0,c=Math.pow(2,h),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;switch(p=u){case 0:for(u=0,c=Math.pow(2,8),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;f[d++]=r(u),p=d-1,l--;break;case 1:for(u=0,c=Math.pow(2,16),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;f[d++]=r(u),p=d-1,l--;break;case 2:return m.join("")}if(0==l&&(l=Math.pow(2,h),h++),f[p])v=f[p];else{if(p!==d)return null;v=i+i.charAt(0)}m.push(v),f[d++]=i+v.charAt(0),l--,i=v,0==l&&(l=Math.pow(2,h),h++)}}};return n}();

/* ========================
   –°–ª–æ–≤–∞—Ä—å (i18n)
   ======================== */
const dict = {
  ru: {
    btnResetProj: "üóë –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë", confirmReset: "–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.", btnCopy: "üìã –ö–æ–¥", sLang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", sName: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã", sDesign: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", lBg: "–§–æ–Ω –∏–≥—Ä—ã", lTarget: "–ú–∏—à–µ–Ω—å (–æ–±—â–∞—è)", optCustom: "–ü–æ —Å—Å—ã–ª–∫–µ...", lRadius: "–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è", lSpeed: "–°–∫–æ—Ä–æ—Å—Ç—å", sGame: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã", lTeams: "–ö–æ–º–∞–Ω–¥ (1-3)", lTeamColors: "–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥", lSound: "–í—ã—Å—Ç—Ä–µ–ª", lVol: "–ì—Ä–æ–º–∫–æ—Å—Ç—å", lPenaltyOn: "–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–º–∞—Ö", lPenaltyPts: "–í—ã—á–∏—Ç–∞—Ç—å –æ—á–∫–æ–≤", oOff: "–í—ã–∫–ª", oOn: "–í–∫–ª", sStart: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω", lInstructionColor: "–¶–≤–µ—Ç —Ä–∞–º–∫–∏", lGlow: "–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏", sEnd: "–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)", sQ: "–í–æ–ø—Ä–æ—Å—ã", btnAdd: "‚ûï –î–æ–±–∞–≤–∏—Ç—å", btnClr: "üßπ –û—á–∏—Å—Ç–∏—Ç—å", previewTitle: "–ü—Ä–æ—Å–º–æ—Ç—Ä", btnModeEdit: "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä", btnModePlay: "‚ñ∂Ô∏è –¢–µ—Å—Ç", mTitle: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å", lQType: "–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞", oChoice: "–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞", oInput: "–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞", lPts: "–û—á–∫–∏", lTimer: "–¢–∞–π–º–µ—Ä", lSec: "–°–µ–∫—É–Ω–¥—ã", lImg: "üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)", lQText: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞", lFont: "–®—Ä–∏—Ñ—Ç", lFontSize: "–†–∞–∑–º–µ—Ä", lTitleColor: "–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞", lAnsOpts: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", btnAddOpt: "‚ûï –í–∞—Ä–∏–∞–Ω—Ç", btnCancel: "–û—Ç–º–µ–Ω–∞", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", lRightAns: "–í–µ—Ä–Ω—ã–π", lOptText: "–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞", lDel: "–£–¥–∞–ª–∏—Ç—å", lGameOver: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã", btnRestart: "‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑", lTeam: "–ö–æ–º–∞–Ω–¥–∞", btnPlay: "‚ñ∂ –ù–∞—á–∞—Ç—å", btnReset: "–°–±—Ä–æ—Å", btnOK: "–û–ö", lCursor: "–ü—Ä–∏—Ü–µ–ª", oCrosshair: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫", oSniper: "–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π (—á—ë—Ä–Ω—ã–π)", oRedDot: "–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä (–∫—Ä–∞—Å–Ω—ã–π)", lSizeOk: "–ö–æ–¥ –≤ –Ω–æ—Ä–º–µ", lSizeWarn: "–ü–æ—á—Ç–∏ –ª–∏–º–∏—Ç", lSizeErr: "–ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢", oMagic: "‚ú® –í–æ–ª—à–µ–±–Ω–∞—è –ø–∞–ª–æ—á–∫–∞", oDing: "üîî –î–∑—ã–Ω—å", lQTarget: "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –º–∏—à–µ–Ω—å", oDefault: "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é", lTargetSize: "–†–∞–∑–º–µ—Ä –º–∏—à–µ–Ω–∏", lCursorSize: "–†–∞–∑–º–µ—Ä –ø—Ä–∏—Ü–µ–ª–∞", btnCopyQ: "–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å", lDragHint: "üí° –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã (–∑–∞ –∑–Ω–∞—á–æ–∫ ‚ò∞), —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –∏—Ö –ø–æ—Ä—è–¥–æ–∫.", btnImportQ: "üì• –ò–º–ø–æ—Ä—Ç",
    bg1: "üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –¥–∞–ª–∏", bg2: "üå≤ –°–∫–∞–∑–æ—á–Ω—ã–π –ª–µ—Å", bg3: "üåä –ú–æ—Ä—Å–∫–æ–µ –¥–Ω–æ", bg4: "üíß –í–æ–¥–Ω—ã–π –º–∏—Ä", bg5: "üå≥ –°—Ç–∞—Ä—ã–π –ø–∞—Ä–∫", bg6: "üèúÔ∏è –î—Ä–µ–≤–Ω–∏–π –ï–≥–∏–ø–µ—Ç", bg7: "üèôÔ∏è –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥", bg8: "üåµ –î–∏–∫–∏–π –ó–∞–ø–∞–¥",
    tgt10: "üîò –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –º–∏—à–µ–Ω—å", tgt11: "üí† –ú–æ–¥–µ—Ä–Ω", tgt12: "üõ∏ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å", tgt13: "üéØ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å", tgt14: "‚≠ê –ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞"
  },
  en: {
    btnResetProj: "üóë Reset All", confirmReset: "Are you sure you want to delete all questions and settings? This cannot be undone.", btnCopy: "üìã Copy Code", sLang: "Interface Language", sName: "Game Title", sDesign: "Design", lBg: "Background", lTarget: "Target (global)", optCustom: "Custom URL...", lRadius: "Orbit Radius", lSpeed: "Speed", sGame: "Game Settings", lTeams: "Teams (1-3)", lTeamColors: "Team Colors", lSound: "Shot Sound", lVol: "Volume", lPenaltyOn: "Penalty for miss", lPenaltyPts: "Points to Deduct", oOff: "Off", oOn: "On", sStart: "Start Screen", lInstructionColor: "Border Color", lGlow: "Border Glow", sEnd: "Feedback Screen", sQ: "Questions", btnAdd: "‚ûï Add", btnClr: "üßπ Clear", previewTitle: "Preview", btnModeEdit: "‚úèÔ∏è Edit", btnModePlay: "‚ñ∂Ô∏è Test", mTitle: "Edit Question", lQType: "Question Type", oChoice: "Multiple Choice", oInput: "Text Input", lPts: "Points", lTimer: "Timer", lSec: "Seconds", lImg: "üñºÔ∏è Image (URL)", lQText: "Question Text", lFont: "Font", lFontSize: "Size", lTitleColor: "Text Color", lAnsOpts: "Answer Options", btnAddOpt: "‚ûï Option", btnCancel: "Cancel", btnSave: "üíæ Save", lRightAns: "Correct", lOptText: "Option Text", lDel: "Delete", lGameOver: "Game Results", btnRestart: "‚Üª Play Again", lTeam: "Team", btnPlay: "‚ñ∂ Play", btnReset: "Reset", btnOK: "OK", lCursor: "Crosshair", oCrosshair: "Standard Crosshair", oSniper: "Sniper (Black)", oRedDot: "Red Dot Sight", lSizeOk: "Code Size OK", lSizeWarn: "Close to Limit", lSizeErr: "LIMIT REACHED", oMagic: "‚ú® Magic Wand", oDing: "üîî Ding", lQTarget: "Individual Target", oDefault: "Default", lTargetSize: "Target Size", lCursorSize: "Crosshair Size", btnCopyQ: "Duplicate", lDragHint: "üí° Drag questions by ‚ò∞ to reorder them.", btnImportQ: "üì• Import",
    bg1: "üåå Deep Space", bg2: "üå≤ Fairy Forest", bg3: "üåä Ocean Floor", bg4: "üíß Water World", bg5: "üå≥ Old Park", bg6: "üèúÔ∏è Ancient Egypt", bg7: "üèôÔ∏è Modern City", bg8: "üåµ Wild West",
    tgt10: "üîò Sport Target", tgt11: "üí† Modern", tgt12: "üõ∏ Space Target", tgt13: "üéØ Classic Target", tgt14: "‚≠ê Golden Star"
  }
};
let lang = "ru";
function t(key) { return (dict[lang] && dict[lang][key]) ? dict[lang][key] : (dict["ru"][key] || key); }
function applyLang() {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const k = el.getAttribute("data-i18n");
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA") el.placeholder = t(k);
    else if(el.tagName==="OPTION") el.textContent = t(k);
    else el.innerText = t(k);
  });
  if(typeof window.renderQList === 'function') window.renderQList();
  if(typeof window.forceCheckSize === 'function') window.forceCheckSize();
}

/* ========================
   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Config) & –£–ü–ê–ö–û–í–ö–ê (–°—É–ø–µ—Ä-—Å–∂–∞—Ç–∏–µ)
   ======================== */
const LS_KEY = 'mathShooterSave_v6'; 
function defaultCfg() {
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä", titleFont: "Roboto", titleSize: 24, titleColor: "#ffffff",
    bg: "2.png", bgUrl: "", target: "13.png", targetUrl: "",
    targetSize: 90, cursorSize: 40,
    cursor: "crosshair", cursorUrl: "",
    radius: 0, speed: 0, teams: 2, teamCols: ["#ffae00", "#33d17a", "#ff5b6b"], sound: "pif", vol: 0.7,
    penalty: { enabled: false, points: 5 },
    start: { enabled: false, text: "–ò–ù–°–¢–†–£–ö–¶–ò–Ø\n\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\n2) –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n\n–ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–∏.", color: "#d99a29", neon: true },
    end: { enabled: true, text: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É." },
    questions: []
  };
}

function packCfg(c) {
  const d = defaultCfg();
  let p = {};
  if(c.title !== d.title) p.t = c.title;
  if(c.titleFont !== d.titleFont) p.tfn = c.titleFont;
  if(Number(c.titleSize) !== d.titleSize) p.tsz = Number(c.titleSize);
  if(c.titleColor !== d.titleColor) p.tcl = c.titleColor;
  if(c.bg !== d.bg) p.b = c.bg;
  if(c.bgUrl) p.bu = c.bgUrl;
  if(c.target !== d.target) p.tg = c.target;
  if(c.targetUrl) p.tu = c.targetUrl;
  if(Number(c.targetSize) !== d.targetSize) p.ts = Number(c.targetSize);
  if(c.cursor !== d.cursor) p.cu = c.cursor;
  if(c.cursorUrl) p.cur = c.cursorUrl;
  if(Number(c.cursorSize) !== d.cursorSize) p.cs = Number(c.cursorSize);
  if(Number(c.radius) !== d.radius) p.r = Number(c.radius);
  if(Number(c.speed) !== d.speed) p.sp = Number(c.speed);
  if(Number(c.teams) !== d.teams) p.tm = Number(c.teams);
  if(JSON.stringify(c.teamCols) !== JSON.stringify(d.teamCols)) p.tc = c.teamCols;
  if(c.sound !== d.sound) p.sd = c.sound;
  if(Number(c.vol) !== d.vol) p.v = Number(c.vol);
  if(c.penalty.enabled !== d.penalty.enabled) p.pe = c.penalty.enabled?1:0;
  if(Number(c.penalty.points) !== d.penalty.points) p.pp = Number(c.penalty.points);
  
  if(c.start.enabled !== d.start.enabled) p.se = c.start.enabled?1:0;
  if(c.start.text !== d.start.text) p.st = c.start.text;
  if(c.start.color !== d.start.color) p.sc = c.start.color;
  if(c.start.neon !== d.start.neon) p.sn = c.start.neon?1:0;
  
  if(c.end.enabled !== d.end.enabled) p.fe = c.end.enabled?1:0;
  if(c.end.text !== d.end.text) p.ft = c.end.text;
  
  if(c.questions.length > 0) {
    p.q = c.questions.map(q => {
      let type = q.type === 'input' ? 1 : 0;
      let opts = type === 0 ? q.opts.map(o => (o.c ? "1" : "0") + o.t) : q.acc;
      return [
        type, 
        q.pts !== 10 ? q.pts : "", 
        q.timer ? 1 : 0, 
        q.sec !== 30 ? q.sec : "", 
        q.img || "", 
        q.font === "Roboto" ? "" : q.font, 
        q.size === 20 ? "" : q.size, 
        Math.round((q.x??50)*10)/10, 
        Math.round((q.y??50)*10)/10, 
        q.text || "", 
        opts,
        q.tgt === 'default' ? "" : (q.tgt || ""),
        q.tu || ""
      ];
    });
  }
  return p;
}

function unpackCfg(p) {
  const d = defaultCfg();
  if(!p || typeof p !== 'object') return d;
  
  return {
    title: p.t ?? d.title, 
    titleFont: p.tfn ?? d.titleFont,
    titleSize: p.tsz ? Number(p.tsz) : d.titleSize,
    titleColor: p.tcl ?? d.titleColor,
    bg: p.b ?? d.bg, bgUrl: p.bu || "",
    target: p.tg ?? d.target, targetUrl: p.tu || "",
    targetSize: p.ts ? Number(p.ts) : d.targetSize,
    cursor: p.cu ?? d.cursor, cursorUrl: p.cur || "", 
    cursorSize: p.cs ? Number(p.cs) : d.cursorSize,
    radius: p.r ? Number(p.r) : d.radius, 
    speed: p.sp ? Number(p.sp) : d.speed,
    teams: p.tm ? Number(p.tm) : d.teams, 
    teamCols: p.tc || d.teamCols,
    sound: p.sd ?? d.sound, 
    vol: p.v !== undefined ? Number(p.v) : d.vol,
    penalty: { enabled: p.pe === 1, points: p.pp !== undefined ? Number(p.pp) : d.penalty.points },
    start: { enabled: p.se === 1, text: p.st ?? d.start.text, color: p.sc ?? d.start.color, neon: p.sn === undefined ? d.start.neon : p.sn === 1 },
    end: { enabled: p.fe === undefined ? d.end.enabled : p.fe === 1, text: p.ft ?? d.end.text },
    questions: (p.q || []).map(q => {
      if(!Array.isArray(q)) {
        let type = q.ty === 1 ? 'input' : 'choice';
        let res = { type: type, pts: q.pt ?? 10, timer: q.tm === 1, sec: q.s ?? 30, img: q.i || "", text: q.p || "", font: q.f || "Roboto", size: q.fs ?? 20, x: q.x ?? 50, y: q.y ?? 50, tgt: "default", tu: "" };
        if(type === 'input') { res.acc = q.a || [""]; res.opts = [{t:"", c:true},{t:"", c:false}]; } 
        else { res.opts = (q.o || []).map(str => ({ c: str.charAt(0) === "1", t: str.slice(1) })); res.acc = [""]; }
        return res;
      }
      
      let type = q[0] === 1 ? 'input' : 'choice';
      let res = {
        type: type, pts: q[1] !== "" ? Number(q[1]) : 10, timer: q[2] === 1, sec: q[3] !== "" ? Number(q[3]) : 30,
        img: q[4] || "", font: q[5] || "Roboto", size: q[6] !== "" ? Number(q[6]) : 20,
        x: q[7] ?? 50, y: q[8] ?? 50, text: q[9] || "", tgt: q[11] || "default", tu: q[12] || ""
      };
      if (type === 'input') {
        res.acc = q[10] || [""]; res.opts = [{t:"", c:true},{t:"", c:false}];
      } else {
        res.opts = (q[10] || []).map(str => ({ c: String(str).charAt(0) === "1", t: String(str).slice(1) }));
        res.acc = [""];
      }
      return res;
    })
  };
}

let cfg = null;
try { const saved = localStorage.getItem(LS_KEY); if(saved) cfg = JSON.parse(saved); } catch(e) {}
if(!cfg) cfg = defaultCfg();
function saveCfg() { try { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); } catch(e) {} }

let editIdx = null;

const b64e = (o) => "~" + LZString.compressToEncodedURIComponent(JSON.stringify(packCfg(o)));
const b64d = (s) => {
  if(s.startsWith("~")) return unpackCfg(JSON.parse(LZString.decompressFromEncodedURIComponent(s.slice(1))));
  return unpackCfg(JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/'))))));
};

/* ========================
   –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª–∏–Ω—ã
   ======================== */
function checkLinkSize(data) {
  const maxLen = 25000;
  const curLen = data.length;
  const pct = Math.min(100, (curLen / maxLen) * 100);
  const bar = document.getElementById("barSize");
  const lblText = document.getElementById("lblSizeText");
  
  if (bar) bar.style.width = pct + "%";
  if (curLen < maxLen * 0.75) {
      if(bar) bar.style.background = "#33d17a";
      if(lblText) { lblText.textContent = "üü¢ " + t("lSizeOk"); lblText.style.color = "#33d17a"; }
  } else if (curLen <= maxLen) {
      if(bar) bar.style.background = "#d99a29";
      if(lblText) { lblText.textContent = "üü° " + t("lSizeWarn"); lblText.style.color = "#d99a29"; }
  } else {
      if(bar) bar.style.background = "#ff5b6b";
      if(lblText) { lblText.textContent = "üî¥ " + t("lSizeErr"); lblText.style.color = "#ff5b6b"; }
  }
}
window.forceCheckSize = () => { try { checkLinkSize(b64e(cfg)); } catch(e){} };
window.checkImgLink = (inp) => { document.getElementById('modImgWarn').style.display = inp.value.length > 500 ? "block" : "none"; };

/* ========================
   –ó–≤—É–∫–æ–≤–æ–π –¥–≤–∏–∂–æ–∫ (–ì–ª–æ–±–∞–ª—å–Ω—ã–π + –ù–∞–¥–µ–∂–Ω—ã–π)
   ======================== */
const AudioSys = (() => {
  let ctx, master;
  function init(){ 
    if(ctx) { if(ctx.state === 'suspended') ctx.resume(); return; }
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if(!AudioContext) return;
    ctx = new AudioContext(); master = ctx.createGain(); master.connect(ctx.destination); 
  }
  
  document.addEventListener('pointerdown', init, {once:true});
  document.addEventListener('click', init, {once:true});
  document.addEventListener('touchstart', init, {once:true});
  
  return {
    init,
    play: (type, v) => {
      init();
      if(!ctx) return;
      if(ctx.state==='suspended') ctx.resume();
      master.gain.value = v * 2; const t = ctx.currentTime;
      
      if (type === 'magic') {
        const freqs = [880, 1108, 1318, 1760];
        freqs.forEach((f, i) => {
            const osc = ctx.createOscillator(); const g2 = ctx.createGain();
            osc.type = 'sine'; osc.frequency.value = f;
            g2.gain.setValueAtTime(0, t + i*0.04); g2.gain.linearRampToValueAtTime(0.2, t + i*0.04 + 0.01); g2.gain.exponentialRampToValueAtTime(0.001, t + i*0.04 + 0.4);
            osc.connect(g2).connect(master); osc.start(t + i*0.04); osc.stop(t + i*0.04 + 0.45);
        });
      }
      else if (type === 'ding') {
        const osc = ctx.createOscillator(); const g2 = ctx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t);
        g2.gain.setValueAtTime(0, t); g2.gain.linearRampToValueAtTime(0.6, t + 0.01); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.8);
        osc.connect(g2).connect(master); osc.start(t); osc.stop(t + 0.85);
      }
      else if (type === 'correct') {
        const osc = ctx.createOscillator(); const g2 = ctx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(440, t);
        osc.frequency.exponentialRampToValueAtTime(880, t + 0.1);
        g2.gain.setValueAtTime(0, t); g2.gain.linearRampToValueAtTime(0.5, t + 0.05); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
        osc.connect(g2).connect(master); osc.start(t); osc.stop(t + 0.35);
      }
      else if (type === 'wrong') {
        const osc = ctx.createOscillator(); const g2 = ctx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, t);
        osc.frequency.exponentialRampToValueAtTime(100, t + 0.2);
        g2.gain.setValueAtTime(0, t); g2.gain.linearRampToValueAtTime(0.5, t + 0.05); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
        osc.connect(g2).connect(master); osc.start(t); osc.stop(t + 0.35);
      }
      else if(type==='boom'){ 
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(90,t); osc.frequency.exponentialRampToValueAtTime(40,t+0.2); g.gain.setValueAtTime(0.8,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.25); 
      }
      else if(type==='snap'){ 
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.type='square'; osc.frequency.setValueAtTime(220,t); osc.frequency.exponentialRampToValueAtTime(880,t+0.05); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.08); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.1); 
      }
      else { 
        const osc = ctx.createOscillator(), g = ctx.createGain();
        osc.type='triangle'; osc.frequency.setValueAtTime(600,t); osc.frequency.exponentialRampToValueAtTime(200,t+0.1); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.15); 
      }
    }
  };
})();

/* ========================
   –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê
   ======================== */
let previewMode = 'edit'; 

function bootEditor() {
  document.body.classList.add('editor-mode');
  document.getElementById('editorApp').style.display = 'grid';

  const upd = () => updateEditor();
  
  document.getElementById('btnResetProject').onclick = () => {
    if(confirm(t('confirmReset'))) { 
      localStorage.removeItem(LS_KEY); 
      window.location.href = window.location.origin + window.location.pathname; 
    }
  };

  document.getElementById('inpTitle').value = cfg.title;
  document.getElementById('inpTitleFont').value = cfg.titleFont || 'Roboto';
  document.getElementById('inpTitleFont').style.fontFamily = cfg.titleFont || 'Roboto';
  document.getElementById('inpTitleSize').value = cfg.titleSize || 24;
  document.getElementById('inpTitleColor').value = cfg.titleColor || '#ffffff';
  
  document.getElementById('selBg').value = cfg.bg; document.getElementById('inpBgCustom').value = cfg.bgUrl;
  document.getElementById('inpBgCustom').style.display = cfg.bg === 'custom' ? 'block' : 'none';
  document.getElementById('selTarget').value = cfg.target; document.getElementById('inpTargetCustom').value = cfg.targetUrl;
  document.getElementById('inpTargetCustom').style.display = cfg.target === 'custom' ? 'block' : 'none';
  document.getElementById('inpTargetSize').value = cfg.targetSize;
  document.getElementById('selCursor').value = cfg.cursor; document.getElementById('inpCursorCustom').value = cfg.cursorUrl;
  document.getElementById('inpCursorCustom').style.display = cfg.cursor === 'custom' ? 'block' : 'none';
  document.getElementById('inpCursorSize').value = cfg.cursorSize;
  document.getElementById('inpRadius').value = cfg.radius; document.getElementById('inpSpeed').value = cfg.speed;
  
  document.getElementById('inpTeams').value = cfg.teams; 
  
  document.getElementById('inpSound').value = cfg.sound; 
  document.getElementById('inpVol').value = cfg.vol;
  document.getElementById('inpPenaltyOn').value = cfg.penalty.enabled ? 'true' : 'false'; 
  document.getElementById('inpPenaltyPts').value = cfg.penalty.points;
  
  document.getElementById('startEnabled').value = cfg.start.enabled ? 'true' : 'false'; 
  document.getElementById('inpStartColor').value = cfg.start.color;
  document.getElementById('chkStartGlow').checked = cfg.start.neon; 
  document.getElementById('inpStartText').value = cfg.start.text;
  document.getElementById('feedEnabled').value = cfg.end.enabled ? 'true' : 'false'; 
  document.getElementById('inpEndText').value = cfg.end.text;

  document.querySelectorAll('#editorApp input:not([id^="mod"]):not(#inpTeams):not(#importText), #editorApp textarea:not([id^="mod"]):not(#importText), #editorApp select:not([id^="mod"]):not(#inpTeams):not(#importMode):not(#importTemplate)').forEach(el => {
    el.addEventListener('input', upd); 
    el.addEventListener('change', upd);
  });
  
  document.getElementById('selLang').addEventListener('change', (e) => { lang = e.target.value; applyLang(); });
  document.getElementById('selBg').addEventListener('change', (e) => { document.getElementById('inpBgCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; });
  document.getElementById('selTarget').addEventListener('change', (e) => { document.getElementById('inpTargetCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; });
  document.getElementById('selCursor').addEventListener('change', (e) => { document.getElementById('inpCursorCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; });
  
  document.getElementById('inpTeams').addEventListener('change', () => { renderTeamColsUI(); updateEditor(); });
  document.getElementById('inpTeams').addEventListener('input', () => { renderTeamColsUI(); updateEditor(); });
  
  document.getElementById('inpSound').addEventListener('change', (e) => { AudioSys.play(e.target.value, document.getElementById('inpVol').value); });

  document.getElementById('btnAddQ').onclick = () => openMod();
  
  document.getElementById('btnClearQ').onclick = () => { 
    if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã?")) { cfg.questions=[]; upd(); }
  };

  document.getElementById('btnSaveQ').onclick = saveMod;
  document.getElementById('btnCopyCodeTop').onclick = () => {
    const url = location.origin + location.pathname + "#game=" + encodeURIComponent(b64e(cfg));
    navigator.clipboard.writeText(`<iframe src="${url}" allow="autoplay; fullscreen" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`).then(()=>alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
  };

  document.getElementById('btnModeEdit').onclick = () => {
    previewMode = 'edit';
    document.getElementById('btnModeEdit').style.background = 'var(--neon-orange-base)';
    document.getElementById('btnModeEdit').style.color = '#000';
    document.getElementById('btnModePlay').style.background = 'transparent';
    document.getElementById('btnModePlay').style.color = '#fff';
    upd();
  };
  document.getElementById('btnModePlay').onclick = () => {
    previewMode = 'play';
    document.getElementById('btnModePlay').style.background = 'var(--neon-orange-base)';
    document.getElementById('btnModePlay').style.color = '#000';
    document.getElementById('btnModeEdit').style.background = 'transparent';
    document.getElementById('btnModeEdit').style.color = '#fff';
    upd();
  };

  window.addEventListener('message', e => {
    if(e.data && e.data.type==='updPos' && cfg.questions[e.data.idx]) {
      cfg.questions[e.data.idx].x = e.data.x; cfg.questions[e.data.idx].y = e.data.y;
      saveCfg(); window.renderQList(); window.forceCheckSize();
    }
  });

  renderTeamColsUI();
  applyLang();
  upd();
}

function renderTeamColsUI() {
  const c = Number(document.getElementById('inpTeams').value) || 2;
  const wrap = document.getElementById('teamColorsWrap');
  wrap.innerHTML = '';
  for(let i=0; i<c; i++){
    if(!cfg.teamCols[i]) cfg.teamCols[i] = ['#ffae00', '#33d17a', '#ff5b6b'][i] || '#ffffff';
    wrap.innerHTML += `<input type="color" id="tc_${i}" value="${cfg.teamCols[i]}">`;
  }
  for(let i=0; i<c; i++){ 
    document.getElementById(`tc_${i}`).addEventListener('input', (e) => { 
      cfg.teamCols[i] = e.target.value; 
      updateEditor(); 
    }); 
  }
}

let _prevTid = null;
function updateEditor() {
  cfg.title = document.getElementById('inpTitle').value;
  cfg.titleFont = document.getElementById('inpTitleFont').value;
  cfg.titleSize = Number(document.getElementById('inpTitleSize').value);
  cfg.titleColor = document.getElementById('inpTitleColor').value;
  cfg.bg = document.getElementById('selBg').value;
  cfg.bgUrl = document.getElementById('inpBgCustom').value;
  cfg.target = document.getElementById('selTarget').value;
  cfg.targetUrl = document.getElementById('inpTargetCustom').value;
  cfg.targetSize = Number(document.getElementById('inpTargetSize').value);
  cfg.cursor = document.getElementById('selCursor').value;
  cfg.cursorUrl = document.getElementById('inpCursorCustom').value;
  cfg.cursorSize = Number(document.getElementById('inpCursorSize').value);
  cfg.radius = Number(document.getElementById('inpRadius').value);
  cfg.speed = Number(document.getElementById('inpSpeed').value);
  
  cfg.teams = Number(document.getElementById('inpTeams').value) || 2;
  
  cfg.sound = document.getElementById('inpSound').value;
  cfg.vol = Number(document.getElementById('inpVol').value);
  cfg.penalty.enabled = document.getElementById('inpPenaltyOn').value === 'true';
  cfg.penalty.points = Number(document.getElementById('inpPenaltyPts').value);
  cfg.start.enabled = document.getElementById('startEnabled').value === 'true';
  cfg.start.color = document.getElementById('inpStartColor').value;
  cfg.start.neon = document.getElementById('chkStartGlow').checked;
  cfg.start.text = document.getElementById('inpStartText').value;
  cfg.end.enabled = document.getElementById('feedEnabled').value === 'true';
  cfg.end.text = document.getElementById('inpEndText').value;

  document.getElementById('qCount').innerText = cfg.questions.length;
  window.renderQList();
  saveCfg(); 

  const data = b64e(cfg);
  checkLinkSize(data);

  if(_prevTid) clearTimeout(_prevTid);
  _prevTid = setTimeout(() => {
    const isEditFlag = previewMode === 'edit' ? '1' : '0';
    document.getElementById('previewFrame').src = location.origin + location.pathname + "?t=" + Date.now() + "&edit=" + isEditFlag + "&lang=" + lang + "#game=" + encodeURIComponent(data);
  }, 400);
}

// === DRAG & DROP –î–õ–Ø –í–û–ü–†–û–°–û–í ===
let draggedQIdx = null;
window.dragQ = (e, i) => { draggedQIdx = i; e.dataTransfer.effectAllowed = 'move'; setTimeout(() => e.target.style.opacity = '0.5', 0); };
window.dragEndQ = (e) => { e.target.style.opacity = '1'; };
window.allowDropQ = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
window.dragEnterQ = (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
window.dragLeaveQ = (e) => { e.currentTarget.classList.remove('drag-over'); };
window.dropQ = (e, i) => {
  e.preventDefault(); e.currentTarget.classList.remove('drag-over');
  if(draggedQIdx === null || draggedQIdx === i) return;
  const item = cfg.questions.splice(draggedQIdx, 1)[0];
  cfg.questions.splice(i, 0, item);
  draggedQIdx = null; updateEditor();
};

window.renderQList = function() {
  document.getElementById('qList').innerHTML = cfg.questions.map((q, i) => `
    <div class="q-item" draggable="true" ondragstart="dragQ(event, ${i})" ondragend="dragEndQ(event)" ondragover="allowDropQ(event)" ondragenter="dragEnterQ(event)" ondragleave="dragLeaveQ(event)" ondrop="dropQ(event, ${i})">
      <div style="cursor: grab; flex:1;"><b>#${i+1} ‚ò∞</b> ${q.text.substring(0,25) || '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞'}... <div style="font-size:11px; color:#aaa">x:${Math.round(q.x ?? 50)}%, y:${Math.round(q.y ?? 50)}%</div></div>
      <div style="display:flex; gap:4px;">
        <button class="btn small" onclick="copyQ(${i})" title="${t('btnCopyQ')}">üìã</button>
        <button class="btn small" onclick="openMod(${i})">‚öôÔ∏è</button> 
        <button class="btn small danger" onclick="delQ(${i})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}
window.delQ = (i) => { cfg.questions.splice(i,1); updateEditor(); };

window.copyQ = (i) => {
  const qCopy = JSON.parse(JSON.stringify(cfg.questions[i]));
  qCopy.x = Math.min(95, (qCopy.x || 50) + 5); 
  qCopy.y = Math.min(95, (qCopy.y || 50) + 5);
  cfg.questions.push(qCopy);
  updateEditor();
};

// === –ü–ê–†–°–ï–† –ò–ú–ü–û–†–¢–ê ===
window.btnImportQ = document.getElementById('btnImportQ');
window.btnImportQ.onclick = () => { 
  const tplSelect = document.getElementById('importTemplate');
  tplSelect.innerHTML = '<option value="-1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>';
  cfg.questions.forEach((q, i) => {
      tplSelect.innerHTML += `<option value="${i}">–ö–∞–∫ –≤ –≤–æ–ø—Ä–æ—Å–µ #${i+1}</option>`;
  });
  document.getElementById('importBackdrop').classList.add('show'); 
};
window.closeImport = () => { document.getElementById('importBackdrop').classList.remove('show'); document.getElementById('importText').value = ''; };

window.fixEgeText = () => {
    let el = document.getElementById('importText');
    let val = el.value;
    
    val = val.replace(/–®/g, '–æ');
    val = val.replace(/t/g, '—Ç');
    val = val.replace(/r/g, '–≥');
    val = val.replace(/u/g, '–∏');
    val = val.replace(/n/g, '–ø');
    val = val.replace(/c/g, '—Å');
    val = val.replace(/p/g, '—Ä');
    val = val.replace(/k/g, '–∫');
    val = val.replace(/x/g, '—Ö');
    val = val.replace(/y/g, '—É');
    val = val.replace(/a/g, '–∞');
    val = val.replace(/e/g, '–µ');
    val = val.replace(/o/g, '–æ');

    val = val.replace(/H/g, '–ù');
    val = val.replace(/T/g, '–¢');
    val = val.replace(/M/g, '–ú');
    val = val.replace(/K/g, '–ö');
    val = val.replace(/P/g, '–†');
    val = val.replace(/C/g, '–°');
    val = val.replace(/E/g, '–ï');
    val = val.replace(/A/g, '–ê');
    val = val.replace(/O/g, '–û');
    val = val.replace(/X/g, '–•');

    el.value = val;
};

window.processImport = () => {
    const txt = document.getElementById('importText').value.trim();
    if (!txt) return closeImport();

    const mode = document.getElementById('importMode').value;
    const tplIdx = parseInt(document.getElementById('importTemplate').value);
    
    let baseQ = { pts: 10, timer: false, sec: 30, font: "Roboto", size: 20, tgt: "default", tu: "" };
    if (tplIdx >= 0 && cfg.questions[tplIdx]) {
        const tq = cfg.questions[tplIdx];
        baseQ = { 
            pts: tq.pts, timer: tq.timer, sec: tq.sec, 
            font: tq.font, size: tq.size, tgt: tq.tgt, tu: tq.tu
        };
    }

    if (mode === 'line') {
        const lines = txt.split('\n');
        lines.forEach((line) => {
            const trimmed = line.trim();
            if (trimmed) {
                cfg.questions.push({ ...baseQ, type: 'input', text: trimmed, opts: [], acc: ['–û—Ç–≤–µ—Ç'] });
            }
        });
    } else {
        const blocks = txt.split(/\n\s*\n/);
        blocks.forEach(block => {
            const lines = block.trim().split('\n');
            let qText = [];
            let opts = [];
            let autoAnswer = ['–û—Ç–≤–µ—Ç'];
            
            const optRegex = /^(\d+[\)\.]|[–∞-—è–ê-–Øa-zA-Z][\)\.])\s+(.+)$/;

            lines.forEach(line => {
                const trimmed = line.trim();
                const match = trimmed.match(optRegex);
                
                if (match) {
                    opts.push({ c: false, t: match[2].trim() });
                } else if (trimmed.toLowerCase().startsWith('–æ—Ç–≤–µ—Ç:')) {
                    autoAnswer = [trimmed.replace(/^–æ—Ç–≤–µ—Ç:\s*/i, '').trim()];
                } else {
                    qText.push(trimmed);
                }
            });

            if (opts.length > 0) {
                cfg.questions.push({ ...baseQ, type: 'choice', text: qText.join('\n'), opts: opts, acc: [''] });
            } else if (qText.length > 0) {
                cfg.questions.push({ ...baseQ, type: 'input', text: qText.join('\n'), opts: [], acc: autoAnswer });
            }
        });
    }

    closeImport();
    updateEditor();
};


// --- Modal ---
function openMod(idx = null) {
  editIdx = idx;
  const q = idx !== null ? cfg.questions[idx] : { type: "choice", text: "", pts: 10, font: "Roboto", size: 20, timer: false, sec: 30, img: "", opts: [{t:"", c:true}, {t:"", c:false}], acc: ["–û—Ç–≤–µ—Ç"], tgt: "default", tu: "" };
  document.getElementById('modType').value = q.type; document.getElementById('modPts').value = q.pts;
  document.getElementById('modTimerOn').value = q.timer ? "true" : "false"; document.getElementById('modTimerSec').value = q.sec;
  document.getElementById('modImg').value = q.img || ""; document.getElementById('modPrompt').value = q.text;
  
  document.getElementById('modTarget').value = q.tgt || 'default';
  document.getElementById('modTargetCustom').value = q.tu || '';
  document.getElementById('modTargetCustom').style.display = (q.tgt === 'custom') ? 'block' : 'none';

  const fSel = document.getElementById('modFont');
  fSel.value = q.font || "Roboto"; fSel.style.fontFamily = fSel.value;
  
  document.getElementById('modFontSize').value = q.size || 20;
  syncModType(); document.getElementById('modType').onchange = syncModType;
  function syncModType() { if(document.getElementById('modType').value === 'choice') renderOpts(q.opts || [{t:"", c:true}, {t:"", c:false}]); else renderAccs(q.acc || [""]); }
  document.getElementById('modalBackdrop').classList.add('show');
}
function renderOpts(opts) {
  document.getElementById('modOptsList').innerHTML = opts.map((o, i) => `<div class="row" style="margin-bottom:6px;"><input type="checkbox" style="width:24px;height:24px;" ${o.c?'checked':''} id="optC_${i}"><input type="text" value="${o.t}" id="optT_${i}" placeholder="${t('lOptText')}"><button class="btn small danger" onclick="delOptRow(${i}, 'choice')">‚úñ</button></div>`).join('');
}
function renderAccs(acc) {
  document.getElementById('modOptsList').innerHTML = acc.map((a, i) => `<div class="row" style="margin-bottom:6px;"><input type="text" value="${a}" id="accT_${i}" placeholder="${t('lRightAns')}"><button class="btn small danger" onclick="delOptRow(${i}, 'input')">‚úñ</button></div>`).join('');
}
window.addOptRow = () => { const type = document.getElementById('modType').value; if(type==='choice') { const o = collectOpts(); o.push({t:"", c:false}); renderOpts(o); } else { const a = collectAccs(); a.push(""); renderAccs(a); } };
window.delOptRow = (i, type) => { if(type==='choice'){ const o=collectOpts(); o.splice(i,1); renderOpts(o); } else { const a=collectAccs(); a.splice(i,1); renderAccs(a); } };
function collectOpts() { const arr=[]; let i=0; while(document.getElementById(`optT_${i}`)) { arr.push({ c: document.getElementById(`optC_${i}`).checked, t: document.getElementById(`optT_${i}`).value }); i++; } return arr; }
function collectAccs() { const arr=[]; let i=0; while(document.getElementById(`accT_${i}`)) { arr.push(document.getElementById(`accT_${i}`).value); i++; } return arr; }

function saveMod() {
  const q = {
    type: document.getElementById('modType').value, text: document.getElementById('modPrompt').value,
    pts: Number(document.getElementById('modPts').value), timer: document.getElementById('modTimerOn').value === "true", sec: Number(document.getElementById('modTimerSec').value),
    img: document.getElementById('modImg').value, font: document.getElementById('modFont').value, size: Number(document.getElementById('modFontSize').value),
    tgt: document.getElementById('modTarget').value, tu: document.getElementById('modTargetCustom').value,
    x: editIdx !== null ? (cfg.questions[editIdx].x ?? 50) : 50,
    y: editIdx !== null ? (cfg.questions[editIdx].y ?? 50) : 50
  };
  if(q.type==='choice') q.opts = collectOpts(); else q.acc = collectAccs();
  if(editIdx !== null) cfg.questions[editIdx] = q; else cfg.questions.push(q);
  closeModal(); updateEditor();
}
window.closeModal = () => document.getElementById('modalBackdrop').classList.remove('show');

/* ========================
   –†–ï–ñ–ò–ú –ò–ì–†–´ (–ò –ü–†–ï–í–¨–Æ)
   ======================== */
function bootGame() {
  const getParam = (k) => {
    let p = new URLSearchParams(location.search).get(k);
    if(!p && location.hash) {
      let hashStr = location.hash.substring(1); 
      try { hashStr = decodeURIComponent(hashStr); } catch(e){}
      p = new URLSearchParams(hashStr).get(k);
    }
    return p;
  };

  document.body.classList.add('game-mode');
  document.getElementById('gameRoot').style.display = 'block';
  lang = getParam('lang') || 'ru'; applyLang();
  
  let gCfg = cfg;
  let gameData = getParam('game');
  
  if(gameData) { 
    try { gCfg = b64d(gameData); } catch(e){ console.error(e); } 
  }
  const isEdit = getParam('edit') === '1';

  window.addEventListener('pointerdown', () => { try { if(AudioSys.ctx && AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume(); } catch(e){} }, {once: true});

  const arenaEl = document.getElementById('gArena');
  const arenaBg = document.getElementById('gBg');
  const aimCursor = document.getElementById('aimCursor');
  
  if(!isEdit) {
    let curHtml = '';
    let cSize = gCfg.cursorSize || 40;
    if(gCfg.cursor === 'sniper') curHtml = `<svg width="${cSize}" height="${cSize}" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="rgba(255,255,255,0.1)" stroke="black" stroke-width="3"/><line x1="20" y1="0" x2="20" y2="40" stroke="black" stroke-width="2"/><line x1="0" y1="20" x2="40" y2="20" stroke="black" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="red"/></svg>`;
    else if(gCfg.cursor === 'reddot') curHtml = `<svg width="${cSize}" height="${cSize}" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="red" stroke-width="3"/><circle cx="16" cy="16" r="4" fill="red"/></svg>`;
    else if(gCfg.cursor === 'custom') curHtml = `<img src="${gCfg.cursorUrl}" style="width:${cSize}px;height:${cSize}px;object-fit:contain; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.4));">`;
    else curHtml = `<svg width="${cSize}" height="${cSize}" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="none" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/><line x1="16" y1="0" x2="16" y2="32" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/><line x1="0" y1="16" x2="32" y2="16" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/></svg>`;
    aimCursor.innerHTML = curHtml;

    arenaEl.classList.add('aiming');
    arenaEl.addEventListener('mousemove', e => {
      const r = arenaEl.getBoundingClientRect();
      aimCursor.style.left = (e.clientX - r.left) + 'px';
      aimCursor.style.top = (e.clientY - r.top) + 'px';
    });
    arenaEl.addEventListener('mouseenter', () => { if(arenaEl.classList.contains('aiming')) aimCursor.style.display = 'block'; });
    arenaEl.addEventListener('mouseleave', () => aimCursor.style.display = 'none');
  }

  arenaEl.addEventListener('mousemove', e => {
      const r = arenaEl.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width - 0.5;
      const y = (e.clientY - r.top) / r.height - 0.5;
      arenaBg.style.transform = `scale(1.05) perspective(1000px) rotateY(${x * 10}deg) rotateX(${-y * 10}deg) translate(${x * -20}px, ${y * -20}px)`;
  });
  arenaEl.addEventListener('mouseleave', () => {
      arenaBg.style.transform = `scale(1.05) perspective(1000px) rotateY(0deg) rotateX(0deg) translate(0px, 0px)`;
  });

  const bgImg = gCfg.bg === 'custom' ? gCfg.bgUrl : gCfg.bg;
  arenaBg.style.backgroundImage = `url("${bgImg}")`;
  
  const gTitleEl = document.getElementById('gTitle');
  gTitleEl.innerText = gCfg.title;
  gTitleEl.style.fontFamily = gCfg.titleFont || 'Roboto';
  gTitleEl.style.fontSize = (gCfg.titleSize || 24) + 'px';
  gTitleEl.style.color = gCfg.titleColor || '#ffffff';

  const tDiv = document.getElementById('gTeams');
  const teamsCount = Number(gCfg.teams) || 2; 
  tDiv.style.gridTemplateColumns = `repeat(${teamsCount}, 1fr)`;
  let scores = Array(teamsCount).fill(0);
  let curTeam = 0;
  
  function drawTeams() {
    tDiv.innerHTML = scores.map((s, i) => {
      const col = gCfg.teamCols[i] || '#ffffff';
      return `<div class="teamCard" style="${i===curTeam ? `border-color:${col}; box-shadow: 0 0 15px ${col}66;` : ''}">
        <input type="text" class="teamInput" value="${t('lTeam')} ${i+1}">
        <b style="color:#fff; font-size:20px;">${s}</b>
      </div>`;
    }).join('');
  }
  drawTeams();

  function popFloatText(x, y, text, col) {
    const el = document.createElement('div');
    el.style.cssText = `position:absolute; left:${x}px; top:${y}px; color:${col}; font-weight:900; font-size:28px; pointer-events:none; z-index:20; transition: transform 0.8s ease-out, opacity 0.8s ease-out; transform: translate(-50%, -50%); text-shadow: 0 4px 10px #000;`;
    el.innerText = text;
    arenaEl.appendChild(el);
    requestAnimationFrame(() => { el.style.transform = 'translate(-50%, -100px)'; el.style.opacity = '0'; });
    setTimeout(() => el.remove(), 800);
  }

  function createExplosion(x, y, teamColor, targetSize) {
    const wave = document.createElement('div');
    wave.className = 'fx-ring';
    wave.style.left = x + 'px'; wave.style.top = y + 'px';
    wave.style.borderColor = teamColor || '#d99a29';
    wave.style.setProperty('--explosion-size', (targetSize * 2) + 'px');
    arenaEl.appendChild(wave);
    setTimeout(() => wave.remove(), 500);

    const count = 12;
    for(let i=0; i<count; i++) {
      const p = document.createElement('div');
      p.className = 'fx-particle';
      p.style.backgroundColor = teamColor || '#d99a29';
      p.style.color = teamColor || '#d99a29';
      p.style.left = x + 'px'; p.style.top = y + 'px';
      const angle = (Math.PI * 2 / count) * i + (Math.random()*0.5);
      const dist = (targetSize * 0.5) + Math.random() * (targetSize);
      const tx = Math.cos(angle) * dist; const ty = Math.sin(angle) * dist;
      p.style.setProperty('--tx', tx + 'px');
      p.style.setProperty('--ty', ty + 'px');
      arenaEl.appendChild(p);
      setTimeout(() => p.remove(), 600);
    }
  }

  arenaEl.onclick = (e) => {
    if(isEdit || !arenaEl.classList.contains('aiming')) return;
    if(e.target.closest('.target') || e.target.closest('.hud') || e.target.closest('.teams') || e.target.closest('.game-modal') || e.target.closest('.screen')) return;
    
    try { AudioSys.play(gCfg.sound, gCfg.vol); } catch(err){}
    
    if(gCfg.penalty && gCfg.penalty.enabled) {
      const p = Number(gCfg.penalty.points || 0);
      scores[curTeam] -= p;
      drawTeams();
      const r = arenaEl.getBoundingClientRect();
      popFloatText(e.clientX - r.left, e.clientY - r.top, `-${p}`, '#ff5b6b');
    }
  };

  const tgtDiv = document.getElementById('gTargets');
  tgtDiv.className = isEdit ? "targets edit-mode" : "targets";
  let targetsHit = 0;
  const tSize = gCfg.targetSize || 90;

  gCfg.questions.forEach((q, i) => {
    const el = document.createElement('div');
    el.className = 'target';
    el.style.width = tSize + 'px';
    el.style.height = tSize + 'px';
    
    if(q.x === undefined) q.x = 15 + (i % 5) * 16;
    if(q.y === undefined) q.y = 30 + Math.floor(i / 5) * 20;

    let finalTgtImg = "";
    if (q.tgt && q.tgt !== 'default') finalTgtImg = q.tgt === 'custom' ? q.tu : q.tgt;
    else finalTgtImg = gCfg.target === 'custom' ? gCfg.targetUrl : gCfg.target;

    el.style.left = q.x + '%'; el.style.top = q.y + '%';
    el.innerHTML = `
      <div class="img" style="background-image:url('${finalTgtImg}')"></div>
      <div class="pts">‚≠ê ${q.pts || 10}</div>
    `;
    
    if(gCfg.radius > 0 && gCfg.speed > 0) {
      let ang = (i / Math.max(1, gCfg.questions.length)) * Math.PI * 2;
      setInterval(() => {
        ang += (gCfg.speed * 0.01);
        el.style.setProperty('--orbit-x', Math.round(Math.cos(ang) * gCfg.radius) + 'px');
        el.style.setProperty('--orbit-y', Math.round(Math.sin(ang) * gCfg.radius) + 'px');
      }, 30);
    }

    if(isEdit) {
      const startDrag = (e) => {
        e.preventDefault(); e.stopPropagation();
        const rect = arenaEl.getBoundingClientRect();
        function move(ev) {
          let cX = ev.clientX ?? (ev.touches ? ev.touches[0].clientX : 0);
          let cY = ev.clientY ?? (ev.touches ? ev.touches[0].clientY : 0);
          let nx = Math.round(((cX - rect.left) / rect.width) * 100);
          let ny = Math.round(((cY - rect.top) / rect.height) * 100);
          nx = Math.max(0, Math.min(100, nx)); ny = Math.max(0, Math.min(100, ny));
          el.style.left = nx + "%"; el.style.top = ny + "%";
          window.parent.postMessage({ type: 'updPos', idx: i, x: nx, y: ny }, '*');
        }
        function stop() { 
          window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move);
          window.removeEventListener('mouseup', stop); window.removeEventListener('touchend', stop);
        }
        window.addEventListener('mousemove', move, {passive: false}); window.addEventListener('touchmove', move, {passive: false});
        window.addEventListener('mouseup', stop); window.addEventListener('touchend', stop);
      };
      el.onmousedown = startDrag;
      el.ontouchstart = startDrag;
    } else {
      el.onclick = (e) => {
        e.stopPropagation(); 
        if(!arenaEl.classList.contains('aiming')) return;
        
        try { AudioSys.play(gCfg.sound, gCfg.vol); } catch(err){}
        
        const rArena = arenaEl.getBoundingClientRect();
        const rTarget = el.getBoundingClientRect();
        const cx = rTarget.left - rArena.left + rTarget.width/2;
        const cy = rTarget.top - rArena.top + rTarget.height/2;
        const tCol = gCfg.teamCols[curTeam] || '#d99a29';
        
        createExplosion(cx, cy, tCol, tSize);

        el.classList.add('hit');
        openGameQuestion(q, tCol, () => {
          targetsHit++;
          if(targetsHit >= gCfg.questions.length && gCfg.end.enabled) showEndScreen();
        });
      };
    }
    tgtDiv.appendChild(el);
  });

  // –õ–æ–≥–∏–∫–∞ —Ö–æ–ª—Å—Ç–∞ (—á–µ—Ä–Ω–æ–≤–∏–∫–∞)
  const drawArea = document.getElementById('gDrawArea');
  const canvas = document.getElementById('gCanvas');
  const ctxCanvas = canvas.getContext('2d');
  let isDrawing = false;

  function resizeCanvas() {
      canvas.width = drawArea.offsetWidth;
      canvas.height = drawArea.offsetHeight;
  }

  function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
  }

  const startDraw = (e) => {
      isDrawing = true;
      const pos = getMousePos(e);
      ctxCanvas.beginPath();
      ctxCanvas.moveTo(pos.x, pos.y);
  };

  const draw = (e) => {
      if (!isDrawing) return;
      const pos = getMousePos(e);
      ctxCanvas.lineTo(pos.x, pos.y);
      ctxCanvas.strokeStyle = '#0f4c81'; 
      ctxCanvas.lineWidth = 3;
      ctxCanvas.lineCap = 'round';
      ctxCanvas.lineJoin = 'round';
      ctxCanvas.stroke();
      if(e.cancelable) e.preventDefault(); 
  };

  const stopDraw = () => isDrawing = false;

  canvas.addEventListener('pointerdown', startDraw);
  canvas.addEventListener('pointermove', draw);
  canvas.addEventListener('pointerup', stopDraw);
  canvas.addEventListener('pointerout', stopDraw);

  document.getElementById('gCanvasClear').onclick = () => {
      ctxCanvas.clearRect(0, 0, canvas.width, canvas.height);
  };

  document.getElementById('gDrawToggle').onclick = () => {
      const modalContent = document.querySelector('.game-modal-content');
      modalContent.classList.toggle('draw-mode');
      
      if(modalContent.classList.contains('draw-mode')) {
          setTimeout(resizeCanvas, 50); 
      }
  };

  let timerId = null;
  function openGameQuestion(q, tCol, onDone) {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∏ –æ—á–∏—â–∞–µ–º –µ–≥–æ
    const modal = document.getElementById('gModal');
    const modalContent = modal.querySelector('.game-modal-content');
    modalContent.classList.remove('draw-mode');
    ctxCanvas.clearRect(0, 0, canvas.width, canvas.height);

    modalContent.style.setProperty('--team-color', tCol);
    
    const hexToRgb = (hex) => {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }
    const rgb = hexToRgb(tCol);
    if(rgb) modalContent.style.setProperty('--team-color-alpha', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25)`);

    modal.classList.add('on');
    
    const txt = document.getElementById('gQText');
    txt.innerText = q.text; txt.style.fontFamily = q.font || 'Roboto'; txt.style.fontSize = (q.size || 20) + "px";
    
    const imgWrap = document.getElementById('gQImgWrap');
    if(q.img) { document.getElementById('gQImg').src = q.img; imgWrap.style.display = 'block'; } else { imgWrap.style.display = 'none'; }

    const ansDiv = document.getElementById('gAnswers'); const inpWrap = document.getElementById('gInputWrap');
    ansDiv.innerHTML = "";
    
    const timerContainer = document.getElementById('gTimerContainer');
    const timerElText = document.getElementById('gTimer');
    const timerWrap = document.getElementById('gTimerWrap');
    timerWrap.classList.remove('shake-err');
    timerElText.style.color = '#000';

    if(q.timer && q.sec > 0) {
      timerContainer.style.display = 'flex'; let timeLeft = q.sec; timerElText.innerText = timeLeft;
      timerId = setInterval(() => { 
        timeLeft--; timerElText.innerText = timeLeft; 
        if(timeLeft <= 0) {
          timerElText.style.color = '#ff5b6b';
          finishTurn(false, null, true);
        }
      }, 1000);
    } else { timerContainer.style.display = 'none'; }

    const inp = document.getElementById('gInput');
    const subBtn = document.getElementById('gSubmitBtn');

    if(q.type === 'choice') {
      inpWrap.style.display = 'none'; ansDiv.style.display = 'grid';
      let opts = [...q.opts].filter(o => o.t.trim() !== "").sort(() => Math.random() - 0.5);
      opts.forEach(o => {
        const b = document.createElement('button'); b.className = 'game-ans-btn'; b.innerText = o.t; b.style.fontFamily = q.font || 'Roboto';
        b.onclick = () => finishTurn(o.c, b);
        ansDiv.appendChild(b);
      });
    } else {
      ansDiv.style.display = 'none'; inpWrap.style.display = 'flex';
      inp.value = ""; inp.style.fontFamily = q.font || 'Roboto';
      inp.disabled = false; subBtn.disabled = false;
      subBtn.onclick = () => {
        const user = inp.value.trim().toLowerCase(); const accs = q.acc.map(a=>a.trim().toLowerCase());
        finishTurn(accs.includes(user), inp);
      };
    }

    function finishTurn(isCorrect, el = null, isTimeout = false) {
      clearInterval(timerId);
      
      const btns = ansDiv.querySelectorAll('.game-ans-btn');
      btns.forEach(b => b.style.pointerEvents = 'none');
      inp.disabled = true; subBtn.disabled = true;

      // –ï—Å–ª–∏ —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–∫—Ä—ã—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      modalContent.classList.remove('draw-mode');

      if(isCorrect) {
          try { AudioSys.play('correct', gCfg.vol); } catch(e){}
          if(el) el.classList.add('ans-correct');
      } else {
          try { AudioSys.play('wrong', gCfg.vol); } catch(e){}
          if(el) el.classList.add('ans-wrong', 'shake-err');
          else if(isTimeout) timerWrap.classList.add('shake-err');
      }

      setTimeout(() => {
          document.getElementById('gModal').classList.remove('on');
          arenaEl.classList.add('aiming'); 
          aimCursor.style.display = 'block'; 
          
          if(isCorrect) { scores[curTeam] += Number(q.pts || 10); }
          curTeam = (curTeam + 1) % teamsCount;
          drawTeams(); onDone();
      }, 1200);
    }
  }

  if(!isEdit && gCfg.start.enabled && gCfg.start.text) {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    const sCard = document.getElementById('gStartCard');
    document.getElementById('gStartScreen').classList.add('on');
    document.getElementById('gStartTitle').innerText = gCfg.title;
    document.getElementById('gStartTitle').style.fontFamily = gCfg.titleFont || 'Roboto';
    document.getElementById('gStartTitle').style.fontSize = (gCfg.titleSize || 24) + 'px';
    document.getElementById('gStartTitle').style.color = gCfg.titleColor || '#ffffff';
    document.getElementById('gStartText').innerText = gCfg.start.text;
    sCard.style.borderColor = gCfg.start.color;
    if(gCfg.start.neon) sCard.style.boxShadow = `0 0 25px ${gCfg.start.color}, inset 0 0 10px ${gCfg.start.color}`;
    
    document.getElementById('gBtnPlay').onclick = () => { 
      try{ AudioSys.init(); }catch(e){} 
      document.getElementById('gStartScreen').classList.remove('on'); 
      arenaEl.classList.add('aiming'); 
      aimCursor.style.display = 'block';
    };
  } else if (!isEdit) {
    arenaEl.classList.add('aiming');
    aimCursor.style.display = 'block'; 
  }

  function showEndScreen() {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    document.getElementById('gEndScreen').classList.add('on');
    document.getElementById('gEndTitle').style.fontFamily = gCfg.titleFont || 'Roboto';
    document.getElementById('gEndTitle').style.fontSize = (gCfg.titleSize || 24) + 'px';
    document.getElementById('gEndTitle').style.color = gCfg.titleColor || '#ffffff';
    document.getElementById('gEndText').innerText = gCfg.end.text;
    const tNames = Array.from(document.querySelectorAll('.teamInput')).map(i => i.value);
    document.getElementById('gEndStats').innerHTML = scores.map((s,i) => `
      <div class="resultRow">
        <span>${tNames[i] || '–ö–æ–º–∞–Ω–¥–∞ '+(i+1)}</span>
        <span style="color:var(--neon-orange-base)">${s}</span>
      </div>
    `).join('');
    document.getElementById('gBtnRestart').onclick = () => location.reload();
  }
  
  document.getElementById('btnReset').onclick = () => location.reload();
}

/* --- –ó–∞–ø—É—Å–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –•–µ—à–∞ --- */
const getParamMain = (k) => {
    let p = new URLSearchParams(location.search).get(k);
    if(!p && location.hash) {
      let hashStr = location.hash.substring(1); 
      try { hashStr = decodeURIComponent(hashStr); } catch(e){}
      p = new URLSearchParams(hashStr).get(k);
    }
    return p;
};

if(getParamMain('game') && getParamMain('edit') !== '1') bootGame();
else { bootEditor(); if(getParamMain('edit') === '1') bootGame(); }
</script>
</body>
</html>
