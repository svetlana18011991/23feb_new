<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor + Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#0b0f14;
      --card:rgba(20,28,38,.72);
      --card2:rgba(15,22,30,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.70);
      --gold: #caa24d;
      --gold2:#f1d089;
      --neon:#ff8a2a;
      --neon2:#ffb24d;
      --neonSoft: rgba(255,138,42,.18);
      --neonLine: rgba(255,138,42,.38);
      --danger:#ff5b6b;
      --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55);
      --r:18px;
      --qFont:'Roboto';
      --aFont:'Roboto';
      --qaSize:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%),
                  radial-gradient(900px 520px at 70% 18%, rgba(255,190,90,.08), transparent 60%),
                  linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Layout (editor) ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 480px 1fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100%;}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--neonLine);
      border-radius: 22px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.20), 0 0 26px var(--neonSoft);
      overflow:hidden;
      position:relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0; 
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 100% 0%, rgba(255,215,120,.07), transparent 65%),
                  repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 2px, transparent 2px 12px);
      opacity:.35;
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:1}

    .panel:hover{
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.32), 0 0 34px rgba(255,138,42,.20);
    }
    .section:hover{
      border-color: rgba(255,138,42,.42);
      box-shadow: 0 0 0 1px rgba(255,138,42,.18), 0 0 26px rgba(255,138,42,.14);
    }

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:800;
      font-size:22px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{ margin-top:4px; font-size:13px; color:var(--muted); }
    .btn{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      padding:10px 14px; border-radius: 14px; border:1px solid rgba(255,255,255,.13);
      background: rgba(25,35,46,.55); color:var(--text); cursor:pointer;
      user-select:none; transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(30,43,58,.68); border-color: rgba(255,255,255,.18)}
    .btn:active{ transform: translateY(1px) }
    .btnGold{ background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13)); border-color: rgba(202,162,77,.45); }
    .btnDanger{ background: linear-gradient(180deg, rgba(255,91,107,.24), rgba(255,91,107,.12)); border-color: rgba(255,91,107,.38); }

    .scroll{ flex: 1; min-height: 0; overflow:auto; padding: 14px 18px 18px 18px; }
    .section{
      background: rgba(10,14,20,.22); border: 1px solid rgba(255,138,42,.28);
      border-radius: 18px; padding: 14px; margin-bottom: 14px;
      box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 18px rgba(255,138,42,.10);
    }
    .section h3{ margin:0 0 10px 0; font-size:14px; color: rgba(255,255,255,.92); letter-spacing:.2px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:11px 12px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12); outline:none;
      background: rgba(10,14,18,.55); color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    textarea{min-height: 84px; resize: vertical;}
    
    .section .row, .section .row1{ margin-top: 10px; }
    .section .row > div, .section .row1 > div{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,0));
      border:1px solid rgba(255,138,42,.22); border-radius: 16px;
      padding: 12px 12px 10px 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 0 14px rgba(255,138,42,.08);
      min-width: 0;
    }
    .section .row > div:hover, .section .row1 > div:hover{
      border-color: rgba(255,138,42,.35); box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 0 18px rgba(255,138,42,.12);
    }
    .section label{ margin-bottom: 7px; font-size: 12.5px; letter-spacing: .15px; }

    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{
      border-color: rgba(255,138,42,.55); box-shadow: 0 0 0 3px rgba(255,138,42,.16); background: rgba(10,14,18,.68);
    }
    select{
      appearance:none; padding-right: 38px;
      background-image: linear-gradient(45deg, transparent 50%, rgba(232,238,247,.75) 50%), linear-gradient(135deg, rgba(232,238,247,.75) 50%, transparent 50%);
      background-position: calc(100% - 18px) 55%, calc(100% - 12px) 55%;
      background-size: 6px 6px, 6px 6px; background-repeat:no-repeat;
    }
    .help{ margin-top: 10px; padding: 10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background: rgba(10,14,18,.35); font-size:12px; color: rgba(232,238,247,.62); line-height:1.25;}
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .split{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .pill{ font-size:12px; padding:5px 9px; border-radius: 999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: rgba(255,255,255,.9); }
    .qList{display:flex; flex-direction:column; gap:10px;}
    .qItem{
      display:grid; grid-template-columns: 1fr auto; gap:10px; padding:10px 12px;
      border-radius: 16px; border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.48); align-items:center; border-color: rgba(255,138,42,.18);
    }
    .qItem:hover{ border-color: rgba(255,138,42,.36); box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 16px rgba(255,138,42,.10); }
    .qTitle{ font-weight:700; font-size:13px; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 320px; }
    .qMeta{ font-size:12px; color: rgba(232,238,247,.62); }
    .iconBtn{ width:38px; height:38px; border-radius: 12px; border:1px solid rgba(255,255,255,.12); background: rgba(25,35,46,.45); color:var(--text); cursor:pointer; display:grid; place-items:center; }
    .iconBtn:hover{ background: rgba(25,35,46,.65) }
    .iconBtn.danger{ border-color: rgba(255,91,107,.45); background: rgba(255,91,107,.12)}
    .iconBtn.danger:hover{ background: rgba(255,91,107,.18)}
    .soundRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end; }
    .range{ width:100%; accent-color: #2aa6ff; }

    .previewWrap{ display:flex; flex-direction:column; min-width: 0; }
    .previewHeader{ padding: 14px 16px; display:flex; align-items:flex-end; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.08); }
    .previewHeader .title2{ font-weight:800; font-size:18px; }
    .previewHeader .muted{ font-size:12px; color:var(--muted); }
    .previewFrame{ flex:1; min-height: 420px; border:0; width:100%; background: transparent; }

    /* ====== GAME MODE ====== */
    .gameRoot{ position:fixed; inset:0; overflow:hidden; display:flex; flex-direction:column; background:#000; }
    .arena{ position:relative; flex:1; border-radius: 22px; overflow:hidden; margin: 16px; border: 1px solid rgba(255,255,255,.10); box-shadow: var(--shadow); background: #0b0f14; }
    .arenaBg{ position:absolute; inset:0; background-size: cover; background-position: center; background-repeat:no-repeat; transform: scale(1.06); filter: saturate(1.05) contrast(1.03) brightness(1.02); }
    .arenaBg::after{ content:""; position:absolute; inset:0; background: radial-gradient(900px 520px at 20% 20%, rgba(255,230,160,.10), transparent 55%), radial-gradient(900px 520px at 80% 25%, rgba(100,180,255,.10), transparent 55%), linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45)); mix-blend-mode: multiply; pointer-events:none; }
    .arenaBg3d{ will-change: transform; transition: transform .08s linear; }

    .hud{ position:absolute; top:14px; left:14px; right:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; pointer-events:none; z-index:10;}
    .hudLeft{ display:flex; flex-direction:column; gap:6px; min-width: 260px; max-width: 460px; }
    .gameTitle{ font-weight:900; font-size:22px; text-shadow: 0 6px 25px rgba(0,0,0,.55); }
    .gameHint{ font-size:12px; color: rgba(255,255,255,.78); text-shadow: 0 6px 25px rgba(0,0,0,.55); }
    .hudRight{ pointer-events:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pillBtn{ pointer-events:auto; border-radius: 999px; padding:9px 12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.32); backdrop-filter: blur(10px); color: rgba(255,255,255,.92); font-weight:650; font-size:13px; cursor:pointer; }
    .pillBtn:hover{ background: rgba(0,0,0,.40) }
    .hudStat{ pointer-events:none; border-radius: 999px; padding:9px 12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.26); backdrop-filter: blur(10px); color: rgba(255,255,255,.9); font-weight:650; font-size:13px; }

    .teams{ position:absolute; top:78px; left:14px; right:14px; display:grid; gap:10px; pointer-events:none; z-index:10;}
    .teamCard{ pointer-events:auto; border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.30); backdrop-filter: blur(10px); padding:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; min-height: 56px; transition: 0.3s ease;}
    .teamNameInput{ pointer-events:auto; width: 100%; max-width: 220px; font-weight:800; font-size:14px; padding:8px 10px; border-radius: 14px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.28); color: rgba(255,255,255,.95); outline:none; }
    .teamScore{ font-weight:900; font-size:18px; color: rgba(255,255,255,.95); min-width: 40px; text-align:right; }
    .teamNow{ display:flex; align-items:center; gap:8px; color: rgba(255,255,255,.78); font-size:12px; white-space:nowrap; }
    .dot{ width:10px; height:10px; border-radius: 50%; background: rgba(255,255,255,.24); border: 1px solid rgba(255,255,255,.25); transition: 0.3s ease;}

    .targets{ position:absolute; inset:0; pointer-events:none; }
    .target{ position:absolute; width: 92px; height: 92px; border-radius: 999px; pointer-events:auto; cursor:pointer; user-select:none; transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); box-shadow: 0 12px 30px rgba(0,0,0,.50); z-index:5;}
    .target .tImg{ position:absolute; inset:-10px; background-image: var(--target-img); background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 10px 18px rgba(0,0,0,.55)); }
    .target .tNum{ position:absolute; inset:0; display:grid; place-items:center; font-weight:900; font-size:22px; color:#fff; text-shadow: 0 2px 10px rgba(0,0,0,.75); }
    .target.hit{ opacity: 0; transform: translate(-50%,-50%) scale(.2); pointer-events:none; transition: opacity .18s ease, transform .18s ease; }
    
    .target.edit-mode { cursor: move !important; border: 2px dashed rgba(255,138,42,0.8); border-radius: 50%; }

    .modalBackdrop{ position:absolute; inset:0; background: radial-gradient(1200px 700px at 20% 10%, rgba(255,138,42,.14), transparent 60%), rgba(0,0,0,.62); backdrop-filter: blur(10px); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 40; }
    .modalBackdrop.on{ display:flex; }
    .modal{ width: min(980px, 96vw); border-radius: 22px; border:1px solid var(--neonLine); background: linear-gradient(180deg, rgba(10,13,18,.94), rgba(6,8,10,.90)); box-shadow: 0 28px 110px rgba(0,0,0,.78); display:flex; flex-direction:column; max-height: calc(100vh - 36px); backdrop-filter: blur(8px); }
    .modalHeader{ padding: 14px 16px; background: linear-gradient(90deg, rgba(255,138,42,.18), rgba(255,138,42,.06) 40%, rgba(255,138,42,0)); border-bottom:1px solid rgba(255,138,42,.22); display:flex; align-items:center; justify-content:space-between; }
    .modalHeader .h{ font-weight:900; font-size:14px; color: rgba(255,255,255,.92); }
    .modalClose{ border-radius: 14px; padding:8px 12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); cursor:pointer; }
    .modalBody{ padding: 16px; display:grid; gap:12px; overflow:auto; flex:1; min-height:0; }
    
    .qText{ font-weight:900; font-size: var(--qaSize); line-height:1.2; font-family: var(--qFont), sans-serif; }
    .qImg{ margin-top: 10px; border-radius: 14px; overflow:hidden; border: 1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.25); text-align:center;}
    .qImg img{ max-width:100%; height:auto; max-height: 46vh; object-fit: contain; }

    .answers{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .ansBtn{ text-align:left; padding:14px; border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); cursor:pointer; display:flex; gap:12px; align-items:flex-start; font-size: var(--qaSize); font-family: var(--aFont), sans-serif; }
    .ansBtn:hover{ background: rgba(255,255,255,.09); }
    .ansKey{ width: 30px; height: 30px; border-radius: 999px; border: 1px solid rgba(202,162,77,.50); display:grid; place-items:center; font-weight:900; color: rgba(255,232,190,.95); flex:0 0 auto; }
    .inputRow{ display:flex; gap:10px; align-items:center; }
    .inputRow input{ flex:1; padding:12px 14px; border-radius: 16px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-weight:700; outline:none; font-family: var(--aFont), sans-serif; }
    
    .primary{ border-radius: 16px; padding: 12px 14px; border:1px solid rgba(202,162,77,.55); background: rgba(202,162,77,.18); color: rgba(255,245,225,.95); font-weight:900; cursor:pointer; }
    .secondary{ border-radius: 16px; padding: 12px 14px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); font-weight:800; cursor:pointer; }

    .timerBadge{ position:absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 8px 12px; border-radius: 999px; border:1px solid rgba(255,166,60,.55); background: rgba(255,166,60,.12); color: rgba(255,230,190,.95); font-weight:900; font-size:14px; display:none; align-items:center; gap:10px; }
    .timerBadge.on{ display:flex; }

    /* Screens */
    .screenBackdrop{ position:absolute; inset:0; background: radial-gradient(1200px 700px at 20% 10%, rgba(255,138,42,.14), transparent 60%), rgba(0,0,0,.66); backdrop-filter: blur(12px); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 70; }
    .screenBackdrop.on{ display:flex; }
    .screenCard{ width: min(980px, 96vw); border-radius: 22px; border: 1px solid var(--screenLine, rgba(255,138,42,.38)); background: linear-gradient(180deg, rgba(10,13,18,.94), rgba(6,8,10,.90)); box-shadow: 0 28px 110px rgba(0,0,0,.78), 0 0 46px var(--screenGlow, rgba(255,138,42,.18)); display:flex; flex-direction:column; max-height: calc(100vh - 36px); }
    .screenHeader{ padding: 14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; }
    .screenHeader .h{ font-weight:900; font-size:14px; color: rgba(255,255,255,.92); }
    .screenBody{ padding: 16px; overflow:auto; flex:1; min-height:0; }
    .screenText{ white-space:pre-wrap; line-height:1.35; font-size:14px; color: rgba(255,255,255,.90); }
    .resultList{ display:grid; gap:10px; margin-top: 10px; }
    .resultRow{ display:flex; align-items:center; justify-content:space-between; padding: 12px; border-radius: 16px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.28); font-weight:800; }
    .resultRow .score{ font-size:18px; font-weight:900; }
    .screenActions{ padding: 14px 16px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; justify-content:flex-end; }

    /* Top Brand */
    .topBrand{ position:fixed; left:18px; top:14px; z-index:9999; display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background:linear-gradient(180deg, rgba(18,24,33,.58), rgba(10,12,16,.35)); border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(8px); }
    .topBrand img{ height:34px; width:auto; object-fit:contain; display:block; border-radius:10px; }
    .topBrand span{ font-weight:800; font-size:13px; color:#fff; }
    body.modeGame .topBrand{ display:none; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Caveat:wght@400;700&family=Neucha&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topBrand" id="headerBrand">
    <img src="63.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'"/>
    <span>–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</span>
  </div>
<div id="root"></div>

<script>
/* ===========================
   –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor + Game v28
   =========================== */
const VERSION = 28;

/* ---------- –°–ª–æ–≤–∞—Ä—å (i18n) ---------- */
const dict = {
  ru: {
    edTitle: "–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª", btnCopy: "üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥", sLang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
    sName: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã", sDesign: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", lBg: "–§–æ–Ω –∏–≥—Ä—ã", lTarget: "–ú–∏—à–µ–Ω—å",
    optCustom: "–ü–æ —Å—Å—ã–ª–∫–µ...", lRadius: "–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è –º–∏—à–µ–Ω–∏", lSpeed: "–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –º–∏—à–µ–Ω–∏", sGame: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã",
    lTeams: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)", lTeamColors: "–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥", lSound: "–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞", lVol: "–ì—Ä–æ–º–∫–æ—Å—Ç—å", sStart: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω", lGlow: "–ù–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ",
    sEnd: "–≠–∫—Ä–∞–Ω —Ñ–∏–¥–±–µ–∫–∞", sQ: "–í–æ–ø—Ä–æ—Å—ã", btnAdd: "‚ûï –î–æ–±–∞–≤–∏—Ç—å", btnClr: "üßπ –û—á–∏—Å—Ç–∏—Ç—å",
    lDragHint: "üí° –î–≤–∏–≥–∞–π—Ç–µ –º–∏—à–µ–Ω–∏ –ø—Ä—è–º–æ –≤ –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞!", previewTitle: "–ü—Ä–æ—Å–º–æ—Ç—Ä", previewHint: "–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é",
    mTitle: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å", lQType: "–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞", oChoice: "–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞", oInput: "–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞",
    lPts: "–û—á–∫–∏", lQText: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞", lFont: "–®—Ä–∏—Ñ—Ç", lFontSize: "–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞",
    lAnsOpts: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", btnAddOpt: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç", btnCancel: "–û—Ç–º–µ–Ω–∞", btnSave: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
    lRightAns: "–í–µ—Ä–Ω—ã–π", lOptText: "–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞", lDel: "–£–¥–∞–ª–∏—Ç—å",
    lGameOver: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã", btnRestart: "‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑", lTeam: "–ö–æ–º–∞–Ω–¥–∞",
    lTimer: "–¢–∞–π–º–µ—Ä", lSec: "–°–µ–∫—É–Ω–¥—ã", lImg: "üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", lTotal: "–í—Å–µ–≥–æ:"
  },
  en: {
    edTitle: "Math Shooter Editor", btnCopy: "üìã Copy Code", sLang: "Interface Language",
    sName: "Game Title", sDesign: "Design", lBg: "Background", lTarget: "Target",
    optCustom: "Custom URL...", lRadius: "Orbit Radius", lSpeed: "Orbit Speed", sGame: "Settings",
    lTeams: "Number of teams (1-3)", lTeamColors: "Team Frame Colors", lSound: "Shot Sound", lVol: "Volume", sStart: "Start Screen", lGlow: "Neon Glow",
    sEnd: "Feedback Screen", sQ: "Questions", btnAdd: "‚ûï Add", btnClr: "üßπ Clear",
    lDragHint: "üí° Drag targets directly in the preview on the right!", previewTitle: "Preview", previewHint: "Live preview",
    mTitle: "Edit Question", lQType: "Question Type", oChoice: "Multiple Choice", oInput: "Text Input",
    lPts: "Points", lQText: "Question Text", lFont: "Font", lFontSize: "Font Size",
    lAnsOpts: "Answer Options", btnAddOpt: "‚ûï Add Option", btnCancel: "Cancel", btnSave: "Save",
    lRightAns: "Correct", lOptText: "Option Text", lDel: "Delete",
    lGameOver: "Game Results", btnRestart: "‚Üª Play Again", lTeam: "Team",
    lTimer: "Timer", lSec: "Seconds", lImg: "üñºÔ∏è Image (URL, optional)", lTotal: "Total:"
  },
  de: {
    edTitle: "Mathe-Shooter Editor", btnCopy: "üìã Code kopieren", sLang: "Sprache",
    sName: "Spieltitel", sDesign: "Design", lBg: "Hintergrund", lTarget: "Ziel",
    optCustom: "Eigene URL...", lRadius: "Orbit-Radius", lSpeed: "Geschwindigkeit", sGame: "Parameter",
    lTeams: "Anzahl der Teams (1-3)", lTeamColors: "Team-Rahmenfarben", lSound: "Schuss-Sound", lVol: "Lautst√§rke", sStart: "Startbildschirm", lGlow: "Neon-Gl√ºhen",
    sEnd: "Feedback-Bildschirm", sQ: "Fragen", btnAdd: "‚ûï Hinzuf√ºgen", btnClr: "üßπ Leeren",
    lDragHint: "üí° Ziehen Sie die Ziele direkt in der Vorschau rechts!", previewTitle: "Vorschau", previewHint: "Live-Vorschau",
    mTitle: "Frage bearbeiten", lQType: "Fragetyp", oChoice: "Multiple Choice", oInput: "Texteingabe",
    lPts: "Punkte", lQText: "Fragentext", lFont: "Schriftart", lFontSize: "Schriftgr√∂√üe",
    lAnsOpts: "Antwortm√∂glichkeiten", btnAddOpt: "‚ûï Option hinzuf√ºgen", btnCancel: "Abbrechen", btnSave: "Speichern",
    lRightAns: "Richtig", lOptText: "Optionstext", lDel: "L√∂schen",
    lGameOver: "Spielergebnisse", btnRestart: "‚Üª Nochmal spielen", lTeam: "Team",
    lTimer: "Timer", lSec: "Sekunden", lImg: "üñºÔ∏è Bild (URL, optional)", lTotal: "Gesamt:"
  },
  zh: {
    edTitle: "Êï∞Â≠¶Â∞ÑÂáªÁºñËæëÂô®", btnCopy: "üìã Â§çÂà∂‰ª£Á†Å", sLang: "ÁïåÈù¢ËØ≠Ë®Ä",
    sName: "Ê∏∏ÊàèÂêçÁß∞", sDesign: "ËÆæËÆ°", lBg: "ËÉåÊôØ", lTarget: "ÁõÆÊ†á",
    optCustom: "Ëá™ÂÆö‰πâ URL...", lRadius: "ËΩ®ÈÅìÂçäÂæÑ", lSpeed: "ÈÄüÂ∫¶", sGame: "ËÆæÁΩÆ",
    lTeams: "Èòü‰ºçÊï∞Èáè (1-3)", lTeamColors: "Èòü‰ºçËæπÊ°ÜÈ¢úËâ≤", lSound: "Â∞ÑÂáªÂ£∞Èü≥", lVol: "Èü≥Èáè", sStart: "ÂºÄÂßãÂ±èÂπï", lGlow: "ÈúìËôπÂèëÂÖâ",
    sEnd: "ÂèçÈ¶àÂ±èÂπï", sQ: "ÈóÆÈ¢ò", btnAdd: "‚ûï Ê∑ªÂä†", btnClr: "üßπ Ê∏ÖÈô§",
    lDragHint: "üí° Áõ¥Êé•Âú®Âè≥‰æßÈ¢ÑËßà‰∏≠ÊãñÂä®ÁõÆÊ†áÔºÅ", previewTitle: "È¢ÑËßà", previewHint: "ÂÆûÊó∂È¢ÑËßà",
    mTitle: "ÁºñËæëÈóÆÈ¢ò", lQType: "ÈóÆÈ¢òÁ±ªÂûã", oChoice: "ÈÄâÊã©È¢ò", oInput: "Â°´Á©∫È¢ò",
    lPts: "ÂàÜÊï∞", lQText: "ÈóÆÈ¢òÊñáÊú¨", lFont: "Â≠ó‰Ωì", lFontSize: "Â≠ó‰ΩìÂ§ßÂ∞è",
    lAnsOpts: "Á≠îÊ°àÈÄâÈ°π", btnAddOpt: "‚ûï Ê∑ªÂä†ÈÄâÈ°π", btnCancel: "ÂèñÊ∂à", btnSave: "‰øùÂ≠ò",
    lRightAns: "Ê≠£Á°Æ", lOptText: "ÈÄâÈ°πÊñáÊú¨", lDel: "Âà†Èô§",
    lGameOver: "Ê∏∏ÊàèÁªìÊûú", btnRestart: "‚Üª ÂÜçÁé©‰∏ÄÊ¨°", lTeam: "Èòü‰ºç",
    lTimer: "ËÆ°Êó∂Âô®", lSec: "Áßí", lImg: "üñºÔ∏è ÂõæÁâá (URLÔºåÂèØÈÄâ)", lTotal: "ÊÄªËÆ°:"
  }
};
let currentLang = "ru";
function t(k) { return dict[currentLang][k] || dict["ru"][k] || k; }
function applyLang() {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const k = el.getAttribute("data-i18n");
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA") el.placeholder = t(k);
    else if(el.tagName==="OPTION") el.textContent = t(k);
    else {
      el.childNodes.forEach(n => { if(n.nodeType===3 && n.nodeValue.trim().length > 0) n.nodeValue = t(k); });
    }
  });
  if(window.renderQuestionList) window.renderQuestionList();
}

/* ---------- helpers ---------- */
const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
function b64uEncode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function b64uDecode(str){ return JSON.parse(decodeURIComponent(escape(atob(str.replace(/-/g,'+').replace(/_/g,'/'))))); }
function urlOfSelf(){ return location.origin + location.pathname; }

/* ---------- Default config ---------- */
function defaultCfg(){
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamsCount: 2,
    teamColors: ["#ffae00", "#33d17a", "#ff5b6b"],
    autoNextTeam: true, latex: false,
    bg: "2.png", targetFile: "13.png",
    targetOrbitRadius: 0, targetOrbitSpeed: 0,
    shot: { variant:"pif", volume:0.7 },
    startScreen: {
      enabled: true,
      text: "–ò–ù–°–¢–†–£–ö–¶–ò–Ø\n\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\n2) –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n\n–ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–∏.",
      color: "#ff8a2a", neon: true
    },
    feedbackScreen: { enabled: true, extraText: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É." },
    questions: [],
    qFont: 'Roboto', aFont: 'Roboto', fontSize: 18
  };
}

/* ---------- WebAudio Shot ---------- */
const AudioKit = (() => {
  let ctx, master;
  function ensure(){ if(ctx)return; ctx=new(window.AudioContext||window.webkitAudioContext)(); master=ctx.createGain(); master.connect(ctx.destination); }
  function playVariant(variant, vol){
    ensure(); if(ctx.state==='suspended') ctx.resume();
    master.gain.value = clamp(vol, 0, 1) * 2.2;
    const t0 = ctx.currentTime; const out = ctx.createGain(); out.gain.value = 1.25; out.connect(master);
    if(variant === 'boom'){
      const osc = ctx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(90, t0); osc.frequency.exponentialRampToValueAtTime(45, t0+0.12);
      const g = ctx.createGain(); g.gain.setValueAtTime(0.0001, t0); g.gain.exponentialRampToValueAtTime(0.9, t0+0.015); g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);
      osc.connect(g).connect(out); osc.start(t0); osc.stop(t0+0.24);
    } else if(variant === 'snap'){
      const osc = ctx.createOscillator(); osc.type = 'square'; osc.frequency.setValueAtTime(220, t0); osc.frequency.exponentialRampToValueAtTime(880, t0+0.03);
      const g = ctx.createGain(); g.gain.setValueAtTime(0.0001, t0); g.gain.exponentialRampToValueAtTime(0.6, t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t0+0.08);
      osc.connect(g).connect(out); osc.start(t0); osc.stop(t0+0.09);
    } else {
      const osc = ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(620, t0); osc.frequency.exponentialRampToValueAtTime(260, t0+0.06);
      const g = ctx.createGain(); g.gain.setValueAtTime(0.0001, t0); g.gain.exponentialRampToValueAtTime(0.7, t0+0.006); g.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      osc.connect(g).connect(out); osc.start(t0); osc.stop(t0+0.10);
    }
  }
  return { playVariant };
})();

const params = new URLSearchParams(location.search);
const isGame = params.has('game');
const isEdit = params.has('edit');
if(isGame) document.body.classList.add('modeGame');

/* ===========================
   GAME MODE
   =========================== */
function mountGame(cfg){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div class="arenaBg" id="arenaBg"></div>
        <div class="hud">
          <div class="hudLeft">
            <div class="gameTitle" id="gTitle"></div>
          </div>
          <div class="hudRight">
            <button class="pillBtn" id="btnHelp" style="display:none">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="pillBtn" id="btnReset">–°–±—Ä–æ—Å</button>
          </div>
        </div>
        <div class="teams" id="teams"></div>
        <div class="targets" id="targets"></div>

        <div class="modalBackdrop" id="modalBack">
          <div class="modal">
            <div class="timerBadge" id="timerBadge">‚è± <span id="timerText">30</span> ${t('lSec')}</div>
            <div class="modalHeader">
              <div class="h" id="qHeader">–í–æ–ø—Ä–æ—Å</div>
              <button class="modalClose" id="btnClose">Esc</button>
            </div>
            <div class="modalBody">
              <div class="qText" id="qText"></div>
              <div id="qMedia"></div>
              <div id="answersWrap"></div>
            </div>
          </div>
        </div>

        <div class="screenBackdrop" id="startBack" aria-modal="true" role="dialog">
          <div class="screenCard" id="startCard">
            <div class="screenHeader">
              <div class="h" id="startTitle">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
              <button class="modalClose" id="btnStartClose">–ù–∞—á–∞—Ç—å</button>
            </div>
            <div class="screenBody">
              <div class="screenText" id="startText"></div>
            </div>
            <div class="screenActions">
              <button class="primary" id="btnStart">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
          </div>
        </div>

        <div class="screenBackdrop" id="feedBack" aria-modal="true" role="dialog">
          <div class="screenCard" id="feedCard">
            <div class="screenHeader">
              <div class="h" data-i18n="lGameOver">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</div>
              <button class="modalClose" id="btnFeedClose">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="screenBody">
              <div class="resultList" id="feedResults"></div>
              <div class="help" style="margin-top:12px;">
                <div class="screenText" id="feedExtra"></div>
              </div>
            </div>
            <div class="screenActions">
              <button class="secondary" id="btnFeedRestart" data-i18n="btnRestart">‚Üª –°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('arenaBg').style.backgroundImage = `url("${cfg.bg || '2.png'}")`;
  document.getElementById('gTitle').textContent = cfg.title;
  document.documentElement.style.setProperty('--qFont', cfg.qFont || 'Roboto');
  document.documentElement.style.setProperty('--aFont', cfg.aFont || 'Roboto');
  document.documentElement.style.setProperty('--qaSize', `${cfg.fontSize || 18}px`);

  // Start Screen Styling
  if(cfg.startScreen){
    const col = cfg.startScreen.color || "#ff8a2a";
    document.documentElement.style.setProperty('--screenLine', col + '66');
    document.documentElement.style.setProperty('--screenGlow', cfg.startScreen.neon ? (col + '55') : 'rgba(0,0,0,0)');
  }

  const teamCount = clamp(Number(cfg.teamsCount||2),1,3);
  const teamNames = Array.from({length: teamCount}, (_,i)=>`${t('lTeam')} ${i+1}`);
  const scores = Array.from({length: teamCount}, ()=>0);
  let currentTeam = 0;
  const hit = new Set();
  let activeQIndex = null;
  let countdownId = null;

  function renderTeams(){
    const defaultCols = ['#ff8a2a', '#33d17a', '#ff5b6b'];
    const tEl = document.getElementById('teams');
    tEl.style.gridTemplateColumns = `repeat(${teamCount}, minmax(0,1fr))`;
    tEl.innerHTML = '';
    for(let i=0; i<teamCount; i++){
      const col = (cfg.teamColors && cfg.teamColors[i]) ? cfg.teamColors[i] : defaultCols[i];
      const card = document.createElement('div');
      card.className = 'teamCard';
      if(i === currentTeam) {
        card.style.borderColor = col;
        card.style.boxShadow = `0 0 15px ${col}66`;
      }
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <input class="teamNameInput" value="${teamNames[i]}"/>
          <div class="teamNow"><span class="dot" style="${i===currentTeam ? `background:${col}; border-color:${col}; box-shadow:0 0 0 4px ${col}33;` : ''}"></span></div>
        </div>
        <div class="teamScore">${scores[i]}</div>
      `;
      card.querySelector('input').addEventListener('input', (e)=>{ teamNames[i] = e.target.value; });
      tEl.appendChild(card);
    }
  }

  function renderTargets(){
    const tEl = document.getElementById('targets');
    tEl.innerHTML = '';
    cfg.questions.forEach((q, i) => {
      const el = document.createElement('div');
      el.className = 'target' + (hit.has(i) ? ' hit' : '');
      el.style.left = (q.x ?? 50) + '%';
      el.style.top = (q.y ?? 40) + '%';
      el.style.setProperty('--target-img', `url("${cfg.targetFile || '13.png'}")`);
      el.innerHTML = `<div class="tImg"></div><div class="tNum">${i+1}</div>`;

      // Orbit movement
      if(cfg.targetOrbitRadius > 0 && cfg.targetOrbitSpeed > 0){
        let ang = (i / cfg.questions.length) * Math.PI * 2;
        setInterval(()=>{
          ang += (cfg.targetOrbitSpeed * 0.01);
          const dx = Math.round(Math.cos(ang) * cfg.targetOrbitRadius);
          const dy = Math.round(Math.sin(ang) * cfg.targetOrbitRadius);
          el.style.setProperty('--orbit-x', dx + 'px');
          el.style.setProperty('--orbit-y', dy + 'px');
        }, 60);
      }

      if(isEdit){
        el.classList.add('edit-mode');
        el.onmousedown = (e) => {
          e.preventDefault();
          const rect = document.getElementById('arena').getBoundingClientRect();
          function move(ev){
            let nx = clamp(((ev.clientX - rect.left) / rect.width) * 100, 0, 100);
            let ny = clamp(((ev.clientY - rect.top) / rect.height) * 100, 0, 100);
            el.style.left = nx + '%'; el.style.top = ny + '%';
            window.parent.postMessage({ type: 'updPos', idx: i, x: nx, y: ny }, '*');
          }
          function stop(){ window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); }
          window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
        };
      } else {
        el.onclick = () => {
          if(hit.has(i)) return;
          AudioKit.playVariant(cfg.shot.variant, cfg.shot.volume);
          el.classList.add('hit');
          openQuestion(i);
        };
      }
      tEl.appendChild(el);
    });
  }

  function startTimer(sec){
    let s = sec;
    document.getElementById('timerText').textContent = s;
    document.getElementById('timerBadge').classList.add('on');
    countdownId = setInterval(()=>{
      s--; document.getElementById('timerText').textContent = s;
      if(s <= 0){ clearInterval(countdownId); finalizeQuestion(false); }
    }, 1000);
  }

  function openQuestion(i){
    activeQIndex = i;
    const q = cfg.questions[i];
    document.getElementById('qHeader').textContent = `–í–æ–ø—Ä–æ—Å #${i+1}`;
    document.getElementById('qText').textContent = q.text || '';
    
    // Image handling
    const mediaWrap = document.getElementById('qMedia');
    mediaWrap.innerHTML = '';
    if(q.image){
      mediaWrap.innerHTML = `<div class="qImg"><img src="${q.image}"></div>`;
    }

    const ansWrap = document.getElementById('answersWrap');
    ansWrap.innerHTML = '';

    if(q.type === 'input'){
      ansWrap.innerHTML = `<div class="inputRow"><input type="text" id="ansInp" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." autocomplete="off"/><button class="primary" id="btnSend">OK</button></div>`;
      const check = () => {
        const user = document.getElementById('ansInp').value.trim().toLowerCase();
        const cor = (q.correct||'').trim().toLowerCase();
        finalizeQuestion(user === cor && user.length > 0);
      };
      document.getElementById('btnSend').onclick = check;
      document.getElementById('ansInp').onkeydown = (e) => { if(e.key==='Enter') check(); };
    } else {
      const grid = document.createElement('div');
      grid.className = 'answers';
      (q.options||[]).forEach((opt, idx) => {
        const b = document.createElement('button');
        b.className = 'ansBtn'; b.innerHTML = `<div class="ansKey">${idx+1}</div><div class="ansText">${opt.text}</div>`;
        b.onclick = () => finalizeQuestion(!!opt.correct);
        grid.appendChild(b);
      });
      ansWrap.appendChild(grid);
    }

    document.getElementById('modalBack').classList.add('on');
    if(q.timerEnabled && q.timerSeconds > 0) startTimer(q.timerSeconds);
  }

  function finalizeQuestion(isCorrect){
    if(activeQIndex === null) return;
    if(countdownId){ clearInterval(countdownId); countdownId = null; }
    document.getElementById('timerBadge').classList.remove('on');
    document.getElementById('modalBack').classList.remove('on');

    if(!hit.has(activeQIndex)){
      hit.add(activeQIndex);
      if(isCorrect) scores[currentTeam] += Number(cfg.questions[activeQIndex].points || 10);
    }
    
    if(cfg.autoNextTeam) currentTeam = (currentTeam + 1) % teamCount;
    renderTeams();

    if(hit.size >= cfg.questions.length && cfg.feedbackScreen?.enabled) {
      setTimeout(showFeedback, 500);
    }
  }

  function showStartScreen(){
    if(!cfg.startScreen?.enabled) return;
    document.getElementById('startText').textContent = cfg.startScreen.text || '';
    document.getElementById('startBack').classList.add('on');
  }
  document.getElementById('btnStart').onclick = () => document.getElementById('startBack').classList.remove('on');
  document.getElementById('btnStartClose').onclick = () => document.getElementById('startBack').classList.remove('on');

  function showFeedback(){
    const r = document.getElementById('feedResults');
    r.innerHTML = '';
    for(let i=0; i<teamCount; i++){
      r.innerHTML += `<div class="resultRow"><div class="name">${teamNames[i]}</div><div class="score">${scores[i]}</div></div>`;
    }
    document.getElementById('feedExtra').textContent = cfg.feedbackScreen?.extraText || '';
    document.getElementById('feedBack').classList.add('on');
  }
  document.getElementById('btnFeedClose').onclick = () => document.getElementById('feedBack').classList.remove('on');
  document.getElementById('btnFeedRestart').onclick = () => location.reload();
  
  document.getElementById('btnReset').onclick = () => {
    hit.clear(); scores.fill(0); currentTeam=0; renderTeams(); renderTargets();
  };
  document.getElementById('btnClose').onclick = () => finalizeQuestion(false);

  renderTeams();
  renderTargets();
  if(!isEdit) showStartScreen();
}

/* ===========================
   EDITOR MODE
   =========================== */
function mountEditor(){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="app">
      <div class="panel">
        <div class="panelHeader">
          <div><div class="title" data-i18n="edTitle">–†–µ–¥–∞–∫—Ç–æ—Ä</div></div>
          <button class="btn btnGold" id="copyIframe" data-i18n="btnCopy">üìã –ö–æ–¥</button>
        </div>
        <div class="scroll">
          <div class="section">
            <div class="split"><label data-i18n="sLang">–Ø–∑—ã–∫</label><select id="selLang" style="width:auto;"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="en">English</option><option value="de">Deutsch</option><option value="zh">‰∏≠Êñá</option></select></div>
          </div>
          <div class="section"><h3 data-i18n="sName">–ù–∞–∑–≤–∞–Ω–∏–µ</h3><input id="inpTitle" type="text" value=""/></div>
          <div class="section">
            <h3 data-i18n="sDesign">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
            <div class="row">
              <div><label data-i18n="lBg">–§–æ–Ω</label><input id="inpBg" type="text" value=""/></div>
              <div><label data-i18n="lTarget">–ú–∏—à–µ–Ω—å</label><input id="inpTarget" type="text" value=""/></div>
            </div>
            <div class="row" style="margin-top:10px;">
              <div><label data-i18n="lRadius">–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpRadius" min="0" max="250" value="0"/></div>
              <div><label data-i18n="lSpeed">–°–∫–æ—Ä–æ—Å—Ç—å</label><input type="range" id="inpSpeed" min="0" max="10" value="0"/></div>
            </div>
          </div>
          <div class="section">
            <h3 data-i18n="sGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="row">
              <div>
                <label data-i18n="lTeams">–ö–æ–º–∞–Ω–¥</label>
                <select id="inpTeams"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
              </div>
              <div>
                <label data-i18n="lSound">–ó–≤—É–∫</label>
                <select id="inpSound"><option value="pif">–ü–∏—Ñ</option><option value="snap">–©–µ–ª—á–æ–∫</option><option value="boom">–ë—É–º</option></select>
              </div>
            </div>
            <div class="row1" style="margin-top:8px;">
              <label data-i18n="lTeamColors">–¶–≤–µ—Ç–∞ –∫–æ–º–∞–Ω–¥</label>
              <div id="teamColorsWrap" style="display:flex; gap:10px;"></div>
            </div>
          </div>
          <div class="section">
            <h3 data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</h3>
            <textarea id="inpStartText"></textarea>
            <div class="row" style="margin-top:8px;">
              <div><input type="color" id="inpStartColor"/></div>
              <div><label><input type="checkbox" id="chkStartGlow"/> <span data-i18n="lGlow">–°–≤–µ—á–µ–Ω–∏–µ</span></label></div>
            </div>
          </div>
          <div class="section">
            <h3 data-i18n="sEnd">–§–∏–¥–±–µ–∫</h3>
            <textarea id="inpFeedText"></textarea>
          </div>
          <div class="section">
            <div class="split"><h3 style="margin:0" data-i18n="sQ">–í–æ–ø—Ä–æ—Å—ã</h3><span class="pill"><span data-i18n="lTotal">–í—Å–µ–≥–æ:</span> <span id="qCount">0</span></span></div>
            <div class="btnRow">
              <button class="btn btnGold" id="btnAddQ" data-i18n="btnAdd">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btnDanger" id="btnClearQ" data-i18n="btnClr">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div style="font-size:11px; color:var(--neon-orange-base); margin-top:8px;" data-i18n="lDragHint">üí° –î–≤–∏–≥–∞–π—Ç–µ –º–∏—à–µ–Ω–∏ –ø—Ä—è–º–æ –≤ –ø—Ä–µ–≤—å—é —Å–ø—Ä–∞–≤–∞!</div>
            <div id="qList" class="qList" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
      <div class="previewWrap">
        <div class="previewHeader"><div><div class="title2" data-i18n="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div><div class="muted" data-i18n="previewHint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é</div></div></div>
        <iframe class="previewFrame" id="previewFrame"></iframe>
      </div>
    </div>

    <div class="modalBackdrop" id="editBack">
      <div class="modal">
        <div class="modalHeader"><div class="h" id="editHdr" data-i18n="mTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</div><button class="modalClose" id="editClose">‚úñ</button></div>
        <div class="modalBody">
          <div class="row">
            <div><label data-i18n="lQType">–¢–∏–ø</label><select id="editType"><option value="choice" data-i18n="oChoice">–í—ã–±–æ—Ä</option><option value="input" data-i18n="oInput">–í–≤–æ–¥</option></select></div>
            <div><label data-i18n="lPts">–û—á–∫–∏</label><input type="number" id="editPts" value="10"/></div>
          </div>
          <div class="row">
            <div><label data-i18n="lTimer">–¢–∞–π–º–µ—Ä</label><select id="editTimerMode"><option value="off">–í—ã–∫–ª</option><option value="on">–í–∫–ª</option></select></div>
            <div><label data-i18n="lSec">–°–µ–∫—É–Ω–¥—ã</label><input type="number" id="editTimerSec" value="30"/></div>
          </div>
          <div class="row1"><div><label data-i18n="lQText">–í–æ–ø—Ä–æ—Å</label><textarea id="editText"></textarea></div></div>
          <div class="row1"><div><label data-i18n="lImg">–ö–∞—Ä—Ç–∏–Ω–∫–∞</label><input type="text" id="editImg"/></div></div>
          
          <div id="choiceBox" class="section" style="margin-top:10px;">
            <div class="title" data-i18n="lAnsOpts">–í–∞—Ä–∏–∞–Ω—Ç—ã</div>
            <div id="optList" class="qList"></div>
            <button class="btn btnGold" id="btnAddOpt" style="margin-top:10px;" data-i18n="btnAddOpt">Ôºã –í–∞—Ä–∏–∞–Ω—Ç</button>
          </div>
          
          <div id="inputBox" class="section" style="display:none; margin-top:10px;">
            <div class="title" data-i18n="lRightAns">–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
            <input type="text" id="editCorrect"/>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px;"><button class="secondary" id="btnCancelQ" data-i18n="btnCancel">–û—Ç–º–µ–Ω–∞</button><button class="primary" id="btnSaveQ" data-i18n="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
      </div>
    </div>
  `;

  let cfg = defaultCfg();
  let editingIdx = null;

  // Sync inputs
  const $i = id => document.getElementById(id);
  $i('selLang').onchange = (e) => { currentLang = e.target.value; applyLang(); updatePreview(); };
  
  function renderTeamColors(){
    const c = parseInt($i('inpTeams').value);
    const wrap = $i('teamColorsWrap');
    wrap.innerHTML = '';
    for(let i=0; i<c; i++){
      const col = cfg.teamColors[i] || ['#ffae00', '#33d17a', '#ff5b6b'][i];
      wrap.innerHTML += `<input type="color" id="tc_${i}" value="${col}" style="width:36px; height:36px; padding:2px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:transparent; cursor:pointer;">`;
    }
    for(let i=0; i<c; i++){
      $i(`tc_${i}`).oninput = (e) => { cfg.teamColors[i] = e.target.value; updatePreview(); };
    }
  }

  function updatePreview(){
    cfg.title = $i('inpTitle').value;
    cfg.bg = $i('inpBg').value;
    cfg.targetFile = $i('inpTarget').value;
    cfg.targetOrbitRadius = Number($i('inpRadius').value);
    cfg.targetOrbitSpeed = Number($i('inpSpeed').value);
    cfg.teamsCount = Number($i('inpTeams').value);
    cfg.shot.variant = $i('inpSound').value;
    cfg.startScreen.text = $i('inpStartText').value;
    cfg.startScreen.color = $i('inpStartColor').value;
    cfg.startScreen.neon = $i('chkStartGlow').checked;
    cfg.feedbackScreen.extraText = $i('inpFeedText').value;
    
    const src = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&edit=1&lang=${currentLang}`;
    $i('previewFrame').src = src;
    renderQuestionList();
  }

  $i('inpTeams').addEventListener('change', () => { renderTeamColors(); updatePreview(); });
  ['inpTitle','inpBg','inpTarget','inpRadius','inpSpeed','inpSound','inpStartText','inpStartColor','chkStartGlow','inpFeedText'].forEach(id=>{
    $i(id).addEventListener('input', updatePreview); $i(id).addEventListener('change', updatePreview);
  });

  window.renderQuestionList = () => {
    $i('qCount').textContent = cfg.questions.length;
    $i('qList').innerHTML = cfg.questions.map((q, i) => `
      <div class="qItem">
        <div style="flex:1;"><b>#${i+1}</b> ${q.text.slice(0,20)}... <div class="qMeta">${q.type==='input' ? t('oInput') : t('oChoice')}</div></div>
        <div style="display:flex; gap:8px;"><button class="iconBtn" onclick="openEditQ(${i})">‚öôÔ∏è</button><button class="iconBtn danger" onclick="delQ(${i})">üóëÔ∏è</button></div>
      </div>
    `).join('');
  };
  window.delQ = (i) => { cfg.questions.splice(i,1); updatePreview(); };

  window.openEditQ = (i) => {
    editingIdx = i;
    const q = cfg.questions[i];
    $i('editType').value = q.type; $i('editPts').value = q.points||10;
    $i('editTimerMode').value = q.timerEnabled ? 'on' : 'off'; $i('editTimerSec').value = q.timerSeconds||30;
    $i('editText').value = q.text||''; $i('editImg').value = q.image||'';
    if(q.type === 'input') $i('editCorrect').value = q.correct||'';
    else renderOptEditor(q.options||[]);
    syncType();
    $i('editBack').classList.add('on');
  };

  function syncType(){
    const isInput = ($i('editType').value === 'input');
    $i('inputBox').style.display = isInput ? 'block' : 'none';
    $i('choiceBox').style.display = isInput ? 'none' : 'block';
  }
  $i('editType').addEventListener('change', syncType);

  function renderOptEditor(opts){
    $i('optList').innerHTML = opts.map((o, i) => `
      <div class="qItem" style="margin-bottom:6px;">
        <input type="checkbox" style="width:20px;height:20px;" ${o.correct?'checked':''} onchange="cfg.questions[${editingIdx}].options[${i}].correct = this.checked">
        <input type="text" style="flex:1;" value="${o.text}" oninput="cfg.questions[${editingIdx}].options[${i}].text = this.value">
        <button class="iconBtn danger" onclick="cfg.questions[${editingIdx}].options.splice(${i},1); openEditQ(${editingIdx});">‚úñ</button>
      </div>
    `).join('');
  }
  $i('btnAddOpt').onclick = () => { cfg.questions[editingIdx].options.push({text:'–í–∞—Ä–∏–∞–Ω—Ç', correct:false}); openEditQ(editingIdx); };
  
  $i('btnSaveQ').onclick = () => {
    const q = cfg.questions[editingIdx];
    q.type = $i('editType').value; q.points = Number($i('editPts').value);
    q.timerEnabled = ($i('editTimerMode').value === 'on'); q.timerSeconds = Number($i('editTimerSec').value);
    q.text = $i('editText').value; q.image = $i('editImg').value;
    if(q.type === 'input') q.correct = $i('editCorrect').value;
    $i('editBack').classList.remove('on'); updatePreview();
  };
  $i('editClose').onclick = () => $i('editBack').classList.remove('on');
  $i('btnCancelQ').onclick = () => $i('editBack').classList.remove('on');

  $i('btnAddQ').onclick = () => {
    cfg.questions.push({ type:'choice', text:'–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å', points:10, timerEnabled:false, timerSeconds:30, image:'', options:[{text:'–î–∞', correct:true},{text:'–ù–µ—Ç', correct:false}] });
    updatePreview(); openEditQ(cfg.questions.length - 1);
  };
  $i('btnClearQ').onclick = () => { cfg.questions = []; updatePreview(); };

  $i('copyIframe').onclick = () => {
    const url = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}`;
    navigator.clipboard.writeText(`<iframe src="${url}" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`).then(()=>alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
  };

  window.addEventListener('message', e => {
    if(e.data && e.data.type === 'updPos') {
      const q = cfg.questions[e.data.idx];
      if(q) { q.x = Math.round(e.data.x*10)/10; q.y = Math.round(e.data.y*10)/10; }
    }
  });

  // Init UI
  $i('inpTitle').value = cfg.title; $i('inpBg').value = cfg.bg; $i('inpTarget').value = cfg.targetFile;
  $i('inpTeams').value = cfg.teamsCount; $i('inpSound').value = cfg.shot.variant;
  $i('inpStartText').value = cfg.startScreen.text; $i('inpStartColor').value = cfg.startScreen.color; $i('chkStartGlow').checked = cfg.startScreen.neon;
  $i('inpFeedText').value = cfg.feedbackScreen.extraText;
  
  renderTeamColors();
  applyLang();
  updatePreview();
}

if(isGame){
  let cfg = defaultCfg();
  try { cfg = b64uDecode(params.get('game')); } catch(e){}
  if(params.get('lang')) { currentLang = params.get('lang'); applyLang(); }
  mountGame(cfg);
} else {
  mountEditor();
}
</script>
</body>
</html>
