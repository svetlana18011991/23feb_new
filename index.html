<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Математический тир — editor+game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=vAQSnmqvoU-az3uCUc5dGt1sVy4idcF5Sf6b_2pIWTrOZFbOdb1x03qCvkjdGE6-GYqCoRxkzSIsximsveC936ky_P3oUGlC2LwIrmK7cmRUXRTf7xBUziu9rTbRBYuMeF2_YEihzxw7WFYYru6tuC-o9RMU_cPFszq9NJj1_otMYtU4jBkwtWN2Pm4Sf9mZOK3ytdkHMLVHGgBMqFbw8ohY8mifQ0t6jf-ylsXj7kse4fsJFTEzPbhXczYZTgq6sQLte1SXq9HZ_bmHy4OJxg" charset="UTF-8"></script><style>
    :root{
      --bg0:#0b0f14;
      --card:rgba(20,28,38,.72);
      --card2:rgba(15,22,30,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.70);
      --gold: #caa24d;
      --gold2:#f1d089;
      --neon:#ff8a2a;
      --neon2:#ffb24d;
      --neonSoft: rgba(255,138,42,.18);
      --neonLine: rgba(255,138,42,.38);
      --danger:#ff5b6b;
      --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55);
      --r:18px;
      --qFont:'Roboto';
      --aFont:'Roboto';
      --qaSize:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%),
                  radial-gradient(900px 520px at 70% 18%, rgba(255,190,90,.08), transparent 60%),
                  linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Layout (editor) ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 480px 1fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100%;}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--neonLine);
      border-radius: 22px;
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.20), 0 0 26px var(--neonSoft);
      overflow:hidden;
      position:relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0; /* важно для скролла внутри flex */
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 100% 0%, rgba(255,215,120,.07), transparent 65%),
                  repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 2px, transparent 2px 12px);
      opacity:.35;
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:1}

    .panel:hover{
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,138,42,.32), 0 0 34px rgba(255,138,42,.20);
    }
    .section:hover{
      border-color: rgba(255,138,42,.42);
      box-shadow: 0 0 0 1px rgba(255,138,42,.18), 0 0 26px rgba(255,138,42,.14);
    }
    

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:800;
      font-size:22px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .btn{
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.13);
      background: rgba(25,35,46,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(30,43,58,.68); border-color: rgba(255,255,255,.18)}
    .btn:active{ transform: translateY(1px) }
    .btnGold{
      background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13));
      border-color: rgba(202,162,77,.45);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,91,107,.24), rgba(255,91,107,.12));
      border-color: rgba(255,91,107,.38);
    }

    .scroll{
      flex: 1;
      min-height: 0;
      overflow:auto;
      padding: 14px 18px 18px 18px;
    }
    .section{
      background: rgba(10,14,20,.22);
      border: 1px solid rgba(255,138,42,.28);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 18px rgba(255,138,42,.10);

    }
    .section h3{
      margin:0 0 10px 0;
      font-size:14px;
      color: rgba(255,255,255,.92);
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      outline:none;
      background: rgba(10,14,18,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{min-height: 84px; resize: vertical;}
    /* ====== Beautify form layout ====== */
    .section .row, .section .row1{ margin-top: 10px; }
    .section .row > div,
    .section .row1 > div{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,0));
      border:1px solid rgba(255,138,42,.22);
      border-radius: 16px;
      padding: 12px 12px 10px 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 0 14px rgba(255,138,42,.08);
      min-width: 0;
    }
    .section .row > div:hover,
    .section .row1 > div:hover{
      border-color: rgba(255,138,42,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 0 18px rgba(255,138,42,.12);
    }
    .section label{ margin-bottom: 7px; font-size: 12.5px; letter-spacing: .15px; }
    input[type="text"], input[type="number"], select, textarea{
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{
      border-color: rgba(255,138,42,.55);
      box-shadow: 0 0 0 3px rgba(255,138,42,.16);
      background: rgba(10,14,18,.68);
    }
    select{
      appearance:none;
      padding-right: 38px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(232,238,247,.75) 50%),
        linear-gradient(135deg, rgba(232,238,247,.75) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 55%,
        calc(100% - 12px) 55%;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    .help{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.35);
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .qItem{
      border-color: rgba(255,138,42,.18);
    }
    .qItem:hover{
      border-color: rgba(255,138,42,.36);
      box-shadow: 0 0 0 1px rgba(255,138,42,.12), 0 0 16px rgba(255,138,42,.10);
    }

    input[type="number"]{appearance:textfield}
    .help{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,238,247,.62);
      line-height:1.25;
    }
    .split{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }
    .qList{display:flex; flex-direction:column; gap:10px;}
    .qItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.48);
      align-items:center;
    }
    .qTitle{
      font-weight:700;
      font-size:13px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }
    .qMeta{
      font-size:12px;
      color: rgba(232,238,247,.62);
    }
    .iconBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(25,35,46,.45);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ background: rgba(25,35,46,.65) }
    .iconBtn.danger{ border-color: rgba(255,91,107,.45); background: rgba(255,91,107,.12)}
    .iconBtn.danger:hover{ background: rgba(255,91,107,.18)}
    .soundRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .range{
      width:100%;
      accent-color: #2aa6ff;
    }

    /* ====== Preview ====== */
    .previewWrap{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .previewHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .previewHeader .title2{
      font-weight:800;
      font-size:18px;
    }
    .previewHeader .muted{
      font-size:12px; color:var(--muted);
    }
    .previewFrame{
      flex:1;
      min-height: 420px;
      border:0;
      width:100%;
      background: transparent;
    }

    /* ====== Version badge ====== */
    .versionBadge{
      display:none !important;
      position:fixed;
      right:14px; bottom:14px;
      z-index:50;
      font-size:12px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      pointer-events:none;
    }

    /* ====== GAME MODE ====== */
    .gameRoot{
      position:fixed;
      inset:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#000;
    }
    .arena{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      margin: 16px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background: #0b0f14;
    }

    /* Background image (non-transparent) */
    .arenaBg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      transform: scale(1.06);
      filter: saturate(1.05) contrast(1.03) brightness(1.02);
    }
    .arenaBg::after{
      /* cinematic + depth */
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,230,160,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 25%, rgba(100,180,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .arenaBg3d{
      /* subtle parallax */
      will-change: transform;
      transition: transform .08s linear;
    }

    .hud{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudLeft{
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      min-width: 260px;
      max-width: 460px;
    }
    .gameTitle{
      font-weight:900;
      font-size:22px;
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .gameHint{
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .hudRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pillBtn{
      pointer-events:auto;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-weight:650;
      font-size:13px;
      cursor:pointer;
    }
    .pillBtn:hover{ background: rgba(0,0,0,.40) }
    .hudStat{
      pointer-events:none;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      font-weight:650;
      font-size:13px;
    }

    /* Team bars */
    .teams{
      position:absolute;
      top:78px; left:14px; right:14px;
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      pointer-events:none;
    }
    .teamCard{
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      padding:10px 10px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
    }
    .teamNameInput{
      pointer-events:auto;
      width: 100%;
      max-width: 220px;
      font-weight:800;
      font-size:14px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      outline:none;
    }
    .teamNameInput:focus{ border-color: rgba(202,162,77,.50); box-shadow: 0 0 0 3px rgba(202,162,77,.12); }
    .teamScore{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.95);
      min-width: 40px;
      text-align:right;
    }
    .teamNow{
      display:flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.78);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.24);
      border: 1px solid rgba(255,255,255,.25);
    }
    .dot.on{ background: rgba(202,162,77,.95); border-color: rgba(202,162,77,.95); box-shadow: 0 0 0 4px rgba(202,162,77,.16); }

    /* Targets */
    .targets{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .target{
      position:absolute;
      width: 92px;
      height: 92px;
      border-radius: 999px;
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px));
      /* fallback if image missing */
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(240,200,120,.18), transparent 65%),
        rgba(0,0,0,.20);
      box-shadow:
        0 12px 30px rgba(0,0,0,.50),
        0 0 0 2px rgba(240,200,120,.16) inset,
        0 0 22px rgba(240,200,120,.18);
      backdrop-filter: blur(2px);
    }
    .target .tImg{
      position:absolute;
      inset:-10px;
      border-radius: 999px;
      background-image: var(--target-img);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
      animation: targetFloat 2.8s ease-in-out infinite;
      animation-delay: var(--float-delay, 0s);
      transform-origin: 50% 60%;
    }
    .target .tNum{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:22px;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      letter-spacing:.5px;
    }
    .target .tPts{
      position:absolute;
      left:50%;
      bottom:-18px;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight:700;
      color: rgba(240,200,120,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap;
      pointer-events:none;
    }
    
    .target.draggable{ cursor: grab; }
    .target.draggable:active{ cursor: grabbing; }
.target.hit{ opacity:.25; filter: grayscale(1); }
    @keyframes targetFloat{
      0%{ transform: translateY(0px) scale(1); }
      50%{ transform: translateY(-7px) scale(1.02); }
      100%{ transform: translateY(0px) scale(1); }
    }
    .target:hover{ transform: translate(-50%,-50%) scale(1.05); }
    .target.hit{
      opacity:.38;
      filter: grayscale(1) brightness(.9);
      pointer-events:none;
    }
    .tNum{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 25px rgba(0,0,0,.65);
    }
    .tPts{
      position:absolute;
      bottom:-10px;
      left:50%;
      transform: translateX(-50%);
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.40);
      background: rgba(0,0,0,.35);
      color: rgba(255,232,190,.95);
      font-weight:800;
      font-size:11px;
      white-space:nowrap;
    }

    /* Modal (game question) */
    .modalBackdrop{
      position:absolute;
      inset:0;
      /* darker + soft orange aura */
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,138,42,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 15%, rgba(255,178,77,.10), transparent 62%),
        rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 40;
    }
    .modalBackdrop.on{ display:flex; }
    .modalBackdrop.on .modal{ animation: modalPop .18s ease-out; }
    @keyframes modalPop{
      from{ transform: translateY(10px) scale(.985); opacity:.0;}
      to{ transform: translateY(0) scale(1); opacity:1;}
    }
    .modal{
      width: min(980px, 96vw);
      border-radius: 22px;
      border:1px solid var(--neonLine);
      background:
        radial-gradient(800px 420px at 22% 8%, rgba(255,138,42,.10), transparent 55%),
        linear-gradient(180deg, rgba(10,13,18,.94), rgba(6,8,10,.90));
      box-shadow:
        0 28px 110px rgba(0,0,0,.78),
        0 0 0 1px rgba(255,138,42,.18),
        0 0 46px rgba(255,138,42,.18);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 36px);
      backdrop-filter: blur(8px);
    }
    .modal::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 24px;
      pointer-events:none;
      background: linear-gradient(135deg, rgba(255,138,42,.35), rgba(255,178,77,.10), rgba(255,138,42,.26));
      filter: blur(14px);
      opacity:.55;
    }
    .modal::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 22px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,138,42,.22), inset 0 0 34px rgba(255,138,42,.10);
    }
    .modal > *{ position:relative; }
    .modalHeader{
      padding: 14px 16px;
      background: linear-gradient(90deg, rgba(255,138,42,.18), rgba(255,138,42,.06) 40%, rgba(255,138,42,0));
      border-bottom:1px solid rgba(255,138,42,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader .h{
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }
    .modalClose{
      border-radius: 14px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .modalClose:hover{
      border-color: rgba(255,138,42,.40);
      background: rgba(255,138,42,.10);
      box-shadow: 0 0 0 1px rgba(255,138,42,.18), 0 0 18px rgba(255,138,42,.20);
    }
    .modalClose:focus-visible{
      outline:none;
      box-shadow: 0 0 0 2px rgba(255,138,42,.32), 0 0 22px rgba(255,138,42,.22);
    }
    .modalBody{
      padding: 16px;
      display:grid;
      gap:12px;
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .qText{
      font-weight:900;
      font-size: var(--qaSize);
      line-height:1.2;
      font-family: var(--qFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .mediaRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: rgba(255,255,255,.8);
      font-size:12px;
    }
    .mediaTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .answers{grid-template-columns:1fr}
    }
    .ansBtn{
      text-align:left;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      position:relative;
      display:flex;
      gap:12px;
      align-items:flex-start;
      font-size: var(--qaSize);
      font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .ansBtn.selected{
      border-color: rgba(51,209,122,.65) !important;
      box-shadow: 0 0 0 2px rgba(51,209,122,.20), 0 0 26px rgba(51,209,122,.14);
      background: rgba(51,209,122,.10);
    }

    .ansBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16);}
    .ansKey{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.50);
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,232,190,.95);
      flex:0 0 auto;
    }
    .ansText{ font-weight:700; line-height:1.25; font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputRow input{
      flex:1;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:700;
      outline:none;
      font-family: var(--aFont), system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .primary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(202,162,77,.55);
      background: rgba(202,162,77,.18);
      color: rgba(255,245,225,.95);
      font-weight:900;
      cursor:pointer;
    }
    .secondary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:800;
      cursor:pointer;
    }

    /* Timer badge top-center */
    .timerBadge{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,166,60,.55);
      background: rgba(255,166,60,.12);
      color: rgba(255,230,190,.95);
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      display:none;
      align-items:center;
      gap:10px;
    }
    .timerBadge.on{
      display:flex;
      animation: pulseOrange 1.6s ease-in-out infinite;
    }
    @keyframes pulseOrange{
      0%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      35%{ box-shadow: 0 0 0 10px rgba(255,166,60,.14) }
      70%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      100%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
    }

    /* Small toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 60;
      font-weight:700;
      font-size:13px;
    }
    .toast.on{ display:block; }
  
/* --- Cursor: crosshair inside game/preview --- */
#previewFrame { cursor: crosshair; }
body[data-mode="game"] .gameRoot,
body[data-mode="game"] .gameRoot * { cursor: crosshair; }
body[data-mode="game"] .gameRoot input,
body[data-mode="game"] .gameRoot textarea { cursor: text; }
body[data-mode="game"] .gameRoot a { cursor: pointer; }


/* ==== Custom crosshair (works inside Genially overlays) ==== */
body.game-cursor { cursor: none !important; }
#aimCursor{
  position: fixed;
  left: -100px;
  top: -100px;
  width: 54px;
  height: 54px;
  transform: translate(-50%,-50%);
  pointer-events: none;
  z-index: 2147483647;
  opacity: 0;
  transition: opacity .12s ease;
}
#aimCursor .ring{
  position:absolute; inset:0;
  border: 2px solid rgba(255,190,90,.9);
  border-radius: 999px;
  box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 16px rgba(255,170,60,.18);
  background: radial-gradient(circle at 50% 50%, rgba(255,190,90,.08), transparent 60%);
}
#aimCursor .h, #aimCursor .v{
  position:absolute;
  left:50%; top:50%;
  background: rgba(255,190,90,.95);
  box-shadow: 0 0 10px rgba(255,170,60,.25);
}
#aimCursor .h{ width: 64px; height: 2px; transform: translate(-50%,-50%); }
#aimCursor .v{ width: 2px; height: 64px; transform: translate(-50%,-50%); }
#aimCursor .dot{
  position:absolute; left:50%; top:50%;
  width: 6px; height: 6px;
  border-radius: 999px;
  transform: translate(-50%,-50%);
  background: rgba(255,190,90,.95);
}


.cornerLogo{position:fixed;top:14px;right:14px;z-index:1000;width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));opacity:.95;pointer-events:none;}

/* v27 tweaks */
.topBrand{position:fixed;left:18px;top:14px;z-index:9999;pointer-events:none;opacity:.98;filter:drop-shadow(0 10px 24px rgba(0,0,0,.55));display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:14px;background:linear-gradient(180deg, rgba(18,24,33,.58), rgba(10,12,16,.35));border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(8px);}
    .modeGame .topBrand{ display:none; }
.topBrand img{height:34px;width:auto;border-radius:10px;display:block;}
.topBrand span{font-weight:800;font-size:13px;letter-spacing:.2px;color:rgba(255,255,255,.92);text-shadow:0 8px 22px rgba(0,0,0,.55);}
/* stronger 3D/parallax background */
.arenaBg{will-change:transform,filter;transform:translate3d(var(--bgx,0px),var(--bgy,0px),0) scale(1.10);filter:saturate(1.05) contrast(1.08);}
.arenaBg::after{content:"";position:absolute;inset:0;background:radial-gradient(1200px 600px at 40% 35%, rgba(255,255,255,.10), rgba(0,0,0,.45) 65%, rgba(0,0,0,.70));mix-blend-mode:overlay;pointer-events:none;}
.hudGoals{animation:goalFloat 3.8s ease-in-out infinite;}
@keyframes goalFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}


    /* Hit FX */
    .hitFx{
      position:absolute;
      width: 2px;
      height: 2px;
      transform: translate(-50%,-50%);
      pointer-events:none;
      mix-blend-mode: screen;
      animation: hitFxFade .52s ease-out forwards;
    }
    @keyframes hitFxFade{
      0%{ opacity:1; }
      100%{ opacity:0; }
    }
    .hitFx .hitCore{
      position:absolute;
      left:0; top:0;
      width: 10px; height: 10px;
      border-radius: 999px;
      transform: translate(-50%,-50%);
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,200,80,.55) 45%, rgba(255,120,0,.0) 72%);
      filter: drop-shadow(0 0 10px rgba(255,140,0,.6));
      animation: hitCore .52s ease-out forwards;
    }
    @keyframes hitCore{
      0%{ transform: translate(-50%,-50%) scale(.9); opacity:1; }
      60%{ transform: translate(-50%,-50%) scale(1.3); opacity:.95; }
      100%{ transform: translate(-50%,-50%) scale(1.8); opacity:0; }
    }
    .hitFx .hitRing{
      position:absolute;
      left:0; top:0;
      width: 16px; height: 16px;
      border-radius: 999px;
      transform: translate(-50%,-50%) scale(.4);
      border: 2px solid rgba(255,255,255,.85);
      box-shadow: 0 0 22px rgba(255,140,0,.45);
      animation: hitRingA .52s ease-out forwards;
    }
    .hitFx .hitRing.r2{
      width: 24px; height: 24px;
      border-color: rgba(255,180,80,.70);
      animation-name: hitRingB;
    }
    @keyframes hitRingA{
      0%{ transform: translate(-50%,-50%) scale(.35); opacity:.95; }
      100%{ transform: translate(-50%,-50%) scale(3.1); opacity:0; }
    }
    @keyframes hitRingB{
      0%{ transform: translate(-50%,-50%) scale(.25); opacity:.85; }
      100%{ transform: translate(-50%,-50%) scale(2.4); opacity:0; }
    }
    .hitFx .hitSparks{
      position:absolute;
      left:0; top:0;
      width: 1px; height: 1px;
      transform: translate(-50%,-50%);
    }
    .hitFx .hitSparks .sp{
      position:absolute;
      left:0; top:0;
      width: 4px; height: 14px;
      border-radius: 6px;
      transform: rotate(var(--a)) translateY(-8px);
      transform-origin: 0 0;
      background: linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,160,40,.75), rgba(255,120,0,0));
      filter: drop-shadow(0 0 10px rgba(255,140,0,.55));
      animation: spark .52s ease-out forwards;
    }
    @keyframes spark{
      0%{ opacity:1; transform: rotate(var(--a)) translateY(-6px) scaleY(.75); }
      100%{ opacity:0; transform: rotate(var(--a)) translateY(-46px) scaleY(1.1); }
    }
      100% { transform: translate(-50%,-50%) scale(2.6); opacity:0; }
    }

    .target.punch{
      animation: punch .14s ease-out;
    }
    @keyframes punch{
      0%   { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1); }
      60%  { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1.10); }
      100% { transform: translate(-50%,-50%) translate(var(--orbit-x,0px), var(--orbit-y,0px)) scale(1); }
    }

    /* When question is taken (hit), hide it completely */
    .target.hit{
      opacity: 0;
      transform: translate(-50%,-50%) scale(.2);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }

    /* Camera shake (very subtle) */
    .arena.shakeHit{ animation: shakeHit .12s linear; }
    .arena.shakeMiss{ animation: shakeMiss .14s linear; }
    @keyframes shakeHit{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(0.8px,-0.6px); }
      50%{ transform: translate(-0.7px,0.6px); }
      75%{ transform: translate(0.6px,0.5px); }
      100%{ transform: translate(0,0); }
    }
    @keyframes shakeMiss{
      0%{ transform: translate(0,0); }
      20%{ transform: translate(1.2px,0.2px); }
      40%{ transform: translate(-1.0px,-0.3px); }
      60%{ transform: translate(0.8px,0.3px); }
      80%{ transform: translate(-0.6px,-0.2px); }
      100%{ transform: translate(0,0); }
    }

    /* Modal image */
    .qImg{
      margin-top: 10px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .qImg img{
      display:block;
      width:100%;
      height:auto;
      max-height: 46vh;
      object-fit: contain;
      background: rgba(0,0,0,.15);
    }

  

    /* ====== Start / Feedback screens ====== */
    .screenBackdrop{
      position:absolute;
      inset:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,138,42,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 15%, rgba(255,178,77,.10), transparent 62%),
        rgba(0,0,0,.66);
      backdrop-filter: blur(12px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 70;
    }
    .screenBackdrop.on{ display:flex; }

    .screenCard{
      width: min(980px, 96vw);
      border-radius: 22px;
      border: 1px solid var(--screenLine, rgba(255,138,42,.38));
      background:
        radial-gradient(800px 420px at 22% 8%, rgba(255,138,42,.10), transparent 55%),
        linear-gradient(180deg, rgba(10,13,18,.94), rgba(6,8,10,.90));
      box-shadow:
        0 28px 110px rgba(0,0,0,.78),
        0 0 0 1px rgba(255,138,42,.18),
        0 0 46px var(--screenGlow, rgba(255,138,42,.18));
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 36px);
    }
    .screenCard::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 22px;
      pointer-events:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .screenHeader{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .screenHeader .h{
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }
    .screenBody{
      padding: 16px;
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .screenText{
      white-space:pre-wrap;
      line-height:1.35;
      font-size:14px;
      color: rgba(255,255,255,.90);
    }
    .resultList{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .resultRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
      font-weight:800;
    }
    .resultRow .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .resultRow .score{ font-size:18px; font-weight:900; }
    .screenActions{
      padding: 14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      background: rgba(255,255,255,.03);
    }
</style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700;800&family=Lato:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;700;900&family=Inter:wght@400;700;900&family=Noto+Sans:wght@400;700;900&family=Merriweather:wght@400;700;900&family=Caveat:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topBrand" aria-hidden="true">
    <img src="63.png" alt="Логотип" onerror="this.style.display='none'"/>
    <span>Светлана Быкова</span>
  </div>
<div id="root"></div>

<div class="toast" id="toast"></div>

<script>
  // Hide brand inside game iframe (keep only in editor)
  try {
    if (typeof isGameMode === 'function' && isGameMode()) {
      const tb = document.querySelector('.topBrand');
      if (tb) tb.style.display = 'none';
    }
  } catch (e) {}

/* ===========================
   Математический тир
   Version 23 — editor+game
   =========================== */

const VERSION = 24;

/* ---------- helpers ---------- */
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('on');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1600);
}

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* base64url */
function b64uEncode(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64uDecode(str){
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  const json = decodeURIComponent(escape(atob(str)));
  return JSON.parse(json);
}

function urlOfSelf(){
  return location.origin + location.pathname;
}

/* ---------- Default config ---------- */
function defaultCfg(){
  return {
    title: "Математический тир",
    teamsCount: 2,
    autoNextTeam: true,
    latex: false,
    bg: "2.png",
    targetFile: "13.png",
    targetLineOffset: 0,
    targetLineJitter: 4,
    targetOrbitRadius: 0,
    targetOrbitSpeed: 0,
    shot: { variant:"pif", volume:0.7 },
    // Start screen (instruction frame shown before the game starts)
    startScreen: {
      enabled: false,
      text: `ИНСТРУКЦИЯ\n\n1) Выберите команду\n2) Кликните по мишени\n3) Ответьте на вопрос\n\nЗа правильный ответ команда получает очки.`,
      color: "#ff8a2a",
      neon: true
    },
    // Feedback screen (results at the end of the game)
    feedbackScreen: {
      enabled: true,
      extraText: "Спасибо за игру!"
    },
    questions: [],
    qFont: 'Roboto',
    aFont: 'Roboto'
  };
}

/* ---------- LaTeX (optional) ---------- */
let katexLoaded = false;
async function ensureKatex(){
  if(katexLoaded) return;
  katexLoaded = true;
  const css = document.createElement('link');
  css.rel = 'stylesheet';
  css.href = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css";
  document.head.appendChild(css);

  const s1 = document.createElement('script');
  s1.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js";
  s1.defer = true;
  document.head.appendChild(s1);

  const s2 = document.createElement('script');
  s2.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js";
  s2.defer = true;
  document.head.appendChild(s2);

  await new Promise(res=> s2.onload = res);
}
function renderLatexIn(el){
  if(!window.renderMathInElement) return;
  try{
    window.renderMathInElement(el, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true},
      ]
    });
  }catch(e){}
}

/* ---------- Shot sound (WebAudio synth, no infinite loop) ---------- */
const AudioKit = (() => {
  let ctx = null;
  let master = null;

  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 1.2;
    master.connect(ctx.destination);
  }
  async function unlock(){
    ensure();
    if(ctx.state === 'suspended') await ctx.resume();
  }
  function setVolume(v){
    ensure();
    master.gain.value = clamp(v, 0, 1) * 2.2;
  }
  function noiseBuffer(){
    ensure();
    const bufferSize = ctx.sampleRate * 0.15;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * (1 - i/data.length);
    return buffer;
  }

  function playVariant(variant){
    ensure();
    const t0 = ctx.currentTime;
    const out = ctx.createGain();
    out.gain.value = 1.25;
    out.connect(master);

    if(variant === 'pif'){ // short 'pif'
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(620, t0);
      osc.frequency.exponentialRampToValueAtTime(260, t0+0.06);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.7, t0+0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      const f = ctx.createBiquadFilter();
      f.type = 'bandpass';
      f.frequency.setValueAtTime(900, t0);
      f.Q.value = 3.5;
      osc.connect(g).connect(f).connect(out);
      osc.start(t0);
      osc.stop(t0+0.10);
    } else if(variant === 'snap'){ // click
      const osc = ctx.createOscillator();
      osc.type = 'square';
      osc.frequency.setValueAtTime(220, t0);
      osc.frequency.exponentialRampToValueAtTime(880, t0+0.03);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.6, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.08);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.09);
    } else if(variant === 'boom'){ // low thump + noise
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(90, t0);
      osc.frequency.exponentialRampToValueAtTime(45, t0+0.12);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.9, t0+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.24);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const nf = ctx.createBiquadFilter();
      nf.type = 'lowpass'; nf.frequency.setValueAtTime(800, t0);
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.4, t0+0.015);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.18);
      n.connect(nf).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.19);
    } else {
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(520, t0);
      osc.frequency.exponentialRampToValueAtTime(220, t0+0.08);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.85, t0+0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.14);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.setValueAtTime(1800, t0); bp.Q.value = 3;
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      n.connect(bp).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.10);
    }

    out.gain.setValueAtTime(1, t0);
    out.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
    setTimeout(()=>{ try{out.disconnect()}catch(e){} }, 500);
  }

  return { ensure, unlock, setVolume, playVariant };
})();

/* ---------- App mode detection ---------- */
const params = new URLSearchParams(location.search);
const isGame = params.has('game');

// Hide editor branding inside the GAME iframe
if (isGame) {
    document.body.classList.add('modeGame');
    document.body.classList.remove('modeEditor');
  const hb = document.getElementById('headerBrand');
  if (hb) hb.style.display = 'none';
}


// ===== Crosshair overlay (needed for Genially where CSS cursor can be ignored) =====
function enableCrosshairOverlay(){
  if(document.getElementById('aimCursor')) return;
  document.body.classList.add('game-cursor');

  const el = document.createElement('div');
  el.id = 'aimCursor';
  el.innerHTML = '<div class="ring"></div><div class="h"></div><div class="v"></div><div class="dot"></div>';
  document.body.appendChild(el);

  const arena = document.getElementById('arena') || document.body;

  const show = () => { el.style.opacity = '1'; };
  const hide = () => { el.style.opacity = '0'; };

  const move = (e) => {
    // Use clientX/Y so it works in iframes and Genially embeds
    el.style.left = e.clientX + 'px';
    el.style.top  = e.clientY + 'px';
    // show on first move
    if(el.style.opacity !== '1') el.style.opacity = '1';
  };

  // Prefer listening on arena; also listen on window as fallback
  arena.addEventListener('mousemove', move, {passive:true});
  window.addEventListener('mousemove', move, {passive:true});

  arena.addEventListener('mouseenter', show, {passive:true});
  arena.addEventListener('mouseleave', hide, {passive:true});

  // Touch devices: keep default cursor (no-op)
  if('ontouchstart' in window){
    document.body.classList.remove('game-cursor');
    el.remove();
  }
}

if(isGame){
  // Delay to ensure #arena exists
  setTimeout(enableCrosshairOverlay, 0);
}


/* ===========================
   GAME MODE
   =========================== */
function mountGame(cfg){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div class="arenaBg arenaBg3d" id="arenaBg"></div>

        <div class="hud">
          <div class="hudLeft">
            <div class="gameTitle" id="gTitle"></div>
            <div class="gameHint">Выберите команду → наведите прицел → выстрелите → ответьте</div>
          </div>
          <div class="hudRight">
            <div class="hudStat" id="hudTurn">Сейчас стреляет: <b id="turnTeam">—</b></div>
            <div class="hudStat hudGoals">Цели: <b id="hudTargets">0/0</b></div>
            <button class="pillBtn" id="btnHelp">Инструкция</button>
            <button class="pillBtn" id="btnReset">Сброс</button>
          </div>
        </div>

        <div class="teams" id="teams"></div>

        <div class="targets" id="targets"></div>

        <div class="modalBackdrop" id="modalBack">
          <div class="modal">
            <div class="timerBadge" id="timerBadge">⏱ <span id="timerText">30</span> сек</div>
            <div class="modalHeader">
              <div class="h" id="qHeader">Вопрос</div>
              <button class="modalClose" id="btnClose">Esc</button>
            </div>
            <div class="modalBody">
              <div class="qText" id="qText"></div>
              <div class="mediaRow" id="qMedia"></div>
              <div id="answersWrap"></div>
            </div>
          </div>
        </div>


        <div class="screenBackdrop" id="startBack" aria-modal="true" role="dialog">
          <div class="screenCard" id="startCard">
            <div class="screenHeader">
              <div class="h" id="startTitle">Инструкция</div>
              <button class="modalClose" id="btnStartClose">Начать</button>
            </div>
            <div class="screenBody">
              <div class="screenText" id="startText"></div>
            </div>
            <div class="screenActions">
              <button class="primary" id="btnStart">Начать игру</button>
            </div>
          </div>
        </div>

        <div class="screenBackdrop" id="feedBack" aria-modal="true" role="dialog">
          <div class="screenCard" id="feedCard">
            <div class="screenHeader">
              <div class="h">Результаты</div>
              <button class="modalClose" id="btnFeedClose">Закрыть</button>
            </div>
            <div class="screenBody">
              <div class="resultList" id="feedResults"></div>
              <div class="help" style="margin-top:12px;">
                <div class="screenText" id="feedExtra"></div>
              </div>
            </div>
            <div class="screenActions">
              <button class="secondary" id="btnFeedRestart">Сыграть снова</button>
            </div>
          </div>
        </div>

        <div class="versionBadge">Версия ${VERSION} • game</div>
      </div>
    </div>
  `;

  const arena = document.getElementById('arena');
  const bg = document.getElementById('arenaBg');

  function setBg(){
    const u = cfg.bg || "";
    bg.style.backgroundImage = u ? `url("${u}")` : 'none';
  }
  setBg();

  function setFonts(){
    const qf = (cfg.qFont || 'Roboto');
    const af = (cfg.aFont || 'Roboto');
    const fs = Number(cfg.fontSize || 18);
    document.documentElement.style.setProperty('--qFont', qf);
    document.documentElement.style.setProperty('--aFont', af);
    document.documentElement.style.setProperty('--qaSize', `${fs}px`);
  }
  setFonts();

  // Start screen styling (color + neon)
  (function applyScreenTheme(){
    const ss = cfg.startScreen || {};
    const col = (ss.color || "#ff8a2a").trim();
    const neonOn = (ss.neon !== false);
    document.documentElement.style.setProperty('--screenLine', col + '66'); // ~40% alpha in hex
    document.documentElement.style.setProperty('--screenGlow', neonOn ? (col + '55') : 'rgba(0,0,0,0)');
    // also tint modal borders a bit for consistency
    try{
      document.documentElement.style.setProperty('--neon', col);
    }catch(e){}
  })();

  // Parallax 3d
  arena.addEventListener('mousemove', (e)=>{
    const r = arena.getBoundingClientRect();
    const x = (e.clientX - r.left)/r.width - 0.5;
    const y = (e.clientY - r.top)/r.height - 0.5;
    bg.style.transform = `scale(1.08) translate(${x*10}px, ${y*10}px)`;
  });
  arena.addEventListener('mouseleave', ()=> bg.style.transform = `scale(1.06)`);

  document.getElementById('gTitle').textContent = cfg.title || "Математический тир";

  // state
  const teamCount = clamp(Number(cfg.teamsCount||2),1,3);
  const teamNames = Array.from({length: teamCount}, (_,i)=>`Команда ${i+1}`);
  const scores = Array.from({length: teamCount}, ()=>0);
  let currentTeam = 0;

  // targets = one per question
  const questions = Array.isArray(cfg.questions)? cfg.questions : [];
  const hit = new Set();
  let activeQIndex = null;
  let countdownId = null;
  let timeLeft = 0;

  
  const arenaEl = document.getElementById('arena') || document.querySelector('.arena');

  function shake(kind){
    if(!arenaEl) return;
    const cls = kind==='miss' ? 'shakeMiss' : 'shakeHit';
    arenaEl.classList.remove('shakeHit','shakeMiss');
    // restart animation
    void arenaEl.offsetWidth;
    arenaEl.classList.add(cls);
    setTimeout(()=>arenaEl.classList.remove(cls), 220);
  }

  function spawnHitFx(clientX, clientY){
    if(!arenaEl) return;
    const r = arenaEl.getBoundingClientRect();
    const x = clientX - r.left;
    const y = clientY - r.top;

    const fx = document.createElement('div');
    fx.className = 'hitFx';
    fx.style.left = x + 'px';
    fx.style.top = y + 'px';

    // Neon burst: rings + sparks
    let sparks = '';
    for(let i=0;i<10;i++){
      sparks += '<span class="sp" style="--a:' + (i*36) + 'deg"></span>';
    }
    fx.innerHTML = ''
      + '<div class="hitRing r1"></div>'
      + '<div class="hitRing r2"></div>'
      + '<div class="hitCore"></div>'
      + '<div class="hitSparks">' + sparks + '</div>';

    arenaEl.appendChild(fx);
    fx.addEventListener('animationend', ()=>fx.remove(), {once:true});
  }
const teamsEl = document.getElementById('teams');
  const targetsEl = document.getElementById('targets');
  const hudTargets = document.getElementById('hudTargets');
  const turnTeamEl = document.getElementById('turnTeam');

  function renderTeams(){
    teamsEl.style.gridTemplateColumns = `repeat(${teamCount}, minmax(0,1fr))`;
    teamsEl.innerHTML = '';
    for(let i=0;i<teamCount;i++){
      const card = document.createElement('div');
      card.className = 'teamCard';
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input class="teamNameInput" value="${teamNames[i]}" aria-label="Название команды ${i+1}"/>
          <div class="teamNow"><span class="dot ${i===currentTeam?'on':''}"></span> ${i===currentTeam?'Сейчас':'Не сейчас'}</div>
        </div>
        <div class="teamScore" id="score_${i}">${scores[i]}</div>
      `;
      const inp = card.querySelector('input');
      inp.addEventListener('input', ()=>{ teamNames[i] = inp.value || `Команда ${i+1}`; renderTurn(); });
      teamsEl.appendChild(card);
    }
  }
  function renderTurn(){
    turnTeamEl.textContent = teamNames[currentTeam] || `Команда ${currentTeam+1}`;
    $$('.teamCard', teamsEl).forEach((c,idx)=>{
      const d = c.querySelector('.dot');
      d.classList.toggle('on', idx===currentTeam);
      c.querySelector('.teamNow').lastChild.textContent = idx===currentTeam ? ' Сейчас' : ' Не сейчас';
    });
  }
  function renderScores(){
    for(let i=0;i<teamCount;i++){
      const s = document.getElementById(`score_${i}`);
      if(s) s.textContent = scores[i];
    }
  }

  function countDone(){ return hit.size; }

  function positionTargets(useManual=true){
    const n = questions.length;

    // --- Base (auto) layout ---
    const pts = [];
    for(let i=0;i<n;i++){
      const col = (i % 6);
      const row = Math.floor(i / 6);
      const x = 12 + col*(76/5);
      const y = 22 + row*10;
      pts.push({x, y});
    }
    const maxY = pts.reduce((m,p)=>Math.max(m,p.y), 0);
    const scaleY = maxY > 55 ? (55-22)/(maxY-22) : 1;

    // (Legacy controls may be absent in the editor UI — keep defaults safe)
    const lineOffset = Number(cfg?.targetLineOffset ?? 0); // percent points
    const lineJitter = Number(cfg?.targetLineJitter ?? 0); // percent points

    // Precompute staggers and center them so jitter doesn't move the whole line
    const staggers = pts.map((_,i)=>Math.sin((i+1)*0.9) * lineJitter * 2.0);
    const meanStagger = staggers.reduce((a,b)=>a+b,0) / (staggers.length || 1);

    pts.forEach((p,i)=>{
      p.y = 22 + (p.y-22)*scaleY;

      // deterministic micro-variation (stable in preview)
      const wobX = Math.sin((i+1)*1.37) * 2.2;
      const wobY = Math.cos((i+1)*1.91) * 1.2;

      // centered stagger
      const stagger = staggers[i] - meanStagger;

      p.x += wobX;
      p.y += wobY + lineOffset + stagger;
    });

    // --- Apply manual overrides (allow partial list; new questions still appear) ---
    if(useManual && Array.isArray(cfg.targetPositions) && cfg.targetPositions.length){
      for(let i=0;i<Math.min(n, cfg.targetPositions.length);i++){
        const p = cfg.targetPositions[i];
        if(p && isFinite(p.x) && isFinite(p.y)){
          pts[i] = { x: Number(p.x), y: Number(p.y) };
        }
      }
    }

    return pts;
  }
    _orbitTimer = setInterval(()=>{
      const t = (Date.now()-startT)/1000;
      for(let i=0;i<els.length;i++){
        const k = Math.floor((t*speed) + phase[i]); // step index
        const ang = (k % steps) * (Math.PI*2/steps);
        const dx = Math.round(Math.cos(ang) * radius);
        const dy = Math.round(Math.sin(ang) * radius);
        els[i].style.setProperty('--orbit-x', dx + 'px');
        els[i].style.setProperty('--orbit-y', dy + 'px');
      }
    }, 60); // ~16 fps for "точечное" движение
  }
  function renderTargets(useManual=true){
    targetsEl.innerHTML = '';
    const n = questions.length;

    const pts = positionTargets(useManual);
    const targetFile = (cfg.targetFile || '13.png').trim();

    for(let i=0;i<n;i++){
      const q = questions[i];
      const el = document.createElement('div');
      el.className = 'target' + (hit.has(i)?' hit':'');
      el.dataset.idx = String(i);

      if(placingTargets){ el.classList.add('draggable'); }

      el.style.left = (pts[i]?.x ?? 50) + '%';
      el.style.top  = (pts[i]?.y ?? 40) + '%';

      // Target image layer (can be swapped from the editor)
      el.style.setProperty('--target-img', `url("${targetFile}")`);

      // Slight float / breathing effect with per-target phase
      const phase = (Math.random()*1.8).toFixed(2);
      el.style.setProperty('--float-delay', phase + 's');

      el.innerHTML = `
        <div class="tImg" aria-hidden="true"></div>
        <div class="tNum">${i+1}</div>
        <div class="tPts">${Number(q.points||10)} очк.</div>
      `;

      if(placingTargets) el.addEventListener('mousedown', onTargetDragStart);
      el.addEventListener('click', async (e)=>{
        if(placingTargets) return;
        if(hit.has(i)) return;
        try{ el.classList.remove('punch'); void el.offsetWidth; el.classList.add('punch'); }catch(err){}
        try{ if(e) spawnHitFx(e.clientX, e.clientY); }catch(err){}
        try{ shake('hit'); }catch(err){}
        try{
          await AudioKit.unlock();
          AudioKit.setVolume(cfg?.shot?.volume ?? 0.7);
          AudioKit.playVariant(cfg?.shot?.variant ?? 'pif');
        }catch(e){}
        await openQuestion(i);
      });

      targetsEl.appendChild(el);
    }

    startOrbitMotion();
  }

  // ====== Manual target placement (editor) ======
  let dragIdx = null;
  let dragRect = null;

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function onTargetDragStart(e){
    if(!placingTargets) return;
    const idx = Number(e.currentTarget?.dataset?.idx ?? -1);
    if(!(idx>=0)) return;
    e.preventDefault();
    e.stopPropagation();

    dragIdx = idx;
    dragRect = targetsEl.getBoundingClientRect();
    document.addEventListener('mousemove', onTargetDragMove);
    document.addEventListener('mouseup', onTargetDragEnd, { once:true });
  }

  function onTargetDragMove(e){
    if(dragIdx==null || !dragRect) return;
    const x = (e.clientX - dragRect.left) / dragRect.width;
    const y = (e.clientY - dragRect.top)  / dragRect.height;
    const px = clamp(x, 0.02, 0.98) * 100;
    const py = clamp(y, 0.02, 0.98) * 100;

    if(!Array.isArray(cfg.targetPositions)) cfg.targetPositions = [];
    cfg.targetPositions[dragIdx] = { x: +px.toFixed(2), y: +py.toFixed(2) };

    const el = targetsEl.querySelector(`.target[data-idx="${dragIdx}"]`);
    if(el){
      el.style.left = px + '%';
      el.style.top  = py + '%';
    }
  }

  function onTargetDragEnd(){
    document.removeEventListener('mousemove', onTargetDragMove);
    dragIdx = null;
    dragRect = null;
    // notify editor about updated positions
    try{ if(window.parent && window.parent!==window){ window.parent.postMessage({type:'ATOMIC_TARGET_POSITIONS', positions: cfg.targetPositions}, '*'); } }catch(e){}
  }

  function enterPlacementMode(){
    placingTargets = true;
    if(btnPlaceTargets) btnPlaceTargets.textContent = 'Готово';
    // seed missing positions from auto layout
    const n = cfg.questions.length;
    const autoPts = positionTargets(false);
    if(!Array.isArray(cfg.targetPositions)) cfg.targetPositions = [];
    cfg.targetPositions = cfg.targetPositions.slice(0, n);
    for(let i=0;i<n;i++){
      if(!cfg.targetPositions[i] || cfg.targetPositions[i].x==null || cfg.targetPositions[i].y==null){
        cfg.targetPositions[i] = autoPts[i] || {x:50,y:40};
      }
    }
    renderTargets();
    try{ if(window.parent && window.parent!==window){ window.parent.postMessage({type:'ATOMIC_PLACE_MODE_ACK', on:true}, '*'); } }catch(e){}
  }

  // listen from editor (iframe parent) to toggle placement mode
  window.addEventListener('message', (ev)=>{
    const d = ev?.data;
    if(!d || d.type!=='ATOMIC_PLACE_MODE') return;
    if(d.reset){ cfg.targetPositions = []; }
    if(d.on) enterPlacementMode(); else exitPlacementMode();
  });

  function exitPlacementMode(){
    placingTargets = false;
    if(btnPlaceTargets) btnPlaceTargets.textContent = 'Расставить мишени';
    renderTargets();
    try{ if(window.parent && window.parent!==window){ window.parent.postMessage({type:'ATOMIC_PLACE_MODE_ACK', on:true}, '*'); } }catch(e){}
  }

  // modal logic
  const modalBack = document.getElementById('modalBack');
  const qHeader = document.getElementById('qHeader');
  const qText = document.getElementById('qText');
  const qMedia = document.getElementById('qMedia');
  const answersWrap = document.getElementById('answersWrap');
  const btnClose = document.getElementById('btnClose');
  const timerBadge = document.getElementById('timerBadge');
  const timerText = document.getElementById('timerText');

  // Start / Feedback screens
  const startBack = document.getElementById('startBack');
  const startText = document.getElementById('startText');
  const btnStart = document.getElementById('btnStart');
  const btnStartClose = document.getElementById('btnStartClose');

  const feedBack = document.getElementById('feedBack');
  const feedResults = document.getElementById('feedResults');
  const feedExtra = document.getElementById('feedExtra');
  const btnFeedClose = document.getElementById('btnFeedClose');
  const btnFeedRestart = document.getElementById('btnFeedRestart');

  function showStartScreen(){
    const ss = cfg.startScreen || {};
    if(!ss.enabled) return;
    startText.textContent = ss.text || '';
    startBack.classList.add('on');
  }
  function hideStartScreen(){
    startBack.classList.remove('on');
  }

  function renderFeedback(){
    feedResults.innerHTML = '';
    for(let i=0;i<teamCount;i++){
      const row = document.createElement('div');
      row.className = 'resultRow';
      row.innerHTML = `<div class="name">${teamNames[i] || ('Команда ' + (i+1))}</div><div class="score">${scores[i]}</div>`;
      feedResults.appendChild(row);
    }
    const fs = cfg.feedbackScreen || {};
    feedExtra.textContent = fs.extraText || '';
  }
  function showFeedback(){
    const fs = cfg.feedbackScreen || {};
    if(!fs.enabled) return;
    renderFeedback();
    feedBack.classList.add('on');
  }
  function hideFeedback(){
    feedBack.classList.remove('on');
  }

  function closeModal(){
    modalBack.classList.remove('on');
    activeQIndex = null;
    stopTimer();
  }

  function stopTimer(){
    if(countdownId){ clearInterval(countdownId); countdownId = null; }
    timerBadge.classList.remove('on');
  }

  function startTimer(seconds){
    stopTimer();
    timeLeft = seconds;
    timerText.textContent = String(timeLeft);
    timerBadge.classList.add('on');
    countdownId = setInterval(()=>{
      timeLeft--;
      timerText.textContent = String(timeLeft);
      if(timeLeft <= 0){
        stopTimer();
        finalizeQuestion(false, true);
      }
    }, 1000);
  }

  function finalizeQuestion(isCorrect, timedOut=false){
    if(activeQIndex === null) return;
    const idx = activeQIndex;
    const q = questions[idx];
    if(!hit.has(idx)){
      hit.add(idx);
      if(isCorrect){
        scores[currentTeam] += Number(q.points||10);
        renderScores();
      }
      const t = targetsEl.children[idx];
      if(t) t.classList.add('hit');
      hudTargets.textContent = `${countDone()}/${questions.length}`;
    }

    if(cfg.autoNextTeam){
      currentTeam = (currentTeam + 1) % teamCount;
      renderTeams();
      renderTurn();
      renderScores();
    }
    closeModal();

    // If all questions are done — show feedback screen
    if(countDone() >= questions.length){
      showFeedback();
    }
  }

  function makeMediaTag(icon, label, url){
    const span = document.createElement('span');
    span.className = 'mediaTag';
    span.innerHTML = `<span aria-hidden="true">${icon}</span> <span>${label}</span>`;
    span.title = url;
    return span;
  }

  async function openQuestion(i){
    activeQIndex = i;
    const q = questions[i];

    qHeader.textContent = `Вопрос #${i+1}`;
    qText.textContent = q.text || '';
    qMedia.innerHTML = '';
    answersWrap.innerHTML = '';

    if(cfg.latex){
      await ensureKatex();
      qText.innerHTML = q.text ? String(q.text) : '';
    }

    // Show image inside the task (if provided)
    const oldImg = document.getElementById('qImgWrap');
    if(oldImg) oldImg.remove();
    if(q.image){
      const wrap = document.createElement('div');
      wrap.className = 'qImg';
      wrap.id = 'qImgWrap';
      const img = document.createElement('img');
      img.alt = 'Картинка к заданию';
      img.src = q.image;
      img.onerror = ()=>{ wrap.style.display='none'; };
      wrap.appendChild(img);
      qText.insertAdjacentElement('afterend', wrap);
    }


    if(q.image){
      qMedia.appendChild(makeMediaTag('🖼️', 'картинка', q.image));
    }

    if(q.type === 'input'){
      const wrap = document.createElement('div');
      wrap.className = 'inputRow';
      wrap.innerHTML = `
        <input id="ansInput" type="text" placeholder="Введите ответ…" autocomplete="off"/>
        <button class="primary" id="btnSend">Ответить</button>
        <button class="secondary" id="btnSkip">Пропустить</button>
      `;
      answersWrap.appendChild(wrap);

      const correctList = String(q.correct||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

      const check = ()=>{
        const v = (document.getElementById('ansInput').value||'').trim().toLowerCase();
        const ok = correctList.length ? correctList.includes(v) : (v.length>0);
        finalizeQuestion(ok);
      };
      document.getElementById('btnSend').addEventListener('click', check);
      document.getElementById('ansInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
      document.getElementById('btnSkip').addEventListener('click', ()=>finalizeQuestion(false));
    } else {
      const opts = Array.isArray(q.options) ? q.options : [];
      const correctIdx = opts.map((o,ii)=> o && o.correct ? ii : -1).filter(ii=>ii>=0);
      const multi = correctIdx.length > 1;

      const grid = document.createElement('div');
      grid.className = 'answers';
      answersWrap.appendChild(grid);

      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const selected = new Set();

      const setSelectedStyle = (btn, on)=>{
        if(on) btn.classList.add('selected');
        else btn.classList.remove('selected');
      };

      opts.forEach((opt, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ansBtn';
        btn.innerHTML = `<div class="ansKey">${letters[idx] || (idx+1)}</div><div class="ansText">${opt?.text ?? ''}</div>`;

        if(multi){
          btn.addEventListener('click', ()=>{
            if(selected.has(idx)){
              selected.delete(idx);
              setSelectedStyle(btn,false);
            }else{
              selected.add(idx);
              setSelectedStyle(btn,true);
            }
          });
        }else{
          btn.addEventListener('click', ()=>{
            const ok = !!opt?.correct;
            finalizeQuestion(ok);
          });
        }

        grid.appendChild(btn);
      });

      const foot = document.createElement('div');
      foot.style.display = 'flex';
      foot.style.justifyContent = 'flex-end';
      foot.style.gap = '10px';
      foot.style.marginTop = '10px';

      if(multi){
        foot.innerHTML = `
          <button class="secondary" id="btnClearSel">Сбросить выбор</button>
          <button class="primary" id="btnSendMulti">Ответить</button>
          <button class="secondary" id="btnSkip2">Пропустить</button>
        `;
      }else{
        foot.innerHTML = `<button class="secondary" id="btnSkip2">Пропустить</button>`;
      }

      answersWrap.appendChild(foot);

      document.getElementById('btnSkip2').addEventListener('click', ()=>finalizeQuestion(false));

      if(multi){
        document.getElementById('btnClearSel').addEventListener('click', ()=>{
          selected.clear();
          grid.querySelectorAll('.ansBtn').forEach(b=>b.classList.remove('selected'));
        });

        document.getElementById('btnSendMulti').addEventListener('click', ()=>{
          // correct if user selected ALL and ONLY correct answers
          const sel = Array.from(selected).sort((a,b)=>a-b);
          const cor = correctIdx.slice().sort((a,b)=>a-b);
          const ok = sel.length === cor.length && sel.every((v,i)=>v===cor[i]);
          finalizeQuestion(ok);
        });
      }
    }

    modalBack.classList.add('on');

    if(q.timerEnabled && Number(q.timerSeconds||0) > 0){
      startTimer(Number(q.timerSeconds));
    } else {
      stopTimer();
    }

    if(cfg.latex){
      setTimeout(()=>{ renderLatexIn(document.querySelector('.modal')); }, 0);
    }
  }

  document.getElementById('btnHelp').addEventListener('click', ()=>{
    if(cfg.startScreen && cfg.startScreen.enabled){
      showStartScreen();
    } else {
      toast("Кликните по мишени → ответьте. Очки идут текущей команде.");
    }
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    hit.clear();
    for(let i=0;i<scores.length;i++) scores[i]=0;
    currentTeam = 0;
    renderTargets();
    renderTeams();
    renderTurn();
    renderScores();
    closeModal();
    toast("Сброс выполнен");
  });

  // Start screen controls
  btnStart.addEventListener('click', async ()=>{
    try{ await AudioKit.unlock(); }catch(e){}
    hideStartScreen();
  });
  btnStartClose.addEventListener('click', async ()=>{
    try{ await AudioKit.unlock(); }catch(e){}
    hideStartScreen();
  });
  // Close start screen on Escape (without affecting question modal)
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && startBack.classList.contains('on')) hideStartScreen(); });

  // Feedback controls
  btnFeedClose.addEventListener('click', hideFeedback);
  btnFeedRestart.addEventListener('click', ()=>{
    hideFeedback();
    hit.clear();
    for(let i=0;i<scores.length;i++) scores[i]=0;
    currentTeam = 0;
    renderTargets();
    renderTeams();
    renderTurn();
    renderScores();
    closeModal();
    hudTargets.textContent = `${countDone()}/${questions.length}`;
    if(cfg.startScreen && cfg.startScreen.enabled) showStartScreen();
  });

  btnClose.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  renderTeams();
  renderTurn();
  renderScores();
  renderTargets();

  // Show start screen at the beginning (if enabled)
  if(cfg.startScreen && cfg.startScreen.enabled){
    showStartScreen();
  }

/* ===========================
   EDITOR MODE
   =========================== */
function mountEditor(){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="app">
      <div class="panel">
        <div class="panelHeader">
          <div>
            <div class="title">Редактор<br>«Математический тир»</div>
            <div class="subtitle"></div>
          </div>
          <button class="btn btnGold" id="copyIframe">📋 Скопировать код</button>
        </div>

        <div class="scroll">
          <div class="section">
            <h3>Название</h3>
            <div class="row1">
              <div>
                <label>Заголовок в игре</label>
                <input id="inpTitle" type="text" value="Математический тир"/>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Параметры</h3>
            <div class="row">
              <div>
                <label>Количество команд (1–3)</label>
                <select id="teamsCount">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div>
                <label>Автопереход команды после вопроса</label>
                <select id="autoNext">
                  <option value="true" selected>Включён</option>
                  <option value="false">Выключен</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>LaTeX (вопросы/ответы)</label>
                <select id="latexToggle">
                  <option value="false" selected>Выключен</option>
                  <option value="true">Включён</option>
                </select>
              </div>
              <div>
                <label>Выбери фон</label>
                <select id="bgSelect" class="select">
                  <option value="1.png">1</option>
                  <option value="2.png" selected>2</option>
                  <option value="3.png">3</option>
                  <option value="4.png">4</option>
                  <option value="5.png">5</option>
                  <option value="6.png">6</option>
                  <option value="7.png">7</option>
                  <option value="8.png">8</option>
                  <option value="__custom__">По ссылке</option>
                </select>
                <input id="bgInput" type="hidden" value="2.png"/>
                <div style="display:flex; gap:10px; margin-top:8px;">
                  <input id="bgUrl" type="text" placeholder="Ссылка на фон (png/jpg/webp)"/>
                  <button class="btn" id="btnBgApply" type="button">Применить</button>
                </div>
                <div class="help">Можно вставить ссылку на картинку. Подойдут https://… и относительные пути (например: images/bg.png).</div>
              </div>
            </div>
<div class="row">
              <div class="field">
                <label>Выбери мишень</label>
                <select id="targetSelect" class="select">
                  <option value="10.png">10</option>
                  <option value="11.png">11</option>
                  <option value="12.png">12</option>
                  <option value="13.png" selected>13</option>
                  <option value="14.png">14</option>
                  <option value="__custom__">По ссылке</option>
                </select>
                <input id="targetInput" type="hidden" value="13.png"/>
                <div style="display:flex; gap:10px; margin-top:8px;">
                  <input id="targetUrl" type="text" placeholder="Ссылка на мишень (png/webp с прозрачностью)"/>
                  <button class="btn" id="btnTargetApply" type="button">Применить</button>
                </div>
                <div class="help">Лучше использовать PNG/WebP с прозрачным фоном.</div>
              </div>
              <div class="field">
                <label>Позиции мишеней</label>
                <div class="hint">Мишени будут появляться в отмеченной зоне на фоне.</div>
              </div>
            </div>
            <div class="help">Файлы мишеней: 10.png … 14.png (рядом с index.html).</div>

            <div class="row" style="margin-top:10px;">
              <button id="btnPlaceTargets" class="btn">Расставить мишени</button>
              <button id="btnResetTargets" class="btn ghost">Сбросить расстановку</button>
            </div>
            <div class="help">Нажмите «Расставить мишени» и перетащите мишени на превью справа. Позиции сохраняются и будут использованы в игре.</div>

          </div>

          <div class="section">
            <h3>Звук выстрела</h3>
            <div class="soundRow">
              <div>
                <label>Вариант (прослушивается при выборе)</label>
                <select id="shotVariant">
                  <option value="pif" selected>Короткий «пиф»</option>
                  <option value="snap">Щелчок «снап»</option>
                  <option value="boom">Глухой «бум»</option>
                </select>
              </div>
              <div>
                <label>Громкость</label>
                <input id="shotVol" class="range" type="range" min="0" max="1" step="0.01" value="0.7"/>
              </div>
            </div>
            <div class="help">В игре звук выстрела звучит при клике по мишени.</div>
          </div>

          
          <div class="section">
            <h3>Стартовый экран</h3>
            <div class="row">
              <div>
                <label>Показывать стартовый экран</label>
                <select id="startEnabled">
                  <option value="true" selected>Включён</option>
                  <option value="false">Выключен</option>
                </select>
              </div>
              <div>
                <label>Цвет рамки</label>
                <input id="startColor" type="color" value="#ff8a2a" style="height:44px; padding:8px 10px;"/>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Неоновое свечение</label>
                <select id="startNeon">
                  <option value="true" selected>Включено</option>
                  <option value="false">Выключено</option>
                </select>
              </div>
              <div>
                <label>Текст инструкции</label>
                <textarea id="startTextInp" placeholder="Инструкция игры…"></textarea>
              </div>
            </div>
            <div class="help">Этот экран появляется в начале игры и открывается кнопкой «Инструкция».</div>
          </div>

          <div class="section">
            <h3>Экран фидбека</h3>
            <div class="row1">
              <div>
                <label>Показывать экран фидбека в конце</label>
                <select id="feedEnabled">
                  <option value="true" selected>Включён</option>
                  <option value="false">Выключен</option>
                </select>
              </div>
              <div>
                <label>Доп. текст (после результатов)</label>
                <textarea id="feedExtraInp" placeholder="Ваши слова после результатов…"></textarea>
              </div>
            </div>
            <div class="help">В конце игры показываются названия команд и их счёт, ниже — ваш текст.</div>
          </div>

<div class="section">
            <div class="split">
              <h3 style="margin:0">Вопросы</h3>
              <span class="pill">Всего: <span id="qCount">0</span></span>
            </div>
            <div class="btnRow">
              <button class="btn btnGold" id="btnAdd">＋ Добавить</button>
              <button class="btn btnDanger" id="btnClear">🧹 Очистить</button>
            </div>
            <div style="height:10px"></div>
            <div class="qList" id="qList"></div>
          </div>
</div>
      </div>

      <div class="panel previewWrap">
        <div class="previewHeader">
          <div>
            <div class="title2">Просмотр</div>
            <div class="muted">Живое превью</div>
          </div>
        </div>
        <iframe class="previewFrame" id="previewFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>

    <div class="modalBackdrop" id="editBack" style="z-index:80;">
      <div class="modal">
        <div class="modalHeader">
          <div class="h" id="editHdr">Вопрос</div>
          <button class="modalClose" id="editClose">Esc</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div>
              <label>Очки</label>
              <input id="editPoints" type="number" min="0" step="1" value="10"/>
            </div>
            <div>
              <label>Таймер</label>
              <select id="editTimerMode">
                <option value="off" selected>Выключен</option>
                <option value="on">Включён</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Секунды (если включён)</label>
              <input id="editTimerSec" type="number" min="1" step="1" value="30"/>
            </div>
            <div>
              <label>Тип вопроса</label>
              <select id="editType">
                <option value="choice" selected>Выбор ответа</option>
                <option value="input">Ввод ответа</option>
              </select>
            </div>
          </div>

          <div class="row1">
            <div>
              <label>Текст вопроса</label>
              <textarea id="editText" placeholder="Напишите вопрос…"></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>🖼️ Картинка (URL, опционально)</label>
              <input id="editImg" type="text" placeholder="https://..."/>
            </div>
            <div>
              <label>Шрифт (для вопроса и ответов)</label>
              <select id="qaFontSelect"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Размер шрифта (для вопроса и ответов)</label>
              <input id="qaFontSize" type="range" min="12" max="44" step="1" value="18"/>
              <div class="muted" style="margin-top:6px;">Текущий: <span id="qaFontSizeVal">18</span> px</div>
            </div>
          </div>

          <div id="choiceBox">
            <div class="split">
              <div style="font-weight:900;">Варианты ответа</div>
            </div>
            <div id="optList" class="qList" style="margin-top:10px;"></div>
            <div style="display:flex; gap:10px;">
              <button class="btn btnGold" id="btnAddOpt">＋ Добавить вариант</button>
            </div>
          </div>

          <div id="inputBox" style="display:none;">
            <label>Правильный ответ</label>
            <input id="editCorrect" type="text" placeholder="например: 12"/>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:4px;">
            <button class="secondary" id="btnCancelQ">Отмена</button>
            <button class="primary" id="btnSaveQ">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  `;

  let cfg = defaultCfg();
  let placingTargets = false;
  let editingIndex = null;

  const inpTitle = document.getElementById('inpTitle');
  const teamsCount = document.getElementById('teamsCount');
  const autoNext = document.getElementById('autoNext');
  const latexToggle = document.getElementById('latexToggle');
  const bgInput = document.getElementById('bgInput') || document.getElementById('bgSelect');
  const bgSelect = document.getElementById('bgSelect');
  const bgUrl = document.getElementById('bgUrl');
  const btnBgApply = document.getElementById('btnBgApply');

  const targetInput = document.getElementById('targetInput');
  const targetSelect = document.getElementById('targetSelect');
  const targetUrl = document.getElementById('targetUrl');
  const btnTargetApply = document.getElementById('btnTargetApply');
const targetOrbitRadius = document.getElementById('targetOrbitRadius');
  const targetOrbitSpeed = document.getElementById('targetOrbitSpeed');

  const btnPlaceTargets = document.getElementById('btnPlaceTargets');
  const btnResetTargets = document.getElementById('btnResetTargets');

  const startEnabled = document.getElementById('startEnabled');
  const startColor = document.getElementById('startColor');
  const startNeon = document.getElementById('startNeon');
  const startTextInp = document.getElementById('startTextInp');

  const feedEnabled = document.getElementById('feedEnabled');
  const feedExtraInp = document.getElementById('feedExtraInp');

  const shotVariantEl = document.getElementById('shotVariant');
  const shotVolEl = document.getElementById('shotVol');

  // font settings (apply to both question + answers)
  const qaFontSelect = document.getElementById('qaFontSelect');
  const qaFontSize = document.getElementById('qaFontSize');
  const qaFontSizeVal = document.getElementById('qaFontSizeVal');


  // init start/feedback inputs from defaults
  try{
    startEnabled.value = String(cfg.startScreen?.enabled ?? false);
    startColor.value = (cfg.startScreen?.color || '#ff8a2a');
    startNeon.value = String(cfg.startScreen?.neon ?? true);
    startTextInp.value = (cfg.startScreen?.text || '');
    feedEnabled.value = String(cfg.feedbackScreen?.enabled ?? true);
    feedExtraInp.value = (cfg.feedbackScreen?.extraText || '');
  }catch(e){}

  function updatePreview(){
    cfg.title = inpTitle.value || "Математический тир";
    cfg.teamsCount = clamp(Number(teamsCount.value||2),1,3);
    cfg.autoNextTeam = (autoNext.value === 'true');
    cfg.latex = (latexToggle.value === 'true');
    cfg.bg = (bgInput.value || "2.png").trim();
    cfg.targetFile = (targetInput?.value || "13.png").trim();
cfg.targetOrbitRadius = Number(targetOrbitRadius?.value ?? 0);
    cfg.targetOrbitSpeed = Number(targetOrbitSpeed?.value ?? 0);
    cfg.shot.variant = document.getElementById('shotVariant').value;
    cfg.shot.volume = clamp(Number(document.getElementById('shotVol').value||0.7),0,1);
    cfg.qFont = (document.getElementById('qaFontSelect')?.value || 'Roboto');
    cfg.aFont = (document.getElementById('qaFontSelect')?.value || 'Roboto');
    cfg.fontSize = clamp(Number(document.getElementById('qaFontSize')?.value || 18), 12, 44);



    // start screen
    cfg.startScreen = cfg.startScreen || {};
    cfg.startScreen.enabled = (startEnabled.value === 'true');
    cfg.startScreen.color = (startColor.value || '#ff8a2a');
    cfg.startScreen.neon = (startNeon.value === 'true');
    cfg.startScreen.text = (startTextInp.value || '');

    // feedback screen
    cfg.feedbackScreen = cfg.feedbackScreen || {};
    cfg.feedbackScreen.enabled = (feedEnabled.value === 'true');
    cfg.feedbackScreen.extraText = (feedExtraInp.value || '');


    const gameUrl = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}&t=${Date.now()}`;
    document.getElementById('previewFrame').src = gameUrl;

    // if we are in placement mode, re-enable it after iframe reload
    if(window.__atomicPlaceMode){
      const fr = document.getElementById('previewFrame');
      const send = ()=>{ try{ fr.contentWindow.postMessage({type:'ATOMIC_PLACE_MODE', on:true}, '*'); }catch(e){} };
      fr.addEventListener('load', send, { once:true });
    }
  }

  // ====== Manual target placement controls (editor) ======
  window.__atomicPlaceMode = false;

  function sendPlaceModeMessage(payload){
    const fr = document.getElementById('previewFrame');
    if(!fr || !fr.contentWindow) return;
    try{ fr.contentWindow.postMessage(payload, '*'); }catch(e){}
  }

  if(btnPlaceTargets){
    btnPlaceTargets.addEventListener('click', ()=>{
      window.__atomicPlaceMode = !window.__atomicPlaceMode;
      btnPlaceTargets.textContent = window.__atomicPlaceMode ? 'Готово' : 'Расставить мишени';
      // ensure iframe has latest cfg (including targetPositions) before toggling mode
      updatePreview();
      const fr = document.getElementById('previewFrame');
      fr.addEventListener('load', ()=> sendPlaceModeMessage({type:'ATOMIC_PLACE_MODE', on: window.__atomicPlaceMode}), { once:true });
    });
  }

  if(btnResetTargets){
    btnResetTargets.addEventListener('click', ()=>{
      cfg.targetPositions = [];
      window.__atomicPlaceMode = true;
      if(btnPlaceTargets) btnPlaceTargets.textContent = 'Готово';
      updatePreview();
      const fr = document.getElementById('previewFrame');
      fr.addEventListener('load', ()=> sendPlaceModeMessage({type:'ATOMIC_PLACE_MODE', on:true, reset:true}), { once:true });
    });
  }

  window.addEventListener('message', (ev)=>{
    const d = ev?.data;
    if(!d || d.type!=='ATOMIC_TARGET_POSITIONS') return;
    if(Array.isArray(d.positions)){
      cfg.targetPositions = d.positions;
      // keep preview as-is while dragging; cfg is now updated for export
    }
  });


  [inpTitle, teamsCount, autoNext, latexToggle, bgSelect, targetSelect,  targetOrbitRadius, targetOrbitSpeed, shotVariantEl, shotVolEl, startEnabled, startColor, startNeon, startTextInp, feedEnabled, feedExtraInp].forEach(el=>{
    el.addEventListener('change', updatePreview);
    if(el.type === 'range' || el.type === 'text') el.addEventListener('input', updatePreview);
  });


  // font controls (one font for question + answers) + size for both
  (function initFontControls(){
    const fonts = [
      {label:"Roboto (sans)", value:"Roboto"},
      {label:"Arial", value:"Arial"},
      {label:"Helvetica", value:"Helvetica"},
      {label:"Verdana", value:"Verdana"},
      {label:"Tahoma", value:"Tahoma"},
      {label:"Trebuchet MS", value:"'Trebuchet MS'"},
      {label:"Georgia", value:"Georgia"},
      {label:"Times New Roman", value:"'Times New Roman'"},
      {label:"Courier New (mono)", value:"'Courier New'"},
      {label:"Impact", value:"Impact"},
      {label:"Caveat (рукописный)", value:"Caveat"},
      {label:"Pacifico (рукописный)", value:"Pacifico"}
    ];
    if(qaFontSelect && qaFontSelect.options.length === 0){
      fonts.forEach(f=>{
        const o = document.createElement('option');
        o.value = f.value;
        o.textContent = f.label;
        o.style.fontFamily = f.value;
        qaFontSelect.appendChild(o);
      });
    }

    // set initial from cfg
    if(qaFontSelect){
      const current = (cfg.qFont || cfg.aFont || 'Roboto');
      qaFontSelect.value = current;
    }
    if(qaFontSize){
      const s = clamp(Number(cfg.fontSize || 18), 12, 44);
      qaFontSize.value = String(s);
      if(qaFontSizeVal) qaFontSizeVal.textContent = String(s);
    }

    // live label
    qaFontSize?.addEventListener('input', ()=>{
      if(qaFontSizeVal) qaFontSizeVal.textContent = String(qaFontSize.value);
    });
  })();

  // preview shot sound when selecting in editor
  shotVariantEl.addEventListener('change', async ()=>{
    try{
      await AudioKit.unlock();
      const vol = clamp(Number(shotVolEl.value||0.7),0,1);
      AudioKit.setVolume(vol);
      AudioKit.playVariant(shotVariantEl.value || 'pif');
    }catch(e){}
  });
  shotVolEl.addEventListener('input', async ()=>{
    try{
      await AudioKit.unlock();
      const vol = clamp(Number(shotVolEl.value||0.7),0,1);
      AudioKit.setVolume(vol);
    }catch(e){}
  });

  const qCount = document.getElementById('qCount');
  const qList = document.getElementById('qList');

  function renderQuestionList(){
    qCount.textContent = String(cfg.questions.length);
    qList.innerHTML = '';
    cfg.questions.forEach((q, idx)=>{
      const item = document.createElement('div');
      item.className = 'qItem';
      const typeLabel = (q.type === 'input') ? 'Ввод ответа' : 'Выбор ответа';
      const pts = Number(q.points || 10);
      item.innerHTML = `
        <div style="flex:1; cursor:pointer;" onclick="openEditQ(${idx})">
          <div class="qTitle">${idx+1}. ${q.text || '(без текста)'}</div>
          <div class="muted" style="font-size:12px; margin-top:2px;">${typeLabel} • ${pts} очк.</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn" onclick="openEditQ(${idx})">⚙️</button>
          <button class="iconBtn danger" onclick="removeQ(${idx})">🗑️</button>
        </div>
      `;
      qList.appendChild(item);
    });
  }

  window.removeQ = (idx) => { cfg.questions.splice(idx,1); renderQuestionList(); updatePreview(); };
  // -------- Question editor modal (for "Добавить" and settings) --------
  const editBack = document.getElementById('editBack');
  const editClose = document.getElementById('editClose');
  const editHdr = document.getElementById('editHdr');
  const editPoints = document.getElementById('editPoints');
  const editTimerMode = document.getElementById('editTimerMode');
  const editTimerSec = document.getElementById('editTimerSec');
  const editType = document.getElementById('editType');
  const editText = document.getElementById('editText');
  const editImg = document.getElementById('editImg');
  const choiceBox = document.getElementById('choiceBox');
  const inputBox = document.getElementById('inputBox');
  const optList = document.getElementById('optList');
  const btnAddOpt = document.getElementById('btnAddOpt');
  const editCorrect = document.getElementById('editCorrect');
  const btnCancelQ = document.getElementById('btnCancelQ');
  const btnSaveQ = document.getElementById('btnSaveQ');

  function openEditQ(idx){
    editingIndex = idx;
    const q = cfg.questions[idx] || {};
    editHdr.textContent = `Вопрос #${idx+1}`;
    editPoints.value = Number(q.points ?? 10);
    editTimerMode.value = (q.timerEnabled ? 'on' : 'off');
    editTimerSec.value = Number(q.timerSeconds ?? 30);
    editType.value = (q.type === 'input') ? 'input' : 'choice';
    editText.value = q.text ?? '';
    editImg.value = q.image ?? '';
    editCorrect.value = q.correct ?? '';
    renderOptEditor();
    syncTypeVisibility();
    // global font settings (apply to both question + answers)
    if(qaFontSelect) qaFontSelect.value = (cfg.qFont || cfg.aFont || 'Roboto');
    if(qaFontSize){
      const s = clamp(Number(cfg.fontSize || qaFontSize.value || 18), 12, 44);
      qaFontSize.value = String(s);
      if(qaFontSizeVal) qaFontSizeVal.textContent = String(s);
    }
    editBack.classList.add('on');
  }
  window.openEditQ = openEditQ;

  function closeEditQ(){
    editBack.classList.remove('on');
    editingIndex = null;
  }

  function syncTypeVisibility(){
    const isInput = (editType.value === 'input');
    inputBox.style.display = isInput ? '' : 'none';
    choiceBox.style.display = isInput ? 'none' : '';
  }

  function renderOptEditor(){
    optList.innerHTML = '';
    const q = cfg.questions[editingIndex] || {};
    const opts = Array.isArray(q.options) ? q.options : [];
    opts.forEach((opt, i)=>{
      const row = document.createElement('div');
      row.className = 'qItem';
      row.style.gap = '10px';
      row.innerHTML = `
        <div style="flex:1;">
          <label style="display:block; font-size:12px; opacity:.8; margin-bottom:4px;">Вариант ${i+1}</label>
          <input type="text" value="${String(opt?.text ?? '').replaceAll('"','&quot;')}" data-opt-text="${i}" />
        </div>
        <div style="display:flex; align-items:flex-end; gap:10px;">
          <label style="display:flex; align-items:center; gap:8px; font-size:12px; opacity:.9;">
            <input type="checkbox" ${opt?.correct ? 'checked' : ''} data-opt-correct="${i}"/> верный
          </label>
          <button class="iconBtn danger" data-opt-del="${i}">🗑️</button>
        </div>
      `;
      optList.appendChild(row);
    });

    // Bind inputs
    optList.querySelectorAll('[data-opt-text]').forEach(inp=>{
      inp.addEventListener('input', (e)=>{
        const idx = Number(e.target.getAttribute('data-opt-text'));
        const q = cfg.questions[editingIndex];
        if(q && q.options && q.options[idx]) q.options[idx].text = e.target.value;
      });
    });
    optList.querySelectorAll('[data-opt-correct]').forEach(chk=>{
      chk.addEventListener('change', (e)=>{
        const idx = Number(e.target.getAttribute('data-opt-correct'));
        const q = cfg.questions[editingIndex];
        if(q && q.options && q.options[idx]) q.options[idx].correct = e.target.checked;
      });
    });
    optList.querySelectorAll('[data-opt-del]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const idx = Number(e.target.getAttribute('data-opt-del'));
        const q = cfg.questions[editingIndex];
        if(q && Array.isArray(q.options)){
          q.options.splice(idx,1);
          renderOptEditor();
        }
      });
    });
  }

  editType.addEventListener('change', syncTypeVisibility);

  btnAddOpt.addEventListener('click', ()=>{
    if(editingIndex == null) return;
    const q = cfg.questions[editingIndex];
    q.options = Array.isArray(q.options) ? q.options : [];
    q.options.push({text:`Вариант ${q.options.length+1}`, correct:false});
    renderOptEditor();
  });

  btnCancelQ.addEventListener('click', ()=>{ closeEditQ(); });
  editClose.addEventListener('click', ()=>{ closeEditQ(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editBack.classList.contains('on')) closeEditQ(); });

  btnSaveQ.addEventListener('click', ()=>{
    if(editingIndex == null) return;
    const q = cfg.questions[editingIndex];
    q.points = clamp(Number(editPoints.value||10), 0, 9999);
    q.timerEnabled = (editTimerMode.value === 'on');
    q.timerSeconds = clamp(Number(editTimerSec.value||30), 1, 9999);
    q.type = (editType.value === 'input') ? 'input' : 'choice';
    q.text = editText.value || '';
    q.image = (editImg.value || '').trim();
    if(q.type === 'input'){
      q.correct = (editCorrect.value || '').trim();
      q.options = [];
    } else {
      q.correct = '';
      q.options = Array.isArray(q.options) ? q.options : [];
      if(q.options.length === 0) q.options = [{text:'Вариант 1', correct:true}];
    }
    renderQuestionList();
    updatePreview();
    closeEditQ();
  });


  document.getElementById('btnAdd').onclick = () => {
    cfg.questions.push({
      type:'choice',
      text:'Новый вопрос',
      points: 10,
      timerEnabled: false,
      timerSeconds: 30,
      image: '',
      options:[{text:'Вариант 1', correct:true},{text:'Вариант 2', correct:false}]
    });
    renderQuestionList();
    updatePreview();
    openEditQ(cfg.questions.length - 1);
  };

  document.getElementById('copyIframe').onclick = () => {
    const src = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}`;
    const code = `<iframe src="${src}" style="width:100%;height:600px;border:0;" allowfullscreen></iframe>`;
    navigator.clipboard.writeText(code);
    toast("Код скопирован");
  };

  renderQuestionList();
  updatePreview();
}

(function boot(){
  if(isGame){
    let cfg = defaultCfg();
  let placingTargets = false;
    try { cfg = b64uDecode(params.get('game')); } catch(e){}
    mountGame(cfg);
  } else {
    mountEditor();
  }
})();
</script>
</body>
</html>
