<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî editor+game</title>
  <style>
    :root{
      --bg0:#0b0f14;
      --card:rgba(20,28,38,.72);
      --card2:rgba(15,22,30,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eef7;
      --muted:rgba(232,238,247,.70);
      --gold: #caa24d;
      --gold2:#f1d089;
      --danger:#ff5b6b;
      --ok:#33d17a;
      --shadow: 0 14px 55px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 12% 12%, rgba(90,140,190,.16), transparent 60%),
                  radial-gradient(900px 520px at 70% 18%, rgba(255,190,90,.08), transparent 60%),
                  linear-gradient(180deg, #0a0f15, #080b10);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== Layout (editor) ====== */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 480px 1fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 1100px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100%;}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0; /* –≤–∞–∂–Ω–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω—É—Ç—Ä–∏ flex */
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 0% 0%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(700px 420px at 100% 0%, rgba(255,215,120,.07), transparent 65%),
                  repeating-linear-gradient(135deg, rgba(255,255,255,.03) 0 2px, transparent 2px 12px);
      opacity:.35;
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:1}

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{
      font-weight:800;
      font-size:22px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
    }
    .btn{
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.13);
      background: rgba(25,35,46,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{ background: rgba(30,43,58,.68); border-color: rgba(255,255,255,.18)}
    .btn:active{ transform: translateY(1px) }
    .btnGold{
      background: linear-gradient(180deg, rgba(202,162,77,.26), rgba(202,162,77,.13));
      border-color: rgba(202,162,77,.45);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,91,107,.24), rgba(255,91,107,.12));
      border-color: rgba(255,91,107,.38);
    }

    .scroll{
      flex: 1;
      min-height: 0;
      overflow:auto;
      padding: 14px 18px 18px 18px;
    }
    .section{
      background: rgba(10,14,20,.22);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .section h3{
      margin:0 0 10px 0;
      font-size:14px;
      color: rgba(255,255,255,.92);
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      outline:none;
      background: rgba(10,14,18,.55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{min-height: 84px; resize: vertical;}
    input[type="number"]{appearance:textfield}
    .help{
      margin-top:8px;
      font-size:12px;
      color: rgba(232,238,247,.62);
      line-height:1.25;
    }
    .split{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .pill{
      font-size:12px;
      padding:5px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
    }
    .qList{display:flex; flex-direction:column; gap:10px;}
    .qItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,18,.48);
      align-items:center;
    }
    .qTitle{
      font-weight:700;
      font-size:13px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }
    .qMeta{
      font-size:12px;
      color: rgba(232,238,247,.62);
    }
    .iconBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(25,35,46,.45);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .iconBtn:hover{ background: rgba(25,35,46,.65) }
    .iconBtn.danger{ border-color: rgba(255,91,107,.45); background: rgba(255,91,107,.12)}
    .iconBtn.danger:hover{ background: rgba(255,91,107,.18)}
    .soundRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .range{
      width:100%;
      accent-color: #2aa6ff;
    }

    /* ====== Preview ====== */
    .previewWrap{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .previewHeader{
      padding: 14px 16px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .previewHeader .title2{
      font-weight:800;
      font-size:18px;
    }
    .previewHeader .muted{
      font-size:12px; color:var(--muted);
    }
    .previewFrame{
      flex:1;
      min-height: 420px;
      border:0;
      width:100%;
      background: transparent;
    }

    /* ====== Version badge ====== */
    .versionBadge{
      position:fixed;
      right:14px; bottom:14px;
      z-index:50;
      font-size:12px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      pointer-events:none;
    }

    /* ====== GAME MODE ====== */
    .gameRoot{
      position:fixed;
      inset:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#000;
    }
    .arena{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      margin: 16px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background: #0b0f14;
    }

    /* Background image (non-transparent) */
    .arenaBg{
      position:absolute;
      inset:0;
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      transform: scale(1.06);
      filter: saturate(1.05) contrast(1.03) brightness(1.02);
    }
    .arenaBg::after{
      /* cinematic + depth */
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,230,160,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 25%, rgba(100,180,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .arenaBg3d{
      /* subtle parallax */
      will-change: transform;
      transition: transform .08s linear;
    }

    .hud{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hudLeft{
      pointer-events:none;
      display:flex; flex-direction:column; gap:6px;
      min-width: 260px;
      max-width: 460px;
    }
    .gameTitle{
      font-weight:900;
      font-size:22px;
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .gameHint{
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-shadow: 0 6px 25px rgba(0,0,0,.55);
    }
    .hudRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pillBtn{
      pointer-events:auto;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-weight:650;
      font-size:13px;
      cursor:pointer;
    }
    .pillBtn:hover{ background: rgba(0,0,0,.40) }
    .hudStat{
      pointer-events:none;
      border-radius: 999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.9);
      font-weight:650;
      font-size:13px;
    }

    /* Team bars */
    .teams{
      position:absolute;
      top:78px; left:14px; right:14px;
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      pointer-events:none;
    }
    .teamCard{
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      padding:10px 10px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
    }
    .teamNameInput{
      pointer-events:auto;
      width: 100%;
      max-width: 220px;
      font-weight:800;
      font-size:14px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      outline:none;
    }
    .teamNameInput:focus{ border-color: rgba(202,162,77,.50); box-shadow: 0 0 0 3px rgba(202,162,77,.12); }
    .teamScore{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.95);
      min-width: 40px;
      text-align:right;
    }
    .teamNow{
      display:flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.78);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.24);
      border: 1px solid rgba(255,255,255,.25);
    }
    .dot.on{ background: rgba(202,162,77,.95); border-color: rgba(202,162,77,.95); box-shadow: 0 0 0 4px rgba(202,162,77,.16); }

    /* Targets */
    .targets{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .target{
      position:absolute;
      width: 86px;
      height: 86px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 50% 45%, rgba(255,255,255,.18), rgba(255,255,255,.06) 35%, rgba(0,0,0,.30) 70%),
        radial-gradient(circle at 50% 50%, rgba(202,162,77,.22), transparent 65%);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      transition: transform .16s ease, filter .16s ease, opacity .16s ease;
    }
    .target:hover{ transform: translate(-50%,-50%) scale(1.05); }
    .target.hit{
      opacity:.38;
      filter: grayscale(1) brightness(.9);
      pointer-events:none;
    }
    .tNum{
      font-weight:900;
      font-size:18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 25px rgba(0,0,0,.65);
    }
    .tPts{
      position:absolute;
      bottom:-10px;
      left:50%;
      transform: translateX(-50%);
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.40);
      background: rgba(0,0,0,.35);
      color: rgba(255,232,190,.95);
      font-weight:800;
      font-size:11px;
      white-space:nowrap;
    }

    /* Modal (game question) */
    .modalBackdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 40;
    }
    .modalBackdrop.on{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,8,10,.88);  /* NOT transparent */
      box-shadow: 0 24px 95px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      max-height: calc(100vh - 36px);
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader .h{
      font-weight:900;
      font-size:14px;
      color: rgba(255,255,255,.92);
    }
    .modalClose{
      border-radius: 14px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
    }
    .modalBody{
      padding: 16px;
      display:grid;
      gap:12px;
      overflow:auto;
      flex:1;
      min-height:0;
    }
    .qText{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
    }
    .mediaRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: rgba(255,255,255,.8);
      font-size:12px;
    }
    .mediaTag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .answers{grid-template-columns:1fr}
    }
    .ansBtn{
      text-align:left;
      padding:14px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      position:relative;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .ansBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.16);}
    .ansKey{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(202,162,77,.50);
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(255,232,190,.95);
      flex:0 0 auto;
    }
    .ansText{ font-weight:700; line-height:1.25; }
    .inputRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inputRow input{
      flex:1;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:700;
      outline:none;
    }
    .primary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(202,162,77,.55);
      background: rgba(202,162,77,.18);
      color: rgba(255,245,225,.95);
      font-weight:900;
      cursor:pointer;
    }
    .secondary{
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:800;
      cursor:pointer;
    }

    /* Timer badge top-center */
    .timerBadge{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,166,60,.55);
      background: rgba(255,166,60,.12);
      color: rgba(255,230,190,.95);
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      display:none;
      align-items:center;
      gap:10px;
    }
    .timerBadge.on{
      display:flex;
      animation: pulseOrange 1.6s ease-in-out infinite;
    }
    @keyframes pulseOrange{
      0%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      35%{ box-shadow: 0 0 0 10px rgba(255,166,60,.14) }
      70%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
      100%{ box-shadow: 0 0 0 0 rgba(255,166,60,.0) }
    }

    /* Small toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 60;
      font-weight:700;
      font-size:13px;
    }
    .toast.on{ display:block; }
  
/* --- Cursor: crosshair inside game/preview --- */
#previewFrame { cursor: crosshair; }
body[data-mode="game"] .gameRoot,
body[data-mode="game"] .gameRoot * { cursor: crosshair; }
body[data-mode="game"] .gameRoot input,
body[data-mode="game"] .gameRoot textarea { cursor: text; }
body[data-mode="game"] .gameRoot a { cursor: pointer; }


/* ==== Custom crosshair (works inside Genially overlays) ==== */
body.game-cursor { cursor: none !important; }
#aimCursor{
  position: fixed;
  left: -100px;
  top: -100px;
  width: 54px;
  height: 54px;
  transform: translate(-50%,-50%);
  pointer-events: none;
  z-index: 2147483647;
  opacity: 0;
  transition: opacity .12s ease;
}
#aimCursor .ring{
  position:absolute; inset:0;
  border: 2px solid rgba(255,190,90,.9);
  border-radius: 999px;
  box-shadow: 0 0 0 2px rgba(0,0,0,.35), 0 0 16px rgba(255,170,60,.18);
  background: radial-gradient(circle at 50% 50%, rgba(255,190,90,.08), transparent 60%);
}
#aimCursor .h, #aimCursor .v{
  position:absolute;
  left:50%; top:50%;
  background: rgba(255,190,90,.95);
  box-shadow: 0 0 10px rgba(255,170,60,.25);
}
#aimCursor .h{ width: 64px; height: 2px; transform: translate(-50%,-50%); }
#aimCursor .v{ width: 2px; height: 64px; transform: translate(-50%,-50%); }
#aimCursor .dot{
  position:absolute; left:50%; top:50%;
  width: 6px; height: 6px;
  border-radius: 999px;
  transform: translate(-50%,-50%);
  background: rgba(255,190,90,.95);
}


.cornerLogo{position:fixed;top:14px;right:14px;z-index:1000;width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));opacity:.95;pointer-events:none;}

/* v27 tweaks */
.topBrand{position:fixed;left:18px;top:14px;z-index:9999;pointer-events:none;opacity:.98;filter:drop-shadow(0 10px 24px rgba(0,0,0,.55));display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:14px;background:linear-gradient(180deg, rgba(18,24,33,.58), rgba(10,12,16,.35));border:1px solid rgba(255,255,255,.12);backdrop-filter: blur(8px);}
.topBrand img{height:34px;width:auto;border-radius:10px;display:block;}
.topBrand span{font-weight:800;font-size:13px;letter-spacing:.2px;color:rgba(255,255,255,.92);text-shadow:0 8px 22px rgba(0,0,0,.55);}
/* stronger 3D/parallax background */
.arenaBg{will-change:transform,filter;transform:translate3d(var(--bgx,0px),var(--bgy,0px),0) scale(1.10);filter:saturate(1.05) contrast(1.08);}
.arenaBg::after{content:"";position:absolute;inset:0;background:radial-gradient(1200px 600px at 40% 35%, rgba(255,255,255,.10), rgba(0,0,0,.45) 65%, rgba(0,0,0,.70));mix-blend-mode:overlay;pointer-events:none;}
.hudGoals{animation:goalFloat 3.8s ease-in-out infinite;}
@keyframes goalFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}

</style>
</head>
<body>
  <div class="topBrand" aria-hidden="true">
    <img src="63.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'"/>
    <span>–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</span>
  </div>
<div id="root"></div>

<div class="toast" id="toast"></div>

<script>
/* ===========================
   –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä
   Version 23 ‚Äî editor+game
   =========================== */

const VERSION = 24;

/* ---------- helpers ---------- */
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('on');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1600);
}

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

/* base64url */
function b64uEncode(obj){
  const json = JSON.stringify(obj);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64uDecode(str){
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while(str.length % 4) str += '=';
  const json = decodeURIComponent(escape(atob(str)));
  return JSON.parse(json);
}

function urlOfSelf(){
  return location.origin + location.pathname;
}

/* ---------- Default config ---------- */
function defaultCfg(){
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä",
    teamsCount: 2,
    autoNextTeam: true,
    latex: false,
    bg: "bg_forest.jpg.png",
    shot: { variant:"pif", volume:0.7 },
    questions: []
  };
}

/* ---------- LaTeX (optional) ---------- */
let katexLoaded = false;
async function ensureKatex(){
  if(katexLoaded) return;
  katexLoaded = true;
  const css = document.createElement('link');
  css.rel = 'stylesheet';
  css.href = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css";
  document.head.appendChild(css);

  const s1 = document.createElement('script');
  s1.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js";
  s1.defer = true;
  document.head.appendChild(s1);

  const s2 = document.createElement('script');
  s2.src = "https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js";
  s2.defer = true;
  document.head.appendChild(s2);

  await new Promise(res=> s2.onload = res);
}
function renderLatexIn(el){
  if(!window.renderMathInElement) return;
  try{
    window.renderMathInElement(el, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true},
      ]
    });
  }catch(e){}
}

/* ---------- Shot sound (WebAudio synth, no infinite loop) ---------- */
const AudioKit = (() => {
  let ctx = null;
  let master = null;

  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 1.2;
    master.connect(ctx.destination);
  }
  async function unlock(){
    ensure();
    if(ctx.state === 'suspended') await ctx.resume();
  }
  function setVolume(v){
    ensure();
    master.gain.value = clamp(v, 0, 1) * 2.2;
  }
  function noiseBuffer(){
    ensure();
    const bufferSize = ctx.sampleRate * 0.15;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * (1 - i/data.length);
    return buffer;
  }

  function playVariant(variant){
    ensure();
    const t0 = ctx.currentTime;
    const out = ctx.createGain();
    out.gain.value = 1.25;
    out.connect(master);

    if(variant === 'snap'){ // click
      const osc = ctx.createOscillator();
      osc.type = 'square';
      osc.frequency.setValueAtTime(220, t0);
      osc.frequency.exponentialRampToValueAtTime(880, t0+0.03);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.6, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.08);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.09);
    } else if(variant === 'boom'){ // low thump + noise
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(90, t0);
      osc.frequency.exponentialRampToValueAtTime(45, t0+0.12);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.9, t0+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.22);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.24);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const nf = ctx.createBiquadFilter();
      nf.type = 'lowpass'; nf.frequency.setValueAtTime(800, t0);
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.4, t0+0.015);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.18);
      n.connect(nf).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.19);
    } else { // 'pif' default
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(520, t0);
      osc.frequency.exponentialRampToValueAtTime(220, t0+0.08);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.85, t0+0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+0.12);
      osc.connect(g).connect(out);
      osc.start(t0);
      osc.stop(t0+0.14);

      const n = ctx.createBufferSource();
      n.buffer = noiseBuffer();
      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.setValueAtTime(1800, t0); bp.Q.value = 3;
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t0);
      ng.gain.exponentialRampToValueAtTime(0.25, t0+0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.09);
      n.connect(bp).connect(ng).connect(out);
      n.start(t0);
      n.stop(t0+0.10);
    }

    out.gain.setValueAtTime(1, t0);
    out.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
    setTimeout(()=>{ try{out.disconnect()}catch(e){} }, 500);
  }

  return { ensure, unlock, setVolume, playVariant };
})();

/* ---------- App mode detection ---------- */
const params = new URLSearchParams(location.search);
const isGame = params.has('game');

// ===== Crosshair overlay (needed for Genially where CSS cursor can be ignored) =====
function enableCrosshairOverlay(){
  if(document.getElementById('aimCursor')) return;
  document.body.classList.add('game-cursor');

  const el = document.createElement('div');
  el.id = 'aimCursor';
  el.innerHTML = '<div class="ring"></div><div class="h"></div><div class="v"></div><div class="dot"></div>';
  document.body.appendChild(el);

  const arena = document.getElementById('arena') || document.body;

  const show = () => { el.style.opacity = '1'; };
  const hide = () => { el.style.opacity = '0'; };

  const move = (e) => {
    // Use clientX/Y so it works in iframes and Genially embeds
    el.style.left = e.clientX + 'px';
    el.style.top  = e.clientY + 'px';
    // show on first move
    if(el.style.opacity !== '1') el.style.opacity = '1';
  };

  // Prefer listening on arena; also listen on window as fallback
  arena.addEventListener('mousemove', move, {passive:true});
  window.addEventListener('mousemove', move, {passive:true});

  arena.addEventListener('mouseenter', show, {passive:true});
  arena.addEventListener('mouseleave', hide, {passive:true});

  // Touch devices: keep default cursor (no-op)
  if('ontouchstart' in window){
    document.body.classList.remove('game-cursor');
    el.remove();
  }
}

if(isGame){
  // Delay to ensure #arena exists
  setTimeout(enableCrosshairOverlay, 0);
}


/* ===========================
   GAME MODE
   =========================== */
function mountGame(cfg){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="gameRoot">
      <div class="arena" id="arena">
        <div class="arenaBg arenaBg3d" id="arenaBg"></div>

        <div class="hud">
          <div class="hudLeft">
            <div class="gameTitle" id="gTitle"></div>
            <div class="gameHint">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É ‚Üí –Ω–∞–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ü–µ–ª ‚Üí –≤—ã—Å—Ç—Ä–µ–ª–∏—Ç–µ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ</div>
          </div>
          <div class="hudRight">
            <div class="hudStat" id="hudTurn">–°–µ–π—á–∞—Å —Å—Ç—Ä–µ–ª—è–µ—Ç: <b id="turnTeam">‚Äî</b></div>
            <div class="hudStat hudGoals">–¶–µ–ª–∏: <b id="hudTargets">0/0</b></div>
            <button class="pillBtn" id="btnHelp">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="pillBtn" id="btnReset">–°–±—Ä–æ—Å</button>
          </div>
        </div>

        <div class="teams" id="teams"></div>

        <div class="targets" id="targets"></div>

        <div class="modalBackdrop" id="modalBack">
          <div class="modal">
            <div class="timerBadge" id="timerBadge">‚è± <span id="timerText">30</span> —Å–µ–∫</div>
            <div class="modalHeader">
              <div class="h" id="qHeader">–í–æ–ø—Ä–æ—Å</div>
              <button class="modalClose" id="btnClose">Esc</button>
            </div>
            <div class="modalBody">
              <div class="qText" id="qText"></div>
              <div class="mediaRow" id="qMedia"></div>
              <div id="answersWrap"></div>
            </div>
          </div>
        </div>

        <div class="versionBadge">–í–µ—Ä—Å–∏—è ${VERSION} ‚Ä¢ game</div>
      </div>
    </div>
  `;

  const arena = document.getElementById('arena');
  const bg = document.getElementById('arenaBg');

  function setBg(){
    const u = cfg.bg || "";
    bg.style.backgroundImage = u ? `url("${u}")` : 'none';
  }
  setBg();

  // Parallax 3d
  arena.addEventListener('mousemove', (e)=>{
    const r = arena.getBoundingClientRect();
    const x = (e.clientX - r.left)/r.width - 0.5;
    const y = (e.clientY - r.top)/r.height - 0.5;
    bg.style.transform = `scale(1.08) translate(${x*10}px, ${y*10}px)`;
  });
  arena.addEventListener('mouseleave', ()=> bg.style.transform = `scale(1.06)`);

  document.getElementById('gTitle').textContent = cfg.title || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";

  // state
  const teamCount = clamp(Number(cfg.teamsCount||2),1,3);
  const teamNames = Array.from({length: teamCount}, (_,i)=>`–ö–æ–º–∞–Ω–¥–∞ ${i+1}`);
  const scores = Array.from({length: teamCount}, ()=>0);
  let currentTeam = 0;

  // targets = one per question
  const questions = Array.isArray(cfg.questions)? cfg.questions : [];
  const hit = new Set();
  let activeQIndex = null;
  let countdownId = null;
  let timeLeft = 0;

  const teamsEl = document.getElementById('teams');
  const targetsEl = document.getElementById('targets');
  const hudTargets = document.getElementById('hudTargets');
  const turnTeamEl = document.getElementById('turnTeam');

  function renderTeams(){
    teamsEl.style.gridTemplateColumns = `repeat(${teamCount}, minmax(0,1fr))`;
    teamsEl.innerHTML = '';
    for(let i=0;i<teamCount;i++){
      const card = document.createElement('div');
      card.className = 'teamCard';
      card.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input class="teamNameInput" value="${teamNames[i]}" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã ${i+1}"/>
          <div class="teamNow"><span class="dot ${i===currentTeam?'on':''}"></span> ${i===currentTeam?'–°–µ–π—á–∞—Å':'–ù–µ —Å–µ–π—á–∞—Å'}</div>
        </div>
        <div class="teamScore" id="score_${i}">${scores[i]}</div>
      `;
      const inp = card.querySelector('input');
      inp.addEventListener('input', ()=>{ teamNames[i] = inp.value || `–ö–æ–º–∞–Ω–¥–∞ ${i+1}`; renderTurn(); });
      teamsEl.appendChild(card);
    }
  }
  function renderTurn(){
    turnTeamEl.textContent = teamNames[currentTeam] || `–ö–æ–º–∞–Ω–¥–∞ ${currentTeam+1}`;
    $$('.teamCard', teamsEl).forEach((c,idx)=>{
      const d = c.querySelector('.dot');
      d.classList.toggle('on', idx===currentTeam);
      c.querySelector('.teamNow').lastChild.textContent = idx===currentTeam ? ' –°–µ–π—á–∞—Å' : ' –ù–µ —Å–µ–π—á–∞—Å';
    });
  }
  function renderScores(){
    for(let i=0;i<teamCount;i++){
      const s = document.getElementById(`score_${i}`);
      if(s) s.textContent = scores[i];
    }
  }

  function countDone(){ return hit.size; }

  function positionTargets(){
    const n = questions.length;
    const pts = [];
    for(let i=0;i<n;i++){
      const col = (i % 6);
      const row = Math.floor(i / 6);
      const x = 12 + col*(76/5);
      const y = 22 + row*10;
      pts.push({x, y});
    }
    const maxY = pts.reduce((m,p)=>Math.max(m,p.y), 0);
    const scaleY = maxY > 55 ? (55-22)/(maxY-22) : 1;
    pts.forEach(p=>{
      p.y = 22 + (p.y-22)*scaleY;
      p.x += (Math.random()*2-1)*3;
      p.y += (Math.random()*2-1)*2;
    });
    return pts;
  }

  function renderTargets(){
    targetsEl.innerHTML = '';
    const n = questions.length;
    const pts = positionTargets();
    for(let i=0;i<n;i++){
      const q = questions[i];
      const el = document.createElement('div');
      el.className = 'target' + (hit.has(i)?' hit':'');
      el.style.left = (pts[i]?.x ?? 50) + '%';
      el.style.top  = (pts[i]?.y ?? 40) + '%';
      el.innerHTML = `
        <div class="tNum">${i+1}</div>
        <div class="tPts">${Number(q.points||10)} –æ—á–∫.</div>
      `;
      el.addEventListener('click', async ()=>{
        if(hit.has(i)) return;
        await AudioKit.unlock();
        AudioKit.setVolume(cfg.shot?.volume ?? 0.7);
        AudioKit.playVariant(cfg.shot?.variant ?? 'pif');
        openQuestion(i);
      });
      targetsEl.appendChild(el);
    }
    hudTargets.textContent = `${countDone()}/${n}`;
  }

  // modal logic
  const modalBack = document.getElementById('modalBack');
  const qHeader = document.getElementById('qHeader');
  const qText = document.getElementById('qText');
  const qMedia = document.getElementById('qMedia');
  const answersWrap = document.getElementById('answersWrap');
  const btnClose = document.getElementById('btnClose');
  const timerBadge = document.getElementById('timerBadge');
  const timerText = document.getElementById('timerText');

  function closeModal(){
    modalBack.classList.remove('on');
    activeQIndex = null;
    stopTimer();
  }

  function stopTimer(){
    if(countdownId){ clearInterval(countdownId); countdownId = null; }
    timerBadge.classList.remove('on');
  }

  function startTimer(seconds){
    stopTimer();
    timeLeft = seconds;
    timerText.textContent = String(timeLeft);
    timerBadge.classList.add('on');
    countdownId = setInterval(()=>{
      timeLeft--;
      timerText.textContent = String(timeLeft);
      if(timeLeft <= 0){
        stopTimer();
        finalizeQuestion(false, true);
      }
    }, 1000);
  }

  function finalizeQuestion(isCorrect, timedOut=false){
    if(activeQIndex === null) return;
    const idx = activeQIndex;
    const q = questions[idx];
    if(!hit.has(idx)){
      hit.add(idx);
      if(isCorrect){
        scores[currentTeam] += Number(q.points||10);
        renderScores();
      }
      const t = targetsEl.children[idx];
      if(t) t.classList.add('hit');
      hudTargets.textContent = `${countDone()}/${questions.length}`;
    }

    if(cfg.autoNextTeam){
      currentTeam = (currentTeam + 1) % teamCount;
      renderTeams();
      renderTurn();
      renderScores();
    }
    closeModal();
  }

  function makeMediaTag(icon, label, url){
    const span = document.createElement('span');
    span.className = 'mediaTag';
    span.innerHTML = `<span aria-hidden="true">${icon}</span> <span>${label}</span>`;
    span.title = url;
    return span;
  }

  async function openQuestion(i){
    activeQIndex = i;
    const q = questions[i];

    qHeader.textContent = `–í–æ–ø—Ä–æ—Å #${i+1}`;
    qText.textContent = q.text || '';
    qMedia.innerHTML = '';
    answersWrap.innerHTML = '';

    if(cfg.latex){
      await ensureKatex();
      qText.innerHTML = q.text ? String(q.text) : '';
    }

    if(q.image){
      qMedia.appendChild(makeMediaTag('üñºÔ∏è', '–∫–∞—Ä—Ç–∏–Ω–∫–∞', q.image));
    }
    if(q.audio){
      qMedia.appendChild(makeMediaTag('üéµ', '–º—É–∑—ã–∫–∞', q.audio));
      try{
        const a = new Audio(q.audio);
        a.volume = 0.9;
        a.play().catch(()=>{});
      }catch(e){}
    }

    if(q.type === 'input'){
      const wrap = document.createElement('div');
      wrap.className = 'inputRow';
      wrap.innerHTML = `
        <input id="ansInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶" autocomplete="off"/>
        <button class="primary" id="btnSend">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        <button class="secondary" id="btnSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      `;
      answersWrap.appendChild(wrap);

      const correctList = String(q.correct||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

      const check = ()=>{
        const v = (document.getElementById('ansInput').value||'').trim().toLowerCase();
        const ok = correctList.length ? correctList.includes(v) : (v.length>0);
        finalizeQuestion(ok);
      };
      document.getElementById('btnSend').addEventListener('click', check);
      document.getElementById('ansInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
      document.getElementById('btnSkip').addEventListener('click', ()=>finalizeQuestion(false));
    } else {
      const opts = Array.isArray(q.options) ? q.options : [];
      const grid = document.createElement('div');
      grid.className = 'answers';
      answersWrap.appendChild(grid);

      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      opts.forEach((opt, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ansBtn';
        btn.innerHTML = `<div class="ansKey">${letters[idx] || (idx+1)}</div><div class="ansText">${opt?.text ?? ''}</div>`;
        btn.addEventListener('click', ()=>{
          const ok = !!opt?.correct;
          finalizeQuestion(ok);
        });
        grid.appendChild(btn);
      });

      const foot = document.createElement('div');
      foot.style.display = 'flex';
      foot.style.justifyContent = 'flex-end';
      foot.style.marginTop = '8px';
      foot.innerHTML = `<button class="secondary" id="btnSkip2">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>`;
      answersWrap.appendChild(foot);
      document.getElementById('btnSkip2').addEventListener('click', ()=>finalizeQuestion(false));
    }

    modalBack.classList.add('on');

    if(q.timerEnabled && Number(q.timerSeconds||0) > 0){
      startTimer(Number(q.timerSeconds));
    } else {
      stopTimer();
    }

    if(cfg.latex){
      setTimeout(()=>{ renderLatexIn(document.querySelector('.modal')); }, 0);
    }
  }

  document.getElementById('btnHelp').addEventListener('click', ()=>{
    toast("–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏ ‚Üí –æ—Ç–≤–µ—Ç—å—Ç–µ. –û—á–∫–∏ –∏–¥—É—Ç —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥–µ.");
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    hit.clear();
    for(let i=0;i<scores.length;i++) scores[i]=0;
    currentTeam = 0;
    renderTargets();
    renderTeams();
    renderTurn();
    renderScores();
    closeModal();
    toast("–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω");
  });
  btnClose.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  renderTeams();
  renderTurn();
  renderScores();
  renderTargets();
}

/* ===========================
   EDITOR MODE
   =========================== */
function mountEditor(){
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="app">
      <div class="panel">
        <div class="panelHeader">
          <div>
            <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä<br>¬´–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä¬ª</div>
            <div class="subtitle"></div>
          </div>
          <button class="btn btnGold" id="copyIframe">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        </div>

        <div class="scroll">
          <div class="section">
            <h3>–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
            <div class="row1">
              <div>
                <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
                <input id="inpTitle" type="text" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä"/>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
            <div class="row">
              <div>
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (1‚Äì3)</label>
                <select id="teamsCount">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div>
                <label>–ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞</label>
                <select id="autoNext">
                  <option value="true" selected>–í–∫–ª—é—á—ë–Ω</option>
                  <option value="false">–í—ã–∫–ª—é—á–µ–Ω</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>LaTeX (–≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã)</label>
                <select id="latexToggle">
                  <option value="false" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
                  <option value="true">–í–∫–ª—é—á—ë–Ω</option>
                </select>
              </div>
              <div>
                <label>–§–æ–Ω –∏–≥—Ä—ã</label>
                <select id="bgSelect" class="select">
                  <option value="1.png">1</option>
                  <option value="2.png" selected>2</option>
                  <option value="3.png">3</option>
                  <option value="4.png">4</option>
                  <option value="5.png">5</option>
                  <option value="6.png">6</option>
                  <option value="7.png">7</option>
                  <option value="8.png">8</option>
                </select>
                <input id="bgInput" type="hidden" value="2.png"/>
              </div>
            </div>
            <div class="help">–ï—Å–ª–∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å <b>index.html</b> ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–µ–Ω–∏. –í–∞–∂–Ω–æ —Ç–æ—á–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞.</div>
            <div class="row">
              <div class="field">
                <label>–ú–∏—à–µ–Ω–∏ (–∫–∞—Ä—Ç–∏–Ω–∫–∞)</label>
                <select id="targetSelect" class="select">
                  <option value="10.png">10</option>
                  <option value="11.png">11</option>
                  <option value="12.png">12</option>
                  <option value="13.png" selected>13</option>
                  <option value="14.png">14</option>
                </select>
                <input id="targetInput" type="hidden" value="13.png"/>
              </div>
              <div class="field">
                <label>–ü–æ–∑–∏—Ü–∏–∏ –º–∏—à–µ–Ω–µ–π</label>
                <div class="hint">–ú–∏—à–µ–Ω–∏ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –≤ –æ—Ç–º–µ—á–µ–Ω–Ω–æ–π –∑–æ–Ω–µ –Ω–∞ —Ñ–æ–Ω–µ.</div>
              </div>
            </div>
            <div class="help">–§–∞–π–ª—ã –º–∏—à–µ–Ω–µ–π: 10.png ‚Ä¶ 14.png (—Ä—è–¥–æ–º —Å index.html).</div>

          </div>

          <div class="section">
            <h3>–ó–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞</h3>
            <div class="soundRow">
              <div>
                <label>–í–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ)</label>
                <select id="shotVariant">
                  <option value="pif" selected>–ö–æ—Ä–æ—Ç–∫–∏–π ¬´–ø–∏—Ñ¬ª</option>
                  <option value="snap">–©–µ–ª—á–æ–∫ ¬´—Å–Ω–∞–ø¬ª</option>
                  <option value="boom">–ì–ª—É—Ö–æ–π ¬´–±—É–º¬ª</option>
                </select>
              </div>
              <div>
                <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
                <input id="shotVol" class="range" type="range" min="0" max="1" step="0.01" value="0.7"/>
              </div>
            </div>
            <div class="help">–í –∏–≥—Ä–µ –∑–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ –∑–≤—É—á–∏—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–∏—à–µ–Ω–∏.</div>
          </div>

          <div class="section">
            <div class="split">
              <h3 style="margin:0">–í–æ–ø—Ä–æ—Å—ã</h3>
              <span class="pill">–í—Å–µ–≥–æ: <span id="qCount">0</span></span>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn btnGold" id="btnAdd">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btnDanger" id="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="help">–ú–∏—à–µ–Ω–µ–π –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤.</div>
            <div style="height:10px"></div>
            <div class="qList" id="qList"></div>
          </div>
</div>
      </div>

      <div class="panel previewWrap">
        <div class="previewHeader">
          <div>
            <div class="title2">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
            <div class="muted">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–∞–∫ –≤ Genially)</div>
          </div>
          <div class="muted">—Ñ–æ–Ω + –º–∏—à–µ–Ω–∏ + –≤–æ–ø—Ä–æ—Å—ã</div>
        </div>
        <iframe class="previewFrame" id="previewFrame" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>

    <div class="versionBadge">–í–µ—Ä—Å–∏—è ${VERSION} ‚Ä¢ editor+game</div>

    <!-- Question editor modal -->
    <div class="modalBackdrop" id="editBack" style="z-index:80;">
      <div class="modal">
        <div class="modalHeader">
          <div class="h" id="editHdr">–í–æ–ø—Ä–æ—Å</div>
          <button class="modalClose" id="editClose">Esc</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div>
              <label>–û—á–∫–∏</label>
              <input id="editPoints" type="number" min="0" step="1" value="10"/>
            </div>
            <div>
              <label>–¢–∞–π–º–µ—Ä</label>
              <select id="editTimerMode">
                <option value="off" selected>–í—ã–∫–ª—é—á–µ–Ω</option>
                <option value="on">–í–∫–ª—é—á—ë–Ω</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>–°–µ–∫—É–Ω–¥—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)</label>
              <input id="editTimerSec" type="number" min="1" step="1" value="30"/>
            </div>
            <div>
              <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
              <select id="editType">
                <option value="choice" selected>–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
                <option value="input">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
              </select>
            </div>
          </div>

          <div class="row1">
            <div>
              <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
              <textarea id="editText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å‚Ä¶"></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="editImg" type="text" placeholder="https://..."/>
            </div>
            <div>
              <label>üéµ –ú—É–∑—ã–∫–∞ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="editAud" type="text" placeholder="https://..."/>
            </div>
          </div>

          <div id="choiceBox">
            <div class="split">
              <div style="font-weight:900;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
              <div class="pill">–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</div>
            </div>
            <div id="optList" class="qList" style="margin-top:10px;"></div>
            <div style="display:flex; gap:10px;">
              <button class="btn btnGold" id="btnAddOpt">Ôºã –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
            </div>
            <div class="help">–û—Ç–º–µ—Ç—å—Ç–µ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∫ ¬´–≤–µ—Ä–Ω—ã–π¬ª (—Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∞).</div>
          </div>

          <div id="inputBox" style="display:none;">
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="editCorrect" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 12, –¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å"/>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:4px;">
            <button class="secondary" id="btnCancelQ">–û—Ç–º–µ–Ω–∞</button>
            <button class="primary" id="btnSaveQ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          </div>
        </div>
      </div>
    </div>
  `;

  let cfg = defaultCfg();
  let editingIndex = null;

  const inpTitle = document.getElementById('inpTitle');
  const teamsCount = document.getElementById('teamsCount');
  const autoNext = document.getElementById('autoNext');
  const latexToggle = document.getElementById('latexToggle');
  const bgInput = document.getElementById('bgInput');
  const bgSelect = document.getElementById('bgSelect');
  const targetInput = document.getElementById('targetInput');
  const targetSelect = document.getElementById('targetSelect');
  const shotVariant = document.getElementById('shotVariant');
  const shotVol = document.getElementById('shotVol');
  const qCount = document.getElementById('qCount');
  const qList = document.getElementById('qList');
  const previewFrame = document.getElementById('previewFrame');

  function readCfgFromUI(){
    cfg.title = inpTitle.value || "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä";
    cfg.teamsCount = clamp(Number(teamsCount.value||2),1,3);
    cfg.autoNextTeam = (autoNext.value === 'true');
    cfg.latex = (latexToggle.value === 'true');
    cfg.bg = (bgInput.value || "bg_forest.jpg.png").trim();
    cfg.shot.variant = shotVariant.value;
    cfg.shot.volume = clamp(Number(shotVol.value||0.7),0,1);
  }

  async function updatePreview(){
    readCfgFromUI();
    if(cfg.latex) ensureKatex();
    const gameUrl = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}&t=${Date.now()}`;
    previewFrame.src = gameUrl;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function renderQuestionList(){
    qCount.textContent = String(cfg.questions.length);
    qList.innerHTML = '';
    cfg.questions.forEach((q, idx)=>{
      const item = document.createElement('div');
      item.className = 'qItem';
      const t = (q.text || '').trim() || '(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)';
      const meta = `${q.type==='input'?'–í–≤–æ–¥':'–í—ã–±–æ—Ä'} ‚Ä¢ ${Number(q.points||10)} –æ—á–∫. ‚Ä¢ ${q.timerEnabled? (q.timerSeconds+' —Å–µ–∫') : '–±–µ–∑ —Ç–∞–π–º–µ—Ä–∞'}`;
      item.innerHTML = `
        <div>
          <div class="qTitle">${idx+1}. ${escapeHtml(t)}</div>
          <div class="qMeta">${meta}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="iconBtn danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        </div>
      `;
      item.querySelector('.iconBtn').addEventListener('click', ()=> openEdit(idx));
      item.querySelector('.iconBtn.danger').addEventListener('click', ()=>{
        cfg.questions.splice(idx,1);
        renderQuestionList();
        updatePreview();
      });
      qList.appendChild(item);
    });
  }

  async function playShotPreview(){
    readCfgFromUI();
    await AudioKit.unlock();
    AudioKit.setVolume(cfg.shot.volume);
    AudioKit.playVariant(cfg.shot.variant);
  }
  shotVariant.addEventListener('change', playShotPreview);
  shotVol.addEventListener('input', ()=>{
    readCfgFromUI();
    AudioKit.setVolume(cfg.shot.volume);
  });

  document.getElementById('copyIframe').addEventListener('click', async ()=>{
    readCfgFromUI();
    const src = urlOfSelf() + `?game=${encodeURIComponent(b64uEncode(cfg))}&v=${VERSION}`;
    const code = `<iframe src="${src}" style="width:100%;height:600px;border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    try{
      await navigator.clipboard.writeText(code);
      toast("iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = code;
      document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      ta.remove();
      toast("iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }
  });

  [inpTitle, teamsCount, autoNext, latexToggle, bgInput].forEach(el=>{
    el.addEventListener('change', updatePreview);
    el.addEventListener('input', ()=>{ if(el===inpTitle || el===bgInput) updatePreview(); });
  });

  document.getElementById('btnAdd').addEventListener('click', ()=> openEdit(null));
  document.getElementById('btnClear').addEventListener('click', ()=>{
    cfg.questions = [];
    renderQuestionList();
    updatePreview();
  });

  const editBack = document.getElementById('editBack');
  const editHdr = document.getElementById('editHdr');
  const editClose = document.getElementById('editClose');
  const editPoints = document.getElementById('editPoints');
  const editTimerMode = document.getElementById('editTimerMode');
  const editTimerSec = document.getElementById('editTimerSec');
  const editType = document.getElementById('editType');
  const editText = document.getElementById('editText');
  const editImg = document.getElementById('editImg');
  const editAud = document.getElementById('editAud');
  const choiceBox = document.getElementById('choiceBox');
  const inputBox = document.getElementById('inputBox');
  const editCorrect = document.getElementById('editCorrect');
  const optList = document.getElementById('optList');

  function closeEdit(){
    editBack.classList.remove('on');
    editingIndex = null;
  }
  editClose.addEventListener('click', closeEdit);
  document.getElementById('btnCancelQ').addEventListener('click', closeEdit);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editBack.classList.contains('on')) closeEdit(); });

  function newQuestion(){
    return {
      type: 'choice',
      text: '',
      points: 10,
      timerEnabled: false,
      timerSeconds: 30,
      image: '',
      audio: '',
      options: [
        {text:'', correct:true},
        {text:'', correct:false},
        {text:'', correct:false}
      ],
      correct: ''
    };
  }

  function renderOptions(q){
    optList.innerHTML = '';
    q.options = Array.isArray(q.options) && q.options.length ? q.options : [{text:'', correct:true}];
    q.options.forEach((o, idx)=>{
      const row = document.createElement('div');
      row.className = 'qItem';
      row.style.gridTemplateColumns = "1fr auto";
      row.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <input type="text" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞" value="${escapeHtml(o.text||'')}" />
          <label style="margin:0; display:flex; align-items:center; gap:8px; white-space:nowrap; color:rgba(255,255,255,.78);">
            <input type="radio" name="correctOpt" ${o.correct?'checked':''}/>
            –≤–µ—Ä–Ω—ã–π
          </label>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn danger" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>
      `;
      const inp = row.querySelector('input[type="text"]');
      inp.addEventListener('input', ()=>{ o.text = inp.value; });
      const radio = row.querySelector('input[type="radio"]');
      radio.addEventListener('change', ()=>{
        q.options.forEach(x=>x.correct=false);
        o.correct = true;
      });
      row.querySelector('.iconBtn.danger').addEventListener('click', ()=>{
        q.options.splice(idx,1);
        if(!q.options.some(x=>x.correct) && q.options[0]) q.options[0].correct = true;
        renderOptions(q);
      });
      optList.appendChild(row);
    });
  }

  function syncTypeUI(){
    const t = editType.value;
    if(t === 'input'){
      choiceBox.style.display = 'none';
      inputBox.style.display = 'block';
    }else{
      choiceBox.style.display = 'block';
      inputBox.style.display = 'none';
    }
  }
  editType.addEventListener('change', syncTypeUI);

  function openEdit(index){
    editingIndex = index;
    const q = (index===null || index===undefined) ? newQuestion() : deepClone(cfg.questions[index]);

    editHdr.textContent = (index===null || index===undefined) ? "–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å" : `–í–æ–ø—Ä–æ—Å #${index+1}`;
    editPoints.value = Number(q.points||10);
    editTimerMode.value = q.timerEnabled ? 'on' : 'off';
    editTimerSec.value = Number(q.timerSeconds||30);
    editType.value = q.type || 'choice';
    editText.value = q.text || '';
    editImg.value = q.image || '';
    editAud.value = q.audio || '';
    editCorrect.value = q.correct || '';

    syncTypeUI();
    renderOptions(q);

    document.getElementById('btnAddOpt').onclick = ()=>{
      q.options.push({text:'', correct: q.options.length===0});
      renderOptions(q);
    };

    document.getElementById('btnSaveQ').onclick = ()=>{
      q.points = Number(editPoints.value||10);
      q.timerEnabled = (editTimerMode.value === 'on');
      q.timerSeconds = Number(editTimerSec.value||30);
      q.type = editType.value;
      q.text = editText.value || '';
      q.image = (editImg.value || '').trim();
      q.audio = (editAud.value || '').trim();
      q.correct = (editCorrect.value || '').trim();

      if(q.type === 'choice'){
        q.options = (q.options||[]).map(x=>({text: x.text||'', correct: !!x.correct}));
        if(!q.options.length) q.options = [{text:'', correct:true}];
        if(!q.options.some(x=>x.correct)) q.options[0].correct = true;
      }else{
        q.options = [];
      }

      if(index===null || index===undefined){
        cfg.questions.push(q);
      }else{
        cfg.questions[index] = q;
      }
      renderQuestionList();
      updatePreview();
      closeEdit();
      toast("–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    };

    editBack.classList.add('on');
  }

  renderQuestionList();
  updatePreview();
}

/* ---------- Boot ---------- */
(function boot(){
  const unlock = async ()=>{ try{ await AudioKit.unlock(); }catch(e){} };
  window.addEventListener('pointerdown', unlock, {once:true});

  if(isGame){
    let cfg = defaultCfg();
    try{
      cfg = b64uDecode(params.get('game'));
    }catch(e){}
    cfg = Object.assign(defaultCfg(), cfg || {});
    cfg.questions = Array.isArray(cfg.questions) ? cfg.questions : [];
    cfg.shot = Object.assign({variant:'pif', volume:0.7}, cfg.shot || {});
    mountGame(cfg);
  } else {
    mountEditor();
  }
})();
</script>
</body>
</html>
