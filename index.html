<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä ‚Äî Editor + Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Neucha&family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Lato:wght@400;700&family=Oswald:wght@400;700&family=Poppins:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --text: #eaf0ff; --muted: #a9b6e6;
      --neon-orange-base: #d99a29; 
      --neon-orange-glow: rgba(217, 154, 41, 0.35);
      --neon-box-shadow: 0 0 4px var(--neon-orange-glow), 0 0 12px var(--neon-orange-glow), inset 0 0 4px rgba(217, 154, 41, 0.15);
      --shadow: 0 14px 40px rgba(0,0,0,0.5);
    }
    
    * { box-sizing: border-box; font-family: 'Roboto', system-ui, sans-serif; }
    html, body { height: 100%; margin: 0; background: #0a0f15; color: var(--text); overflow: hidden; }
    
    body.editor-mode { background: radial-gradient(1100px 700px at 12% 18%, rgba(217, 154, 41, 0.12) 0%, rgba(5,8,22,0) 58%), #050816; }
    body.game-mode { background: #000; }

    .app { display: grid; grid-template-columns: 480px 1fr; gap: 14px; padding: 14px; height: 100vh; max-width: 1600px; margin: 0 auto; }
    @media (max-width: 1020px) { .app { grid-template-columns: 1fr; } }
    
    .panel { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border: 1px solid rgba(217, 154, 41, 0.6); border-radius: 22px; box-shadow: var(--neon-box-shadow); backdrop-filter: blur(10px); display: flex; flex-direction: column; overflow: hidden; }
    .panel-header { padding: 12px 14px; border-bottom: 1px solid rgba(217, 154, 41, 0.3); display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap:wrap;}
    .panel-body { padding: 14px; overflow-y: auto; flex: 1; }
    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-thumb { background: rgba(217, 154, 41, 0.4); border-radius: 4px; }
    
    .section { background: rgba(15, 10, 5, 0.4); border: 1px solid rgba(217, 154, 41, 0.3); border-radius: 16px; padding: 12px; margin-bottom: 12px; }
    .section .title { font-weight: 900; font-size: 14px; color: var(--neon-orange-base); margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    label { display: block; font-size: 12px; color: rgba(255,255,255,.8); margin: 8px 0 4px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.3); color: #fff; outline: none; }
    input:focus, select:focus, textarea:focus { border-color: var(--neon-orange-base); box-shadow: 0 0 6px var(--neon-orange-glow); }
    textarea { resize: vertical; min-height: 70px; }
    input[type="range"] { width: 100%; accent-color: var(--neon-orange-base); }
    input[type="color"] { width: 40px; height: 40px; padding: 2px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: transparent; }
    
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 120px; }
    
    .btn { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(217, 154, 41, 0.5); background: rgba(217, 154, 41, 0.1); color: #fff; cursor: pointer; font-weight: 900; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn:hover { background: rgba(217, 154, 41, 0.2); box-shadow: 0 0 8px var(--neon-orange-glow); }
    .btn.primary { background: linear-gradient(90deg, rgba(217, 154, 41, 0.4), rgba(217, 120, 41, 0.3)); border-color: var(--neon-orange-base); }
    .btn.danger { border-color: #ff4d4d; background: rgba(255, 77, 77, 0.1); }
    .btn.danger:hover { background: rgba(255, 77, 77, 0.25); box-shadow: 0 0 10px rgba(255,77,77,0.4); }
    .btn.small { padding: 6px 10px; font-size: 12px; border-radius: 10px; }
    
    .preview-stage { flex: 1; background: #000; border-radius: 20px; overflow: hidden; position: relative; }
    iframe { width: 100%; height: 100%; border: 0; background: #000; }
    
    .q-list { display: flex; flex-direction: column; gap: 8px; }
    .q-item { padding: 10px; border-radius: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .q-item:hover { border-color: rgba(217, 154, 41, 0.4); }
    
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-backdrop.show { display: flex; }
    .modal { width: min(800px, 95%); background: #16110c; border: 1px solid var(--neon-orange-base); border-radius: 20px; box-shadow: var(--neon-box-shadow); max-height: 90vh; display: flex; flex-direction: column; }
    .modal-head { padding: 14px 20px; border-bottom: 1px solid rgba(217, 154, 41, 0.3); display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 18px; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-foot { padding: 14px 20px; border-top: 1px solid rgba(217, 154, 41, 0.3); display: flex; justify-content: flex-end; gap: 10px; }
    
    .topBrand { display: flex; align-items: center; gap: 10px; }
    .topBrand img { height: 36px; width: 36px; object-fit: contain; border-radius: 8px; }
    
    /* --- GAME UI --- */
    .gameRoot { position: absolute; inset: 0; overflow: hidden; background: #000; font-family: 'Roboto', sans-serif; cursor: var(--game-cursor, default); perspective: 1000px; }
    .arenaBg { position: absolute; inset: -25px; background-size: cover; background-position: center; transition: transform 0.15s ease-out; will-change: transform; cursor: var(--game-cursor, default); }
    
    .hud { position: absolute; top: 14px; left: 14px; right: 14px; pointer-events: none; z-index: 10; display:flex; justify-content:space-between; align-items:center; }
    .gameTitle { font-weight: 900; font-size: 24px; text-shadow: 0 4px 15px #000; color: #fff; }
    .teams { display: grid; gap: 10px; margin-top: 54px; padding:0 14px; pointer-events: auto; position:relative; z-index:10; cursor: default; }
    .teamCard { background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 10px; backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: space-between; transition: 0.3s; }
    .teamInput { background: transparent; border: none; outline: none; color: #fff; font-weight: 900; font-size: 16px; width: 100%; max-width: 150px; }
    
    /* Targets */
    .targets { position: absolute; inset: 0; pointer-events: none; z-index: 5; }
    .target { position: absolute; width: 90px; height: 90px; transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); pointer-events: auto; transition: transform 0.1s; cursor: var(--game-cursor, pointer); }
    .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)) scale(1.1); }
    .target .img { position: absolute; inset: 0; background-image: var(--target-img); background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.6)); }
    .target .num { position: absolute; inset: 0; display: grid; place-items: center; font-weight: 900; font-size: 24px; color: #fff; text-shadow: 0 2px 8px #000; }
    .target .pts { position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); border: 1px solid rgba(217,154,41,0.5); color: var(--neon-orange-base); padding: 2px 8px; border-radius: 8px; font-size: 12px; font-weight: 900; white-space: nowrap; pointer-events: none; backdrop-filter: blur(4px); text-shadow: 0 2px 4px #000; }
    .target.hit { opacity: 0; pointer-events: none; transform: translate(-50%, -50%) scale(0); transition: 0.3s ease; }
    
    .edit-mode .target { cursor: move !important; border: 2px dashed rgba(217, 154, 41, 0.8); border-radius: 50%; }
    .edit-mode .target:hover { transform: translate(-50%, -50%) translate(var(--orbit-x, 0px), var(--orbit-y, 0px)); }

    /* Crosshair */
    #gArena.aiming, #gArena.aiming * { cursor: none !important; }
    #aimCursor { position: absolute; pointer-events: none; z-index: 45; transform: translate(-50%, -50%); display: none; }
    #gArena.aiming #aimCursor { display: block; }

    /* Modals & Screens */
    .game-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 50; cursor: default; }
    .game-modal.on { display: flex; }
    .game-modal-content { background: #0a0d12; border: 1px solid var(--neon-orange-base); border-radius: 20px; padding: 24px; width: min(800px, 90%); box-shadow: 0 0 30px rgba(217,154,41,0.25); position:relative; max-height:90vh; overflow-y:auto; }
    .game-ans-btn { width: 100%; text-align: left; padding: 14px; margin-top: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; color: #fff; font-size: 18px; cursor: pointer; transition: 0.2s; }
    .game-ans-btn:hover { background: rgba(255,255,255,0.1); }
    .screen { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; text-align: center; cursor: default; }
    .screen.on { display: flex; }
    .screenCard { background: #111; border-radius: 20px; padding: 30px; border: 1px solid; max-width: 600px; width: 90%; }
    .resultRow { display:flex; justify-content:space-between; background:rgba(255,255,255,0.1); padding:12px 20px; border-radius:12px; margin-bottom:10px; font-size:18px; font-weight:bold; }
  </style>
</head>
<body>

<div class="app" id="editorApp" style="display:none;">
  <div class="panel">
    <div class="panel-header">
      <div class="topBrand">
        <img src="63.png" alt="Logo" onerror="this.style.display='none'">
        <div style="font-weight:900; font-size:16px;">–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; margin-right:5px;">
           <span id="lblSizeText" style="font-size:11px; font-weight:900; color:#33d17a;" data-i18n="lSizeOk">üü¢ –ö–æ–¥ –≤ –Ω–æ—Ä–º–µ</span>
           <div style="width:80px; background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.1); height:6px; border-radius:3px; overflow:hidden;">
              <div id="barSize" style="width:0%; height:100%; background:#33d17a; transition: width 0.3s, background 0.3s;"></div>
           </div>
        </div>
        <button class="btn danger small" id="btnResetProject" data-i18n="btnResetProj">üóë –°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="btn primary small" id="btnCopyCodeTop" data-i18n="btnCopy">üìã –ö–æ–¥</button>
      </div>
    </div>
    
    <div class="panel-body">
      <div class="section">
        <div class="title" data-i18n="sLang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        <select id="selLang">
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </div>

      <div class="section">
        <div class="title" data-i18n="sName">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</div>
        <input type="text" id="inpTitle" value="–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä">
      </div>

      <div class="section">
        <div class="title" data-i18n="sDesign">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ</div>
        <div class="row">
          <div>
            <label data-i18n="lBg">–§–æ–Ω –∏–≥—Ä—ã</label>
            <select id="selBg">
              <option value="1.png" data-i18n="bg1">üå≤ –°–∫–∞–∑–æ—á–Ω—ã–π –ª–µ—Å</option>
              <option value="2.png" selected data-i18n="bg2">üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –¥–∞–ª–∏</option>
              <option value="3.png" data-i18n="bg3">üåä –ú–æ—Ä—Å–∫–æ–µ –¥–Ω–æ</option>
              <option value="4.png" data-i18n="bg4">üè∞ –°—Ç–∞—Ä—ã–π –∑–∞–º–æ–∫</option>
              <option value="5.png" data-i18n="bg5">üåµ –î–∏–∫–∏–π –ó–∞–ø–∞–¥</option>
              <option value="6.png" data-i18n="bg6">‚ùÑÔ∏è –ó–∏–º–Ω–∏–π –ø–µ–π–∑–∞–∂</option>
              <option value="7.png" data-i18n="bg7">üè¥‚Äç‚ò†Ô∏è –ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å</option>
              <option value="8.png" data-i18n="bg8">üè´ –®–∫–æ–ª—å–Ω–∞—è –¥–æ—Å–∫–∞</option>
              <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
            </select>
            <input type="text" id="inpBgCustom" placeholder="https://..." style="display:none; margin-top:8px;">
          </div>
          <div>
            <label data-i18n="lTarget">–ú–∏—à–µ–Ω—å</label>
            <select id="selTarget">
              <option value="10.png" data-i18n="tgt10">üéØ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å</option>
              <option value="11.png" data-i18n="tgt11">üéà –í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä–∏–∫</option>
              <option value="12.png" data-i18n="tgt12">üõ∏ –õ–µ—Ç–∞—é—â–∞—è —Ç–∞—Ä–µ–ª–∫–∞</option>
              <option value="13.png" selected data-i18n="tgt13">üõ°Ô∏è –î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —â–∏—Ç</option>
              <option value="14.png" data-i18n="tgt14">‚≠ê –ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞</option>
              <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
            </select>
            <input type="text" id="inpTargetCustom" placeholder="https://..." style="display:none; margin-top:8px;">
          </div>
        </div>
        
        <label data-i18n="lCursor" style="margin-top:10px;">–ü—Ä–∏—Ü–µ–ª (–∫—É—Ä—Å–æ—Ä –≤ –∏–≥—Ä–µ)</label>
        <select id="selCursor">
          <option value="crosshair" data-i18n="oCrosshair">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫</option>
          <option value="sniper" data-i18n="oSniper">–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π (—á—ë—Ä–Ω—ã–π –æ–ø—Ç–∏—á–µ—Å–∫–∏–π)</option>
          <option value="reddot" data-i18n="oRedDot">–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞)</option>
          <option value="custom" data-i18n="optCustom">–ü–æ —Å—Å—ã–ª–∫–µ...</option>
        </select>
        <input type="text" id="inpCursorCustom" placeholder="https://... (.png)" style="display:none; margin-top:8px;">

        <div class="row" style="margin-top:10px;">
          <div><label data-i18n="lRadius">–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpRadius" min="0" max="250" value="0"></div>
          <div><label data-i18n="lSpeed">–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è</label><input type="range" id="inpSpeed" min="0" max="10" value="0"></div>
        </div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</div>
        <div class="row">
          <div><label data-i18n="lTeams">–ö–æ–º–∞–Ω–¥ (1-3)</label><select id="inpTeams"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select></div>
          <div><label data-i18n="lSound">–í—ã—Å—Ç—Ä–µ–ª</label><select id="inpSound"><option value="pif">–ü–∏—Ñ</option><option value="snap">–©–µ–ª—á–æ–∫</option><option value="boom">–ë—É–º</option></select></div>
          <div><label data-i18n="lVol">–ì—Ä–æ–º–∫–æ—Å—Ç—å</label><input type="range" id="inpVol" min="0" max="1" step="0.1" value="0.7"></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div><label data-i18n="lPenaltyOn">–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–º–∞—Ö (–º–∏–º–æ –º–∏—à–µ–Ω–∏)</label><select id="inpPenaltyOn"><option value="false" data-i18n="oOff">–í—ã–∫–ª</option><option value="true" data-i18n="oOn">–í–∫–ª</option></select></div>
          <div><label data-i18n="lPenaltyPts">–í—ã—á–∏—Ç–∞—Ç—å –æ—á–∫–æ–≤</label><input type="number" id="inpPenaltyPts" value="5"></div>
        </div>
        <label data-i18n="lTeamColors" style="margin-top:10px;">–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥</label>
        <div id="teamColorsWrap" style="display:flex; gap:10px; margin-top:5px;"></div>
      </div>

      <div class="section">
        <div class="title" data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</div>
        <div class="row">
          <div><label data-i18n="sStart">–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω</label><select id="startEnabled"><option value="false" data-i18n="oOff">–í—ã–∫–ª—é—á–µ–Ω</option><option value="true" data-i18n="oOn">–í–∫–ª—é—á–µ–Ω</option></select></div>
          <div><label data-i18n="lInstructionColor">–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label><input type="color" id="inpStartColor" value="#d99a29"></div>
        </div>
        <label style="display:flex; align-items:center; gap:5px; margin-top:10px;"><input type="checkbox" id="chkStartGlow" checked> <span data-i18n="lGlow">–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏</span></label>
        <textarea id="inpStartText" style="margin-top:10px;" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."></textarea>
      </div>
      
      <div class="section">
        <div class="title" data-i18n="sEnd">–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)</div>
        <label data-i18n="sEnd">–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</label><select id="feedEnabled"><option value="true" data-i18n="oOn">–í–∫–ª—é—á–µ–Ω</option><option value="false" data-i18n="oOff">–í—ã–∫–ª—é—á–µ–Ω</option></select>
        <textarea id="inpEndText" style="margin-top:10px;" placeholder="–î–æ–ø. —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."></textarea>
      </div>

      <div class="section">
        <div class="title"><span data-i18n="sQ">–í–æ–ø—Ä–æ—Å—ã</span> <span id="qCount" style="color:#fff">0</span></div>
        <div class="row" style="margin-bottom:12px;">
          <button class="btn primary" id="btnAddQ" data-i18n="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" id="btnClearQ" data-i18n="btnClr">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div style="font-size:11px; color:var(--neon-orange-base); margin-bottom:8px;" data-i18n="lDragHint">üí° –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∫—É—Ä—Å–æ—Ä –æ–±—ã—á–Ω—ã–π (—á—Ç–æ–±—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –º–∏—à–µ–Ω–∏). –í —Å–∞–º–æ–π –∏–≥—Ä–µ –æ–Ω —Å—Ç–∞–Ω–µ—Ç –ø—Ä–∏—Ü–µ–ª–æ–º!</div>
        <div id="qList" class="q-list"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div style="font-weight:900" data-i18n="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
      <div style="font-size:12px; color:var(--muted)" data-i18n="previewHint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)</div>
    </div>
    <div class="panel-body" style="display:flex; flex-direction:column; padding:0;">
      <div class="preview-stage" style="border-radius:0; border:none;">
        <iframe id="previewFrame"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-head">
      <span id="modalTitle" data-i18n="mTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</span>
      <button class="btn small danger" onclick="closeModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="row">
        <div><label data-i18n="lQType">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label><select id="modType"><option value="choice" data-i18n="oChoice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option><option value="input" data-i18n="oInput">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option></select></div>
        <div><label data-i18n="lPts">–û—á–∫–∏</label><input type="number" id="modPts" value="10"></div>
      </div>
      <div class="row">
        <div><label data-i18n="lTimer">–¢–∞–π–º–µ—Ä</label><select id="modTimerOn"><option value="false" data-i18n="oOff">–í—ã–∫–ª</option><option value="true" data-i18n="oOn">–í–∫–ª</option></select></div>
        <div><label data-i18n="lSec">–°–µ–∫—É–Ω–¥—ã</label><input type="number" id="modTimerSec" value="30"></div>
      </div>
      <label data-i18n="lImg">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
      <input type="text" id="modImg" placeholder="https://..." oninput="checkImgLink(this)">
      <div id="modImgWarn" style="color:#ff4d4d; font-size:11px; margin-top:4px; display:none;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ö–∞–∂–µ—Ç—Å—è, –≤—ã –≤—Å—Ç–∞–≤–∏–ª–∏ Base64 –∫–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –∏–≥—Ä—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (URL).</div>
      
      <label data-i18n="lQText">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
      <textarea id="modPrompt"></textarea>
      <div class="row" style="margin-top:10px;">
        <div>
          <label data-i18n="lFont">–®—Ä–∏—Ñ—Ç</label>
          <select id="modFont" onchange="this.style.fontFamily=this.value">
            <option value="Roboto" style="font-family: 'Roboto';">Roboto</option>
            <option value="Open Sans" style="font-family: 'Open Sans';">Open Sans</option>
            <option value="Montserrat" style="font-family: 'Montserrat';">Montserrat</option>
            <option value="Lato" style="font-family: 'Lato';">Lato</option>
            <option value="Oswald" style="font-family: 'Oswald';">Oswald</option>
            <option value="Poppins" style="font-family: 'Poppins';">Poppins</option>
            <option value="Merriweather" style="font-family: 'Merriweather';">Merriweather</option>
            <option value="Playfair Display" style="font-family: 'Playfair Display';">Playfair Display</option>
            <option value="Lora" style="font-family: 'Lora';">Lora</option>
            <option value="Courier New" style="font-family: 'Courier New';">Courier New</option>
            <option value="Caveat" style="font-family: 'Caveat';">Caveat (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
            <option value="Neucha" style="font-family: 'Neucha';">Neucha (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
          </select>
        </div>
        <div><label data-i18n="lFontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label><input type="number" id="modFontSize" value="20"></div>
      </div>

      <div class="section" style="margin-top:15px;">
        <div class="title" data-i18n="lAnsOpts">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
        <div id="modOptsList"></div>
        <button class="btn small" style="margin-top:10px;" onclick="addOptRow()" id="btnAddOpt" data-i18n="btnAddOpt">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal()" data-i18n="btnCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveQ" data-i18n="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="gameRoot" style="display:none;">
  <div class="gameRoot" id="gArena">
    <div class="arenaBg" id="gBg"></div>
    <div id="aimCursor"></div>

    <div class="hud">
      <div class="gameTitle" id="gTitle"></div>
      <button class="btn small" id="btnReset" style="pointer-events:auto; z-index: 100;" data-i18n="btnReset">–°–±—Ä–æ—Å</button>
    </div>
    <div class="teams" id="gTeams"></div>
    <div class="targets" id="gTargets"></div>

    <div class="game-modal" id="gModal">
      <div class="game-modal-content">
        <div id="gTimer" style="position:absolute; top:10px; right:20px; font-weight:900; font-size:24px; color:var(--neon-orange-base); display:none;">30</div>
        <h2 id="gQText" style="color:#fff; margin-top:0; padding-right:40px;"></h2>
        <div id="gQImgWrap" style="text-align:center; margin-bottom:15px; display:none;"><img id="gQImg" style="max-width:100%; max-height:300px; border-radius:10px;"></div>
        <div id="gAnswers"></div>
        <div id="gInputWrap" style="display:none; gap:10px; margin-top:15px;">
          <input type="text" id="gInput" style="flex:1; font-size:18px; padding:10px; border-radius:10px;">
          <button class="btn primary" id="gSubmitBtn" data-i18n="btnOK">OK</button>
        </div>
      </div>
    </div>

    <div class="screen" id="gStartScreen">
      <div class="screenCard" id="gStartCard">
        <h1 id="gStartTitle" style="color:#fff; margin-top:0;"></h1>
        <p id="gStartText" style="color:#ccc; font-size:18px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnPlay" style="font-size:20px; padding:12px 24px; margin-top:20px;" data-i18n="btnPlay">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
      </div>
    </div>

    <div class="screen" id="gEndScreen">
      <div class="screenCard">
        <h1 style="color:var(--neon-orange-base); margin-top:0;" data-i18n="lGameOver">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h1>
        <div id="gEndStats" style="width:100%; margin:20px 0;"></div>
        <p id="gEndText" style="color:#ccc; font-size:16px; white-space:pre-wrap;"></p>
        <button class="btn primary" id="gBtnRestart" style="margin-top:15px;" data-i18n="btnRestart">‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================
   –°–∂–∞—Ç–∏–µ LZString (–ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä)
   ======================== */
var LZString=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-=$";var n={compressToEncodedURIComponent:function(r){return n.compress(r,6,function(r){return o.charAt(r)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:r.replace(/ /g,"+"),n.decompress(r.length,32,function(n){return o.indexOf(r.charAt(n))})},compress:function(o,n,t){if(null==o)return"";var e,i,u,s={},c={},a="",p="",f="",l=2,d=3,h=2,v=[],m=0,g=0,w;for(u=0;u<o.length;u+=1)if(a=o.charAt(u),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=d++,c[a]=!0),p=f+a,Object.prototype.hasOwnProperty.call(s,p))f=p;else{if(Object.prototype.hasOwnProperty.call(c,f)){if(256>f.charCodeAt(0)){for(e=0;h>e;e++)m=m<<1,g==n-1?(g=0,v.push(t(m)),m=0):g++;for(i=f.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}else{for(i=1,e=0;h>e;e++)m=m<<1|i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i=0;for(i=f.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[f]}else for(i=s[f],e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[p]=d++,f=String(a)}if(""!==f){if(Object.prototype.hasOwnProperty.call(c,f)){if(256>f.charCodeAt(0)){for(e=0;h>e;e++)m=m<<1,g==n-1?(g=0,v.push(t(m)),m=0):g++;for(i=f.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}else{for(i=1,e=0;h>e;e++)m=m<<1|i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i=0;for(i=f.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete c[f]}else for(i=s[f],e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(i=2,e=0;h>e;e++)m=m<<1|1&i,g==n-1?(g=0,v.push(t(m)),m=0):g++,i>>=1;for(;;)if(m<<=1,g==n-1){v.push(t(m));break}else g++;return v.join("")},decompress:function(o,n,t){var e,i,u,s,c,a,p,f=[],l=4,d=4,h=3,v="",m=[],g={val:t(0),position:n,index:1};for(e=0;3>e;e+=1)f[e]=e;for(u=0,c=Math.pow(2,2),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;switch(u){case 0:for(u=0,c=Math.pow(2,8),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;p=r(u);break;case 1:for(u=0,c=Math.pow(2,16),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;p=r(u);break;case 2:return""}for(f[3]=p,i=p,m.push(p);;){if(g.index>o)return"";for(u=0,c=Math.pow(2,h),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;switch(p=u){case 0:for(u=0,c=Math.pow(2,8),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;f[d++]=r(u),p=d-1,l--;break;case 1:for(u=0,c=Math.pow(2,16),a=1;a!=c;)s=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=t(g.index++)),u|=(s>0?1:0)*a,a<<=1;f[d++]=r(u),p=d-1,l--;break;case 2:return m.join("")}if(0==l&&(l=Math.pow(2,h),h++),f[p])v=f[p];else{if(p!==d)return null;v=i+i.charAt(0)}m.push(v),f[d++]=i+v.charAt(0),l--,i=v,0==l&&(l=Math.pow(2,h),h++)}}};return n}();

/* ========================
   –°–ª–æ–≤–∞—Ä—å (i18n)
   ======================== */
const dict = {
  ru: {
    btnResetProj: "üóë –°–±—Ä–æ—Å–∏—Ç—å", confirmReset: "–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.", btnCopy: "üìã –ö–æ–¥", sLang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", sName: "–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã", sDesign: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", lBg: "–§–æ–Ω –∏–≥—Ä—ã", lTarget: "–ú–∏—à–µ–Ω—å", optCustom: "–ü–æ —Å—Å—ã–ª–∫–µ...", lRadius: "–†–∞–¥–∏—É—Å –¥–≤–∏–∂–µ–Ω–∏—è", lSpeed: "–°–∫–æ—Ä–æ—Å—Ç—å", sGame: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã", lTeams: "–ö–æ–º–∞–Ω–¥ (1-3)", lTeamColors: "–¶–≤–µ—Ç–∞ —Ä–∞–º–æ–∫ –∫–æ–º–∞–Ω–¥", lSound: "–í—ã—Å—Ç—Ä–µ–ª", lVol: "–ì—Ä–æ–º–∫–æ—Å—Ç—å", lPenaltyOn: "–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–º–∞—Ö (–∫–ª–∏–∫ –º–∏–º–æ –º–∏—à–µ–Ω–∏)", lPenaltyPts: "–í—ã—á–∏—Ç–∞—Ç—å –æ—á–∫–æ–≤", oOff: "–í—ã–∫–ª", oOn: "–í–∫–ª", sStart: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω", lInstructionColor: "–¶–≤–µ—Ç —Ä–∞–º–∫–∏", lGlow: "–°–≤–µ—á–µ–Ω–∏–µ —Ä–∞–º–∫–∏", sEnd: "–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (–§–∏–¥–±–µ–∫)", sQ: "–í–æ–ø—Ä–æ—Å—ã", btnAdd: "‚ûï –î–æ–±–∞–≤–∏—Ç—å", btnClr: "üßπ –û—á–∏—Å—Ç–∏—Ç—å", lDragHint: "üí° –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∫—É—Ä—Å–æ—Ä –æ–±—ã—á–Ω—ã–π (—á—Ç–æ–±—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –º–∏—à–µ–Ω–∏). –í —Å–∞–º–æ–π –∏–≥—Ä–µ –æ–Ω —Å—Ç–∞–Ω–µ—Ç –ø—Ä–∏—Ü–µ–ª–æ–º –≤–µ–∑–¥–µ!", previewTitle: "–ü—Ä–æ—Å–º–æ—Ç—Ä", previewHint: "–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)", mTitle: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å", lQType: "–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞", oChoice: "–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞", oInput: "–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞", lPts: "–û—á–∫–∏", lTimer: "–¢–∞–π–º–µ—Ä", lSec: "–°–µ–∫—É–Ω–¥—ã", lImg: "üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)", lQText: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞", lFont: "–®—Ä–∏—Ñ—Ç", lFontSize: "–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞", lAnsOpts: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", btnAddOpt: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç", btnCancel: "–û—Ç–º–µ–Ω–∞", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", lRightAns: "–í–µ—Ä–Ω—ã–π", lOptText: "–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞", lDel: "–£–¥–∞–ª–∏—Ç—å", lGameOver: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã", btnRestart: "‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑", lTeam: "–ö–æ–º–∞–Ω–¥–∞", btnPlay: "‚ñ∂ –ù–∞—á–∞—Ç—å", btnReset: "–°–±—Ä–æ—Å", btnOK: "–û–ö", lCursor: "–ü—Ä–∏—Ü–µ–ª (–∫—É—Ä—Å–æ—Ä –≤ –∏–≥—Ä–µ)", oCrosshair: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫", oSniper: "–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–π (—á—ë—Ä–Ω—ã–π –æ–ø—Ç–∏—á–µ—Å–∫–∏–π)", oRedDot: "–ö–æ–ª–ª–∏–º–∞—Ç–æ—Ä (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞)", lSizeOk: "–ö–æ–¥ –≤ –Ω–æ—Ä–º–µ", lSizeWarn: "–ü–æ—á—Ç–∏ –ª–∏–º–∏—Ç", lSizeErr: "–ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢",
    bg1: "üå≤ –°–∫–∞–∑–æ—á–Ω—ã–π –ª–µ—Å", bg2: "üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –¥–∞–ª–∏", bg3: "üåä –ú–æ—Ä—Å–∫–æ–µ –¥–Ω–æ", bg4: "üè∞ –°—Ç–∞—Ä—ã–π –∑–∞–º–æ–∫", bg5: "üåµ –î–∏–∫–∏–π –ó–∞–ø–∞–¥", bg6: "‚ùÑÔ∏è –ó–∏–º–Ω–∏–π –ø–µ–π–∑–∞–∂", bg7: "üè¥‚Äç‚ò†Ô∏è –ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å", bg8: "üè´ –®–∫–æ–ª—å–Ω–∞—è –¥–æ—Å–∫–∞",
    tgt10: "üéØ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∏—à–µ–Ω—å", tgt11: "üéà –í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä–∏–∫", tgt12: "üõ∏ –õ–µ—Ç–∞—é—â–∞—è —Ç–∞—Ä–µ–ª–∫–∞", tgt13: "üõ°Ô∏è –î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —â–∏—Ç", tgt14: "‚≠ê –ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞"
  },
  en: {
    btnResetProj: "üóë Reset", confirmReset: "Are you sure you want to delete all questions and settings? This cannot be undone.", btnCopy: "üìã Copy Code", sLang: "Interface Language", sName: "Game Title", sDesign: "Design", lBg: "Background", lTarget: "Target", optCustom: "Custom URL...", lRadius: "Orbit Radius", lSpeed: "Speed", sGame: "Game Settings", lTeams: "Teams (1-3)", lTeamColors: "Team Colors", lSound: "Shot Sound", lVol: "Volume", lPenaltyOn: "Penalty for missing target", lPenaltyPts: "Points to Deduct", oOff: "Off", oOn: "On", sStart: "Start Screen", lInstructionColor: "Border Color", lGlow: "Border Glow", sEnd: "Feedback Screen", sQ: "Questions", btnAdd: "‚ûï Add", btnClr: "üßπ Clear", lDragHint: "üí° In preview, the cursor is normal for easy dragging. In the game, it becomes a crosshair!", previewTitle: "Preview", previewHint: "Live preview (coordinates are saved)", mTitle: "Edit Question", lQType: "Question Type", oChoice: "Multiple Choice", oInput: "Text Input", lPts: "Points", lTimer: "Timer", lSec: "Seconds", lImg: "üñºÔ∏è Image (URL)", lQText: "Question Text", lFont: "Font", lFontSize: "Font Size", lAnsOpts: "Answer Options", btnAddOpt: "‚ûï Add Option", btnCancel: "Cancel", btnSave: "üíæ Save", lRightAns: "Correct", lOptText: "Option Text", lDel: "Delete", lGameOver: "Game Results", btnRestart: "‚Üª Play Again", lTeam: "Team", btnPlay: "‚ñ∂ Play", btnReset: "Reset", btnOK: "OK", lCursor: "Crosshair (in-game cursor)", oCrosshair: "Standard Crosshair", oSniper: "Sniper (Black)", oRedDot: "Red Dot Sight", lSizeOk: "Code Size OK", lSizeWarn: "Close to Limit", lSizeErr: "LIMIT REACHED",
    bg1: "üå≤ Fairy Forest", bg2: "üåå Deep Space", bg3: "üåä Ocean Floor", bg4: "üè∞ Old Castle", bg5: "üåµ Wild West", bg6: "‚ùÑÔ∏è Winter Landscape", bg7: "üè¥‚Äç‚ò†Ô∏è Pirate Ship", bg8: "üè´ Blackboard",
    tgt10: "üéØ Classic Target", tgt11: "üéà Balloon", tgt12: "üõ∏ UFO", tgt13: "üõ°Ô∏è Wooden Shield", tgt14: "‚≠ê Golden Star"
  },
  de: {
    btnResetProj: "üóë Alles zur√ºcksetzen", confirmReset: "M√∂chten Sie wirklich alle Fragen und Einstellungen l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.", btnCopy: "üìã Code kopieren", sLang: "Sprache", sName: "Spieltitel", sDesign: "Design", lBg: "Hintergrund", lTarget: "Ziel", optCustom: "Eigene URL...", lRadius: "Orbit-Radius", lSpeed: "Geschwindigkeit", sGame: "Spieleinstellungen", lTeams: "Teams (1-3)", lTeamColors: "Teamfarben", lSound: "Schuss-Sound", lVol: "Lautst√§rke", lPenaltyOn: "Strafe bei Fehlschuss", lPenaltyPts: "Punkte abziehen", oOff: "Aus", oOn: "An", sStart: "Startbildschirm", lInstructionColor: "Randfarbe", lGlow: "Randleuchten", sEnd: "Endbildschirm", sQ: "Fragen", btnAdd: "‚ûï Hinzuf√ºgen", btnClr: "üßπ Leeren", lDragHint: "üí° In der Vorschau ist der Cursor normal zum einfachen Ziehen. Im Spiel wird er zum Fadenkreuz!", previewTitle: "Vorschau", previewHint: "Live-Vorschau (Koordinaten werden gespeichert)", mTitle: "Frage bearbeiten", lQType: "Fragetyp", oChoice: "Multiple Choice", oInput: "Texteingabe", lPts: "Punkte", lTimer: "Timer", lSec: "Sekunden", lImg: "üñºÔ∏è Bild (URL)", lQText: "Fragentext", lFont: "Schriftart", lFontSize: "Schriftgr√∂√üe", lAnsOpts: "Antwortm√∂glichkeiten", btnAddOpt: "‚ûï Option hinzuf√ºgen", btnCancel: "Abbrechen", btnSave: "üíæ Speichern", lRightAns: "Richtig", lOptText: "Optionstext", lDel: "L√∂schen", lGameOver: "Spielergebnisse", btnRestart: "‚Üª Nochmal spielen", lTeam: "Team", btnPlay: "‚ñ∂ Start", btnReset: "Zur√ºcksetzen", btnOK: "OK", lCursor: "Fadenkreuz (Spiel-Cursor)", oCrosshair: "Standard-Fadenkreuz", oSniper: "Scharfsch√ºtze (Schwarz)", oRedDot: "Leuchtpunktvisier", lSizeOk: "Code Size OK", lSizeWarn: "Close to Limit", lSizeErr: "LIMIT REACHED",
    bg1: "üå≤ M√§rchenwald", bg2: "üåå Weltraum", bg3: "üåä Meeresgrund", bg4: "üè∞ Alte Burg", bg5: "üåµ Wilder Westen", bg6: "‚ùÑÔ∏è Winterlandschaft", bg7: "üè¥‚Äç‚ò†Ô∏è Piratenschiff", bg8: "üè´ Schultafel",
    tgt10: "üéØ Klassisches Ziel", tgt11: "üéà Luftballon", tgt12: "üõ∏ UFO", tgt13: "üõ°Ô∏è Holzschild", tgt14: "‚≠ê Goldener Stern"
  },
  zh: {
    btnResetProj: "üóë ÈáçÁΩÆÂÖ®ÈÉ®", confirmReset: "ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÈóÆÈ¢òÂíåËÆæÁΩÆÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ", btnCopy: "üìã Â§çÂà∂‰ª£Á†Å", sLang: "ÁïåÈù¢ËØ≠Ë®Ä", sName: "Ê∏∏ÊàèÂêçÁß∞", sDesign: "ËÆæËÆ°", lBg: "ËÉåÊôØ", lTarget: "ÁõÆÊ†á", optCustom: "Ëá™ÂÆö‰πâ URL...", lRadius: "ËΩ®ÈÅìÂçäÂæÑ", lSpeed: "ÈÄüÂ∫¶", sGame: "Ê∏∏ÊàèËÆæÁΩÆ", lTeams: "Èòü‰ºç (1-3)", lTeamColors: "Èòü‰ºçËæπÊ°ÜÈ¢úËâ≤", lSound: "Â∞ÑÂáªÂ£∞Èü≥", lVol: "Èü≥Èáè", lPenaltyOn: "ËÑ±Èù∂ÊÉ©ÁΩö", lPenaltyPts: "Êâ£Èô§ÂàÜÊï∞", oOff: "ÂÖ≥", oOn: "ÂºÄ", sStart: "ÂºÄÂßãÂ±èÂπï", lInstructionColor: "ËæπÊ°ÜÈ¢úËâ≤", lGlow: "ËæπÊ°ÜÂèëÂÖâ", sEnd: "ÂèçÈ¶àÂ±èÂπï", sQ: "ÈóÆÈ¢ò", btnAdd: "‚ûï Ê∑ªÂä†", btnClr: "üßπ Ê∏ÖÈô§", lDragHint: "üí° Âú®È¢ÑËßà‰∏≠ÔºåÂÖâÊ†áÊ≠£Â∏∏‰ª•‰æøÊãñÂä®„ÄÇÂú®Ê∏∏Êàè‰∏≠ÔºåÂÆÉ‰ºöÂèòÊàêÂçÅÂ≠óÂáÜÊòüÔºÅ", previewTitle: "È¢ÑËßà", previewHint: "ÂÆûÊó∂È¢ÑËßàÔºàÂùêÊ†áÂ∑≤‰øùÂ≠òÔºâ", mTitle: "ÁºñËæëÈóÆÈ¢ò", lQType: "ÈóÆÈ¢òÁ±ªÂûã", oChoice: "ÈÄâÊã©È¢ò", oInput: "Â°´Á©∫È¢ò", lPts: "ÂàÜÊï∞", lTimer: "ËÆ°Êó∂Âô®", lSec: "Áßí", lImg: "üñºÔ∏è ÂõæÁâá (URL)", lQText: "ÈóÆÈ¢òÊñáÊú¨", lFont: "Â≠ó‰Ωì", lFontSize: "Â≠ó‰ΩìÂ§ßÂ∞è", lAnsOpts: "Á≠îÊ°àÈÄâÈ°π", btnAddOpt: "‚ûï Ê∑ªÂä†ÈÄâÈ°π", btnCancel: "ÂèñÊ∂à", btnSave: "üíæ ‰øùÂ≠ò", lRightAns: "Ê≠£Á°Æ", lOptText: "ÈÄâÈ°πÊñáÊú¨", lDel: "Âà†Èô§", lGameOver: "Ê∏∏ÊàèÁªìÊûú", btnRestart: "‚Üª ÂÜçÁé©‰∏ÄÊ¨°", lTeam: "Èòü‰ºç", btnPlay: "‚ñ∂ ÂºÄÂßã", btnReset: "ÈáçÁΩÆ", btnOK: "Á°ÆÂÆö", lCursor: "ÂáÜÊòüÔºàÊ∏∏ÊàèÂÜÖÂÖâÊ†áÔºâ", oCrosshair: "Ê†áÂáÜÂçÅÂ≠ó", oSniper: "ÁãôÂáªÔºàÈªëËâ≤Ôºâ", oRedDot: "Á∫¢ÁÇπÁûÑÂáÜÈïú", lSizeOk: "Code Size OK", lSizeWarn: "Close to Limit", lSizeErr: "LIMIT REACHED",
    bg1: "üå≤ Á´•ËØùÊ£ÆÊûó", bg2: "üåå Ê∑±Á©∫", bg3: "üåä Êµ∑Â∫ï", bg4: "üè∞ Âè§Â†°", bg5: "üåµ ÁãÇÈáéË•øÈÉ®", bg6: "‚ùÑÔ∏è ÂÜ¨Â≠£ÊôØËßÇ", bg7: "üè¥‚Äç‚ò†Ô∏è Êµ∑ÁõóËàπ", bg8: "üè´ ÈªëÊùø",
    tgt10: "üéØ ÁªèÂÖ∏Èù∂Â≠ê", tgt11: "üéà Ê∞îÁêÉ", tgt12: "üõ∏ È£ûÁ¢ü", tgt13: "üõ°Ô∏è Êú®Áõæ", tgt14: "‚≠ê ÈáëÊòü"
  }
};
let lang = "ru";
function t(key) { return (dict[lang] && dict[lang][key]) ? dict[lang][key] : (dict["ru"][key] || key); }
function applyLang() {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const k = el.getAttribute("data-i18n");
    if(el.tagName==="INPUT" || el.tagName==="TEXTAREA") el.placeholder = t(k);
    else if(el.tagName==="OPTION") el.textContent = t(k);
    else el.innerText = t(k);
  });
  if(typeof window.renderQList === 'function') window.renderQList();
  if(typeof window.forceCheckSize === 'function') window.forceCheckSize();
}

/* ========================
   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Config) & LocalStorage & –°–∂–∞—Ç–∏–µ
   ======================== */
const LS_KEY = 'mathShooterSave_v3';
function defaultCfg() {
  return {
    title: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∏—Ä", bg: "2.png", bgUrl: "", target: "13.png", targetUrl: "",
    cursor: "crosshair", cursorUrl: "",
    radius: 0, speed: 0, teams: 2, teamCols: ["#ffae00", "#33d17a", "#ff5b6b"], sound: "pif", vol: 0.7,
    penalty: { enabled: false, points: 5 },
    start: { enabled: false, text: "–ò–ù–°–¢–†–£–ö–¶–ò–Ø\n\n1) –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É\n2) –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–∏—à–µ–Ω–∏\n3) –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å\n\n–ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—á–∫–∏.", color: "#d99a29", neon: true },
    end: { enabled: true, text: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É." },
    questions: []
  };
}

function packCfg(c) {
  const d = defaultCfg();
  let p = {};
  if(c.title !== d.title) p.t = c.title;
  if(c.bg !== d.bg) p.b = c.bg;
  if(c.bgUrl) p.bu = c.bgUrl;
  if(c.target !== d.target) p.tg = c.target;
  if(c.targetUrl) p.tu = c.targetUrl;
  if(c.cursor !== d.cursor) p.cu = c.cursor;
  if(c.cursorUrl) p.cur = c.cursorUrl;
  if(c.radius !== d.radius) p.r = c.radius;
  if(c.speed !== d.speed) p.sp = c.speed;
  if(c.teams !== d.teams) p.tm = c.teams;
  if(JSON.stringify(c.teamCols) !== JSON.stringify(d.teamCols)) p.tc = c.teamCols;
  if(c.sound !== d.sound) p.sd = c.sound;
  if(c.vol !== d.vol) p.v = c.vol;
  if(c.penalty.enabled !== d.penalty.enabled) p.pe = c.penalty.enabled?1:0;
  if(c.penalty.points !== d.penalty.points) p.pp = c.penalty.points;
  
  if(c.start.enabled !== d.start.enabled) p.se = c.start.enabled?1:0;
  if(c.start.text !== d.start.text) p.st = c.start.text;
  if(c.start.color !== d.start.color) p.sc = c.start.color;
  if(c.start.neon !== d.start.neon) p.sn = c.start.neon?1:0;
  
  if(c.end.enabled !== d.end.enabled) p.fe = c.end.enabled?1:0;
  if(c.end.text !== d.end.text) p.ft = c.end.text;
  
  if(c.questions.length > 0) {
    p.q = c.questions.map(q => {
      let rq = {};
      if(q.type === 'input') rq.ty = 1;
      if(q.pts !== 10) rq.pt = q.pts;
      if(q.timer) { rq.tm = 1; rq.s = q.sec; }
      if(q.img) rq.i = q.img;
      if(q.text) rq.p = q.text;
      if(q.font !== "Roboto") rq.f = q.font;
      if(q.size !== 20) rq.fs = q.size;
      rq.x = Math.round((q.x??50)*10)/10;
      rq.y = Math.round((q.y??50)*10)/10;
      if(q.type === 'choice') {
        rq.o = q.opts.map(o => (o.c ? "1" : "0") + o.t); 
      } else {
        rq.a = q.acc;
      }
      return rq;
    });
  }
  return p;
}

function unpackCfg(p) {
  const d = defaultCfg();
  if(!p || typeof p !== 'object') return d;
  if(p.questions) return p; 
  
  return {
    title: p.t ?? d.title, bg: p.b ?? d.bg, bgUrl: p.bu || "",
    target: p.tg ?? d.target, targetUrl: p.tu || "",
    cursor: p.cu ?? d.cursor, cursorUrl: p.cur || "",
    radius: p.r ?? d.radius, speed: p.sp ?? d.speed,
    teams: p.tm ?? d.teams, teamCols: p.tc || d.teamCols,
    sound: p.sd ?? d.sound, vol: p.v ?? d.vol,
    penalty: { enabled: p.pe === 1, points: p.pp ?? d.penalty.points },
    start: { enabled: p.se === 1, text: p.st ?? d.start.text, color: p.sc ?? d.start.color, neon: p.sn === undefined ? d.start.neon : p.sn === 1 },
    end: { enabled: p.fe === undefined ? d.end.enabled : p.fe === 1, text: p.ft ?? d.end.text },
    questions: (p.q || []).map(q => {
      let res = {
        type: q.ty === 1 ? 'input' : 'choice', pts: q.pt ?? 10, timer: q.tm === 1, sec: q.s ?? 30,
        img: q.i || "", text: q.p || "", font: q.f || "Roboto", size: q.fs ?? 20, x: q.x ?? 50, y: q.y ?? 50,
      };
      if(q.ty === 1) {
        res.acc = q.a || [""];
        res.opts = [{t:"", c:true},{t:"", c:false}];
      } else {
        if(q.o) { res.opts = q.o.map(str => ({ c: str.charAt(0) === "1", t: str.slice(1) })); } 
        else { res.opts = [{t:"", c:true},{t:"", c:false}]; }
        res.acc = [""];
      }
      return res;
    })
  };
}

let cfg = null;
try { const saved = localStorage.getItem(LS_KEY); if(saved) cfg = JSON.parse(saved); } catch(e) {}
if(!cfg) cfg = defaultCfg();
function saveCfg() { try { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); } catch(e) {} }

let editIdx = null;

const b64e = (o) => "~" + LZString.compressToEncodedURIComponent(JSON.stringify(packCfg(o)));
const b64d = (s) => {
  if(s.startsWith("~")) return unpackCfg(JSON.parse(LZString.decompressFromEncodedURIComponent(s.slice(1))));
  return unpackCfg(JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/'))))));
};

/* ========================
   –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª–∏–Ω—ã
   ======================== */
function checkLinkSize(data) {
  const maxLen = 2000;
  const curLen = data.length;
  const pct = Math.min(100, (curLen / maxLen) * 100);
  const bar = document.getElementById("barSize");
  const lblText = document.getElementById("lblSizeText");
  
  if (bar) bar.style.width = pct + "%";
  if (curLen < maxLen * 0.75) {
      if(bar) bar.style.background = "#33d17a";
      if(lblText) { lblText.textContent = "üü¢ " + t("lSizeOk"); lblText.style.color = "#33d17a"; }
  } else if (curLen <= maxLen) {
      if(bar) bar.style.background = "#ffae00";
      if(lblText) { lblText.textContent = "üü° " + t("lSizeWarn"); lblText.style.color = "#ffae00"; }
  } else {
      if(bar) bar.style.background = "#ff5b6b";
      if(lblText) { lblText.textContent = "üî¥ " + t("lSizeErr"); lblText.style.color = "#ff5b6b"; }
  }
}
window.forceCheckSize = () => { try { checkLinkSize(b64e(cfg)); } catch(e){} };
window.checkImgLink = (inp) => {
    document.getElementById('modImgWarn').style.display = inp.value.length > 500 ? "block" : "none";
};

/* ========================
   –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê
   ======================== */
function bootEditor() {
  document.body.classList.add('editor-mode');
  document.getElementById('editorApp').style.display = 'grid';

  const upd = () => updateEditor();
  
  document.getElementById('btnResetProject').onclick = () => {
    if(confirm(t('confirmReset'))) { localStorage.removeItem(LS_KEY); location.reload(); }
  };

  document.getElementById('inpTitle').value = cfg.title;
  document.getElementById('selBg').value = cfg.bg; document.getElementById('inpBgCustom').value = cfg.bgUrl;
  document.getElementById('inpBgCustom').style.display = cfg.bg === 'custom' ? 'block' : 'none';
  document.getElementById('selTarget').value = cfg.target; document.getElementById('inpTargetCustom').value = cfg.targetUrl;
  document.getElementById('inpTargetCustom').style.display = cfg.target === 'custom' ? 'block' : 'none';
  document.getElementById('selCursor').value = cfg.cursor; document.getElementById('inpCursorCustom').value = cfg.cursorUrl;
  document.getElementById('inpCursorCustom').style.display = cfg.cursor === 'custom' ? 'block' : 'none';
  document.getElementById('inpRadius').value = cfg.radius; document.getElementById('inpSpeed').value = cfg.speed;
  document.getElementById('inpTeams').value = cfg.teams; document.getElementById('inpSound').value = cfg.sound; document.getElementById('inpVol').value = cfg.vol;
  document.getElementById('inpPenaltyOn').value = cfg.penalty.enabled ? 'true' : 'false'; document.getElementById('inpPenaltyPts').value = cfg.penalty.points;
  document.getElementById('startEnabled').value = cfg.start.enabled ? 'true' : 'false'; document.getElementById('inpStartColor').value = cfg.start.color;
  document.getElementById('chkStartGlow').checked = cfg.start.neon; document.getElementById('inpStartText').value = cfg.start.text;
  document.getElementById('feedEnabled').value = cfg.end.enabled ? 'true' : 'false'; document.getElementById('inpEndText').value = cfg.end.text;

  document.getElementById('selLang').onchange = (e) => { lang = e.target.value; applyLang(); upd(); };
  document.getElementById('selBg').onchange = (e) => { document.getElementById('inpBgCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; upd(); };
  document.getElementById('selTarget').onchange = (e) => { document.getElementById('inpTargetCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; upd(); };
  document.getElementById('selCursor').onchange = (e) => { document.getElementById('inpCursorCustom').style.display = e.target.value === 'custom' ? 'block' : 'none'; upd(); };
  document.getElementById('inpTeams').onchange = () => { renderTeamColsUI(); upd(); };
  document.getElementById('inpSound').onchange = (e) => { AudioSys.play(e.target.value, document.getElementById('inpVol').value); upd(); };

  document.querySelectorAll('#editorApp input:not(#inpBgCustom):not(#inpTargetCustom):not(#inpCursorCustom):not(#modImg), #editorApp textarea, #editorApp select:not(#selBg):not(#selTarget):not(#selCursor):not(#inpTeams):not(#selLang)').forEach(el => {
    el.addEventListener('input', upd); el.addEventListener('change', upd);
  });

  document.getElementById('btnAddQ').onclick = () => openMod();
  document.getElementById('btnClearQ').onclick = () => { cfg.questions=[]; upd(); };
  document.getElementById('btnSaveQ').onclick = saveMod;
  document.getElementById('btnCopyCodeTop').onclick = () => {
    const url = location.origin + location.pathname + "?game=" + encodeURIComponent(b64e(cfg));
    navigator.clipboard.writeText(`<iframe src="${url}" style="width:100%;height:600px;border:0" allowfullscreen></iframe>`).then(()=>alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
  };

  window.addEventListener('message', e => {
    if(e.data && e.data.type==='updPos' && cfg.questions[e.data.idx]) {
      cfg.questions[e.data.idx].x = e.data.x; cfg.questions[e.data.idx].y = e.data.y;
      saveCfg(); window.renderQList(); window.forceCheckSize();
    }
  });

  renderTeamColsUI();
  applyLang();
  upd();
}

function renderTeamColsUI() {
  const c = Number(document.getElementById('inpTeams').value);
  const wrap = document.getElementById('teamColorsWrap');
  wrap.innerHTML = '';
  for(let i=0; i<c; i++){
    const col = cfg.teamCols[i] || ['#ffae00', '#33d17a', '#ff5b6b'][i];
    wrap.innerHTML += `<input type="color" id="tc_${i}" value="${col}">`;
  }
  for(let i=0; i<c; i++){ document.getElementById(`tc_${i}`).oninput = (e) => { cfg.teamCols[i] = e.target.value; updateEditor(); }; }
}

let _prevTid = null;
function updateEditor() {
  cfg.title = document.getElementById('inpTitle').value;
  cfg.bg = document.getElementById('selBg').value; cfg.bgUrl = document.getElementById('inpBgCustom').value;
  cfg.target = document.getElementById('selTarget').value; cfg.targetUrl = document.getElementById('inpTargetCustom').value;
  cfg.cursor = document.getElementById('selCursor').value; cfg.cursorUrl = document.getElementById('inpCursorCustom').value;
  cfg.radius = Number(document.getElementById('inpRadius').value); cfg.speed = Number(document.getElementById('inpSpeed').value);
  cfg.teams = Number(document.getElementById('inpTeams').value); cfg.sound = document.getElementById('inpSound').value; cfg.vol = Number(document.getElementById('inpVol').value);
  cfg.penalty.enabled = document.getElementById('inpPenaltyOn').value === 'true'; cfg.penalty.points = Number(document.getElementById('inpPenaltyPts').value);
  cfg.start.enabled = document.getElementById('startEnabled').value === 'true'; cfg.start.color = document.getElementById('inpStartColor').value; cfg.start.neon = document.getElementById('chkStartGlow').checked; cfg.start.text = document.getElementById('inpStartText').value;
  cfg.end.enabled = document.getElementById('feedEnabled').value === 'true'; cfg.end.text = document.getElementById('inpEndText').value;

  document.getElementById('qCount').innerText = cfg.questions.length;
  window.renderQList();
  saveCfg(); 

  const data = b64e(cfg);
  checkLinkSize(data);

  if(_prevTid) clearTimeout(_prevTid);
  _prevTid = setTimeout(() => {
    document.getElementById('previewFrame').src = location.origin + location.pathname + "?game=" + encodeURIComponent(data) + "&edit=1&lang=" + lang;
  }, 400);
}

window.renderQList = function() {
  document.getElementById('qList').innerHTML = cfg.questions.map((q, i) => `
    <div class="q-item">
      <div><b>#${i+1}</b> ${q.text.substring(0,25)}... <div style="font-size:11px; color:#aaa">x:${Math.round(q.x ?? 50)}%, y:${Math.round(q.y ?? 50)}%</div></div>
      <div><button class="btn small" onclick="openMod(${i})">‚öôÔ∏è</button> <button class="btn small danger" onclick="delQ(${i})">üóëÔ∏è</button></div>
    </div>
  `).join('');
}
window.delQ = (i) => { cfg.questions.splice(i,1); updateEditor(); };

// --- Modal ---
function openMod(idx = null) {
  editIdx = idx;
  const q = idx !== null ? cfg.questions[idx] : { type: "choice", text: "", pts: 10, font: "Roboto", size: 20, timer: false, sec: 30, img: "", opts: [{t:"", c:true}, {t:"", c:false}], acc: ["–û—Ç–≤–µ—Ç"] };
  document.getElementById('modType').value = q.type; document.getElementById('modPts').value = q.pts;
  document.getElementById('modTimerOn').value = q.timer ? "true" : "false"; document.getElementById('modTimerSec').value = q.sec;
  document.getElementById('modImg').value = q.img || ""; document.getElementById('modPrompt').value = q.text;
  
  const fSel = document.getElementById('modFont');
  fSel.value = q.font || "Roboto";
  fSel.style.fontFamily = fSel.value;
  
  document.getElementById('modFontSize').value = q.size || 20;
  syncModType(); document.getElementById('modType').onchange = syncModType;
  function syncModType() { if(document.getElementById('modType').value === 'choice') renderOpts(q.opts || [{t:"", c:true}, {t:"", c:false}]); else renderAccs(q.acc || [""]); }
  document.getElementById('modalBackdrop').classList.add('show');
}
function renderOpts(opts) {
  document.getElementById('modOptsList').innerHTML = opts.map((o, i) => `<div class="row" style="margin-bottom:6px;"><input type="checkbox" style="width:24px;height:24px;" ${o.c?'checked':''} id="optC_${i}"><input type="text" value="${o.t}" id="optT_${i}" placeholder="${t('lOptText')}"><button class="btn small danger" onclick="delOptRow(${i}, 'choice')">‚úñ</button></div>`).join('');
}
function renderAccs(acc) {
  document.getElementById('modOptsList').innerHTML = acc.map((a, i) => `<div class="row" style="margin-bottom:6px;"><input type="text" value="${a}" id="accT_${i}" placeholder="${t('lRightAns')}"><button class="btn small danger" onclick="delOptRow(${i}, 'input')">‚úñ</button></div>`).join('');
}
window.addOptRow = () => { const type = document.getElementById('modType').value; if(type==='choice') { const o = collectOpts(); o.push({t:"", c:false}); renderOpts(o); } else { const a = collectAccs(); a.push(""); renderAccs(a); } };
window.delOptRow = (i, type) => { if(type==='choice'){ const o=collectOpts(); o.splice(i,1); renderOpts(o); } else { const a=collectAccs(); a.splice(i,1); renderAccs(a); } };
function collectOpts() { const arr=[]; let i=0; while(document.getElementById(`optT_${i}`)) { arr.push({ c: document.getElementById(`optC_${i}`).checked, t: document.getElementById(`optT_${i}`).value }); i++; } return arr; }
function collectAccs() { const arr=[]; let i=0; while(document.getElementById(`accT_${i}`)) { arr.push(document.getElementById(`accT_${i}`).value); i++; } return arr; }

function saveMod() {
  const q = {
    type: document.getElementById('modType').value, text: document.getElementById('modPrompt').value,
    pts: Number(document.getElementById('modPts').value), timer: document.getElementById('modTimerOn').value === "true", sec: Number(document.getElementById('modTimerSec').value),
    img: document.getElementById('modImg').value, font: document.getElementById('modFont').value, size: Number(document.getElementById('modFontSize').value),
    x: editIdx !== null ? (cfg.questions[editIdx].x ?? 50) : 50,
    y: editIdx !== null ? (cfg.questions[editIdx].y ?? 50) : 50
  };
  if(q.type==='choice') q.opts = collectOpts(); else q.acc = collectAccs();
  if(editIdx !== null) cfg.questions[editIdx] = q; else cfg.questions.push(q);
  closeModal(); updateEditor();
}
window.closeModal = () => document.getElementById('modalBackdrop').classList.remove('show');

/* ========================
   –†–ï–ñ–ò–ú –ò–ì–†–´ (–ò –ü–†–ï–í–¨–Æ)
   ======================== */
function bootGame() {
  const qs = new URLSearchParams(location.search);
  document.body.classList.add('game-mode');
  document.getElementById('gameRoot').style.display = 'block';
  lang = qs.get('lang') || 'ru'; applyLang();
  
  let gCfg = cfg;
  if(qs.get('game')) { try { gCfg = b64d(qs.get('game')); } catch(e){} }
  const isEdit = qs.get('edit') === '1';

  const arenaEl = document.getElementById('gArena');
  const arenaBg = document.getElementById('gBg');
  const aimCursor = document.getElementById('aimCursor');
  
  if(!isEdit) {
    let curHtml = '';
    if(gCfg.cursor === 'sniper') curHtml = `<svg width="46" height="46" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="rgba(255,255,255,0.1)" stroke="black" stroke-width="3"/><line x1="20" y1="0" x2="20" y2="40" stroke="black" stroke-width="2"/><line x1="0" y1="20" x2="40" y2="20" stroke="black" stroke-width="2"/><circle cx="20" cy="20" r="2" fill="red"/></svg>`;
    else if(gCfg.cursor === 'reddot') curHtml = `<svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="red" stroke-width="3"/><circle cx="16" cy="16" r="4" fill="red"/></svg>`;
    else if(gCfg.cursor === 'custom') curHtml = `<img src="${gCfg.cursorUrl}" style="width:40px;height:40px;object-fit:contain;">`;
    else curHtml = `<svg width="34" height="34" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="none" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/><line x1="16" y1="0" x2="16" y2="32" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/><line x1="0" y1="16" x2="32" y2="16" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px black)"/></svg>`;
    aimCursor.innerHTML = curHtml;

    arenaEl.classList.add('aiming');
    arenaEl.addEventListener('mousemove', e => {
      const r = arenaEl.getBoundingClientRect();
      aimCursor.style.left = (e.clientX - r.left) + 'px';
      aimCursor.style.top = (e.clientY - r.top) + 'px';
    });
    arenaEl.addEventListener('mouseenter', () => { if(arenaEl.classList.contains('aiming')) aimCursor.style.display = 'block'; });
    arenaEl.addEventListener('mouseleave', () => aimCursor.style.display = 'none');
  }

  arenaEl.addEventListener('mousemove', e => {
      const r = arenaEl.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width - 0.5;
      const y = (e.clientY - r.top) / r.height - 0.5;
      arenaBg.style.transform = `scale(1.05) perspective(1000px) rotateY(${x * 10}deg) rotateX(${-y * 10}deg) translate(${x * -20}px, ${y * -20}px)`;
  });
  arenaEl.addEventListener('mouseleave', () => {
      arenaBg.style.transform = `scale(1.05) perspective(1000px) rotateY(0deg) rotateX(0deg) translate(0px, 0px)`;
  });

  const bgImg = gCfg.bg === 'custom' ? gCfg.bgUrl : gCfg.bg;
  arenaBg.style.backgroundImage = `url("${bgImg}")`;
  const tgtImg = gCfg.target === 'custom' ? gCfg.targetUrl : gCfg.target;
  document.getElementById('gTitle').innerText = gCfg.title;

  const tDiv = document.getElementById('gTeams');
  tDiv.style.gridTemplateColumns = `repeat(${gCfg.teams}, 1fr)`;
  let scores = Array(gCfg.teams).fill(0);
  let curTeam = 0;
  
  function drawTeams() {
    tDiv.innerHTML = scores.map((s, i) => {
      const col = gCfg.teamCols[i] || '#ffffff';
      return `<div class="teamCard" style="${i===curTeam ? `border-color:${col}; box-shadow: 0 0 15px ${col}66;` : ''}">
        <input type="text" class="teamInput" value="${t('lTeam')} ${i+1}">
        <b style="color:#fff; font-size:20px;">${s}</b>
      </div>`;
    }).join('');
  }
  drawTeams();

  function popFloatText(x, y, text, col) {
    const el = document.createElement('div');
    el.style.cssText = `position:absolute; left:${x}px; top:${y}px; color:${col}; font-weight:900; font-size:28px; pointer-events:none; z-index:20; transition: transform 0.8s ease-out, opacity 0.8s ease-out; transform: translate(-50%, -50%); text-shadow: 0 4px 10px #000;`;
    el.innerText = text;
    arenaEl.appendChild(el);
    requestAnimationFrame(() => { el.style.transform = 'translate(-50%, -100px)'; el.style.opacity = '0'; });
    setTimeout(() => el.remove(), 800);
  }

  // –®—Ç—Ä–∞—Ñ –¢–û–õ–¨–ö–û –∑–∞ –ø—Ä–æ–º–∞—Ö
  arenaEl.addEventListener('mousedown', (e) => {
    if(isEdit || !arenaEl.classList.contains('aiming')) return;
    if(e.target.closest('.target') || e.target.closest('.hud') || e.target.closest('.teams') || e.target.closest('.game-modal') || e.target.closest('.screen')) return;
    
    AudioSys.play(gCfg.sound, gCfg.vol); 
    if(gCfg.penalty && gCfg.penalty.enabled) {
      const p = Number(gCfg.penalty.points || 0);
      scores[curTeam] -= p;
      drawTeams();
      const r = arenaEl.getBoundingClientRect();
      popFloatText(e.clientX - r.left, e.clientY - r.top, `-${p}`, '#ff5b6b');
    }
  });

  const tgtDiv = document.getElementById('gTargets');
  tgtDiv.className = isEdit ? "targets edit-mode" : "targets";
  let targetsHit = 0;

  gCfg.questions.forEach((q, i) => {
    const el = document.createElement('div');
    el.className = 'target';
    if(q.x === undefined) q.x = 15 + (i % 5) * 16;
    if(q.y === undefined) q.y = 30 + Math.floor(i / 5) * 20;

    el.style.left = q.x + '%'; el.style.top = q.y + '%';
    el.innerHTML = `
      <div class="img" style="background-image:url('${tgtImg}')"></div>
      <div class="num">${i+1}</div>
      <div class="pts">‚≠ê ${q.pts || 10}</div>
    `;
    
    if(gCfg.radius > 0 && gCfg.speed > 0) {
      let ang = (i / Math.max(1, gCfg.questions.length)) * Math.PI * 2;
      setInterval(() => {
        ang += (gCfg.speed * 0.01);
        el.style.setProperty('--orbit-x', Math.round(Math.cos(ang) * gCfg.radius) + 'px');
        el.style.setProperty('--orbit-y', Math.round(Math.sin(ang) * gCfg.radius) + 'px');
      }, 30);
    }

    if(isEdit) {
      el.onmousedown = (e) => {
        e.preventDefault(); e.stopPropagation();
        const rect = arenaEl.getBoundingClientRect();
        function move(ev) {
          let nx = Math.round(((ev.clientX - rect.left) / rect.width) * 100);
          let ny = Math.round(((ev.clientY - rect.top) / rect.height) * 100);
          nx = Math.max(0, Math.min(100, nx)); ny = Math.max(0, Math.min(100, ny));
          el.style.left = nx + "%"; el.style.top = ny + "%";
          window.parent.postMessage({ type: 'updPos', idx: i, x: nx, y: ny }, '*');
        }
        function stop() { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); }
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
      };
    } else {
      el.onmousedown = (e) => {
        e.stopPropagation(); // –ù–µ –ø—Ä–æ–º–∞—Ö!
        if(!arenaEl.classList.contains('aiming')) return;
        AudioSys.play(gCfg.sound, gCfg.vol);
        el.classList.add('hit');
        openGameQuestion(q, () => {
          targetsHit++;
          if(targetsHit >= gCfg.questions.length && gCfg.end.enabled) showEndScreen();
        });
      };
    }
    tgtDiv.appendChild(el);
  });

  let timerId = null;
  function openGameQuestion(q, onDone) {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    document.getElementById('gModal').classList.add('on');
    
    const txt = document.getElementById('gQText');
    txt.innerText = q.text; txt.style.fontFamily = q.font || 'Roboto'; txt.style.fontSize = (q.size || 20) + "px";
    
    const imgWrap = document.getElementById('gQImgWrap');
    if(q.img) { document.getElementById('gQImg').src = q.img; imgWrap.style.display = 'block'; } else { imgWrap.style.display = 'none'; }

    const ansDiv = document.getElementById('gAnswers'); const inpWrap = document.getElementById('gInputWrap');
    ansDiv.innerHTML = "";
    
    const timerEl = document.getElementById('gTimer');
    if(q.timer && q.sec > 0) {
      timerEl.style.display = 'block'; let timeLeft = q.sec; timerEl.innerText = timeLeft;
      timerId = setInterval(() => { timeLeft--; timerEl.innerText = timeLeft; if(timeLeft <= 0) finishTurn(false); }, 1000);
    } else { timerEl.style.display = 'none'; }

    if(q.type === 'choice') {
      inpWrap.style.display = 'none'; ansDiv.style.display = 'block';
      let opts = [...q.opts].filter(o => o.t.trim() !== "").sort(() => Math.random() - 0.5);
      opts.forEach(o => {
        const b = document.createElement('button'); b.className = 'game-ans-btn'; b.innerText = o.t; b.style.fontFamily = q.font || 'Roboto';
        b.onclick = () => finishTurn(o.c);
        ansDiv.appendChild(b);
      });
    } else {
      ansDiv.style.display = 'none'; inpWrap.style.display = 'flex';
      const inp = document.getElementById('gInput'); inp.value = ""; inp.style.fontFamily = q.font || 'Roboto';
      document.getElementById('gSubmitBtn').onclick = () => {
        const user = inp.value.trim().toLowerCase(); const accs = q.acc.map(a=>a.trim().toLowerCase());
        finishTurn(accs.includes(user));
      };
    }

    function finishTurn(isCorrect) {
      clearInterval(timerId); document.getElementById('gModal').classList.remove('on');
      arenaEl.classList.add('aiming'); 
      if(isCorrect) { scores[curTeam] += Number(q.pts || 10); }
      curTeam = (curTeam + 1) % gCfg.teams;
      drawTeams(); onDone();
    }
  }

  if(!isEdit && gCfg.start.enabled && gCfg.start.text) {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    const sCard = document.getElementById('gStartCard');
    document.getElementById('gStartScreen').classList.add('on');
    document.getElementById('gStartTitle').innerText = gCfg.title;
    document.getElementById('gStartText').innerText = gCfg.start.text;
    sCard.style.borderColor = gCfg.start.color;
    if(gCfg.start.neon) sCard.style.boxShadow = `0 0 25px ${gCfg.start.color}, inset 0 0 10px ${gCfg.start.color}`;
    document.getElementById('gBtnPlay').onclick = () => { AudioSys.init(); document.getElementById('gStartScreen').classList.remove('on'); arenaEl.classList.add('aiming'); };
  }

  function showEndScreen() {
    arenaEl.classList.remove('aiming'); aimCursor.style.display = 'none';
    document.getElementById('gEndScreen').classList.add('on');
    document.getElementById('gEndText').innerText = gCfg.end.text;
    const tNames = Array.from(document.querySelectorAll('.teamInput')).map(i => i.value);
    document.getElementById('gEndStats').innerHTML = scores.map((s,i) => `
      <div class="resultRow">
        <span>${tNames[i] || '–ö–æ–º–∞–Ω–¥–∞ '+(i+1)}</span>
        <span style="color:var(--neon-orange-base)">${s}</span>
      </div>
    `).join('');
    document.getElementById('gBtnRestart').onclick = () => location.reload();
  }
  
  document.getElementById('btnReset').onclick = () => location.reload();
}

/* --- –ó–∞–ø—É—Å–∫ --- */
const p = new URLSearchParams(location.search);
if(p.has('game') && p.get('edit') !== '1') bootGame();
else { bootEditor(); if(p.get('edit') === '1') bootGame(); }
</script>
</body>
</html>
